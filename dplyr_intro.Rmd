---
title: "dplyr入門"
date: '2020-04-20'
categories: []
tags: ["統計学", "R", "データハンドリング"]
markup: "mmark"
---

## 参考資料

* [dplyr of Datacamp](https://www.datacamp.com/courses/dplyr-data-manipulation-r-tutorial): 実はこんなもん読むよりこっちのホームページへアクセスして実習した方が100倍いいと思う。
* [Introduction to dplyr](https://cran.rstudio.com/web/packages/dplyr/vignettes/introduction.html)

---

dplyrはR業界の神様、[Hadley Wickham](http://hadley.nz/)が作成したRのパッケージである。 R内蔵の関数でもデータの管理はできるが、dplyrを使うと生産性は何倍も向上する。

dplyrの主な使い道は以下のとおり

```{r, echo = FALSE}
library(knitr)
library(kableExtra)

data.frame(関数名 = c("`filter`", "`arrange`", "`select`", 
                      "`mutate`", "`summarise`"),
           機能 = c("ある条件に合ったケースだけを抽出",
                    "データをある基準に合わせて揃える",
                    "指定した変数のみを抽出",
                    "計算した結果を新しい変数として定義",
                    "データの要約")) %>%
    kable() %>%
    kable_styling(bootstrap_options = c("striped", "hover", "condensed",
                                        "responsive"),
                  full_width = FALSE)
```

これらの機能を最大限発揮するために、いくつかの良き友達がいる

```{r, echo = FALSE, results='asis'}
data.frame(関数名 = c("`group_by`", "`%>%` (注)"),
           機能 = c("データのグループ化",
                    "複数の処理を逐次的に実行")) %>%
    kable(escape = FALSE, format = "html") %>%
    kable_styling(bootstrap_options = c("striped", "hover", "condensed",
                                        "responsive"),
                  full_width = FALSE)
```

※なぜか2行目は`%&gt;%`と表示されていますが、正しいのは`%>%`です。

---

## 実習の準備

まずは、dplyrのインストールと読み込みである。dplyrはCRANに登録されているので、`install.packages()`でインストールできる。

```{r, eval = FALSE}
install.packages("dplyr")
```

```{r}
library(dplyr)
```

実習用データは有名な`nycflights13`データを使う。これはニューヨーク出発の航空便のデータで、336,776のケースが含まれている。インストールされていない場合、`install.packages("nycflights13")`でインストールしておこう。

まず、データを読み込み、中身を見てみよう。

```{r}
library(nycflights13)

head(flights) # データの中身を見る(最初の6行だけ)
```


---
    
### filter()

`filter()`はある条件に合ったケースのみを抽出する関数である。使い方は`filter(データ, 条件)`である。ここでデータは`flights`である。試しに3月のデータだけを抽出してみる。月は`month`変数である。

```{r}
filter(flights, month == 3)
```

ここで注意すべきなのは`month = 3`ではなく、`month == 3`ということだ。 ほとんどの言語で`=`は代入を意味する。「同じ」を意味するわけではない。

簡単にまとめてみよう

```{r, echo = FALSE, results='asis'}
data.frame(演算子 = c("A == B", "A < B", "A > B",
                      "A <= B", "A >= B", "A != B"),
           意味 = c("AとBは同値",
                    "AはBより小さい(未満)",
                    "AはBより大きい(超過)",
                    "AはBより小さいか、同じ(以下)",
                    "AはBより大きいか、同じ(以上)",
                    "AとBは同じではない")) %>%
    kable(escape = FALSE, format = "html") %>%
    kable_styling(bootstrap_options = c("striped", "hover", "condensed",
                                        "responsive"),
                  full_width = FALSE)
```

先ほどの例では3月(`month == 3`)のデータを抽出したが、もっと条件を絞ることもできる。

たとえば、3月10日に絞りたい場合の条件式は`month == 3 & day == 10`である。

```{r}
filter(flights, month == 3 & day == 10)
```

`&`はANDを意味する。もし、3月10日と11日のデータがほしいなるどうすればいいか。 この場合、OR表現が必要となる。ORは`|`と書く。

```{r}
filter(flights, month == 3 & (day == 10 | day == 11))
```

ここで条件式はANDとORの組み合わせになっている。簡単に表現すると「A and (B or C)」である。これは

* (AかつB) あるいは(AかつC)

を意味する。ちなみに以上のコマンドはもっと省略できる。

```{r}
filter(flights, month == 3 & (day == 10 | 11))
```

`day ==`を一回書くだけでも結果は同じ。ちなみに、OR演算の他の表現法もある。それは%in%である。 `A %in% (1, 2, 3, 4)`は「Aが1, 2, 3, 4どっちかに該当するか」を意味する。これを使って先のコマンドを書きなおしてみよう。

```{r}
filter(flights, month == 3 & (day %in% c(10, 11)))
```

やはり結果は変わらない。ちなみに、Rで複数の要素(数字でも文字でも)を並ぶときには`c()`を使う。ただし、一つのベクトルに数字が文字が混在されることはない。

このデータを使っては実習できないが、欠損値のあるケースを除去したい場合もあろう。 たとえば、`year`が欠損値になってるケースが除去したいなら`filter(flights, year == NA)`で良いだろうか。

実は違う。

この場合は`is.na(year)`と書く。理由は聞かないでほしい。

---

### arrange()

`arrange`はケースをある基準に合わせて並べ直す関数である。

特に意味はないが、データを`month`が小さい順に並べてみよう。

```{r}
arrange(flights, month)
```

もし、大きい方から表示したいなら`desc()`を使う。

```{r}
arrange(flights, desc(month))
```

次は「`month`の順で並べて、もし同じなら、次は`day`の順で並べたい」である。どうすればいいだろうか。実はこれも簡単だ。 条件式に次の基準となる変数名を入れるだけでいい。

```{r}
arrange(flights, month, day)
```

これを「`month`は12から1へ、`day`も31から1の順で並べたい」と思うなら

```{r}
arrange(flights, desc(month), desc(day))
```

最後に、欠損値(`NA`)は常に一番最後の行になる。

---