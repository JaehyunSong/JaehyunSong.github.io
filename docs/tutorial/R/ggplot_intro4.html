<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="ja" xml:lang="ja"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.232">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Jaehyun Song, Ph.D.&nbsp;- 可視化[発展]</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<link href="../../imgs/favicon.png" rel="icon" type="image/png">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-text-highlighting-styles">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting-dark.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-bootstrap" data-mode="light">
<link href="../../site_libs/bootstrap/bootstrap-dark.min.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-bootstrap" data-mode="dark">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "サーチ"
  }
}</script>
<script async="" src="https://www.googletagmanager.com/gtag/js?id=G-BCE61P2YP7"></script>

<script type="text/javascript">

window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-BCE61P2YP7', { 'anonymize_ip': true});
</script>

  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<link rel="stylesheet" href="../../styles.css">
<meta property="og:title" content="Jaehyun Song, Ph.D.">
<meta property="og:description" content="Jaehyun Song’s personal homepage">
<meta property="og:image" content="https://www.jaysong.net/tutorial/R/imgs/favicon.png">
<meta property="og:site_name" content="Jaehyun Song, Ph.D.">
<meta name="twitter:title" content="Jaehyun Song, Ph.D.">
<meta name="twitter:description" content="Jaehyun Song’s personal homepage">
<meta name="twitter:image" content="https://www.jaysong.net/tutorial/R/imgs/favicon.png">
<meta name="twitter:creator" content="@Tintstyle">
<meta name="twitter:site" content="@Tintstyle">
<meta name="twitter:card" content="summary">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a href="../../index.html" class="navbar-brand navbar-brand-logo">
    <img src="../../imgs/logo.png" alt="" class="navbar-logo">
    </a>
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">Jaehyun Song, Ph.D.</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="サーチ"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="ナビゲーションを切り替える" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../cv/index.html" rel="" target="">
 <span class="menu-text">CV</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../research/index.html" rel="" target="">
 <span class="menu-text">Research</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../teaching/index.html" rel="" target="">
 <span class="menu-text">Teaching</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="https://www.jaysong.net/seminar/" rel="" target="">
 <span class="menu-text">Seminar</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../software/index.html" rel="" target="">
 <span class="menu-text">Software</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../notes/index.html" rel="" target="">
 <span class="menu-text">Notes</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../tutorial/index.html" rel="" target="">
 <span class="menu-text">Tutorials</span></a>
  </li>  
</ul>
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item compact">
    <a class="nav-link" href="https://twitter.com/Tintstyle" rel="" target=""><i class="bi bi-twitter" role="img">
</i> 
 <span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://www.facebook.com/tintstyle" rel="" target=""><i class="bi bi-facebook" role="img">
</i> 
 <span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://www.instagram.com/tintstyle/" rel="" target=""><i class="bi bi-instagram" role="img">
</i> 
 <span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/JaehyunSong" rel="" target=""><i class="bi bi-github" role="img">
</i> 
 <span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://scholar.google.com/citations?user=8a-NxjkAAAAJ&amp;hl=ja" rel="" target=""><i class="bi bi-mortarboard-fill" role="img">
</i> 
 <span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://researchmap.jp/jaysong" rel="" target=""><i class="bi bi-map" role="img">
</i> 
 <span class="menu-text"></span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
          <div class="quarto-navbar-tools">
  <a href="" class="quarto-color-scheme-toggle quarto-navigation-tool  px-1" onclick="window.quartoToggleColorScheme(); return false;" title="ダークモードの切り替え"><i class="bi"></i></a>
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">目次</h2>
   
  <ul>
  <li><a href="#visual4-intro" id="toc-visual4-intro" class="nav-link active" data-scroll-target="#visual4-intro">概要</a></li>
  <li><a href="#visual4-violin" id="toc-visual4-violin" class="nav-link" data-scroll-target="#visual4-violin">バイオリンプロット</a></li>
  <li><a href="#visual4-rug" id="toc-visual4-rug" class="nav-link" data-scroll-target="#visual4-rug">ラグプロット</a></li>
  <li><a href="#visual4-ridge" id="toc-visual4-ridge" class="nav-link" data-scroll-target="#visual4-ridge">リッジプロット</a></li>
  <li><a href="#visual4-pointrange" id="toc-visual4-pointrange" class="nav-link" data-scroll-target="#visual4-pointrange">エラーバー付き散布図</a></li>
  <li><a href="#visual4-lollipop" id="toc-visual4-lollipop" class="nav-link" data-scroll-target="#visual4-lollipop">ロリーポップチャート</a></li>
  <li><a href="#visual4-smooth" id="toc-visual4-smooth" class="nav-link" data-scroll-target="#visual4-smooth">平滑化ライン</a></li>
  <li><a href="#visual4-text" id="toc-visual4-text" class="nav-link" data-scroll-target="#visual4-text">文字列の出力</a></li>
  <li><a href="#visual4-heatmap" id="toc-visual4-heatmap" class="nav-link" data-scroll-target="#visual4-heatmap">ヒートマップ</a>
  <ul class="collapse">
  <li><a href="#つの離散変数の分布を表すヒートマップ" id="toc-つの離散変数の分布を表すヒートマップ" class="nav-link" data-scroll-target="#つの離散変数の分布を表すヒートマップ">2つの離散変数の分布を表すヒートマップ</a></li>
  <li><a href="#離散変数times離散変数における連続変数の値を示すヒートマップ" id="toc-離散変数times離散変数における連続変数の値を示すヒートマップ" class="nav-link" data-scroll-target="#離散変数times離散変数における連続変数の値を示すヒートマップ">離散変数<span class="math inline">\(\times\)</span>離散変数における連続変数の値を示すヒートマップ</a></li>
  </ul></li>
  <li><a href="#visual4-contour" id="toc-visual4-contour" class="nav-link" data-scroll-target="#visual4-contour">等高線図</a></li>
  <li><a href="#visual4-map" id="toc-visual4-map" class="nav-link" data-scroll-target="#visual4-map">地図</a>
  <ul class="collapse">
  <li><a href="#世界地図" id="toc-世界地図" class="nav-link" data-scroll-target="#世界地図">世界地図</a></li>
  <li><a href="#日本地図全体" id="toc-日本地図全体" class="nav-link" data-scroll-target="#日本地図全体">日本地図（全体）</a></li>
  <li><a href="#日本地図特定の都道府県" id="toc-日本地図特定の都道府県" class="nav-link" data-scroll-target="#日本地図特定の都道府県">日本地図（特定の都道府県）</a></li>
  </ul></li>
  <li><a href="#visual4-dag" id="toc-visual4-dag" class="nav-link" data-scroll-target="#visual4-dag">非巡回有向グラフ</a>
  <ul class="collapse">
  <li><a href="#ノードの位置を指定する" id="toc-ノードの位置を指定する" class="nav-link" data-scroll-target="#ノードの位置を指定する">ノードの位置を指定する</a></li>
  </ul></li>
  <li><a href="#visual4-bump" id="toc-visual4-bump" class="nav-link" data-scroll-target="#visual4-bump">バンプチャート</a></li>
  <li><a href="#visual4-alluvial" id="toc-visual4-alluvial" class="nav-link" data-scroll-target="#visual4-alluvial">沖積図</a></li>
  <li><a href="#visual4-tree" id="toc-visual4-tree" class="nav-link" data-scroll-target="#visual4-tree">ツリーマップ</a></li>
  <li><a href="#visual4-mosaic" id="toc-visual4-mosaic" class="nav-link" data-scroll-target="#visual4-mosaic">モザイクプロット</a></li>
  <li><a href="#visual4-further" id="toc-visual4-further" class="nav-link" data-scroll-target="#visual4-further">その他のグラフ</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">可視化[発展]</h1>
</div>



<div class="quarto-title-meta">

    
    <div>
    <div class="quarto-title-meta-heading">作成日</div>
    <div class="quarto-title-meta-contents">
      <p class="date">2023年7月19日</p>
    </div>
  </div>
  
    
  </div>
  

</header>

<section id="visual4-intro" class="level2">
<h2 class="anchored" data-anchor-id="visual4-intro">概要</h2>
<p>　<a href="../../tutorial/R/ggplot_intro1.html">理論編</a>では{ggplot2}の仕組みについて、<a href="../../tutorial/R/ggplot_intro2.html">基礎編</a>ではよく使われる5種類のプロット（棒グラフ、散布図、折れ線グラフ、箱ひげ図、ヒストグラム）の作り方を、<a href="../../tutorial/R/ggplot_intro3.html">応用編</a>ではスケール、座標系などの操作を通じたグラフの見た目調整について解説しました。本記事では<a href="../../tutorial/R/ggplot_intro2.html">基礎編</a>の延長線上に位置づけることができ、紹介しきれなかった様々なグラフの作り方について簡単に解説します。本記事で紹介するグラフは以下の通りです。</p>
<ul>
<li><a href="#visual4-violin">バイオリンプロット</a></li>
<li><a href="#visual4-rug">ラグプロット</a></li>
<li><a href="#visual4-ridge">リッジプロット</a></li>
<li><a href="#visual4-pointrange">エラーバー付き散布図</a></li>
<li><a href="#visual4-lollipop">ロリーポップチャート</a></li>
<li><a href="#visual4-smooth">平滑化ライン</a></li>
<li><a href="#visual4-text">文字列の出力</a></li>
<li><a href="#visual4-heatmap">ヒートマップ</a></li>
<li><a href="#visual4-contour">等高線図</a></li>
<li><a href="#visual4-map">地図</a></li>
<li><a href="#visual4-dag">非巡回有向グラフ</a></li>
<li><a href="#visual4-bump">バンプチャート</a></li>
<li><a href="#visual4-alluvial">沖積図</a></li>
<li><a href="#visual4-tree">ツリーマップ</a></li>
<li><a href="#visual4-mosaic">モザイクプロット</a></li>
</ul>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1"></a>pacman<span class="sc">::</span><span class="fu">p_load</span>(tidyverse)</span>
<span id="cb1-2"><a href="#cb1-2"></a></span>
<span id="cb1-3"><a href="#cb1-3"></a>Country_df <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">"Data/Countries.csv"</span>)</span>
<span id="cb1-4"><a href="#cb1-4"></a>COVID19_df <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">"Data/COVID19_Worldwide.csv"</span>, <span class="at">guess_max =</span> <span class="dv">10000</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="visual4-violin" class="level2">
<h2 class="anchored" data-anchor-id="visual4-violin">バイオリンプロット</h2>
<p>　バイオリンプロットは連続変数の分布を可視化する際に使用するプロットの一つです。<a href="../../tutorial/R/ggplot_intro1.html">理論編</a>で紹介しましたヒストグラムや箱ひげ図と目的は同じです。それではバイオリンプロットとは何かについて例を見ながら解説します。</p>
<p>　以下の図は対数化した一人当たり購買力平価GDP（<code>PPP_per_capita</code>）のヒストグラムです。</p>
<div class="cell" data-layout-align="center" data-hash="ggplot_intro4_cache/html/visual4-violin1_68f92d717d45af449a791d7748ffaade">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="ggplot_intro4_files/figure-html/visual4-violin1-1.png" class="img-fluid figure-img" width="2100"></p>
</figure>
</div>
</div>
</div>
<p>　このヒストグラムをなめらかにすると以下のような図になります。</p>
<div class="cell" data-layout-align="center" data-hash="ggplot_intro4_cache/html/visual4-violin2_d017a078f93067f99d8028568e2f5913">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="ggplot_intro4_files/figure-html/visual4-violin2-1.png" class="img-fluid figure-img" width="2100"></p>
</figure>
</div>
</div>
</div>
<p>　この密度曲線を上下対称にすると以下のような図となり、これがバイオリンプロットです。ヒストグラムのようにデータの分布が分かりやすくなります。</p>
<div class="cell" data-layout-align="center" data-hash="ggplot_intro4_cache/html/visual4-violin3_ed7ee1c9478203dd5169ac3515782b99">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="ggplot_intro4_files/figure-html/visual4-violin3-1.png" class="img-fluid figure-img" width="2100"></p>
</figure>
</div>
</div>
</div>
<p>　しかし、この図の場合、ヒストグラムと同様、中央値や四分位数などの情報が含まれておりません。これらの箱ひげ図を使用した方が良いでしょう。バイオリンプロットの良い点はバイオリンの中に箱ひげ図を入れ、ヒストグラムと箱ひげ図両方の長所を取ることができる点です。たとえば、バイオリンプロットを90度回転させ、中にバイオリン図を入れると以下のようになります。</p>
<div class="cell" data-layout-align="center" data-hash="ggplot_intro4_cache/html/visual4-violin4_784108a2627456d15bbfc153fb1d4db6">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="ggplot_intro4_files/figure-html/visual4-violin4-1.png" class="img-fluid figure-img" width="2100"></p>
</figure>
</div>
</div>
</div>
<p>　それでは実際にバイオリンプロットを作ってみましょう。使い方は箱ひげ図（<code>geom_boxplot()</code>）と同じです。たとえば、横軸は大陸（<code>Continent</code>）に、縦軸は対数化した一人当たり購買力平価GDP（<code>PPP_per_capita</code>）にしたバイオリンプロットを作るには作るには<code>geom_violin()</code>幾何オブジェクトの中にマッピングするだけです。大陸ごとに色分けしたい場合は<code>fill</code>引数に<code>Continent</code>をマッピングします。</p>
<div class="cell" data-layout-align="center" data-hash="ggplot_intro4_cache/html/visual4-violin5_e012599ebbeced28d4729687de0dc343">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1"></a>Country_df <span class="sc">%&gt;%</span></span>
<span id="cb2-2"><a href="#cb2-2"></a>    <span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb2-3"><a href="#cb2-3"></a>    <span class="fu">geom_violin</span>(<span class="fu">aes</span>(<span class="at">x =</span> Continent, <span class="at">y =</span> PPP_per_capita, <span class="at">fill =</span> Continent)) <span class="sc">+</span></span>
<span id="cb2-4"><a href="#cb2-4"></a>    <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"大陸"</span>, <span class="at">y =</span> <span class="st">"一人当たり購買力平価GDP (対数)"</span>) <span class="sc">+</span></span>
<span id="cb2-5"><a href="#cb2-5"></a>    <span class="fu">scale_y_continuous</span>(<span class="at">breaks =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1000</span>, <span class="dv">10000</span>, <span class="dv">100000</span>),</span>
<span id="cb2-6"><a href="#cb2-6"></a>                       <span class="at">labels =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1000</span>, <span class="dv">10000</span>, <span class="dv">100000</span>),</span>
<span id="cb2-7"><a href="#cb2-7"></a>                       <span class="at">trans  =</span> <span class="st">"log10"</span>) <span class="sc">+</span> <span class="co"># y軸を対数化</span></span>
<span id="cb2-8"><a href="#cb2-8"></a>    <span class="fu">guides</span>(<span class="at">fill =</span> <span class="st">"none"</span>) <span class="sc">+</span> <span class="co"># fillのマッピング情報の凡例を隠す</span></span>
<span id="cb2-9"><a href="#cb2-9"></a>    <span class="fu">theme_minimal</span>(<span class="at">base_size =</span> <span class="dv">16</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="ggplot_intro4_files/figure-html/visual4-violin5-1.png" class="img-fluid figure-img" width="2100"></p>
</figure>
</div>
</div>
</div>
<p>　ここに箱ひげ図も載せたい場合は、<code>geom_violin()</code>オブジェクトの後に<code>geom_boxplot()</code>オブジェクトを入れるだけで十分です。</p>
<div class="cell" data-layout-align="center" data-hash="ggplot_intro4_cache/html/visual4-violin6_938097db7fbd4112ef0afea66bcb0d9d">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1"></a>Country_df <span class="sc">%&gt;%</span></span>
<span id="cb3-2"><a href="#cb3-2"></a>    <span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb3-3"><a href="#cb3-3"></a>    <span class="fu">geom_violin</span>(<span class="fu">aes</span>(<span class="at">x =</span> Continent, <span class="at">y =</span> PPP_per_capita, <span class="at">fill =</span> Continent)) <span class="sc">+</span></span>
<span id="cb3-4"><a href="#cb3-4"></a>    <span class="fu">geom_boxplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> Continent, <span class="at">y =</span> PPP_per_capita),</span>
<span id="cb3-5"><a href="#cb3-5"></a>                 <span class="at">width =</span> <span class="fl">0.2</span>) <span class="sc">+</span></span>
<span id="cb3-6"><a href="#cb3-6"></a>    <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"大陸"</span>, <span class="at">y =</span> <span class="st">"一人当たり購買力平価GDP (対数)"</span>) <span class="sc">+</span></span>
<span id="cb3-7"><a href="#cb3-7"></a>    <span class="fu">scale_y_continuous</span>(<span class="at">breaks =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1000</span>, <span class="dv">10000</span>, <span class="dv">100000</span>),</span>
<span id="cb3-8"><a href="#cb3-8"></a>                       <span class="at">labels =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1000</span>, <span class="dv">10000</span>, <span class="dv">100000</span>),</span>
<span id="cb3-9"><a href="#cb3-9"></a>                       <span class="at">trans =</span> <span class="st">"log10"</span>) <span class="sc">+</span></span>
<span id="cb3-10"><a href="#cb3-10"></a>    <span class="fu">guides</span>(<span class="at">fill =</span> <span class="st">"none"</span>) <span class="sc">+</span></span>
<span id="cb3-11"><a href="#cb3-11"></a>    <span class="fu">theme_minimal</span>(<span class="at">base_size =</span> <span class="dv">16</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="ggplot_intro4_files/figure-html/visual4-violin6-1.png" class="img-fluid figure-img" width="2100"></p>
</figure>
</div>
</div>
</div>
<p>　箱ひげ図は四分位範囲、四分位数、最小値、最大値などの情報を素早く読み取れますが、どの値当たりが分厚いかなどの情報が欠けています。これをバイオリンプロットで補うことで、よりデータの分布を的確に把握することができます。</p>
</section>
<section id="visual4-rug" class="level2">
<h2 class="anchored" data-anchor-id="visual4-rug">ラグプロット</h2>
<p>　ラグプロット（rug plot）は変数の分布を示す点ではヒストグラム、箱ひげ図、バイオリンプロットと同じ目的を持ちますが、大きな違いとしてはラグプロット単体で使われるケースがない（または、非常に稀）という点です。ラグプロットは上述しましたヒストグラムや箱ひげ図、または散布図などと組み合わせて使うのが一般的です。</p>
<p>　以下は<code>Country_df</code>の<code>PPP_per_capita</code>（常用対数変換）のヒストグラムです。</p>
<div class="cell" data-layout-align="center" data-hash="ggplot_intro4_cache/html/visual4-rug1_9ec34515c3609a3d380fcecab7d5c27e">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="ggplot_intro4_files/figure-html/visual4-rug1-1.png" class="img-fluid figure-img" width="2100"></p>
</figure>
</div>
</div>
</div>
<p>　一変数の分布を確認する場合、ヒストグラムは情報量の損失が少ない方です。それでも値一つ一つの情報は失われますね。例えば、上記のヒストグラムで左端の度数は1です。左端の棒の区間はおおよそ500から780であり、一人当たりPPPがこの区間に属する国は1カ国ということです。ちなみに、その国はブルンジ共和国ですが、ブルンジ共和国の具体的な一人当たりPPPはヒストグラムから分かりません。情報量をより豊富に持たせるためには区間を細かく刻むことも出来ますが、逆に分布の全体像が読みにくくなります。</p>
<p>　ここで登場するのがラグプロットです。これは座標平面の端を使ってデータを一時現状に並べたものです。多くの場合、点ではなく、垂直線（｜）を使います。ラグプロットの幾何オブジェクトは{ggplot2}でデフォルトで提供されており、<code>geom_rug()</code>を使います。マッピングは<code>x</code>または<code>y</code>に対して行いますが、座標平面の下段にラグプロットを出力する場合は<code>x</code>に変数（ここでは<code>PPP_per_capita</code>）をマッピングします。</p>
<div class="cell" data-layout-align="center" data-hash="ggplot_intro4_cache/html/visual4-rug2_d4915225d20bff8169a603d75de4b359">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="ggplot_intro4_files/figure-html/visual4-rug2-1.png" class="img-fluid figure-img" width="2100"></p>
</figure>
</div>
</div>
</div>
<p>ラグプロットを使うと本来のヒストグラムの外見にほぼ影響を与えず、更に情報を付け加えることが可能です。点（｜）の密度でデータの分布を確認することもできますが、その密度の相対的な比較に関してはヒストグラムの方が良いでしょう。</p>
<p>ラグプロットは散布図に使うことも可能です。散布図は一つ一つの点が具体的な値がマッピングされるため、情報量の損失はほぼないでしょう。それでも散布図にラグプロットを加える意味はあります。まず、<code>Country_df</code>のフリーダムハウス指数（<code>FH_Total</code>）と一人当たりPPP（<code>PPP_per_capita</code>）の散布図を作ってみましょう。</p>
<div class="cell" data-layout-align="center" data-hash="ggplot_intro4_cache/html/visual4-rug3_8f24428a58883e564411752da096a2cd">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="ggplot_intro4_files/figure-html/visual4-rug3-1.png" class="img-fluid figure-img" width="2100"></p>
</figure>
</div>
</div>
</div>
<p>散布図の目的は二変量間の<strong>関係</strong>を確認することであって、それぞれの変数の分布を確認することではありません。もし、<code>FH_Total</code>と<code>PPP_per_capita</code>の分布が確認したいなら、それぞれのヒストグラムや箱ひげ図を作成した方が良いでしょう。しかし、ラグプロットを使えば、点（｜）の密度で大まかな分布は確認出来ますし、図の見た目にもほぼ影響を与えません。</p>
<p>横軸と縦軸両方のラグプロットは、<code>geom_rug()</code>に<code>x</code>と<code>y</code>両方マッピングするだけです。</p>
<div class="cell" data-layout-align="center" data-hash="ggplot_intro4_cache/html/visual4-rug4_3f35f04d3a946f5bb67ede7be77c4582">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="ggplot_intro4_files/figure-html/visual4-rug4-1.png" class="img-fluid figure-img" width="2100"></p>
</figure>
</div>
</div>
</div>
<p>　これで<code>FH_Total</code>はほぼ均等に分布していて、<code>PPP_per_capita</code>は2万ドル以下に多く密集していることが確認できます。</p>
<p>　{ggExtra}の<code>ggMarginal()</code>を使えば、ラグプロットでなく、箱ひげ図やヒストグラムを付けることも可能です。{ggplot2}で作図した図をオブジェクトとして格納し、<code>ggMarginal()</code>の第一引数として指定します。第一引数のみだと密度のだけ出力されるため、箱ひげ図を付けるためには<code>type = "boxplot"</code>を指定します（既定値は<code>"density"</code>）。ヒストグラムを出力する場合は<code>"histogram"</code>と指定します。</p>
<div class="cell" data-layout-align="center" data-hash="ggplot_intro4_cache/html/visual4-rug5_e289f18ab4f3964e676249f0889085d6">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="ggplot_intro4_files/figure-html/visual4-rug5-1.png" class="img-fluid figure-img" width="2100"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="visual4-ridge" class="level2">
<h2 class="anchored" data-anchor-id="visual4-ridge">リッジプロット</h2>
<p>　リッジプロット（ridge plot）はある変数の分布をグループごとに出力する図です。大陸ごとの人間開発指数の分布を示したり、時系列データなら分布の変化を示す時にも使えます。ここでは大陸ごとの人間開発指数の分布をリッジプロットで示してみましょう。</p>
<p>　リッジプロットを作成する前に、<code>geom_density()</code>幾何オブジェクトを用い、変数の密度曲線（density curve）を作ってみます。マッピングは<code>x</code>に対し、分布を出力する変数名を指定します。また、密度曲線内部に色塗り（<code>fill</code>）をし、曲線を計算する際のバンド幅（<code>bw</code>）は0.054にします。<code>bw</code>が大きいほど、なめらかな曲線になります。</p>
<div class="cell" data-layout-align="center" data-hash="ggplot_intro4_cache/html/visual4-ridge1_d0ba1d6c75a214c799ba9fa7f725160f">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1"></a>Country_df <span class="sc">%&gt;%</span></span>
<span id="cb4-2"><a href="#cb4-2"></a>  <span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb4-3"><a href="#cb4-3"></a>  <span class="fu">geom_density</span>(<span class="fu">aes</span>(<span class="at">x =</span> HDI_2018), <span class="at">fill =</span> <span class="st">"gray70"</span>, <span class="at">bw =</span> <span class="fl">0.054</span>) <span class="sc">+</span></span>
<span id="cb4-4"><a href="#cb4-4"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"2018年人間開発指数"</span>, <span class="at">y =</span> <span class="st">"大陸"</span>) <span class="sc">+</span></span>
<span id="cb4-5"><a href="#cb4-5"></a>  <span class="fu">theme_minimal</span>(<span class="at">base_size =</span> <span class="dv">12</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Removed 6 rows containing non-finite values (stat_density).</code></pre>
</div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="ggplot_intro4_files/figure-html/visual4-ridge1-1.png" class="img-fluid figure-img" width="2100"></p>
</figure>
</div>
</div>
</div>
<p>　これを大陸ごとに出力する場合、ファセット分割を行います。今回は大陸ごとに1列（<code>ncol = 1</code>）でファセットを分割します。</p>
<div class="cell" data-layout-align="center" data-hash="ggplot_intro4_cache/html/visual4-ridge2_bc88f860c9c2661dc14ea0468233cb80">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1"></a>Country_df <span class="sc">%&gt;%</span></span>
<span id="cb6-2"><a href="#cb6-2"></a>  <span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb6-3"><a href="#cb6-3"></a>  <span class="fu">geom_density</span>(<span class="fu">aes</span>(<span class="at">x =</span> HDI_2018), <span class="at">fill =</span> <span class="st">"gray70"</span>, <span class="at">bw =</span> <span class="fl">0.054</span>) <span class="sc">+</span></span>
<span id="cb6-4"><a href="#cb6-4"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"2018年人間開発指数"</span>, <span class="at">y =</span> <span class="st">"大陸"</span>) <span class="sc">+</span></span>
<span id="cb6-5"><a href="#cb6-5"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span>Continent, <span class="at">ncol =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb6-6"><a href="#cb6-6"></a>  <span class="fu">theme_minimal</span>(<span class="at">base_size =</span> <span class="dv">12</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Removed 6 rows containing non-finite values (stat_density).</code></pre>
</div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="ggplot_intro4_files/figure-html/visual4-ridge2-1.png" class="img-fluid figure-img" width="2100"></p>
</figure>
</div>
</div>
</div>
<p>　それでは上のグラフをリッジプロットとして作図してみましょう。今回は{ggridges}パッケージを使います。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1"></a>pacman<span class="sc">::</span><span class="fu">p_load</span>(ggridges)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>　使用する幾何オブジェクトは<code>geom_density_ridges()</code>です。似たような幾何オブジェクトとして<code>geom_ridgeline()</code>がありますが、こちらは予め密度曲線の高さを計算しておく必要があります。一方、<code>geom_density_ridges()</code>は変数だけ指定すれば密度を自動的に計算してくれます。マッピングは<code>x</code>と<code>y</code>に対し、それぞれ分布を出力する変数名とグループ変数名を指定します。また、密度曲線が重なるケースもあるため、透明度（<code>alpha</code>）も0.5にしておきましょう。ここでは別途指定しませんが、ハンド幅も指定可能であり、<code>aes()</code>の外側に<code>bandwidth</code>を指定するだけです。</p>
<div class="cell" data-layout-align="center" data-hash="ggplot_intro4_cache/html/visual4-ridge4_3c57d589ee3779eb20d282eb6fa5e1d6">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1"></a>Country_df <span class="sc">%&gt;%</span></span>
<span id="cb9-2"><a href="#cb9-2"></a>  <span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb9-3"><a href="#cb9-3"></a>  <span class="fu">geom_density_ridges</span>(<span class="fu">aes</span>(<span class="at">x =</span> HDI_2018, <span class="at">y =</span> Continent), </span>
<span id="cb9-4"><a href="#cb9-4"></a>                      <span class="at">alpha =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb9-5"><a href="#cb9-5"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"2018年人間開発指数"</span>, <span class="at">y =</span> <span class="st">"大陸"</span>) <span class="sc">+</span></span>
<span id="cb9-6"><a href="#cb9-6"></a>  <span class="fu">theme_minimal</span>(<span class="at">base_size =</span> <span class="dv">12</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Picking joint bandwidth of 0.054</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Removed 6 rows containing non-finite values (stat_density_ridges).</code></pre>
</div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="ggplot_intro4_files/figure-html/visual4-ridge4-1.png" class="img-fluid figure-img" width="2100"></p>
</figure>
</div>
</div>
</div>
<p>先ほど作図した図と非常に似た図が出来上がりました。ファセット分割に比べ、空間を最大限に活用していることが分かります。ファセットラベルがなく、グループ名が縦軸上に位置するからです。また、リッジプロットの特徴は密度曲線がオーバラップする点ですが、以下のように<code>scale = 1</code>を指定すると、オーバラップなしで作成することも可能です。もし、<code>scale = 3</code>にすると最大2つの密度曲線が重なることになります。たとえば最下段のアフリカはアメリカの行と若干オーバラップしていますが、<code>scale = 3</code>の場合、アジアの行までオーバーラップされうることになります。</p>
<div class="cell" data-layout-align="center" data-hash="ggplot_intro4_cache/html/visual4-ridge5_fe68fdef3f91c14048b67f62ecf22586">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1"></a>Country_df <span class="sc">%&gt;%</span></span>
<span id="cb12-2"><a href="#cb12-2"></a>  <span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb12-3"><a href="#cb12-3"></a>  <span class="fu">geom_density_ridges</span>(<span class="fu">aes</span>(<span class="at">x =</span> HDI_2018, <span class="at">y =</span> Continent), </span>
<span id="cb12-4"><a href="#cb12-4"></a>                      <span class="at">scale =</span> <span class="dv">1</span>, <span class="at">alpha =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb12-5"><a href="#cb12-5"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"2018年人間開発指数"</span>, <span class="at">y =</span> <span class="st">"大陸"</span>) <span class="sc">+</span></span>
<span id="cb12-6"><a href="#cb12-6"></a>  <span class="fu">theme_minimal</span>(<span class="at">base_size =</span> <span class="dv">12</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Picking joint bandwidth of 0.054</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Removed 6 rows containing non-finite values (stat_density_ridges).</code></pre>
</div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="ggplot_intro4_files/figure-html/visual4-ridge5-1.png" class="img-fluid figure-img" width="2100"></p>
</figure>
</div>
</div>
</div>
<p>　また、横軸の値に応じて背景の色をグラデーションで表現することも可能です。この場合、<code>geom_density_ridges()</code>幾何オブジェクトでなく、<code>geom_density_ridges_gradient()</code>を使い、<code>fill</code>にもマッピングをする必要があります。横軸（<code>x</code>）の値に応じて色塗りをする場合、<code>fill = stat(x)</code>とします。デフォルトでは横軸の値が高いほど空色、低いほど黒になります。ここでは高いほど黄色、低いほど紫ににするため、色弱にも優しい<code>scale_fill_viridis_c()</code>を使い<a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a>、カラーオプションはplasmaにします（<code>option = "c"</code>）。</p>
<div class="cell" data-layout-align="center" data-hash="ggplot_intro4_cache/html/visual4-ridge6_a51de756f0a4caadfa8028d50a73015f">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1"></a>Country_df <span class="sc">%&gt;%</span></span>
<span id="cb15-2"><a href="#cb15-2"></a>  <span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb15-3"><a href="#cb15-3"></a>  <span class="fu">geom_density_ridges_gradient</span>(<span class="fu">aes</span>(<span class="at">x =</span> HDI_2018, <span class="at">y =</span> Continent, <span class="at">fill =</span> <span class="fu">stat</span>(x)), </span>
<span id="cb15-4"><a href="#cb15-4"></a>                               <span class="at">alpha =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb15-5"><a href="#cb15-5"></a>  <span class="fu">scale_fill_viridis_c</span>(<span class="at">option =</span> <span class="st">"C"</span>) <span class="sc">+</span></span>
<span id="cb15-6"><a href="#cb15-6"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"2018年人間開発指数"</span>, <span class="at">y =</span> <span class="st">"大陸"</span>, <span class="at">fill =</span> <span class="st">"2018年人間開発指数"</span>) <span class="sc">+</span></span>
<span id="cb15-7"><a href="#cb15-7"></a>  <span class="fu">theme_minimal</span>(<span class="at">base_size =</span> <span class="dv">12</span>) <span class="sc">+</span></span>
<span id="cb15-8"><a href="#cb15-8"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"bottom"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Picking joint bandwidth of 0.054</code></pre>
</div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="ggplot_intro4_files/figure-html/visual4-ridge6-1.png" class="img-fluid figure-img" width="2100"></p>
</figure>
</div>
</div>
</div>
<p>密度曲線は基本的にはなめらかな曲線であるため、データが存在しない箇所にも密度が高く見積もられるケースがあります。全体的な分布を俯瞰するには良いですが、情報の損失は避けられません。そこで出てくるのが点付きのリッジプロットです。<code>HDI_2018</code>の個々の値を点で出力するには<code>jittered_points = TRUE</code>を指定するだけです。これだけで密度曲線の内側に点が若干のズレ付き（jitter）で出力されます。ただし、密度曲線がオーバーラップされるリッジプロットの特徴を考えると、グループごとに点の色分けをする必要があります（同じ色になると、どのグループの点かが分からなくなるので）。この場合、<code>point_color</code>に対し、グループ変数（<code>Continent</code>）をマッピングします。また、密度曲線の色と合わせるために密度曲線の色塗りも<code>fill</code>で指定します。</p>
<div class="cell" data-layout-align="center" data-hash="ggplot_intro4_cache/html/visual4-ridge7_6a24a7ea379edeec355e8c107060f131">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1"></a>Country_df <span class="sc">%&gt;%</span></span>
<span id="cb17-2"><a href="#cb17-2"></a>  <span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb17-3"><a href="#cb17-3"></a>  <span class="fu">geom_density_ridges</span>(<span class="fu">aes</span>(<span class="at">x =</span> HDI_2018, <span class="at">y =</span> Continent, <span class="at">fill =</span> Continent,</span>
<span id="cb17-4"><a href="#cb17-4"></a>                          <span class="at">point_color =</span> Continent), </span>
<span id="cb17-5"><a href="#cb17-5"></a>                      <span class="at">alpha =</span> <span class="fl">0.5</span>, <span class="at">jittered_points =</span> <span class="cn">TRUE</span>) <span class="sc">+</span></span>
<span id="cb17-6"><a href="#cb17-6"></a>  <span class="fu">guides</span>(<span class="at">fill =</span> <span class="st">"none"</span>, <span class="at">point_color =</span> <span class="st">"none"</span>) <span class="sc">+</span> <span class="co"># 凡例を削除</span></span>
<span id="cb17-7"><a href="#cb17-7"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"2018年人間開発指数"</span>, <span class="at">y =</span> <span class="st">"大陸"</span>) <span class="sc">+</span></span>
<span id="cb17-8"><a href="#cb17-8"></a>  <span class="fu">theme_minimal</span>(<span class="at">base_size =</span> <span class="dv">12</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Picking joint bandwidth of 0.054</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Removed 6 rows containing non-finite values (stat_density_ridges).</code></pre>
</div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="ggplot_intro4_files/figure-html/visual4-ridge7-1.png" class="img-fluid figure-img" width="2100"></p>
</figure>
</div>
</div>
</div>
<p>　他にも密度曲線の下側にラグプロットを付けることも可能です。こうすれば点ごとに色訳をする必要もなくなります。ラグプロットを付けるためには点の形（<code>point_shape</code>）を「|」にする必要があります。ただ、これだけだと「|」が密度曲線内部に散らばる（jittered）だけです。散らばりをなくす、つまり密度曲線の下段に固定する必要があり、これは<code>aes()</code>その外側に<code>position = position_points_jitter(width = 0, height = 0)</code>を指定することで出来ます。</p>
<div class="cell" data-layout-align="center" data-hash="ggplot_intro4_cache/html/visual4-ridge8_0652a3f6e69624ee18b97a8c1b8f58bc">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1"></a>Country_df <span class="sc">%&gt;%</span></span>
<span id="cb20-2"><a href="#cb20-2"></a>  <span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb20-3"><a href="#cb20-3"></a>  <span class="fu">geom_density_ridges</span>(<span class="fu">aes</span>(<span class="at">x =</span> HDI_2018, <span class="at">y =</span> Continent, <span class="at">fill =</span> Continent), </span>
<span id="cb20-4"><a href="#cb20-4"></a>                      <span class="at">alpha =</span> <span class="fl">0.5</span>, <span class="at">jittered_points =</span> <span class="cn">TRUE</span>,</span>
<span id="cb20-5"><a href="#cb20-5"></a>                      <span class="at">position =</span> <span class="fu">position_points_jitter</span>(<span class="at">width =</span> <span class="dv">0</span>, <span class="at">height =</span> <span class="dv">0</span>),</span>
<span id="cb20-6"><a href="#cb20-6"></a>                      <span class="at">point_shape =</span> <span class="st">"|"</span>, <span class="at">point_size =</span> <span class="dv">3</span>) <span class="sc">+</span></span>
<span id="cb20-7"><a href="#cb20-7"></a>  <span class="fu">guides</span>(<span class="at">fill =</span> <span class="st">"none"</span>) <span class="sc">+</span></span>
<span id="cb20-8"><a href="#cb20-8"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"2018年人間開発指数"</span>, <span class="at">y =</span> <span class="st">"大陸"</span>) <span class="sc">+</span></span>
<span id="cb20-9"><a href="#cb20-9"></a>  <span class="fu">theme_minimal</span>(<span class="at">base_size =</span> <span class="dv">12</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Picking joint bandwidth of 0.054</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Removed 6 rows containing non-finite values (stat_density_ridges).</code></pre>
</div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="ggplot_intro4_files/figure-html/visual4-ridge8-1.png" class="img-fluid figure-img" width="2100"></p>
</figure>
</div>
</div>
</div>
<p>　最後に密度曲線でなく、ヒストグラムで示す方法を紹介します。これは<code>geom_density_ridges()</code>の内部に<code>stat = "binline"</code>を指定するだけです。</p>
<div class="cell" data-layout-align="center" data-hash="ggplot_intro4_cache/html/visual4-ridge9_5f26cb89eddee2680ff6d50d35913a53">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1"></a>Country_df <span class="sc">%&gt;%</span></span>
<span id="cb23-2"><a href="#cb23-2"></a>  <span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb23-3"><a href="#cb23-3"></a>  <span class="fu">geom_density_ridges</span>(<span class="fu">aes</span>(<span class="at">x =</span> HDI_2018, <span class="at">y =</span> Continent), <span class="at">alpha =</span> <span class="fl">0.5</span>,</span>
<span id="cb23-4"><a href="#cb23-4"></a>                      <span class="at">stat =</span> <span class="st">"binline"</span>) <span class="sc">+</span></span>
<span id="cb23-5"><a href="#cb23-5"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"2018年人間開発指数"</span>, <span class="at">y =</span> <span class="st">"大陸"</span>) <span class="sc">+</span></span>
<span id="cb23-6"><a href="#cb23-6"></a>  <span class="fu">theme_minimal</span>(<span class="at">base_size =</span> <span class="dv">12</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>`stat_binline()` using `bins = 30`. Pick better value with `binwidth`.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Removed 6 rows containing non-finite values (stat_binline).</code></pre>
</div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="ggplot_intro4_files/figure-html/visual4-ridge9-1.png" class="img-fluid figure-img" width="2100"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="visual4-pointrange" class="level2">
<h2 class="anchored" data-anchor-id="visual4-pointrange">エラーバー付き散布図</h2>
<p>　エラーバー付きの散布図は推定結果の点推定値とその不確実性（信頼区間など）を示す際によく使われる図です。以下の表は<code>Country_df</code>を用い、大陸（オセアニアを除く）ごとにフリーダムハウス・スコア（<code>FH_Total</code>）を一人当たりPPP GDP（<code>PPP_per_capita</code>）に回帰させた分析から得られたフリーダムハウス・スコア（<code>FH_Total</code>）の係数（以下の式の<span class="math inline">\(\beta_1\)</span>）の点推定値と95%信頼区間です。</p>
<p><span class="math display">\[
\text{PPP per capita} = \beta_0 + \beta_1 \cdot \text{FH}\_\text{Total} + \varepsilon
\]</span></p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1"></a>Pointrange_df <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb26-2"><a href="#cb26-2"></a>    <span class="at">Continent =</span> <span class="fu">c</span>(<span class="st">"Asia"</span>, <span class="st">"Europe"</span>, <span class="st">"Africa"</span>, <span class="st">"America"</span>),</span>
<span id="cb26-3"><a href="#cb26-3"></a>    <span class="at">Coef      =</span> <span class="fu">c</span>(<span class="fl">65.3</span>, <span class="fl">588.0</span>, <span class="fl">53.4</span>, <span class="fl">316.0</span>),</span>
<span id="cb26-4"><a href="#cb26-4"></a>    <span class="at">Conf_lwr  =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="fl">250.0</span>, <span class="fl">376.0</span>, <span class="sc">-</span><span class="fl">14.5</span>, <span class="fl">128.0</span>),</span>
<span id="cb26-5"><a href="#cb26-5"></a>    <span class="at">Conf_upr  =</span> <span class="fu">c</span>(<span class="fl">380.0</span>, <span class="fl">801.0</span>, <span class="fl">121.0</span>, <span class="fl">504.0</span>)</span>
<span id="cb26-6"><a href="#cb26-6"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1"></a>Pointrange_df</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 4 × 4
# Groups:   Continent [4]
  Continent  Coef Conf_lwr Conf_upr
  &lt;chr&gt;     &lt;dbl&gt;    &lt;dbl&gt;    &lt;dbl&gt;
1 Asia       65.3   -250.      380.
2 Europe    588.     376.      801.
3 Africa     53.4    -14.5     121.
4 America   316.     128.      504.</code></pre>
</div>
</div>
<p>　実は以上のデータは以下のようなコードで作成されています。{purrr}パッケージの使い方に慣れる必要があるので、<a href="../../tutorial/R/purrr_intro.html">purrr入門</a>を参照してください。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1"></a>Pointrange_df <span class="ot">&lt;-</span> Country_df <span class="sc">%&gt;%</span></span>
<span id="cb29-2"><a href="#cb29-2"></a>    <span class="fu">filter</span>(Continent <span class="sc">!=</span> <span class="st">"Oceania"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb29-3"><a href="#cb29-3"></a>    <span class="fu">group_by</span>(Continent) <span class="sc">%&gt;%</span></span>
<span id="cb29-4"><a href="#cb29-4"></a>    <span class="fu">nest</span>() <span class="sc">%&gt;%</span></span>
<span id="cb29-5"><a href="#cb29-5"></a>    <span class="fu">mutate</span>(<span class="at">Fit =</span> <span class="fu">map</span>(data, <span class="sc">~</span><span class="fu">lm</span>(PPP_per_capita <span class="sc">~</span> FH_Total, <span class="at">data =</span> .)),</span>
<span id="cb29-6"><a href="#cb29-6"></a>           <span class="at">Est =</span> <span class="fu">map</span>(Fit, broom<span class="sc">::</span>tidy, <span class="at">conf.int =</span> <span class="cn">TRUE</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb29-7"><a href="#cb29-7"></a>    <span class="fu">unnest</span>(Est) <span class="sc">%&gt;%</span></span>
<span id="cb29-8"><a href="#cb29-8"></a>    <span class="fu">filter</span>(term <span class="sc">==</span> <span class="st">"FH_Total"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb29-9"><a href="#cb29-9"></a>    <span class="fu">select</span>(Continent, <span class="at">Coef =</span> estimate, </span>
<span id="cb29-10"><a href="#cb29-10"></a>           <span class="at">Conf_lwr =</span> conf.low, <span class="at">Conf_upr =</span> conf.high) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>この<code>Pointrange_df</code>を用いて横軸は大陸（<code>Continent</code>）、縦軸には点推定値（<code>Coef</code>）と95%信頼区間（<code>Conf_lwr</code>と<code>Conf_upr</code>）を出力します。ここで使う幾何オブジェクトは<code>geom_pointrange()</code>です。横軸<code>x</code>と点推定値<code>y</code>、95%信頼区間の下限の<code>ymin</code>、上限の<code>ymax</code>にマッピングします。エラーバー付き散布図を立てに並べたい場合は<code>y</code>と<code>x</code>、<code>xmin</code>、<code>xmax</code>にマッピングします。</p>
<div class="cell" data-layout-align="center" data-hash="ggplot_intro4_cache/html/visual4-pointrage5_f3f4dceb1f1ded140aea99976b225f84">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1"></a>Pointrange_df <span class="sc">%&gt;%</span></span>
<span id="cb30-2"><a href="#cb30-2"></a>    <span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb30-3"><a href="#cb30-3"></a>    <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">0</span>, <span class="at">linetype =</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb30-4"><a href="#cb30-4"></a>    <span class="fu">geom_pointrange</span>(<span class="fu">aes</span>(<span class="at">x =</span> Continent, <span class="at">y =</span> Coef, </span>
<span id="cb30-5"><a href="#cb30-5"></a>                        <span class="at">ymin =</span> Conf_lwr, <span class="at">ymax =</span> Conf_upr),</span>
<span id="cb30-6"><a href="#cb30-6"></a>                    <span class="at">size =</span> <span class="fl">0.75</span>) <span class="sc">+</span></span>
<span id="cb30-7"><a href="#cb30-7"></a>    <span class="fu">labs</span>(<span class="at">y =</span> <span class="fu">expression</span>(<span class="fu">paste</span>(beta[<span class="dv">1</span>], <span class="st">" with 95% CI"</span>))) <span class="sc">+</span></span>
<span id="cb30-8"><a href="#cb30-8"></a>    <span class="fu">theme_bw</span>(<span class="at">base_size =</span> <span class="dv">12</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="ggplot_intro4_files/figure-html/visual4-pointrage5-1.png" class="img-fluid figure-img" width="2100"></p>
</figure>
</div>
</div>
</div>
<p>ここでもう一つの次元を追加することもあるでしょう。たとえば、複数のモデルを比較した場合がそうかもしれません。以下の<code>Pointrange_df2</code>について考えてみましょう。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1"></a>Pointrange_df2 <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb31-2"><a href="#cb31-2"></a>    <span class="at">Continent =</span> <span class="fu">rep</span>(<span class="fu">c</span>(<span class="st">"Asia"</span>, <span class="st">"Europe"</span>, <span class="st">"Africa"</span>, <span class="st">"America"</span>), <span class="at">each =</span> <span class="dv">2</span>),</span>
<span id="cb31-3"><a href="#cb31-3"></a>    <span class="at">Term      =</span> <span class="fu">rep</span>(<span class="fu">c</span>(<span class="st">"Civic Liverty"</span>, <span class="st">"Political Right"</span>), <span class="dv">4</span>),</span>
<span id="cb31-4"><a href="#cb31-4"></a>    <span class="at">Coef      =</span> <span class="fu">c</span>(<span class="fl">207.747</span>, <span class="fl">29.188</span>, <span class="fl">1050.164</span>, <span class="fl">1284.101</span>,</span>
<span id="cb31-5"><a href="#cb31-5"></a>                  <span class="fl">110.025</span>, <span class="fl">93.537</span>, <span class="fl">581.4593</span>, <span class="fl">646.9211</span>),</span>
<span id="cb31-6"><a href="#cb31-6"></a>    <span class="at">Conf_lwr  =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="fl">385.221</span>, <span class="sc">-</span><span class="fl">609.771</span>, <span class="fl">692.204</span>, <span class="fl">768.209</span>,</span>
<span id="cb31-7"><a href="#cb31-7"></a>                  <span class="sc">-</span><span class="fl">12.648</span>, <span class="sc">-</span><span class="fl">53.982</span>, <span class="fl">262.056</span>, <span class="fl">201.511</span>),</span>
<span id="cb31-8"><a href="#cb31-8"></a>    <span class="at">Conf_upr  =</span> <span class="fu">c</span>(<span class="fl">800.716</span>, <span class="fl">668.147</span>, <span class="fl">1408.125</span>, <span class="fl">1801.994</span>,</span>
<span id="cb31-9"><a href="#cb31-9"></a>                  <span class="fl">232.697</span>, <span class="fl">241.057</span>, <span class="fl">900.863</span>, <span class="fl">1092.331</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1"></a>Pointrange_df2</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 8 × 5
# Groups:   Continent [4]
  Continent Term              Coef Conf_lwr Conf_upr
  &lt;chr&gt;     &lt;chr&gt;            &lt;dbl&gt;    &lt;dbl&gt;    &lt;dbl&gt;
1 Asia      Civic Liberty    208.    -385.      801.
2 Asia      Political Right   29.2   -610.      668.
3 Europe    Civic Liberty   1050.     692.     1408.
4 Europe    Political Right 1285.     768.     1802.
5 Africa    Civic Liberty    110.     -12.6     233.
6 Africa    Political Right   93.5    -54.0     241.
7 America   Civic Liberty    581.     262.      901.
8 America   Political Right  647.     202.     1092.</code></pre>
</div>
</div>
<p>このデータは以下の2つのモデルを大陸ごとに推定した<span class="math inline">\(\beta_1\)</span>と<span class="math inline">\(\gamma_1\)</span>の点推定値と95%信頼区間です。</p>
<p><span class="math display">\[
\begin{aligned}
\text{PPP per capita} &amp; = \beta_0 + \beta_1 \cdot \text{FH}\_\text{CL} + \varepsilon \\
\text{PPP per capita} &amp; = \gamma_0 + \gamma_1 \cdot \text{FH}\_\text{PR} + \upsilon
\end{aligned}
\]</span></p>
<p>　どの説明変数を用いたかでエラーバーと点の色分けを行う場合、<code>color</code>に対して<code>Term</code>をマッピングします。</p>
<div class="cell" data-layout-align="center" data-hash="ggplot_intro4_cache/html/visual4-pointrage9_ad108dd63871a7d3da648bfd1ecc5a53">
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1"></a>Pointrange_df2 <span class="sc">%&gt;%</span></span>
<span id="cb34-2"><a href="#cb34-2"></a>    <span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb34-3"><a href="#cb34-3"></a>    <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">0</span>, <span class="at">linetype =</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb34-4"><a href="#cb34-4"></a>    <span class="fu">geom_pointrange</span>(<span class="fu">aes</span>(<span class="at">x =</span> Continent, <span class="at">y =</span> Coef, </span>
<span id="cb34-5"><a href="#cb34-5"></a>                        <span class="at">ymin =</span> Conf_lwr, <span class="at">ymax =</span> Conf_upr,</span>
<span id="cb34-6"><a href="#cb34-6"></a>                        <span class="at">color =</span> Term), <span class="at">size =</span> <span class="fl">0.75</span>) <span class="sc">+</span></span>
<span id="cb34-7"><a href="#cb34-7"></a>    <span class="fu">labs</span>(<span class="at">y =</span> <span class="fu">expression</span>(<span class="fu">paste</span>(beta[<span class="dv">1</span>], <span class="st">" and "</span>, gamma[<span class="dv">1</span>], <span class="st">" with 95% CI"</span>)),</span>
<span id="cb34-8"><a href="#cb34-8"></a>         <span class="at">color =</span> <span class="st">""</span>) <span class="sc">+</span></span>
<span id="cb34-9"><a href="#cb34-9"></a>    <span class="fu">theme_bw</span>(<span class="at">base_size =</span> <span class="dv">12</span>) <span class="sc">+</span></span>
<span id="cb34-10"><a href="#cb34-10"></a>    <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"bottom"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="ggplot_intro4_files/figure-html/visual4-pointrage9-1.png" class="img-fluid figure-img" width="2100"></p>
</figure>
</div>
</div>
</div>
<p>　何か違いますね。この2つのエラーバーと点の位置をずらす必要があるようです。これは3次元以上の棒グラフで使った<code>position</code>引数で調整可能です。今回は実引数として<code>position_dodge(0.5)</code>を指定してみましょう。</p>
<div class="cell" data-layout-align="center" data-hash="ggplot_intro4_cache/html/visual4-pointrage10_d7b7ad4bec84b97e8e38f0aaef5bd6cc">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1"></a>Pointrange_df2 <span class="sc">%&gt;%</span></span>
<span id="cb35-2"><a href="#cb35-2"></a>    <span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb35-3"><a href="#cb35-3"></a>    <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">0</span>, <span class="at">linetype =</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb35-4"><a href="#cb35-4"></a>    <span class="fu">geom_pointrange</span>(<span class="fu">aes</span>(<span class="at">x =</span> Continent, <span class="at">y =</span> Coef, </span>
<span id="cb35-5"><a href="#cb35-5"></a>                        <span class="at">ymin =</span> Conf_lwr, <span class="at">ymax =</span> Conf_upr,</span>
<span id="cb35-6"><a href="#cb35-6"></a>                        <span class="at">color =</span> Term),</span>
<span id="cb35-7"><a href="#cb35-7"></a>                    <span class="at">size =</span> <span class="fl">0.75</span>, <span class="at">position =</span> <span class="fu">position_dodge</span>(<span class="fl">0.5</span>)) <span class="sc">+</span></span>
<span id="cb35-8"><a href="#cb35-8"></a>    <span class="fu">labs</span>(<span class="at">y =</span> <span class="fu">expression</span>(<span class="fu">paste</span>(beta[<span class="dv">1</span>], <span class="st">" and "</span>, gamma[<span class="dv">1</span>], <span class="st">" with 95% CI"</span>)),</span>
<span id="cb35-9"><a href="#cb35-9"></a>         <span class="at">color =</span> <span class="st">""</span>) <span class="sc">+</span></span>
<span id="cb35-10"><a href="#cb35-10"></a>    <span class="fu">theme_bw</span>(<span class="at">base_size =</span> <span class="dv">12</span>) <span class="sc">+</span></span>
<span id="cb35-11"><a href="#cb35-11"></a>    <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"bottom"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="ggplot_intro4_files/figure-html/visual4-pointrage10-1.png" class="img-fluid figure-img" width="2100"></p>
</figure>
</div>
</div>
</div>
<p>　これで完成です。更に、<span class="math inline">\(\alpha = 0.05\)</span>水準で統計的に有意か否かを透明度で示し、透明度の凡例を非表示にしてみましょう。<span class="math inline">\(\alpha = 0.05\)</span>水準で統計的に有意か否かは95%信頼区間の上限と下限の積が0より大きいか否かで判定できます。<code>ggplot()</code>にデータを渡す前に統計的有意か否かを意味する<code>Sig</code>変数を作成し、<code>geom_pointrage()</code>の内部では<code>alpha</code>に<code>Sig</code>をマッピングします。</p>
<div class="cell" data-layout-align="center" data-hash="ggplot_intro4_cache/html/visual4-pointrage11_c8c19395664723c43d812fdb6044dd03">
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1"></a>Pointrange_df2 <span class="sc">%&gt;%</span></span>
<span id="cb36-2"><a href="#cb36-2"></a>    <span class="fu">mutate</span>(<span class="at">Sig =</span> <span class="fu">if_else</span>(Conf_lwr <span class="sc">*</span> Conf_upr <span class="sc">&gt;</span> <span class="dv">0</span>, </span>
<span id="cb36-3"><a href="#cb36-3"></a>                         <span class="st">"Significant"</span>, <span class="st">"Insignificant"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb36-4"><a href="#cb36-4"></a>    <span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb36-5"><a href="#cb36-5"></a>    <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">0</span>, <span class="at">linetype =</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb36-6"><a href="#cb36-6"></a>    <span class="fu">geom_pointrange</span>(<span class="fu">aes</span>(<span class="at">x =</span> Continent, <span class="at">y =</span> Coef, </span>
<span id="cb36-7"><a href="#cb36-7"></a>                        <span class="at">ymin =</span> Conf_lwr, <span class="at">ymax =</span> Conf_upr,</span>
<span id="cb36-8"><a href="#cb36-8"></a>                        <span class="at">color =</span> Term, <span class="at">alpha =</span> Sig),</span>
<span id="cb36-9"><a href="#cb36-9"></a>                    <span class="at">size =</span> <span class="fl">0.75</span>, <span class="at">position =</span> <span class="fu">position_dodge</span>(<span class="fl">0.5</span>)) <span class="sc">+</span></span>
<span id="cb36-10"><a href="#cb36-10"></a>    <span class="fu">labs</span>(<span class="at">y =</span> <span class="fu">expression</span>(<span class="fu">paste</span>(beta[<span class="dv">1</span>], <span class="st">" and "</span>, gamma[<span class="dv">1</span>], <span class="st">" with 95% CI"</span>)),</span>
<span id="cb36-11"><a href="#cb36-11"></a>         <span class="at">color =</span> <span class="st">""</span>) <span class="sc">+</span></span>
<span id="cb36-12"><a href="#cb36-12"></a>    <span class="fu">scale_alpha_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"Significant"</span> <span class="ot">=</span> <span class="dv">1</span>, <span class="st">"Insignificant"</span> <span class="ot">=</span> <span class="fl">0.35</span>)) <span class="sc">+</span></span>
<span id="cb36-13"><a href="#cb36-13"></a>    <span class="fu">guides</span>(<span class="at">alpha =</span> <span class="cn">FALSE</span>) <span class="sc">+</span></span>
<span id="cb36-14"><a href="#cb36-14"></a>    <span class="fu">theme_bw</span>(<span class="at">base_size =</span> <span class="dv">12</span>) <span class="sc">+</span></span>
<span id="cb36-15"><a href="#cb36-15"></a>    <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"bottom"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: `guides(&lt;scale&gt; = FALSE)` is deprecated. Please use `guides(&lt;scale&gt; =
"none")` instead.</code></pre>
</div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="ggplot_intro4_files/figure-html/visual4-pointrage11-1.png" class="img-fluid figure-img" width="2100"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="visual4-lollipop" class="level2">
<h2 class="anchored" data-anchor-id="visual4-lollipop">ロリーポップチャート</h2>
<p>　ロリーポップチャートは棒グラフの特殊な形態であり、棒がロリーポップ（チュッパチャップス）の形をしているものを指します。したがって、2つの図は本質的に同じですが、棒が多い場合はロリーポップチャートを使うケースがあります。棒が非常に多い棒グラフの場合、図を不適切に縮小すると<a href="https://ja.wikipedia.org/wiki/%E3%83%A2%E3%82%A2%E3%83%AC">モアレ</a>が生じるケースがあるからです。</p>
<p>　まず、<code>Country_df</code>を用い、ヨーロッパ諸国の一人当たりPPP GDP（<code>PPP_per_capita</code>）の棒グラフを作るとします。<code>PPP_per_capita</code>が欠損していないヨーロッパの国は46行であり、非常に棒が多い棒グラフになります。</p>
<div class="cell" data-layout-align="center" data-hash="ggplot_intro4_cache/html/visual4-lollipop1_3f6779f0e5e52e92a17508ca3f363598">
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1"></a>Country_df <span class="sc">%&gt;%</span></span>
<span id="cb38-2"><a href="#cb38-2"></a>  <span class="fu">filter</span>(Continent <span class="sc">==</span> <span class="st">"Europe"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb38-3"><a href="#cb38-3"></a>  <span class="fu">drop_na</span>(PPP_per_capita) <span class="sc">%&gt;%</span></span>
<span id="cb38-4"><a href="#cb38-4"></a>  <span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb38-5"><a href="#cb38-5"></a>  <span class="fu">geom_bar</span>(<span class="fu">aes</span>(<span class="at">y =</span> Country, <span class="at">x =</span> PPP_per_capita), <span class="at">stat =</span> <span class="st">"identity"</span>) <span class="sc">+</span></span>
<span id="cb38-6"><a href="#cb38-6"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"一人あたり購買力平価GDP"</span>, <span class="at">y =</span> <span class="st">"国"</span>) <span class="sc">+</span></span>
<span id="cb38-7"><a href="#cb38-7"></a>  <span class="fu">theme_bw</span>(<span class="at">base_size =</span> <span class="dv">12</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="ggplot_intro4_files/figure-html/visual4-lollipop1-1.png" class="img-fluid figure-img" width="2100"></p>
</figure>
</div>
</div>
</div>
<p>ここで登場するのがロリーポップチャートです。ロリーポップチャートの構成要素は棒とキャンディーの部分です。棒は線になるため<code>geom_segement()</code>を、キャンディーは散布図<code>geom_point()</code>を使います。散布図については既に<a href="../../tutorial/R/ggplot_intro2.html">基礎編</a>で説明しましたので、ここでは<code>geom_segment()</code>について説明します。</p>
<p>　<code>geom_segment()</code>は直線を引く幾何オブジェクトであり、線の起点（<code>x</code>と<code>y</code>）と終点（<code>xend</code>と<code>yend</code>）に対してマッピングをする必要があります。横軸上の起点は0、縦軸上の起点は<code>Country</code>です。そして横軸上の終点は<code>PPP_per_capita</code>、縦軸上のそれは<code>Country</code>です。縦軸上の起点と終点が同じということは水平線を引くことになります。</p>
<p>　<code>geom_segment()</code>で水平線を描いたら、次は散布図をオーバーラップさせます。点の横軸上の位置は<code>PPP_per_capita</code>、縦軸上の位置は<code>Country</code>です。</p>
<div class="cell" data-layout-align="center" data-hash="ggplot_intro4_cache/html/visual4-lollipop2_b5c6041f3c326ea08b6ae0a45495eb49">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1"></a>Country_df <span class="sc">%&gt;%</span></span>
<span id="cb39-2"><a href="#cb39-2"></a>  <span class="fu">filter</span>(Continent <span class="sc">==</span> <span class="st">"Europe"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb39-3"><a href="#cb39-3"></a>  <span class="fu">drop_na</span>(PPP_per_capita) <span class="sc">%&gt;%</span></span>
<span id="cb39-4"><a href="#cb39-4"></a>  <span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb39-5"><a href="#cb39-5"></a>  <span class="fu">geom_segment</span>(<span class="fu">aes</span>(<span class="at">y =</span> Country, <span class="at">yend =</span> Country,</span>
<span id="cb39-6"><a href="#cb39-6"></a>                   <span class="at">x =</span> <span class="dv">0</span>, <span class="at">xend =</span> PPP_per_capita)) <span class="sc">+</span></span>
<span id="cb39-7"><a href="#cb39-7"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">y =</span> Country, <span class="at">x =</span> PPP_per_capita), <span class="at">color =</span> <span class="st">"orange"</span>) <span class="sc">+</span></span>
<span id="cb39-8"><a href="#cb39-8"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"一人あたり購買力平価GDP (USD)"</span>, <span class="at">y =</span> <span class="st">"国"</span>) <span class="sc">+</span></span>
<span id="cb39-9"><a href="#cb39-9"></a>  <span class="fu">theme_bw</span>(<span class="at">base_size =</span> <span class="dv">12</span>) <span class="sc">+</span></span>
<span id="cb39-10"><a href="#cb39-10"></a>  <span class="fu">theme</span>(<span class="at">panel.grid.major.y =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb39-11"><a href="#cb39-11"></a>        <span class="at">panel.border =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb39-12"><a href="#cb39-12"></a>        <span class="at">axis.ticks.y =</span> <span class="fu">element_blank</span>())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="ggplot_intro4_files/figure-html/visual4-lollipop2-1.png" class="img-fluid figure-img" width="2100"></p>
</figure>
</div>
</div>
</div>
<p>　これで完成です。もし一人当たりPPP GDP順で並べ替えたい場合は<code>fct_reorder()</code>を使います。<code>Country</code>を<code>PPP_per_capita</code>の低い方を先にくるようにするなら、<code>fct_reorder(Country, PPP_per_capita)</code>です。縦に並ぶの棒グラフなら最初に来る水準が下に位置されます。もし、順番を逆にしたいなら、更に<code>fct_rev()</code>で水準の順番を逆転させます。</p>
<div class="cell" data-layout-align="center" data-hash="ggplot_intro4_cache/html/visual4-lollipop3_7bfbfb54ab339c822adf2c703e767361">
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1"></a>Country_df <span class="sc">%&gt;%</span></span>
<span id="cb40-2"><a href="#cb40-2"></a>  <span class="fu">filter</span>(Continent <span class="sc">==</span> <span class="st">"Europe"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb40-3"><a href="#cb40-3"></a>  <span class="fu">drop_na</span>(PPP_per_capita) <span class="sc">%&gt;%</span></span>
<span id="cb40-4"><a href="#cb40-4"></a>  <span class="fu">mutate</span>(<span class="at">Country =</span> <span class="fu">fct_reorder</span>(Country, PPP_per_capita)) <span class="sc">%&gt;%</span> </span>
<span id="cb40-5"><a href="#cb40-5"></a>  <span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb40-6"><a href="#cb40-6"></a>  <span class="fu">geom_segment</span>(<span class="fu">aes</span>(<span class="at">y =</span> Country, <span class="at">yend =</span> Country,</span>
<span id="cb40-7"><a href="#cb40-7"></a>                   <span class="at">x =</span> <span class="dv">0</span>, <span class="at">xend =</span> PPP_per_capita)) <span class="sc">+</span></span>
<span id="cb40-8"><a href="#cb40-8"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">y =</span> Country, <span class="at">x =</span> PPP_per_capita), <span class="at">color =</span> <span class="st">"orange"</span>) <span class="sc">+</span></span>
<span id="cb40-9"><a href="#cb40-9"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"一人あたり購買力平価GDP (USD)"</span>, <span class="at">y =</span> <span class="st">"国"</span>) <span class="sc">+</span></span>
<span id="cb40-10"><a href="#cb40-10"></a>  <span class="fu">theme_bw</span>(<span class="at">base_size =</span> <span class="dv">12</span>) <span class="sc">+</span></span>
<span id="cb40-11"><a href="#cb40-11"></a>  <span class="fu">theme</span>(<span class="at">panel.grid.major.y =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb40-12"><a href="#cb40-12"></a>        <span class="at">panel.border =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb40-13"><a href="#cb40-13"></a>        <span class="at">axis.ticks.y =</span> <span class="fu">element_blank</span>())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="ggplot_intro4_files/figure-html/visual4-lollipop3-1.png" class="img-fluid figure-img" width="2100"></p>
</figure>
</div>
</div>
</div>
<p>　ロリーポップロリーポップチャートで次元を追加するには点（キャンディー）の色分けが考えられます。たとえば、OECD加盟国か否かの次元を追加する場合、<code>geom_point()</code>において<code>color</code>をマッピングするだけです。</p>
<div class="cell" data-layout-align="center" data-hash="ggplot_intro4_cache/html/visual4-lollipop4_73d6688db4df55f7c92c549ef2b0d4fd">
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1"></a>Country_df <span class="sc">%&gt;%</span></span>
<span id="cb41-2"><a href="#cb41-2"></a>  <span class="fu">filter</span>(Continent <span class="sc">==</span> <span class="st">"Europe"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb41-3"><a href="#cb41-3"></a>  <span class="fu">drop_na</span>(PPP_per_capita) <span class="sc">%&gt;%</span></span>
<span id="cb41-4"><a href="#cb41-4"></a>  <span class="fu">mutate</span>(<span class="at">Country =</span> <span class="fu">fct_reorder</span>(Country, PPP_per_capita),</span>
<span id="cb41-5"><a href="#cb41-5"></a>         <span class="at">OECD    =</span> <span class="fu">if_else</span>(OECD <span class="sc">==</span> <span class="dv">1</span>, <span class="st">"OECD"</span>, <span class="st">"non-OECD"</span>),</span>
<span id="cb41-6"><a href="#cb41-6"></a>         <span class="at">OECD    =</span> <span class="fu">factor</span>(OECD, <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"OECD"</span>, <span class="st">"non-OECD"</span>))) <span class="sc">%&gt;%</span> </span>
<span id="cb41-7"><a href="#cb41-7"></a>  <span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb41-8"><a href="#cb41-8"></a>  <span class="fu">geom_segment</span>(<span class="fu">aes</span>(<span class="at">y =</span> Country, <span class="at">yend =</span> Country,</span>
<span id="cb41-9"><a href="#cb41-9"></a>                   <span class="at">x =</span> <span class="dv">0</span>, <span class="at">xend =</span> PPP_per_capita)) <span class="sc">+</span></span>
<span id="cb41-10"><a href="#cb41-10"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">y =</span> Country, <span class="at">x =</span> PPP_per_capita, <span class="at">color =</span> OECD)) <span class="sc">+</span></span>
<span id="cb41-11"><a href="#cb41-11"></a>  <span class="fu">scale_color_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"OECD"</span> <span class="ot">=</span> <span class="st">"orange"</span>, <span class="st">"non-OECD"</span> <span class="ot">=</span> <span class="st">"royalblue"</span>)) <span class="sc">+</span></span>
<span id="cb41-12"><a href="#cb41-12"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"一人あたり購買力平価GDP (USD)"</span>, <span class="at">y =</span> <span class="st">"国"</span>, <span class="at">color =</span> <span class="st">""</span>) <span class="sc">+</span></span>
<span id="cb41-13"><a href="#cb41-13"></a>  <span class="fu">theme_bw</span>(<span class="at">base_size =</span> <span class="dv">12</span>) <span class="sc">+</span></span>
<span id="cb41-14"><a href="#cb41-14"></a>  <span class="fu">theme</span>(<span class="at">panel.grid.major.y =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb41-15"><a href="#cb41-15"></a>        <span class="at">panel.border       =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb41-16"><a href="#cb41-16"></a>        <span class="at">axis.ticks.y       =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb41-17"><a href="#cb41-17"></a>        <span class="at">legend.position    =</span> <span class="st">"bottom"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="ggplot_intro4_files/figure-html/visual4-lollipop4-1.png" class="img-fluid figure-img" width="2100"></p>
</figure>
</div>
</div>
</div>
<p>　ファセット分割ももちろんできますが、この場合、OECD加盟国の一人当たりPPP GDPが相対的に高いことを示すなら、一つのファセットにまとめた方が良いでしょう。</p>
<p>　以下のようにロリーポップを横に並べることもできますが、棒の数が多いケースがほとんどであるロリーポップチャートではラベルの回転が必要になるため、読みにくくなるかも知れません。</p>
<div class="cell" data-layout-align="center" data-hash="ggplot_intro4_cache/html/visual4-lollipop5_542b4b1a3472aec14bafc7969d8502cd">
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb42-1"><a href="#cb42-1"></a>Country_df <span class="sc">%&gt;%</span></span>
<span id="cb42-2"><a href="#cb42-2"></a>  <span class="fu">filter</span>(Continent <span class="sc">==</span> <span class="st">"Europe"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb42-3"><a href="#cb42-3"></a>  <span class="fu">drop_na</span>(PPP_per_capita) <span class="sc">%&gt;%</span></span>
<span id="cb42-4"><a href="#cb42-4"></a>  <span class="fu">mutate</span>(<span class="at">Country =</span> <span class="fu">fct_reorder</span>(Country, PPP_per_capita),</span>
<span id="cb42-5"><a href="#cb42-5"></a>         <span class="at">Country =</span> <span class="fu">fct_rev</span>(Country)) <span class="sc">%&gt;%</span> </span>
<span id="cb42-6"><a href="#cb42-6"></a>  <span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb42-7"><a href="#cb42-7"></a>  <span class="fu">geom_segment</span>(<span class="fu">aes</span>(<span class="at">x =</span> Country, <span class="at">xend =</span> Country,</span>
<span id="cb42-8"><a href="#cb42-8"></a>                   <span class="at">y =</span> <span class="dv">0</span>, <span class="at">yend =</span> PPP_per_capita)) <span class="sc">+</span></span>
<span id="cb42-9"><a href="#cb42-9"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">x =</span> Country, <span class="at">y =</span> PPP_per_capita), <span class="at">color =</span> <span class="st">"orange"</span>) <span class="sc">+</span></span>
<span id="cb42-10"><a href="#cb42-10"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"国"</span>, <span class="at">y =</span> <span class="st">"一人あたり購買力平価GDP (USD)"</span>) <span class="sc">+</span></span>
<span id="cb42-11"><a href="#cb42-11"></a>  <span class="fu">theme_bw</span>(<span class="at">base_size =</span> <span class="dv">12</span>) <span class="sc">+</span></span>
<span id="cb42-12"><a href="#cb42-12"></a>  <span class="fu">theme</span>(<span class="at">panel.grid.major.y =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb42-13"><a href="#cb42-13"></a>        <span class="at">panel.border =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb42-14"><a href="#cb42-14"></a>        <span class="at">axis.ticks.y =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb42-15"><a href="#cb42-15"></a>        <span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">angle =</span> <span class="dv">90</span>, <span class="at">vjust =</span> <span class="fl">0.5</span>, <span class="at">hjust =</span> <span class="dv">1</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="ggplot_intro4_files/figure-html/visual4-lollipop5-1.png" class="img-fluid figure-img" width="2100"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="visual4-smooth" class="level2">
<h2 class="anchored" data-anchor-id="visual4-smooth">平滑化ライン</h2>
<p>2次元平面上に散布図をプロットし、二変数間の関係を一本の線で要約するのは平滑化ラインです。{ggplot2}では<code>geom_smooth()</code>幾何オブジェクトを重ねることで簡単に平滑化ラインをプロットすることができます。まずは、横軸をフリーダムハウス・スコア（<code>FH_Total</code>）、縦軸を一人当たり購買力平価GDP（<code>PPP_per_capita</code>）にした散布図を出力し、その上に平滑化ラインを追加してみましょう。<code>geom_smooth()</code>にもマッピングが必要で、<code>aes()</code>の内部に<code>x</code>と<code>y</code>をマッピングします。今回は<code>geom_point()</code>と<code>geom_smooth()</code>が同じマッピング情報を共有するため、<code>ggplot()</code>内部でマッピングします。</p>
<div class="cell" data-layout-align="center" data-hash="ggplot_intro4_cache/html/visual4-smooth1_ceb9191adbad9c1fbbd43a76a8364e36">
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1"></a>Country_df <span class="sc">%&gt;%</span></span>
<span id="cb43-2"><a href="#cb43-2"></a>    <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> FH_Total, <span class="at">y =</span> PPP_per_capita)) <span class="sc">+</span></span>
<span id="cb43-3"><a href="#cb43-3"></a>    <span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb43-4"><a href="#cb43-4"></a>    <span class="fu">geom_smooth</span>()  <span class="sc">+</span></span>
<span id="cb43-5"><a href="#cb43-5"></a>    <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Freedom House Score"</span>, <span class="at">y =</span> <span class="st">"PPP per capita (USD)"</span>) <span class="sc">+</span></span>
<span id="cb43-6"><a href="#cb43-6"></a>    <span class="fu">scale_y_continuous</span>(<span class="at">breaks =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">120000</span>, <span class="at">by =</span> <span class="dv">10000</span>),</span>
<span id="cb43-7"><a href="#cb43-7"></a>                       <span class="at">labels =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">120000</span>, <span class="at">by =</span> <span class="dv">10000</span>)) <span class="sc">+</span></span>
<span id="cb43-8"><a href="#cb43-8"></a>    <span class="fu">theme_minimal</span>(<span class="at">base_size =</span> <span class="dv">12</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="ggplot_intro4_files/figure-html/visual4-smooth1-1.png" class="img-fluid figure-img" width="2100"></p>
</figure>
</div>
</div>
</div>
<p>　青い線が平滑化ライン、網掛けの領域が95%信頼区間です。この線はLOESS (<strong>LO</strong>cal <strong>E</strong>stimated <strong>S</strong>catterplot <strong>S</strong>moothing)と呼ばれる非線形平滑化ラインです。どのようなラインを引くかは<code>method</code>引数で指定しますが、この<code>method</code>既定値が<code>"loess"</code>です。これを見るとフリーダムハウス・スコアが75以下の国では国の自由度と所得間の関係があまり見られませんが、75からは正の関係が確認できます。</p>
<p>　LOESS平滑化の場合、<code>span</code>引数を使って滑らかさを調整することができます。<code>span</code>の既定値は0.75ですが、これが小さいほど散布図によりフィットしたラインが引かれ、よりギザギザな線になります。たとえば、<code>span</code>を0.25にすると以下のようなグラフが得られます。</p>
<div class="cell" data-layout-align="center" data-hash="ggplot_intro4_cache/html/visual4-smooth2_b709a09f4cddb700a62fbc3c54fd3446">
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb44-1"><a href="#cb44-1"></a>Country_df <span class="sc">%&gt;%</span></span>
<span id="cb44-2"><a href="#cb44-2"></a>    <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> FH_Total, <span class="at">y =</span> PPP_per_capita)) <span class="sc">+</span></span>
<span id="cb44-3"><a href="#cb44-3"></a>    <span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb44-4"><a href="#cb44-4"></a>    <span class="fu">geom_smooth</span>(<span class="at">method =</span> <span class="st">"loess"</span>, <span class="at">span =</span> <span class="fl">0.25</span>)  <span class="sc">+</span></span>
<span id="cb44-5"><a href="#cb44-5"></a>    <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Freedom House Score"</span>, <span class="at">y =</span> <span class="st">"PPP per capita (USD)"</span>) <span class="sc">+</span></span>
<span id="cb44-6"><a href="#cb44-6"></a>    <span class="fu">scale_y_continuous</span>(<span class="at">breaks =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">120000</span>, <span class="at">by =</span> <span class="dv">10000</span>),</span>
<span id="cb44-7"><a href="#cb44-7"></a>                       <span class="at">labels =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">120000</span>, <span class="at">by =</span> <span class="dv">10000</span>)) <span class="sc">+</span></span>
<span id="cb44-8"><a href="#cb44-8"></a>    <span class="fu">theme_minimal</span>(<span class="at">base_size =</span> <span class="dv">12</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="ggplot_intro4_files/figure-html/visual4-smooth2-1.png" class="img-fluid figure-img" width="2100"></p>
</figure>
</div>
</div>
</div>
<p>　他にも定番の回帰直線を引くこともできます。<code>method</code>の実引数を<code>"lm"</code>に変えるだけです。</p>
<div class="cell" data-layout-align="center" data-hash="ggplot_intro4_cache/html/visual4-smooth3_8bed5dd548b711219da7a7bd7c1086f8">
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb45-1"><a href="#cb45-1"></a>Country_df <span class="sc">%&gt;%</span></span>
<span id="cb45-2"><a href="#cb45-2"></a>    <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> FH_Total, <span class="at">y =</span> PPP_per_capita)) <span class="sc">+</span></span>
<span id="cb45-3"><a href="#cb45-3"></a>    <span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb45-4"><a href="#cb45-4"></a>    <span class="fu">geom_smooth</span>(<span class="at">method =</span> <span class="st">"lm"</span>)  <span class="sc">+</span></span>
<span id="cb45-5"><a href="#cb45-5"></a>    <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Freedom House Score"</span>, <span class="at">y =</span> <span class="st">"PPP per capita (USD)"</span>) <span class="sc">+</span></span>
<span id="cb45-6"><a href="#cb45-6"></a>    <span class="fu">scale_y_continuous</span>(<span class="at">breaks =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">120000</span>, <span class="at">by =</span> <span class="dv">10000</span>),</span>
<span id="cb45-7"><a href="#cb45-7"></a>                       <span class="at">labels =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">120000</span>, <span class="at">by =</span> <span class="dv">10000</span>)) <span class="sc">+</span></span>
<span id="cb45-8"><a href="#cb45-8"></a>    <span class="fu">theme_minimal</span>(<span class="at">base_size =</span> <span class="dv">12</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="ggplot_intro4_files/figure-html/visual4-smooth3-1.png" class="img-fluid figure-img" width="2100"></p>
</figure>
</div>
</div>
</div>
<p>　信頼区間は既定値だと95%信頼区間が表示されますが、<code>level</code>引数で調整することができます。たとえば、99.9%信頼区間を表示したい場合、<code>level = 0.999</code>を指定します。</p>
<div class="cell" data-layout-align="center" data-hash="ggplot_intro4_cache/html/visual4-smooth4_d21288bf49e9bd640d31eaa6ab6d27e6">
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb46-1"><a href="#cb46-1"></a>Country_df <span class="sc">%&gt;%</span></span>
<span id="cb46-2"><a href="#cb46-2"></a>    <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> FH_Total, <span class="at">y =</span> PPP_per_capita)) <span class="sc">+</span></span>
<span id="cb46-3"><a href="#cb46-3"></a>    <span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb46-4"><a href="#cb46-4"></a>    <span class="fu">geom_smooth</span>(<span class="at">method =</span> <span class="st">"lm"</span>, <span class="at">level =</span> <span class="fl">0.999</span>)  <span class="sc">+</span></span>
<span id="cb46-5"><a href="#cb46-5"></a>    <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Freedom House Score"</span>, <span class="at">y =</span> <span class="st">"PPP per capita (USD)"</span>) <span class="sc">+</span></span>
<span id="cb46-6"><a href="#cb46-6"></a>    <span class="fu">scale_y_continuous</span>(<span class="at">breaks =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">120000</span>, <span class="at">by =</span> <span class="dv">10000</span>),</span>
<span id="cb46-7"><a href="#cb46-7"></a>                       <span class="at">labels =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">120000</span>, <span class="at">by =</span> <span class="dv">10000</span>)) <span class="sc">+</span></span>
<span id="cb46-8"><a href="#cb46-8"></a>    <span class="fu">theme_minimal</span>(<span class="at">base_size =</span> <span class="dv">12</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="ggplot_intro4_files/figure-html/visual4-smooth4-1.png" class="img-fluid figure-img" width="2100"></p>
</figure>
</div>
</div>
</div>
<p>　信頼区間を消したい場合は<code>se = FALSE</code>を指定します（既定値は<code>TRUE</code>）。</p>
<div class="cell" data-layout-align="center" data-hash="ggplot_intro4_cache/html/visual4-smooth5_cb384e5b4dadc616754c2638b8a3e748">
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb47-1"><a href="#cb47-1"></a>Country_df <span class="sc">%&gt;%</span></span>
<span id="cb47-2"><a href="#cb47-2"></a>    <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> FH_Total, <span class="at">y =</span> PPP_per_capita)) <span class="sc">+</span></span>
<span id="cb47-3"><a href="#cb47-3"></a>    <span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb47-4"><a href="#cb47-4"></a>    <span class="fu">geom_smooth</span>(<span class="at">method =</span> <span class="st">"lm"</span>, <span class="at">se =</span> <span class="cn">FALSE</span>)  <span class="sc">+</span></span>
<span id="cb47-5"><a href="#cb47-5"></a>    <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Freedom House Score"</span>, <span class="at">y =</span> <span class="st">"PPP per capita (USD)"</span>) <span class="sc">+</span></span>
<span id="cb47-6"><a href="#cb47-6"></a>    <span class="fu">scale_y_continuous</span>(<span class="at">breaks =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">120000</span>, <span class="at">by =</span> <span class="dv">10000</span>),</span>
<span id="cb47-7"><a href="#cb47-7"></a>                       <span class="at">labels =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">120000</span>, <span class="at">by =</span> <span class="dv">10000</span>)) <span class="sc">+</span></span>
<span id="cb47-8"><a href="#cb47-8"></a>    <span class="fu">theme_minimal</span>(<span class="at">base_size =</span> <span class="dv">12</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="ggplot_intro4_files/figure-html/visual4-smooth5-1.png" class="img-fluid figure-img" width="2100"></p>
</figure>
</div>
</div>
</div>
<p>　最後にデータのサブセットごとに回帰直線を引く方法について説明します。散布図で色分けを行う場合、<code>aes()</code>内で<code>color</code>引数を指定しますが、これだけで十分です。今回はこれまでの散布図をOECD加盟有無ごとに色分けし、それぞれ別の回帰直線を重ねてみましょう。回帰直線も色分けしたいので<code>color</code>引数で次元を増やす必要があり、これは<code>geom_point()</code>と共通であるため、<code>ggplot()</code>内でマッピングします。</p>
<div class="cell" data-layout-align="center" data-hash="ggplot_intro4_cache/html/visual4-smooth6_01b8b0ad1646c269f3162156cf97a710">
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb48-1"><a href="#cb48-1"></a>Country_df <span class="sc">%&gt;%</span></span>
<span id="cb48-2"><a href="#cb48-2"></a>    <span class="fu">mutate</span>(<span class="at">OECD =</span> <span class="fu">if_else</span>(OECD <span class="sc">==</span> <span class="dv">1</span>, <span class="st">"加盟国"</span>, <span class="st">"非加盟国"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb48-3"><a href="#cb48-3"></a>    <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> FH_Total, <span class="at">y =</span> PPP_per_capita, <span class="at">color =</span> OECD)) <span class="sc">+</span></span>
<span id="cb48-4"><a href="#cb48-4"></a>    <span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb48-5"><a href="#cb48-5"></a>    <span class="fu">geom_smooth</span>(<span class="at">method =</span> <span class="st">"lm"</span>)  <span class="sc">+</span></span>
<span id="cb48-6"><a href="#cb48-6"></a>    <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Freedom House Score"</span>, <span class="at">y =</span> <span class="st">"PPP per capita (USD)"</span>) <span class="sc">+</span></span>
<span id="cb48-7"><a href="#cb48-7"></a>    <span class="fu">scale_y_continuous</span>(<span class="at">breaks =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">120000</span>, <span class="at">by =</span> <span class="dv">10000</span>),</span>
<span id="cb48-8"><a href="#cb48-8"></a>                       <span class="at">labels =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">120000</span>, <span class="at">by =</span> <span class="dv">10000</span>)) <span class="sc">+</span></span>
<span id="cb48-9"><a href="#cb48-9"></a>    <span class="fu">coord_cartesian</span>(<span class="at">ylim =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">120000</span>)) <span class="sc">+</span></span>
<span id="cb48-10"><a href="#cb48-10"></a>    <span class="fu">theme_bw</span>(<span class="at">base_size =</span> <span class="dv">12</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="ggplot_intro4_files/figure-html/visual4-smooth6-1.png" class="img-fluid figure-img" width="2100"></p>
</figure>
</div>
</div>
</div>
<p>　これを見ると、国の自由度と所得の間に関係が見られるのはOECD加盟国で、非加盟国では非常に関係が弱いことが分かります。</p>
<p>　あまりいい方法ではないと思いますが、散布図は色（<code>color</code>）で分け、回帰直線は線の種類（<code>linetype</code>）で分けるならどうすれば良いでしょうか。この場合は<code>color</code>は<code>geom_point()</code>内部で、<code>linetype</code>は<code>geom_smooth()</code>でマッピングします。</p>
<div class="cell" data-layout-align="center" data-hash="ggplot_intro4_cache/html/visual4-smooth7_3c531d1ade1cc9c1789d69234c3a732c">
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb49-1"><a href="#cb49-1"></a>Country_df <span class="sc">%&gt;%</span></span>
<span id="cb49-2"><a href="#cb49-2"></a>    <span class="fu">mutate</span>(<span class="at">OECD =</span> <span class="fu">if_else</span>(OECD <span class="sc">==</span> <span class="dv">1</span>, <span class="st">"加盟国"</span>, <span class="st">"非加盟国"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb49-3"><a href="#cb49-3"></a>    <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> FH_Total, <span class="at">y =</span> PPP_per_capita)) <span class="sc">+</span></span>
<span id="cb49-4"><a href="#cb49-4"></a>    <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">color =</span> OECD)) <span class="sc">+</span></span>
<span id="cb49-5"><a href="#cb49-5"></a>    <span class="fu">geom_smooth</span>(<span class="fu">aes</span>(<span class="at">linetype =</span> OECD), <span class="at">method =</span> <span class="st">"lm"</span>, <span class="at">color =</span> <span class="st">"black"</span>)  <span class="sc">+</span></span>
<span id="cb49-6"><a href="#cb49-6"></a>    <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Freedom House Score"</span>, <span class="at">y =</span> <span class="st">"PPP per capita (USD)"</span>) <span class="sc">+</span></span>
<span id="cb49-7"><a href="#cb49-7"></a>    <span class="fu">scale_y_continuous</span>(<span class="at">breaks =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">120000</span>, <span class="at">by =</span> <span class="dv">10000</span>),</span>
<span id="cb49-8"><a href="#cb49-8"></a>                       <span class="at">labels =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">120000</span>, <span class="at">by =</span> <span class="dv">10000</span>)) <span class="sc">+</span></span>
<span id="cb49-9"><a href="#cb49-9"></a>    <span class="fu">coord_cartesian</span>(<span class="at">ylim =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">120000</span>)) <span class="sc">+</span></span>
<span id="cb49-10"><a href="#cb49-10"></a>    <span class="fu">theme_bw</span>(<span class="at">base_size =</span> <span class="dv">12</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="ggplot_intro4_files/figure-html/visual4-smooth7-1.png" class="img-fluid figure-img" width="2100"></p>
</figure>
</div>
</div>
</div>
<p>　{ggplot2}が提供する平滑化ラインにはLOESSと回帰直線以外にも<code>"glm"</code>や<code>"gam"</code>などがります。詳細はRコンソール上で<code>?geom_smooth</code>を入力し、ヘルプを参照してください。</p>
</section>
<section id="visual4-text" class="level2">
<h2 class="anchored" data-anchor-id="visual4-text">文字列の出力</h2>
<p><code>geom_text()</code>: マッピングされた<code>x</code>と<code>y</code>の箇所に文字列を付ける</p>
<div class="cell" data-layout-align="center" data-hash="ggplot_intro4_cache/html/visual4-text-1_98fa74f1f4d3733db324d5e6886b4e56">
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb50-1"><a href="#cb50-1"></a>bar_plot <span class="ot">&lt;-</span> Country_df <span class="sc">%&gt;%</span></span>
<span id="cb50-2"><a href="#cb50-2"></a>  <span class="fu">group_by</span>(Continent) <span class="sc">%&gt;%</span></span>
<span id="cb50-3"><a href="#cb50-3"></a>  <span class="fu">summarise</span>(<span class="at">HDI =</span> <span class="fu">mean</span>(HDI_2018, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb50-4"><a href="#cb50-4"></a>  <span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb50-5"><a href="#cb50-5"></a>  <span class="fu">geom_bar</span>(<span class="fu">aes</span>(<span class="at">x =</span> Continent, <span class="at">y =</span> HDI), <span class="at">stat =</span> <span class="st">"identity"</span>) <span class="sc">+</span></span>
<span id="cb50-6"><a href="#cb50-6"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Continent"</span>, <span class="at">y =</span> <span class="st">"Mean of</span><span class="sc">\n</span><span class="st">Human Development Index (2018)"</span>) <span class="sc">+</span></span>
<span id="cb50-7"><a href="#cb50-7"></a>  <span class="fu">theme_minimal</span>(<span class="at">base_size =</span> <span class="dv">12</span>)</span>
<span id="cb50-8"><a href="#cb50-8"></a></span>
<span id="cb50-9"><a href="#cb50-9"></a>bar_plot <span class="sc">+</span></span>
<span id="cb50-10"><a href="#cb50-10"></a>  <span class="fu">geom_text</span>(<span class="fu">aes</span>(<span class="at">x =</span> Continent, <span class="at">y =</span> HDI, <span class="at">label =</span> HDI),</span>
<span id="cb50-11"><a href="#cb50-11"></a>            <span class="at">size =</span> <span class="dv">4</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="ggplot_intro4_files/figure-html/visual4-text-1-1.png" class="img-fluid figure-img" width="2100"></p>
</figure>
</div>
</div>
</div>
<p>文字の位置をやや高めにし、平均値の小数点を3桁に丸める。</p>
<p>ただし、<code>round()</code>を使う場合、<code>round(1.1298, 3)</code>は1.13と出力される。もし、1.130のように出力したい場合は<code>round()</code>の代わりに<code>sprintf()</code>を使用する。今回の例の場合、<code>sprintf("%.3f", 1.1298)</code>のように書く。</p>
<div class="cell" data-layout-align="center" data-hash="ggplot_intro4_cache/html/visual4-text-2_e77ee973e5304714ada209e38839bd8e">
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb51-1"><a href="#cb51-1"></a>bar_plot <span class="sc">+</span></span>
<span id="cb51-2"><a href="#cb51-2"></a>  <span class="fu">geom_text</span>(<span class="fu">aes</span>(<span class="at">x =</span> Continent, <span class="at">y =</span> HDI <span class="sc">+</span> <span class="fl">0.03</span>, <span class="at">label =</span> <span class="fu">round</span>(HDI, <span class="dv">3</span>)),</span>
<span id="cb51-3"><a href="#cb51-3"></a>            <span class="at">size =</span> <span class="dv">4</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="ggplot_intro4_files/figure-html/visual4-text-2-1.png" class="img-fluid figure-img" width="2100"></p>
</figure>
</div>
</div>
</div>
<p><code>geom_label()</code>: マッピングされた<code>x</code>と<code>y</code>の箇所にラベルを付ける</p>
<div class="cell" data-layout-align="center" data-hash="ggplot_intro4_cache/html/visual4-text-3_b681188bfac5abbc7bf7c254d95ea4fc">
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb52-1"><a href="#cb52-1"></a>bar_plot <span class="sc">+</span></span>
<span id="cb52-2"><a href="#cb52-2"></a>  <span class="fu">geom_label</span>(<span class="fu">aes</span>(<span class="at">x =</span> Continent, <span class="at">y =</span> HDI, <span class="at">label =</span> <span class="fu">round</span>(HDI, <span class="dv">3</span>)),</span>
<span id="cb52-3"><a href="#cb52-3"></a>             <span class="at">size =</span> <span class="dv">4</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="ggplot_intro4_files/figure-html/visual4-text-3-1.png" class="img-fluid figure-img" width="2100"></p>
</figure>
</div>
</div>
</div>
<p><code>annotate()</code>: 任意の箇所に文字列 or ラベルを追加</p>
<p><code>"text"</code>の代わりに<code>"label"</code>をすると、ラベル形式になる。</p>
<div class="cell" data-layout-align="center" data-hash="ggplot_intro4_cache/html/visual4-text-4_818359b7515d38f605ca0cd529877d44">
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb53-1"><a href="#cb53-1"></a>lm_plot <span class="ot">&lt;-</span> Country_df <span class="sc">%&gt;%</span></span>
<span id="cb53-2"><a href="#cb53-2"></a>    <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> FH_Total, <span class="at">y =</span> PPP_per_capita)) <span class="sc">+</span></span>
<span id="cb53-3"><a href="#cb53-3"></a>    <span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb53-4"><a href="#cb53-4"></a>    <span class="fu">geom_smooth</span>(<span class="at">method =</span> <span class="st">"lm"</span>, <span class="at">level =</span> <span class="fl">0.999</span>)  <span class="sc">+</span></span>
<span id="cb53-5"><a href="#cb53-5"></a>    <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Freedom House Score"</span>, <span class="at">y =</span> <span class="st">"PPP per capita (USD)"</span>) <span class="sc">+</span></span>
<span id="cb53-6"><a href="#cb53-6"></a>    <span class="fu">scale_y_continuous</span>(<span class="at">breaks =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">120000</span>, <span class="at">by =</span> <span class="dv">10000</span>),</span>
<span id="cb53-7"><a href="#cb53-7"></a>                       <span class="at">labels =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">120000</span>, <span class="at">by =</span> <span class="dv">10000</span>)) <span class="sc">+</span></span>
<span id="cb53-8"><a href="#cb53-8"></a>    <span class="fu">theme_minimal</span>(<span class="at">base_size =</span> <span class="dv">12</span>)</span>
<span id="cb53-9"><a href="#cb53-9"></a></span>
<span id="cb53-10"><a href="#cb53-10"></a>lm_plot <span class="sc">+</span></span>
<span id="cb53-11"><a href="#cb53-11"></a>  <span class="fu">annotate</span>(<span class="st">"text"</span>, <span class="at">x =</span> <span class="dv">0</span>, <span class="at">y =</span> <span class="dv">110000</span>, <span class="at">label =</span> <span class="st">"注: 青い線は回帰直線を表す。"</span>, </span>
<span id="cb53-12"><a href="#cb53-12"></a>           <span class="at">hjust =</span> <span class="dv">0</span>, <span class="at">size =</span> <span class="dv">5</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="ggplot_intro4_files/figure-html/visual4-text-4-1.png" class="img-fluid figure-img" width="2100"></p>
</figure>
</div>
</div>
</div>
<p>数式: {latex2exp}</p>
<p>LaTeXの数式表記をほぼそのまま使えるが、<code>\</code>は<code>\\</code>に置換すること。</p>
<div class="cell" data-layout-align="center" data-hash="ggplot_intro4_cache/html/visual4-text-5_191b4ee19dd201cd9623b3e3580f3c92">
<div class="sourceCode cell-code" id="cb54"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb54-1"><a href="#cb54-1"></a>pacman<span class="sc">::</span><span class="fu">p_load</span>(latex2exp)</span>
<span id="cb54-2"><a href="#cb54-2"></a></span>
<span id="cb54-3"><a href="#cb54-3"></a>lm_plot <span class="sc">+</span></span>
<span id="cb54-4"><a href="#cb54-4"></a>  <span class="fu">annotate</span>(<span class="st">"text"</span>, <span class="at">x =</span> <span class="dv">0</span>, <span class="at">y =</span> <span class="dv">110000</span>, </span>
<span id="cb54-5"><a href="#cb54-5"></a>           <span class="at">label =</span> <span class="fu">TeX</span>(<span class="st">"$PPP</span><span class="sc">\\</span><span class="st">_per</span><span class="sc">\\</span><span class="st">_capita = </span><span class="sc">\\</span><span class="st">alpha + </span><span class="sc">\\</span><span class="st">beta </span><span class="sc">\\</span><span class="st">cdot Freedom</span><span class="sc">\\</span><span class="st">_House</span><span class="sc">\\</span><span class="st">_Score + </span><span class="sc">\\</span><span class="st">epsilon </span><span class="sc">\\</span><span class="st"> where </span><span class="sc">\\</span><span class="st"> </span><span class="sc">\\</span><span class="st">epsilon </span><span class="sc">\\</span><span class="st">sim Normal(0, </span><span class="sc">\\</span><span class="st">sigma).$"</span>), </span>
<span id="cb54-6"><a href="#cb54-6"></a>           <span class="at">hjust =</span> <span class="dv">0</span>, <span class="at">size =</span> <span class="dv">5</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="ggplot_intro4_files/figure-html/visual4-text-5-1.png" class="img-fluid figure-img" width="2100"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="visual4-heatmap" class="level2">
<h2 class="anchored" data-anchor-id="visual4-heatmap">ヒートマップ</h2>
<section id="つの離散変数の分布を表すヒートマップ" class="level3">
<h3 class="anchored" data-anchor-id="つの離散変数の分布を表すヒートマップ">2つの離散変数の分布を表すヒートマップ</h3>
<p>　ヒートマップ（heat map）には2つの使い方があります。まずは、離散変数<span class="math inline">\(\times\)</span>離散変数の同時分布を示す時です。これは後ほど紹介するモザイク・プロットと目的は同じですが、モザイク・プロットはセルの<strong>面積</strong>で密度や度数を表すに対し、ヒートマップは主に<strong>色</strong>で密度や度数を表します。</p>
<p>　ここでは一人当たり購買力平価GDP（<code>PPP_per_capita</code>）を「1万ドル未満」、「1万ドル以上・2万ドル未満」、「2万ドル以上、3万ドル未満」、「3万ドル以上」の離散変数に変換し、大陸ごとの国家数をヒートマップとして示してみたいと思います。まずは、変数のリコーディングをし、全てfactor化します。最後に国家名（<code>Country</code>）、大陸（<code>Continent</code>）、所得（<code>Income</code>）、フリーダム・ハウス・スコア（<code>FH_Total</code>）、人間開発指数（<code>HDI_2018</code>）列のみ抽出し、<code>Heatmap_df</code>という名のオブジェクトとして格納しておきます。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb55-1"><a href="#cb55-1"></a>Heatmap_df <span class="ot">&lt;-</span> Country_df <span class="sc">%&gt;%</span></span>
<span id="cb55-2"><a href="#cb55-2"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(PPP_per_capita)) <span class="sc">%&gt;%</span></span>
<span id="cb55-3"><a href="#cb55-3"></a>  <span class="fu">mutate</span>(<span class="at">Continent =</span> <span class="fu">recode</span>(Continent,</span>
<span id="cb55-4"><a href="#cb55-4"></a>                            <span class="st">"Africa"</span>  <span class="ot">=</span> <span class="st">"アフリカ"</span>,</span>
<span id="cb55-5"><a href="#cb55-5"></a>                            <span class="st">"America"</span> <span class="ot">=</span> <span class="st">"アメリカ"</span>,</span>
<span id="cb55-6"><a href="#cb55-6"></a>                            <span class="st">"Asia"</span>    <span class="ot">=</span> <span class="st">"アジア"</span>,</span>
<span id="cb55-7"><a href="#cb55-7"></a>                            <span class="st">"Europe"</span>  <span class="ot">=</span> <span class="st">"ヨーロッパ"</span>,</span>
<span id="cb55-8"><a href="#cb55-8"></a>                            <span class="at">.default  =</span> <span class="st">"オセアニア"</span>),</span>
<span id="cb55-9"><a href="#cb55-9"></a>         <span class="at">Continent =</span> <span class="fu">factor</span>(Continent, <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"アフリカ"</span>, <span class="st">"アメリカ"</span>, <span class="st">"アジア"</span>, </span>
<span id="cb55-10"><a href="#cb55-10"></a>                                                  <span class="st">"ヨーロッパ"</span>, <span class="st">"オセアニア"</span>)),</span>
<span id="cb55-11"><a href="#cb55-11"></a>         <span class="at">Income    =</span> <span class="fu">case_when</span>(PPP_per_capita <span class="sc">&lt;</span> <span class="dv">10000</span> <span class="sc">~</span> <span class="st">"1万ドル未満"</span>,</span>
<span id="cb55-12"><a href="#cb55-12"></a>                               PPP_per_capita <span class="sc">&lt;</span> <span class="dv">20000</span> <span class="sc">~</span> <span class="st">"1万ドル以上</span><span class="sc">\n</span><span class="st">2万ドル未満"</span>,</span>
<span id="cb55-13"><a href="#cb55-13"></a>                               PPP_per_capita <span class="sc">&lt;</span> <span class="dv">30000</span> <span class="sc">~</span> <span class="st">"2万ドル以上</span><span class="sc">\n</span><span class="st">3万ドル未満"</span>,</span>
<span id="cb55-14"><a href="#cb55-14"></a>                               <span class="cn">TRUE</span>                   <span class="sc">~</span> <span class="st">"3万ドル以上"</span>),</span>
<span id="cb55-15"><a href="#cb55-15"></a>         <span class="at">Income    =</span> <span class="fu">factor</span>(Income, <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"1万ドル未満"</span>, <span class="st">"1万ドル以上</span><span class="sc">\n</span><span class="st">2万ドル未満"</span>,</span>
<span id="cb55-16"><a href="#cb55-16"></a>                                               <span class="st">"2万ドル以上</span><span class="sc">\n</span><span class="st">3万ドル未満"</span>, <span class="st">"3万ドル以上"</span>))) <span class="sc">%&gt;%</span></span>
<span id="cb55-17"><a href="#cb55-17"></a>  <span class="fu">select</span>(Country, Continent, Income, FH_Total, HDI_2018)</span>
<span id="cb55-18"><a href="#cb55-18"></a></span>
<span id="cb55-19"><a href="#cb55-19"></a>Heatmap_df</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 178 × 5
   Country             Continent  Income                     FH_Total HDI_2018
   &lt;chr&gt;               &lt;fct&gt;      &lt;fct&gt;                         &lt;dbl&gt;    &lt;dbl&gt;
 1 Afghanistan         アジア     "1万ドル未満"                    27    0.496
 2 Albania             ヨーロッパ "1万ドル以上\n2万ドル未満"       67    0.791
 3 Algeria             アフリカ   "1万ドル以上\n2万ドル未満"       34    0.759
 4 Angola              アフリカ   "1万ドル未満"                    32    0.574
 5 Antigua and Barbuda アメリカ   "2万ドル以上\n3万ドル未満"       85    0.776
 6 Argentina           アメリカ   "2万ドル以上\n3万ドル未満"       85    0.83 
 7 Armenia             ヨーロッパ "1万ドル以上\n2万ドル未満"       53    0.76 
 8 Australia           オセアニア "3万ドル以上"                    97    0.938
 9 Austria             ヨーロッパ "3万ドル以上"                    93    0.914
10 Azerbaijan          ヨーロッパ "1万ドル以上\n2万ドル未満"       10    0.754
# ℹ 168 more rows</code></pre>
</div>
</div>
<p>　次は<code>group_by()</code>と<code>summarise()</code>を使って、各カテゴリーに属するケース数を計算し、<code>N</code>という名の列として追加します。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb57"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb57-1"><a href="#cb57-1"></a>Heatmap_df1 <span class="ot">&lt;-</span> Heatmap_df <span class="sc">%&gt;%</span></span>
<span id="cb57-2"><a href="#cb57-2"></a>  <span class="fu">group_by</span>(Continent, Income) <span class="sc">%&gt;%</span></span>
<span id="cb57-3"><a href="#cb57-3"></a>  <span class="fu">summarise</span>(<span class="at">N       =</span> <span class="fu">n</span>(),</span>
<span id="cb57-4"><a href="#cb57-4"></a>            <span class="at">.groups =</span> <span class="st">"drop"</span>)</span>
<span id="cb57-5"><a href="#cb57-5"></a></span>
<span id="cb57-6"><a href="#cb57-6"></a>Heatmap_df1</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 18 × 3
   Continent  Income                         N
   &lt;fct&gt;      &lt;fct&gt;                      &lt;int&gt;
 1 アフリカ   "1万ドル未満"                 41
 2 アフリカ   "1万ドル以上\n2万ドル未満"     9
 3 アフリカ   "2万ドル以上\n3万ドル未満"     2
 4 アメリカ   "1万ドル未満"                 10
 5 アメリカ   "1万ドル以上\n2万ドル未満"    14
 6 アメリカ   "2万ドル以上\n3万ドル未満"     6
 7 アメリカ   "3万ドル以上"                  5
 8 アジア     "1万ドル未満"                 17
 9 アジア     "1万ドル以上\n2万ドル未満"    10
10 アジア     "2万ドル以上\n3万ドル未満"     3
11 アジア     "3万ドル以上"                 11
12 ヨーロッパ "1万ドル未満"                  1
13 ヨーロッパ "1万ドル以上\n2万ドル未満"    10
14 ヨーロッパ "2万ドル以上\n3万ドル未満"     7
15 ヨーロッパ "3万ドル以上"                 28
16 オセアニア "1万ドル未満"                  1
17 オセアニア "1万ドル以上\n2万ドル未満"     1
18 オセアニア "3万ドル以上"                  2</code></pre>
</div>
</div>
<p>　これでデータの準備は終わりました。ヒートマップを作成する幾何オブジェクトは<code>geom_tile()</code>です。同時分布を示したい変数を、それぞれ<code>x</code>と<code>y</code>にマッピングし、密度、または度数を表す変数を<code>fill</code>にマッピングします。ここでは横軸を大陸（<code>Continent</code>）、縦軸を一人当たり購買力平価GDP（<code>Income</code>）とし、<code>fill</code>には<code>N</code>変数をマッピングします。</p>
<div class="cell" data-layout-align="center" data-hash="ggplot_intro4_cache/html/visual4-heatmap3_fbaa47da2f8bc7fc34c1eb7b8c24a4cb">
<div class="sourceCode cell-code" id="cb59"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb59-1"><a href="#cb59-1"></a>Heatmap_df1 <span class="sc">%&gt;%</span></span>
<span id="cb59-2"><a href="#cb59-2"></a>  <span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb59-3"><a href="#cb59-3"></a>  <span class="fu">geom_tile</span>(<span class="fu">aes</span>(<span class="at">x =</span> Continent, <span class="at">y =</span> Income, <span class="at">fill =</span> N)) <span class="sc">+</span></span>
<span id="cb59-4"><a href="#cb59-4"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"大陸"</span>, <span class="at">y =</span> <span class="st">"一人当たり購買力平価GDP（ドル）"</span>, <span class="at">fill =</span> <span class="st">"国家数"</span>) <span class="sc">+</span></span>
<span id="cb59-5"><a href="#cb59-5"></a>  <span class="fu">theme_bw</span>(<span class="at">base_size =</span> <span class="dv">12</span>) <span class="sc">+</span></span>
<span id="cb59-6"><a href="#cb59-6"></a>  <span class="fu">theme</span>(<span class="at">panel.grid =</span> <span class="fu">element_blank</span>()) <span class="co"># グリッドラインを消す</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="ggplot_intro4_files/figure-html/visual4-heatmap3-1.png" class="img-fluid figure-img" width="2100"></p>
</figure>
</div>
</div>
</div>
<p>　明るいほどカテゴリーに属するケースが多く、暗いほど少ないことを意味します。これを見ると世界で最も多くの割合を占めているのは、一人当たり購買力平価GDPが1万ドル未満のアフリカの国で、次は一人当たり購買力平価GDPが3万ドル以上のヨーロッパの国であることが分かります。欠損している（ケース数が0）セルは白の空白となります。</p>
<p>　色をカスタマイズするには<code>scale_fill_gradient()</code>です。これは<a href="../../tutorial/R/ggplot_intro3.html">応用編</a>で紹介しました<code>scale_color_gradient()</code>と使い方は同じです。<code>scale_fill_gradient()</code>は中間点なし、<code>scale_fill_gradient2()</code>は中間点ありの場合に使いますが、ここでは度数が小さい場合は<span style="color:#FFF8DC;font-weight:bold;">cornsilk</span>色を、大きい場合は<span style="color:#cd3333;font-weight:bold;">brown3</span>色を使います。それぞれ<code>low</code>と<code>high</code>に色を指定するだけです。</p>
<div class="cell" data-layout-align="center" data-hash="ggplot_intro4_cache/html/visual4-heatmap4_7ba8c77a4ef8bf219f2209d23cc15109">
<div class="sourceCode cell-code" id="cb60"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb60-1"><a href="#cb60-1"></a>Heatmap_df1 <span class="sc">%&gt;%</span></span>
<span id="cb60-2"><a href="#cb60-2"></a>  <span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb60-3"><a href="#cb60-3"></a>  <span class="fu">geom_tile</span>(<span class="fu">aes</span>(<span class="at">x =</span> Continent, <span class="at">y =</span> Income, <span class="at">fill =</span> N)) <span class="sc">+</span></span>
<span id="cb60-4"><a href="#cb60-4"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"大陸"</span>, <span class="at">y =</span> <span class="st">"一人当たり購買力平価GDP（ドル）"</span>, <span class="at">fill =</span> <span class="st">"国家数"</span>) <span class="sc">+</span></span>
<span id="cb60-5"><a href="#cb60-5"></a>  <span class="fu">scale_fill_gradient</span>(<span class="at">low  =</span> <span class="st">"cornsilk"</span>, </span>
<span id="cb60-6"><a href="#cb60-6"></a>                      <span class="at">high =</span> <span class="st">"brown3"</span>) <span class="sc">+</span></span>
<span id="cb60-7"><a href="#cb60-7"></a>  <span class="fu">theme_bw</span>(<span class="at">base_size =</span> <span class="dv">12</span>) <span class="sc">+</span></span>
<span id="cb60-8"><a href="#cb60-8"></a>  <span class="fu">theme</span>(<span class="at">panel.grid =</span> <span class="fu">element_blank</span>()) <span class="co"># グリッドラインを消す</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="ggplot_intro4_files/figure-html/visual4-heatmap4-1.png" class="img-fluid figure-img" width="2100"></p>
</figure>
</div>
</div>
</div>
<p>　気のせいかも知れませんが、先ほどよりは読みやすくなったような気がしますね。</p>
</section>
<section id="離散変数times離散変数における連続変数の値を示すヒートマップ" class="level3">
<h3 class="anchored" data-anchor-id="離散変数times離散変数における連続変数の値を示すヒートマップ">離散変数<span class="math inline">\(\times\)</span>離散変数における連続変数の値を示すヒートマップ</h3>
<p>　次は、離散変数<span class="math inline">\(\times\)</span>離散変数における連続変数の値を示すヒートマップを作ってみましょう。ヒートマップにおけるそれぞれのタイル（tile）は横軸上の位置と縦軸上の位置情報を持ち、これは前回と同様、離散変数でマッピングされます。そして、タイルの色は何らかの連続変数にマッピングされます。前回作成しましたヒートマップは度数、または密度であり、これも実は連続変数だったので、図の作り方は本質的には同じです。</p>
<p>　ここでは大陸と所得ごとに人間開発指数の平均値を表すヒートマップを作ってみましょう。大陸（<code>Continent</code>）と所得（<code>Income</code>）でグループ化し、人間開発指数（<code>HDI_2018</code>）の平均値を計算したものを<code>Heatmap_df2</code>という名のオブジェクトとして格納します。</p>
<div class="cell" data-layout-align="center" data-hash="ggplot_intro4_cache/html/visual4-heatmap5_00518c7de88b3af2aee4ca4a6f0f6a36">
<div class="sourceCode cell-code" id="cb61"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb61-1"><a href="#cb61-1"></a>Heatmap_df2 <span class="ot">&lt;-</span> Heatmap_df <span class="sc">%&gt;%</span></span>
<span id="cb61-2"><a href="#cb61-2"></a>  <span class="fu">group_by</span>(Continent, Income) <span class="sc">%&gt;%</span></span>
<span id="cb61-3"><a href="#cb61-3"></a>  <span class="fu">summarise</span>(<span class="at">HDI     =</span> <span class="fu">mean</span>(HDI_2018, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb61-4"><a href="#cb61-4"></a>            <span class="at">.groups =</span> <span class="st">"drop"</span>)</span>
<span id="cb61-5"><a href="#cb61-5"></a></span>
<span id="cb61-6"><a href="#cb61-6"></a>Heatmap_df2</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 18 × 3
   Continent  Income                       HDI
   &lt;fct&gt;      &lt;fct&gt;                      &lt;dbl&gt;
 1 アフリカ   "1万ドル未満"              0.510
 2 アフリカ   "1万ドル以上\n2万ドル未満" 0.697
 3 アフリカ   "2万ドル以上\n3万ドル未満" 0.798
 4 アメリカ   "1万ドル未満"              0.638
 5 アメリカ   "1万ドル以上\n2万ドル未満" 0.752
 6 アメリカ   "2万ドル以上\n3万ドル未満" 0.806
 7 アメリカ   "3万ドル以上"              0.841
 8 アジア     "1万ドル未満"              0.624
 9 アジア     "1万ドル以上\n2万ドル未満" 0.730
10 アジア     "2万ドル以上\n3万ドル未満" 0.818
11 アジア     "3万ドル以上"              0.872
12 ヨーロッパ "1万ドル未満"              0.711
13 ヨーロッパ "1万ドル以上\n2万ドル未満" 0.776
14 ヨーロッパ "2万ドル以上\n3万ドル未満" 0.827
15 ヨーロッパ "3万ドル以上"              0.902
16 オセアニア "1万ドル未満"              0.543
17 オセアニア "1万ドル以上\n2万ドル未満" 0.724
18 オセアニア "3万ドル以上"              0.930</code></pre>
</div>
</div>
<p>　作図の方法は前回と同じですが、今回はタイルの色塗り（<code>fill</code>）を人間開発指数の平均値（<code>HDI</code>）でマッピングする必要があります。他の箇所は同じコードでも良いですが、ここでは色塗りの際、中間点を指定してみましょう。たとえば人間開発指数が0.75なら色を<span style="color:#fff8dc;font-weight:bold;background-color:#000000;">cornsilk</span>色とし、これより低いっほど<span style="color:#6495ED;font-weight:bold;">cornflowerblue</span>色に、高いほど<span style="color:#cd3333;font-weight:bold;">brown3</span>色になるように指定します。中間点を持つグラデーション色塗りは<code>scale_fill_gradient2()</code>で調整することができます。使い方は<code>scale_fill_gradient()</code>とほぼ同じですが、中間点の色（<code>mid</code>）と中間点の値（<code>midpoint</code>）をさらに指定する必要があります。</p>
<div class="cell" data-layout-align="center" data-hash="ggplot_intro4_cache/html/visual4-heatmap6_f9fa631500cc422b98cbfa5c64dbffb2">
<div class="sourceCode cell-code" id="cb63"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb63-1"><a href="#cb63-1"></a>Heatmap_df2 <span class="sc">%&gt;%</span></span>
<span id="cb63-2"><a href="#cb63-2"></a>  <span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb63-3"><a href="#cb63-3"></a>  <span class="fu">geom_tile</span>(<span class="fu">aes</span>(<span class="at">x =</span> Continent, <span class="at">y =</span> Income, <span class="at">fill =</span> HDI)) <span class="sc">+</span></span>
<span id="cb63-4"><a href="#cb63-4"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"大陸"</span>, <span class="at">y =</span> <span class="st">"一人当たり購買力平価GDP（ドル）"</span>, </span>
<span id="cb63-5"><a href="#cb63-5"></a>       <span class="at">fill =</span> <span class="st">"人間開発指数の平均値 (2018)"</span>) <span class="sc">+</span></span>
<span id="cb63-6"><a href="#cb63-6"></a>  <span class="fu">scale_fill_gradient2</span>(<span class="at">low  =</span> <span class="st">"cornflowerblue"</span>, </span>
<span id="cb63-7"><a href="#cb63-7"></a>                       <span class="at">mid  =</span> <span class="st">"cornsilk"</span>,</span>
<span id="cb63-8"><a href="#cb63-8"></a>                       <span class="at">high =</span> <span class="st">"brown3"</span>,</span>
<span id="cb63-9"><a href="#cb63-9"></a>                       <span class="at">midpoint =</span> <span class="fl">0.75</span>) <span class="sc">+</span></span>
<span id="cb63-10"><a href="#cb63-10"></a>  <span class="fu">theme_bw</span>(<span class="at">base_size =</span> <span class="dv">12</span>) <span class="sc">+</span></span>
<span id="cb63-11"><a href="#cb63-11"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"bottom"</span>,</span>
<span id="cb63-12"><a href="#cb63-12"></a>        <span class="at">panel.grid      =</span> <span class="fu">element_blank</span>())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="ggplot_intro4_files/figure-html/visual4-heatmap6-1.png" class="img-fluid figure-img" width="2100"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="visual4-contour" class="level2">
<h2 class="anchored" data-anchor-id="visual4-contour">等高線図</h2>
<p>　ヒートマップを使えば、離散変数<span class="math inline">\(\times\)</span>離散変数の同時分布を可視化することは出来ますが、連続変数<span class="math inline">\(\times\)</span>連続変数の同時分布を可視化するには限界があります。むろん、一つ一つのタイルを小さくすることも出来ますが、効率的な方法ではないでしょう。ここで活躍するのが等高線図 (contour plot) です。</p>
<p>　たとえば、<code>Country_df</code>の<code>FH_Total</code>と<code>HDI_2018</code>の分布は散布図を通じて可視化することができます。</p>
<div class="cell" data-layout-align="center" data-hash="ggplot_intro4_cache/html/visual4-contour1_302ca1820918f9f48c0c0d6d3558323d">
<div class="sourceCode cell-code" id="cb64"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb64-1"><a href="#cb64-1"></a>Country_df <span class="sc">%&gt;%</span></span>
<span id="cb64-2"><a href="#cb64-2"></a>  <span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb64-3"><a href="#cb64-3"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">x =</span> FH_Total, <span class="at">y =</span> HDI_2018)) <span class="sc">+</span></span>
<span id="cb64-4"><a href="#cb64-4"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"フリーダム・ハウス・スコア"</span>, <span class="at">y =</span> <span class="st">"人間開発指数 (2018)"</span>) <span class="sc">+</span></span>
<span id="cb64-5"><a href="#cb64-5"></a>  <span class="fu">theme_minimal</span>(<span class="at">base_size =</span> <span class="dv">12</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="ggplot_intro4_files/figure-html/visual4-contour1-1.png" class="img-fluid figure-img" width="2100"></p>
</figure>
</div>
</div>
</div>
<p>　右上に点が集まっていることから、密度の高い箇所だと考えられます。この密度を示す等高線図の幾何オブジェクトは<code>geom_density_2d()</code>です。マッピング要素は<code>geom_point()</code>と同じなので、マッピングは<code>ggplot()</code>内で行い、<code>geom_density_2d()</code>レイヤーを使いしてみましょう。</p>
<div class="cell" data-layout-align="center" data-hash="ggplot_intro4_cache/html/visual4-contour2_9aa607c8ae66b60f1d8a3533487af3f6">
<div class="sourceCode cell-code" id="cb65"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb65-1"><a href="#cb65-1"></a>Country_df <span class="sc">%&gt;%</span></span>
<span id="cb65-2"><a href="#cb65-2"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> FH_Total, <span class="at">y =</span> HDI_2018)) <span class="sc">+</span></span>
<span id="cb65-3"><a href="#cb65-3"></a>  <span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb65-4"><a href="#cb65-4"></a>  <span class="fu">geom_density_2d</span>() <span class="sc">+</span></span>
<span id="cb65-5"><a href="#cb65-5"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"フリーダム・ハウス・スコア"</span>, <span class="at">y =</span> <span class="st">"人間開発指数 (2018)"</span>) <span class="sc">+</span></span>
<span id="cb65-6"><a href="#cb65-6"></a>  <span class="fu">theme_minimal</span>(<span class="at">base_size =</span> <span class="dv">12</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="ggplot_intro4_files/figure-html/visual4-contour2-1.png" class="img-fluid figure-img" width="2100"></p>
</figure>
</div>
</div>
</div>
<p>　密度に応じて色塗りをする場合は<code>geom_density_2d()</code>の代わりに<code>geom_density_2d_filled()</code>を使います。</p>
<div class="cell" data-layout-align="center" data-hash="ggplot_intro4_cache/html/visual4-contour3_fb41131e1b08c889a1869d3d81e4dfef">
<div class="sourceCode cell-code" id="cb66"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb66-1"><a href="#cb66-1"></a>Country_df <span class="sc">%&gt;%</span></span>
<span id="cb66-2"><a href="#cb66-2"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> FH_Total, <span class="at">y =</span> HDI_2018)) <span class="sc">+</span></span>
<span id="cb66-3"><a href="#cb66-3"></a>  <span class="fu">geom_density_2d_filled</span>() <span class="sc">+</span></span>
<span id="cb66-4"><a href="#cb66-4"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"フリーダム・ハウス・スコア"</span>, <span class="at">y =</span> <span class="st">"人間開発指数 (2018)"</span>,</span>
<span id="cb66-5"><a href="#cb66-5"></a>       <span class="at">fill =</span> <span class="st">"密度"</span>) <span class="sc">+</span></span>
<span id="cb66-6"><a href="#cb66-6"></a>  <span class="fu">theme_minimal</span>(<span class="at">base_size =</span> <span class="dv">12</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="ggplot_intro4_files/figure-html/visual4-contour3-1.png" class="img-fluid figure-img" width="2100"></p>
</figure>
</div>
</div>
</div>
<p>　<code>geom_density_2d_filled()</code>オブジェクトの後に<code>geom_density_2d()</code>オブジェクトを重ねると、区間の区画線を追加することもできます。</p>
<div class="cell" data-layout-align="center" data-hash="ggplot_intro4_cache/html/visual4-contour4_b2e3d2d3f6902446681e7a8a1fd5a8dd">
<div class="sourceCode cell-code" id="cb67"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb67-1"><a href="#cb67-1"></a>Country_df <span class="sc">%&gt;%</span></span>
<span id="cb67-2"><a href="#cb67-2"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> FH_Total, <span class="at">y =</span> HDI_2018)) <span class="sc">+</span></span>
<span id="cb67-3"><a href="#cb67-3"></a>  <span class="fu">geom_density_2d_filled</span>() <span class="sc">+</span></span>
<span id="cb67-4"><a href="#cb67-4"></a>  <span class="fu">geom_density_2d</span>(<span class="at">color =</span> <span class="st">"black"</span>) <span class="sc">+</span></span>
<span id="cb67-5"><a href="#cb67-5"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"フリーダム・ハウス・スコア"</span>, <span class="at">y =</span> <span class="st">"人間開発指数 (2018)"</span>,</span>
<span id="cb67-6"><a href="#cb67-6"></a>       <span class="at">fill =</span> <span class="st">"密度"</span>) <span class="sc">+</span></span>
<span id="cb67-7"><a href="#cb67-7"></a>  <span class="fu">theme_minimal</span>(<span class="at">base_size =</span> <span class="dv">12</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="ggplot_intro4_files/figure-html/visual4-contour4-1.png" class="img-fluid figure-img" width="2100"></p>
</figure>
</div>
</div>
</div>
<p>　色が気に入らない場合、自分で調整することも可能です。<code>scale_fill_manual()</code>で各区間ごとの色を指定することもできませんが、あまり効率的ではありません。ここでは<code>scale_fill_brewer()</code>関数を使って、<a href="https://colorbrewer2.org/">ColorBrewer</a>のパレットを使ってみましょう。引数なしでも使えますが、既定値のパレットは区間が9つまで対応します。今回の等高線図は全部で10区間ですので、あまり適切ではありません。ここでは11区間まで対応可能な<code>"Spectral"</code>パレットを使いますが、これは<code>palette</code>引数で指定できます。</p>
<div class="cell" data-layout-align="center" data-hash="ggplot_intro4_cache/html/visual4-contour5_7d2e027a3d870314898b0659b61743bf">
<div class="sourceCode cell-code" id="cb68"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb68-1"><a href="#cb68-1"></a>Country_df <span class="sc">%&gt;%</span></span>
<span id="cb68-2"><a href="#cb68-2"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> FH_Total, <span class="at">y =</span> HDI_2018)) <span class="sc">+</span></span>
<span id="cb68-3"><a href="#cb68-3"></a>  <span class="fu">geom_density_2d_filled</span>() <span class="sc">+</span></span>
<span id="cb68-4"><a href="#cb68-4"></a>  <span class="fu">scale_fill_brewer</span>(<span class="at">palette =</span> <span class="st">"Spectral"</span>) <span class="sc">+</span></span>
<span id="cb68-5"><a href="#cb68-5"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"フリーダム・ハウス・スコア"</span>, <span class="at">y =</span> <span class="st">"人間開発指数 (2018)"</span>,</span>
<span id="cb68-6"><a href="#cb68-6"></a>       <span class="at">fill =</span> <span class="st">"密度"</span>) <span class="sc">+</span></span>
<span id="cb68-7"><a href="#cb68-7"></a>  <span class="fu">theme_minimal</span>(<span class="at">base_size =</span> <span class="dv">12</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="ggplot_intro4_files/figure-html/visual4-contour5-1.png" class="img-fluid figure-img" width="2100"></p>
</figure>
</div>
</div>
</div>
<p>　<code>palette</code>で指定可能なカラーパレットの一覧は{RColorBrewer}の<code>display.brewer.all()</code>関数で確認することが出来ます。各パレットが何区間まで対応できるかを見てから自分でパレットを作成することも可能ですが、詳細はネット上の各種記事を参照してください。</p>
<div class="cell" data-layout-align="center" data-hash="ggplot_intro4_cache/html/visual4-contour6_1027e725a4796c46a34054a5cd94c046">
<div class="sourceCode cell-code" id="cb69"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb69-1"><a href="#cb69-1"></a>RColorBrewer<span class="sc">::</span><span class="fu">display.brewer.all</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="ggplot_intro4_files/figure-html/visual4-contour6-1.png" class="img-fluid figure-img" width="2100"></p>
<figcaption class="figure-caption">{RColorBrewer}が提供するパレート一覧</figcaption>
</figure>
</div>
</div>
</div>
</section>
<section id="visual4-map" class="level2">
<h2 class="anchored" data-anchor-id="visual4-map">地図</h2>
<section id="世界地図" class="level3">
<h3 class="anchored" data-anchor-id="世界地図">世界地図</h3>
<p>{ggplot2}で地図をプロットする方法は色々あります。理想としては各国政府が提供する地図データをダウンロードし、それを読み込み・加工してプロットすることでしょうが、ここではパッケージを使ったマッピングについて紹介します。</p>
<p>　今回使用するパッケージは{rnaturalearth}、{rnaturalearthdata}、{rgeos}です。他にも使うパッケージはありますが、世界地図ならとりあえずこれで十分です。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb70"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb70-1"><a href="#cb70-1"></a>pacman<span class="sc">::</span><span class="fu">p_load</span>(rnaturalearth, rnaturalearthdata, rgeos)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>　世界地図を読み込む関数は{rnaturalearth}が提供する<code>ne_countries()</code>です。とりあえず指定する引数は<code>scale</code>と<code>retunrclass</code>です。<code>scale</code>は地図の解像度であり、世界地図なら<code>"small"</code>で十分です。もう少し拡大される大陸地図なら<code>"medium"</code>が、一国だけの地図なら<code>"large"</code>が良いかも知れません。<code>reutrnclass</code>は<code>"sf"</code>と指定します。今回は低解像度の世界地図をsfクラスで読み込んでみましょう。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb71"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb71-1"><a href="#cb71-1"></a>world_map <span class="ot">&lt;-</span> <span class="fu">ne_countries</span>(<span class="at">scale =</span> <span class="st">"small"</span>, <span class="at">returnclass =</span> <span class="st">"sf"</span>)</span>
<span id="cb71-2"><a href="#cb71-2"></a></span>
<span id="cb71-3"><a href="#cb71-3"></a><span class="fu">class</span>(world_map)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "sf"         "data.frame"</code></pre>
</div>
</div>
<p>　クラスはdata.frameとsfであり、実際、<code>world_map</code>を出力してみると、見た目がデータフレームであることが分かります。地図の出力は<code>geom_sf()</code>幾何オブジェクトを使用します。とりあえず、やってみましょう。</p>
<div class="cell" data-layout-align="center" data-hash="ggplot_intro4_cache/html/visual4-map3_fab7085799af62581fd0d20bd1b1a05d">
<div class="sourceCode cell-code" id="cb73"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb73-1"><a href="#cb73-1"></a>world_map <span class="sc">%&gt;%</span> </span>
<span id="cb73-2"><a href="#cb73-2"></a>  <span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb73-3"><a href="#cb73-3"></a>  <span class="fu">geom_sf</span>() <span class="sc">+</span></span>
<span id="cb73-4"><a href="#cb73-4"></a>  <span class="fu">theme_void</span>() <span class="co"># 何もないテーマを指定する。ここはお好みで</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="ggplot_intro4_files/figure-html/visual4-map3-1.png" class="img-fluid figure-img" width="2100"></p>
</figure>
</div>
</div>
</div>
<p>　もし、各国の人口に応じて色塗りをする場合はどうすれば良いでしょうか。実は、今回使用するデータがデータフレーム形式であることを考えると、これまでの{ggplot2}の使い方とあまり変わりません。{rnaturalearth}から読み込んだデータには既に<code>pop_est</code>という各国の人口データが含まれて負います。この値に応じて色塗りを行うため、<code>geom_sf()</code>内に<code>fill = pop_est</code>でマッピングするだけです。</p>
<p>　他にも自分で構築したデータがあるなら、データを結合して使用すれば良いでしょう。これについては後述します。</p>
<div class="cell" data-layout-align="center" data-hash="ggplot_intro4_cache/html/visual4-map4_33b06d1502e1bc3c6c7f2af6f26a2e3e">
<div class="sourceCode cell-code" id="cb74"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb74-1"><a href="#cb74-1"></a>world_map <span class="sc">%&gt;%</span> </span>
<span id="cb74-2"><a href="#cb74-2"></a>  <span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb74-3"><a href="#cb74-3"></a>  <span class="fu">geom_sf</span>(<span class="fu">aes</span>(<span class="at">fill =</span> pop_est)) <span class="sc">+</span></span>
<span id="cb74-4"><a href="#cb74-4"></a>  <span class="co"># 人口が少ない国はcornflowerblue色に、多い国はbrown3色とする</span></span>
<span id="cb74-5"><a href="#cb74-5"></a>  <span class="fu">scale_fill_gradient</span>(<span class="at">low =</span> <span class="st">"cornflowerblue"</span>, <span class="at">high =</span> <span class="st">"brown3"</span>) <span class="sc">+</span></span>
<span id="cb74-6"><a href="#cb74-6"></a>  <span class="fu">labs</span>(<span class="at">fill =</span> <span class="st">"人口"</span>) <span class="sc">+</span></span>
<span id="cb74-7"><a href="#cb74-7"></a>  <span class="fu">theme_void</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="ggplot_intro4_files/figure-html/visual4-map4-1.png" class="img-fluid figure-img" width="2100"></p>
</figure>
</div>
</div>
</div>
<p>　もし、世界でなく一部の地域だけを出力するなら、<code>coord_sf()</code>で座標系を調整します。東アジアと東南アジアの一部を出力したいとします。この場合、経度は90度から150度まで、緯度は10度から50度に絞ることになります。経度は<code>xlim</code>で、緯度は<code>ylim</code>で調整します。</p>
<div class="cell" data-layout-align="center" data-hash="ggplot_intro4_cache/html/visual4-map5_cc9f6155f995c83ffc2b90ab7306d35a">
<div class="sourceCode cell-code" id="cb75"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb75-1"><a href="#cb75-1"></a>world_map <span class="sc">%&gt;%</span> </span>
<span id="cb75-2"><a href="#cb75-2"></a>  <span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb75-3"><a href="#cb75-3"></a>  <span class="fu">geom_sf</span>(<span class="fu">aes</span>(<span class="at">fill =</span> pop_est)) <span class="sc">+</span></span>
<span id="cb75-4"><a href="#cb75-4"></a>  <span class="fu">scale_fill_gradient</span>(<span class="at">low =</span> <span class="st">"cornflowerblue"</span>, <span class="at">high =</span> <span class="st">"brown3"</span>) <span class="sc">+</span></span>
<span id="cb75-5"><a href="#cb75-5"></a>  <span class="fu">labs</span>(<span class="at">fill =</span> <span class="st">"人口"</span>) <span class="sc">+</span></span>
<span id="cb75-6"><a href="#cb75-6"></a>  <span class="fu">coord_sf</span>(<span class="at">xlim =</span> <span class="fu">c</span>(<span class="dv">90</span>, <span class="dv">150</span>), <span class="at">ylim =</span> <span class="fu">c</span>(<span class="dv">10</span>, <span class="dv">50</span>)) <span class="sc">+</span></span>
<span id="cb75-7"><a href="#cb75-7"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb75-8"><a href="#cb75-8"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"bottom"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="ggplot_intro4_files/figure-html/visual4-map5-1.png" class="img-fluid figure-img" width="2100"></p>
</figure>
</div>
</div>
</div>
<p>　他にも<code>ne_countries()</code>内に<code>continent</code>引数を指定し、特定の大陸だけを読み込むことで可能です。ここではアジアの国のみを抽出し、<code>asia_map</code>という名のオブジェクトとして格納します。解像度は中程度とします。</p>
<div class="cell" data-layout-align="center" data-hash="ggplot_intro4_cache/html/visual4-map6_b6b6a3b823c84cb568e318c51d86da6f">
<div class="sourceCode cell-code" id="cb76"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb76-1"><a href="#cb76-1"></a>asia_map <span class="ot">&lt;-</span> <span class="fu">ne_countries</span>(<span class="at">scale =</span> <span class="st">"medium"</span>, <span class="at">continent =</span> <span class="st">"Asia"</span>, </span>
<span id="cb76-2"><a href="#cb76-2"></a>                         <span class="at">returnclass =</span> <span class="st">"sf"</span>)</span>
<span id="cb76-3"><a href="#cb76-3"></a></span>
<span id="cb76-4"><a href="#cb76-4"></a>asia_map <span class="sc">%&gt;%</span></span>
<span id="cb76-5"><a href="#cb76-5"></a>    <span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb76-6"><a href="#cb76-6"></a>    <span class="co"># 所得グループで色塗り</span></span>
<span id="cb76-7"><a href="#cb76-7"></a>    <span class="fu">geom_sf</span>(<span class="fu">aes</span>(<span class="at">fill =</span> income_grp)) <span class="sc">+</span></span>
<span id="cb76-8"><a href="#cb76-8"></a>    <span class="fu">theme_void</span>() <span class="sc">+</span></span>
<span id="cb76-9"><a href="#cb76-9"></a>    <span class="fu">labs</span>(<span class="at">fill =</span> <span class="st">"Income Group"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="ggplot_intro4_files/figure-html/visual4-map6-1.png" class="img-fluid figure-img" width="2100"></p>
</figure>
</div>
</div>
</div>
<p>　アジアの中から更に東アジアに絞りたい場合は<code>filter()</code>を使用し、<code>subregion</code>列を基準に抽出することも可能です。</p>
<div class="cell" data-layout-align="center" data-hash="ggplot_intro4_cache/html/visual4-map7_f8dd2e1043763f500395131d2bf7ba4e">
<div class="sourceCode cell-code" id="cb77"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb77-1"><a href="#cb77-1"></a>asia_map <span class="sc">%&gt;%</span></span>
<span id="cb77-2"><a href="#cb77-2"></a>    <span class="fu">filter</span>(subregion <span class="sc">==</span> <span class="st">"Eastern Asia"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb77-3"><a href="#cb77-3"></a>    <span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb77-4"><a href="#cb77-4"></a>    <span class="fu">geom_sf</span>(<span class="fu">aes</span>(<span class="at">fill =</span> income_grp)) <span class="sc">+</span></span>
<span id="cb77-5"><a href="#cb77-5"></a>    <span class="fu">theme_void</span>() <span class="sc">+</span></span>
<span id="cb77-6"><a href="#cb77-6"></a>    <span class="fu">labs</span>(<span class="at">fill =</span> <span class="st">"Income Group"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="ggplot_intro4_files/figure-html/visual4-map7-1.png" class="img-fluid figure-img" width="2100"></p>
</figure>
</div>
</div>
</div>
<p>　<code>subregion</code>の値は以下のように確認可能です。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb78"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb78-1"><a href="#cb78-1"></a><span class="fu">unique</span>(asia_map<span class="sc">$</span>subregion)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "Southern Asia"           "Western Asia"           
[3] "South-Eastern Asia"      "Eastern Asia"           
[5] "Seven seas (open ocean)" "Central Asia"           </code></pre>
</div>
</div>
<p>　これまで使用してきたデータがデータフレームと同じ見た目をしているため、{dplyr}を用いたデータハンドリングも可能です。たとえば、人口を連続変数としてでなく、factor型に変換してからマッピングをしてみましょう。</p>
<div class="cell" data-layout-align="center" data-hash="ggplot_intro4_cache/html/visual4-map9_355566ed12e879e925ac1edb632101dc">
<div class="sourceCode cell-code" id="cb80"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb80-1"><a href="#cb80-1"></a>asia_map <span class="sc">%&gt;%</span> </span>
<span id="cb80-2"><a href="#cb80-2"></a>  <span class="fu">mutate</span>(<span class="at">Population =</span> <span class="fu">case_when</span>(pop_est <span class="sc">&lt;</span> <span class="dv">10000000</span>  <span class="sc">~</span> <span class="st">"1千万未満"</span>,</span>
<span id="cb80-3"><a href="#cb80-3"></a>                                pop_est <span class="sc">&lt;</span> <span class="dv">50000000</span>  <span class="sc">~</span> <span class="st">"5千万未満"</span>,</span>
<span id="cb80-4"><a href="#cb80-4"></a>                                pop_est <span class="sc">&lt;</span> <span class="dv">100000000</span> <span class="sc">~</span> <span class="st">"1億未満"</span>,</span>
<span id="cb80-5"><a href="#cb80-5"></a>                                pop_est <span class="sc">&lt;</span> <span class="dv">500000000</span> <span class="sc">~</span> <span class="st">"5億未満"</span>,</span>
<span id="cb80-6"><a href="#cb80-6"></a>                                <span class="cn">TRUE</span>                <span class="sc">~</span> <span class="st">"5億以上"</span>),</span>
<span id="cb80-7"><a href="#cb80-7"></a>         <span class="at">Population =</span> <span class="fu">factor</span>(Population, </span>
<span id="cb80-8"><a href="#cb80-8"></a>                             <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"1千万未満"</span>, <span class="st">"5千万未満"</span>, <span class="st">"1億未満"</span>,</span>
<span id="cb80-9"><a href="#cb80-9"></a>                                        <span class="st">"5億未満"</span>, <span class="st">"5億以上"</span>))) <span class="sc">%&gt;%</span></span>
<span id="cb80-10"><a href="#cb80-10"></a>  <span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb80-11"><a href="#cb80-11"></a>  <span class="fu">geom_sf</span>(<span class="fu">aes</span>(<span class="at">fill =</span> Population)) <span class="sc">+</span></span>
<span id="cb80-12"><a href="#cb80-12"></a>  <span class="fu">scale_fill_brewer</span>(<span class="at">palette =</span> <span class="st">"Blues"</span>, <span class="at">drop =</span> <span class="cn">FALSE</span>) <span class="sc">+</span></span>
<span id="cb80-13"><a href="#cb80-13"></a>  <span class="fu">labs</span>(<span class="at">fill =</span> <span class="st">"人口"</span>) <span class="sc">+</span></span>
<span id="cb80-14"><a href="#cb80-14"></a>  <span class="fu">theme_void</span>() <span class="sc">+</span></span>
<span id="cb80-15"><a href="#cb80-15"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"bottom"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="ggplot_intro4_files/figure-html/visual4-map9-1.png" class="img-fluid figure-img" width="2100"></p>
</figure>
</div>
</div>
</div>
<p>　<code>scale_fill_brewer()</code>の<code>palette</code>引数は等高線図のときに紹介しましたパレート一覧を参照してください。</p>
</section>
<section id="日本地図全体" class="level3">
<h3 class="anchored" data-anchor-id="日本地図全体">日本地図（全体）</h3>
<p>　次は日本地図の出力についてです。日本全土だけを出力するなら、これまで使いました<code>ne_countries</code>に<code>country</code>引数を指定するだけで使えます。たとえば、日本の地図だけなら、<code>country = "Japan"</code>を指定します。</p>
<div class="cell" data-layout-align="center" data-hash="ggplot_intro4_cache/html/visual4-map10_73b92676bb42209378884cd4009aec69">
<div class="sourceCode cell-code" id="cb81"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb81-1"><a href="#cb81-1"></a><span class="fu">ne_countries</span>(<span class="at">scale =</span> <span class="st">"small"</span>, <span class="at">country =</span> <span class="st">"Japan"</span>, <span class="at">returnclass =</span> <span class="st">"sf"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb81-2"><a href="#cb81-2"></a>    <span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb81-3"><a href="#cb81-3"></a>    <span class="fu">geom_sf</span>() <span class="sc">+</span></span>
<span id="cb81-4"><a href="#cb81-4"></a>    <span class="fu">theme_void</span>() <span class="co"># 空っぽのテーマ</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="ggplot_intro4_files/figure-html/visual4-map10-1.png" class="img-fluid figure-img" width="2100"></p>
</figure>
</div>
</div>
</div>
<p>　これだと、物足りない感があるので、もう少し高解像度の地図にしてみましょう。高解像度の地図データを読み込む際は<code>scale = "large"</code>を指定します。</p>
<div class="cell" data-layout-align="center" data-hash="ggplot_intro4_cache/html/visual4-map11_205104043d16463faeaf4a41d14f3bbc">
<div class="sourceCode cell-code" id="cb82"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb82-1"><a href="#cb82-1"></a><span class="fu">ne_countries</span>(<span class="at">scale =</span> <span class="st">"large"</span>, <span class="at">country =</span> <span class="st">"Japan"</span>, <span class="at">returnclass =</span> <span class="st">"sf"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb82-2"><a href="#cb82-2"></a>    <span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb82-3"><a href="#cb82-3"></a>    <span class="fu">geom_sf</span>() <span class="sc">+</span></span>
<span id="cb82-4"><a href="#cb82-4"></a>    <span class="fu">theme_void</span>() <span class="co"># 空っぽのテーマ</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="ggplot_intro4_files/figure-html/visual4-map11-1.png" class="img-fluid figure-img" width="2100"></p>
</figure>
</div>
</div>
</div>
<p>　ただ、日本地図を出すという場合、多くは都道府県レベルでマッピングが目的でしょう。世界地図のマッピングならこれで問題ありませんが、一国だけなら、その下の自治体の境界線も必要です。したがって、先ほど使用しましたパッケージのより高解像度の地図が含まれている{rnaturalearthhires}をインストールし、読み込みましょう。2023年Jul月19日現在、{rnaturalearthhires}はCRANに登録されておらず、GitHubの<a href="https://github.com/ropensci">ropensciレポジトリー</a>のみで公開されているため、今回は{pacman}の<code>p_load()</code>でなく、<code>p_load_gh()</code>を使用します。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb83"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb83-1"><a href="#cb83-1"></a>pacman<span class="sc">::</span><span class="fu">p_load_gh</span>(<span class="st">"ropensci/rnaturalearthhires"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>　地図データの抽出には<code>ne_states()</code>関数を使用します。第一引数として国家名を指定し、地図データのクラスはsfとします。抽出したデータの使い方は世界地図の時と同じです。</p>
<div class="cell" data-layout-align="center" data-hash="ggplot_intro4_cache/html/visual4-map13_ec15352d10da7acaa2a517c0a05cd61c">
<div class="sourceCode cell-code" id="cb84"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb84-1"><a href="#cb84-1"></a>Japan_Map <span class="ot">&lt;-</span> <span class="fu">ne_states</span>(<span class="st">"Japan"</span>, <span class="at">returnclass =</span> <span class="st">"sf"</span>)</span>
<span id="cb84-2"><a href="#cb84-2"></a></span>
<span id="cb84-3"><a href="#cb84-3"></a>Japan_Map <span class="sc">%&gt;%</span></span>
<span id="cb84-4"><a href="#cb84-4"></a>  <span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb84-5"><a href="#cb84-5"></a>  <span class="fu">geom_sf</span>() <span class="sc">+</span></span>
<span id="cb84-6"><a href="#cb84-6"></a>  <span class="fu">theme_void</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="ggplot_intro4_files/figure-html/visual4-map13-1.png" class="img-fluid figure-img" width="2100"></p>
</figure>
</div>
</div>
</div>
<p>　今回は各都道府県を人口密度ごとに色塗りをしてみましょう。<code>ne_states()</code>で読み込んだデータに人口密度のデータはないため、別途のデータと結合する必要があります。筆者が予め作成しておいた<a href="Data/Japan_Density.csv">データ</a>を読み込み、中身を確認してみます。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb85"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb85-1"><a href="#cb85-1"></a>Japan_Density <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">"Data/Japan_Density.csv"</span>)</span>
<span id="cb85-2"><a href="#cb85-2"></a></span>
<span id="cb85-3"><a href="#cb85-3"></a>Japan_Density</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 47 × 3
    Code Name   Density
   &lt;dbl&gt; &lt;chr&gt;    &lt;dbl&gt;
 1     1 北海道    66.6
 2     2 青森県   128. 
 3     3 岩手県    79.2
 4     4 宮城県   316. 
 5     5 秋田県    82.4
 6     6 山形県   115. 
 7     7 福島県   133  
 8     8 茨城県   470. 
 9     9 栃木県   302. 
10    10 群馬県   305. 
# ℹ 37 more rows</code></pre>
</div>
</div>
<p>　各都道府県の人口密度がついております、左側の<code>Code</code>は何でしょうか。これは各都道府県のISOコードであり、このコードをキー変数としてデータを結合することとなります。各都道府県のコードは<a href="https://nlftp.mlit.go.jp/ksj/gml/codelist/PrefCd.html">国土交通省のホームページ</a>から確認可能です。</p>
<p>　それではデータを結合してみましょう。<code>ne_states()</code>で読み込んだデータの場合、地域のコードは<code>iso_3166_2</code>という列に格納されています。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb87"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb87-1"><a href="#cb87-1"></a>Japan_Map<span class="sc">$</span>iso_3166_2</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> [1] "JP-46" "JP-44" "JP-40" "JP-41" "JP-42" "JP-43" "JP-45" "JP-36" "JP-37"
[10] "JP-38" "JP-39" "JP-32" "JP-35" "JP-31" "JP-28" "JP-26" "JP-18" "JP-17"
[19] "JP-16" "JP-15" "JP-06" "JP-05" "JP-02" "JP-03" "JP-04" "JP-07" "JP-08"
[28] "JP-12" "JP-13" "JP-14" "JP-22" "JP-23" "JP-24" "JP-30" "JP-27" "JP-33"
[37] "JP-34" "JP-01" "JP-47" "JP-10" "JP-20" "JP-09" "JP-21" "JP-25" "JP-11"
[46] "JP-19" "JP-29"</code></pre>
</div>
</div>
<p>　こちらは文字列となっていますね。これを左から4番目の文字から切り取り、数値型に変換します。変換したコードは結合のために<code>Code</code>という名の列として追加しましょう。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb89"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb89-1"><a href="#cb89-1"></a>Japan_Map <span class="ot">&lt;-</span> Japan_Map <span class="sc">%&gt;%</span></span>
<span id="cb89-2"><a href="#cb89-2"></a>    <span class="fu">mutate</span>(<span class="at">Code =</span> <span class="fu">str_sub</span>(iso_3166_2, <span class="dv">4</span>),</span>
<span id="cb89-3"><a href="#cb89-3"></a>           <span class="at">Code =</span> <span class="fu">as.numeric</span>(Code))</span>
<span id="cb89-4"><a href="#cb89-4"></a></span>
<span id="cb89-5"><a href="#cb89-5"></a>Japan_Map<span class="sc">$</span>Code</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> [1] 46 44 40 41 42 43 45 36 37 38 39 32 35 31 28 26 18 17 16 15  6  5  2  3  4
[26]  7  8 12 13 14 22 23 24 30 27 33 34  1 47 10 20  9 21 25 11 19 29</code></pre>
</div>
</div>
<p>　続いて、<code>Japan_Map</code>と<code>Japan_Density</code>を<code>Code</code>列をキー変数として結合します。データの中身を確認すると、<code>Density</code>列が最後(の直前)の列に追加されたことが分かります。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb91"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb91-1"><a href="#cb91-1"></a>Japan_Map <span class="ot">&lt;-</span> <span class="fu">left_join</span>(Japan_Map, Japan_Density, <span class="at">by =</span> <span class="st">"Code"</span>)</span>
<span id="cb91-2"><a href="#cb91-2"></a></span>
<span id="cb91-3"><a href="#cb91-3"></a>Japan_Map</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Simple feature collection with 47 features and 86 fields
Geometry type: MULTIPOLYGON
Dimension:     XY
Bounding box:  xmin: 122.9382 ymin: 24.2121 xmax: 153.9856 ymax: 45.52041
Geodetic CRS:  +proj=longlat +datum=WGS84 +no_defs +ellps=WGS84 +towgs84=0,0,0
First 10 features:
           featurecla scalerank adm1_code diss_me iso_3166_2 wikipedia iso_a2
1  Admin-1 scale rank         2  JPN-3501    3501      JP-46      &lt;NA&gt;     JP
2  Admin-1 scale rank         6  JPN-1835    1835      JP-44      &lt;NA&gt;     JP
3  Admin-1 scale rank         6  JPN-1829    1829      JP-40      &lt;NA&gt;     JP
4  Admin-1 scale rank         6  JPN-1827    1827      JP-41      &lt;NA&gt;     JP
5  Admin-1 scale rank         2  JPN-3500    3500      JP-42      &lt;NA&gt;     JP
6  Admin-1 scale rank         6  JPN-1830    1830      JP-43      &lt;NA&gt;     JP
7  Admin-1 scale rank         6  JPN-1831    1831      JP-45      &lt;NA&gt;     JP
8  Admin-1 scale rank         6  JPN-1836    1836      JP-36      &lt;NA&gt;     JP
9  Admin-1 scale rank         6  JPN-1833    1833      JP-37      &lt;NA&gt;     JP
10 Admin-1 scale rank         6  JPN-1832    1832      JP-38      &lt;NA&gt;     JP
   adm0_sr      name name_alt name_local type    type_en code_local code_hasc
1        5 Kagoshima     &lt;NA&gt;       &lt;NA&gt;  Ken Prefecture       &lt;NA&gt;     JP.KS
2        1      Oita     &lt;NA&gt;       &lt;NA&gt;  Ken Prefecture       &lt;NA&gt;     JP.OT
3        1   Fukuoka  Hukuoka       &lt;NA&gt;  Ken Prefecture       &lt;NA&gt;     JP.FO
4        1      Saga     &lt;NA&gt;       &lt;NA&gt;  Ken Prefecture       &lt;NA&gt;     JP.SG
5        3  Nagasaki     &lt;NA&gt;       &lt;NA&gt;  Ken Prefecture       &lt;NA&gt;     JP.NS
6        1  Kumamoto     &lt;NA&gt;       &lt;NA&gt;  Ken Prefecture       &lt;NA&gt;     JP.KM
7        1  Miyazaki     &lt;NA&gt;       &lt;NA&gt;  Ken Prefecture       &lt;NA&gt;     JP.MZ
8        1 Tokushima Tokusima       &lt;NA&gt;  Ken Prefecture       &lt;NA&gt;     JP.TS
9        1    Kagawa     &lt;NA&gt;       &lt;NA&gt;  Ken Prefecture       &lt;NA&gt;     JP.KG
10       4     Ehime     &lt;NA&gt;       &lt;NA&gt;  Ken Prefecture       &lt;NA&gt;     JP.EH
   note hasc_maybe  region region_cod provnum_ne gadm_level check_me datarank
1  &lt;NA&gt;      JP.NR  Kyushu    JPN-KYS          3          1       20        9
2  &lt;NA&gt;      JP.ON  Kyushu    JPN-SHK         48          1       20        2
3  &lt;NA&gt;      JP.NS  Kyushu    JPN-KYS         46          1       20        2
4  &lt;NA&gt;      JP.OS    &lt;NA&gt;       &lt;NA&gt;         47          1       20        2
5  &lt;NA&gt;      JP.OY    &lt;NA&gt;       &lt;NA&gt;          5          1       20        9
6  &lt;NA&gt;      JP.NI  Kyushu    JPN-KYS          6          1       20        2
7  &lt;NA&gt;      JP.OT  Kyushu    JPN-KYS         49          1       20        2
8  &lt;NA&gt;      JP.SZ Shikoku    JPN-SHK         45          1       20        2
9  &lt;NA&gt;      JP.SH Shikoku    JPN-SHK          4          1       20        2
10 &lt;NA&gt;      JP.ST Shikoku    JPN-SHK         14          1       20        2
   abbrev postal area_sqkm sameascity labelrank name_len mapcolor9 mapcolor13
1    &lt;NA&gt;   &lt;NA&gt;         0         NA         2        9         5          4
2    &lt;NA&gt;     OT         0          7         7        4         5          4
3    &lt;NA&gt;     FO         0          7         7        7         5          4
4    &lt;NA&gt;     SG         0         NA         6        4         5          4
5    &lt;NA&gt;   &lt;NA&gt;         0         NA         2        8         5          4
6    &lt;NA&gt;     KM         0         NA         6        8         5          4
7    &lt;NA&gt;     MZ         0         NA         6        8         5          4
8    &lt;NA&gt;     TS         0         NA         6        9         5          4
9    &lt;NA&gt;     KG         0         NA         6        6         5          4
10   &lt;NA&gt;     EH         0         NA         6        5         5          4
   fips fips_alt   woe_id                       woe_label  woe_name latitude
1  JA18     JA28  2345867 Kagoshima Prefecture, JP, Japan Kagoshima  29.4572
2  JA30     JA47  2345879      Oita Prefecture, JP, Japan      Oita  33.2006
3  JA07     JA27 58646425   Fukuoka Prefecture, JP, Japan   Fukuoka  33.4906
4  JA33     JA32  2345882      Saga Prefecture, JP, Japan      Saga  33.0097
5  JA27     JA31  2345876  Nagasaki Prefecture, JP, Japan  Nagasaki  32.6745
6  JA21     JA29  2345870  Kumamoto Prefecture, JP, Japan  Kumamoto  32.5880
7  JA25     JA30  2345874  Miyazaki Prefecture, JP, Japan  Miyazaki  32.0981
8  JA39     JA37  2345888 Tokushima Prefecture, JP, Japan Tokushima  33.8546
9  JA17     JA35  2345866    Kagawa Prefecture, JP, Japan    Kagawa  34.2162
10 JA05     JA34  2345855     Ehime Prefecture, JP, Japan     Ehime  33.8141
   longitude sov_a3 adm0_a3 adm0_label admin geonunit gu_a3   gn_id
1    129.601    JPN     JPN          4 Japan    Japan   JPN 1860825
2    131.449    JPN     JPN          4 Japan    Japan   JPN 1854484
3    130.616    JPN     JPN          4 Japan    Japan   JPN 1863958
4    130.147    JPN     JPN          4 Japan    Japan   JPN 1853299
5    128.755    JPN     JPN          4 Japan    Japan   JPN 1856156
6    130.834    JPN     JPN          4 Japan    Japan   JPN 1858419
7    131.286    JPN     JPN          4 Japan    Japan   JPN 1856710
8    134.200    JPN     JPN          4 Japan    Japan   JPN 1850157
9    134.001    JPN     JPN          4 Japan    Japan   JPN 1860834
10   132.916    JPN     JPN          4 Japan    Japan   JPN 1864226
         gn_name  gns_id      gns_name gn_level gn_region gn_a1_code region_sub
1  Kagoshima-ken -231556 Kagoshima-ken        1      &lt;NA&gt;      JP.18       &lt;NA&gt;
2       Oita-ken -240089      Oita-ken        1      &lt;NA&gt;      JP.30       &lt;NA&gt;
3    Fukuoka-ken -227382   Fukuoka-ken        1      &lt;NA&gt;      JP.07       &lt;NA&gt;
4       Saga-ken -241905      Saga-ken        1      &lt;NA&gt;      JP.33       &lt;NA&gt;
5   Nagasaki-ken -237758  Nagasaki-ken        1      &lt;NA&gt;      JP.27       &lt;NA&gt;
6   Kumamoto-ken -234759  Kumamoto-ken        1      &lt;NA&gt;      JP.21       &lt;NA&gt;
7   Miyazaki-ken -236958  Miyazaki-ken        1      &lt;NA&gt;      JP.25       &lt;NA&gt;
8  Tokushima-ken -246216 Tokushima-ken        1      &lt;NA&gt;      JP.39       &lt;NA&gt;
9     Kagawa-ken -231546    Kagawa-ken        1      &lt;NA&gt;      JP.17       &lt;NA&gt;
10     Ehime-ken -227007     Ehime-ken        1      &lt;NA&gt;      JP.05       &lt;NA&gt;
   sub_code gns_level gns_lang gns_adm1 gns_region min_label max_label min_zoom
1      &lt;NA&gt;         1      jpn     JA18       &lt;NA&gt;         7        11        3
2      &lt;NA&gt;         1      jpn     JA30       &lt;NA&gt;         7        11        3
3      &lt;NA&gt;         1      jpn     JA07       &lt;NA&gt;         7        11        3
4      &lt;NA&gt;         1      jpn     JA33       &lt;NA&gt;         7        11        3
5      &lt;NA&gt;         1      jpn     JA27       &lt;NA&gt;         7        11        3
6      &lt;NA&gt;         1      jpn     JA21       &lt;NA&gt;         7        11        3
7      &lt;NA&gt;         1      jpn     JA25       &lt;NA&gt;         7        11        3
8      &lt;NA&gt;         1      jpn     JA39       &lt;NA&gt;         7        11        3
9      &lt;NA&gt;         1      jpn     JA17       &lt;NA&gt;         7        11        3
10     &lt;NA&gt;         1      jpn     JA05       &lt;NA&gt;         7        11        3
   wikidataid name_ar name_bn             name_de              name_en
1      Q15701    &lt;NA&gt;    &lt;NA&gt; Präfektur Kagoshima Kagoshima Prefecture
2     Q133924    &lt;NA&gt;    &lt;NA&gt;      Präfektur Oita      Oita Prefecture
3     Q123258    &lt;NA&gt;    &lt;NA&gt;   Präfektur Fukuoka   Fukuoka Prefecture
4     Q160420    &lt;NA&gt;    &lt;NA&gt;      Präfektur Saga      Saga Prefecture
5     Q169376    &lt;NA&gt;    &lt;NA&gt;  Präfektur Nagasaki  Nagasaki Prefecture
6     Q130308    &lt;NA&gt;    &lt;NA&gt;  Präfektur Kumamoto  Kumamoto Prefecture
7     Q130300    &lt;NA&gt;    &lt;NA&gt;  Präfektur Miyazaki  Miyazaki Prefecture
8     Q160734    &lt;NA&gt;    &lt;NA&gt; Präfektur Tokushima Tokushima Prefecture
9     Q161454    &lt;NA&gt;    &lt;NA&gt;    Präfektur Kagawa    Kagawa Prefecture
10    Q123376    &lt;NA&gt;    &lt;NA&gt;     Präfektur Ehime     Ehime Prefecture
                   name_es                 name_fr name_el name_hi
1  Prefectura de Kagoshima Préfecture de Kagoshima    &lt;NA&gt;    &lt;NA&gt;
2       Prefectura de Oita       Préfecture d'Oita    &lt;NA&gt;    &lt;NA&gt;
3    Prefectura de Fukuoka   Préfecture de Fukuoka    &lt;NA&gt;    &lt;NA&gt;
4       Prefectura de Saga      Préfecture de Saga    &lt;NA&gt;    &lt;NA&gt;
5   Prefectura de Nagasaki  Préfecture de Nagasaki    &lt;NA&gt;    &lt;NA&gt;
6   Prefectura de Kumamoto  Préfecture de Kumamoto    &lt;NA&gt;    &lt;NA&gt;
7   Prefectura de Miyazaki  Préfecture de Miyazaki    &lt;NA&gt;    &lt;NA&gt;
8  Prefectura de Tokushima Préfecture de Tokushima    &lt;NA&gt;    &lt;NA&gt;
9     Prefectura de Kagawa    Préfecture de Kagawa    &lt;NA&gt;    &lt;NA&gt;
10     Prefectura de Ehime      Préfecture d'Ehime    &lt;NA&gt;    &lt;NA&gt;
                name_hu             name_id                 name_it name_ja
1   Kagosima prefektúra Prefektur Kagoshima prefettura di Kagoshima    &lt;NA&gt;
2       Óita prefektúra      Prefektur Oita      prefettura di Oita    &lt;NA&gt;
3    Fukuoka prefektúra   Prefektur Fukuoka   prefettura di Fukuoka    &lt;NA&gt;
4      Szaga prefektúra      Prefektur Saga      Prefettura di Saga    &lt;NA&gt;
5  Nagaszaki prefektúra  Prefektur Nagasaki  prefettura di Nagasaki    &lt;NA&gt;
6   Kumamoto prefektúra  Prefektur Kumamoto  prefettura di Kumamoto    &lt;NA&gt;
7   Mijazaki prefektúra  Prefektur Miyazaki  prefettura di Miyazaki    &lt;NA&gt;
8   Tokusima prefektúra Prefektur Tokushima prefettura di Tokushima    &lt;NA&gt;
9     Kagava prefektúra    Prefektur Kagawa    prefettura di Kagawa    &lt;NA&gt;
10     Ehime prefektúra     Prefektur Ehime     prefettura di Ehime    &lt;NA&gt;
   name_ko   name_nl              name_pl   name_pt name_ru             name_sv
1     &lt;NA&gt; Kagoshima Prefektura Kagoshima Kagoshima    &lt;NA&gt; Kagoshima prefektur
2     &lt;NA&gt;      Oita      Prefektura Oita      Oita    &lt;NA&gt;      Oita prefektur
3     &lt;NA&gt;   Fukuoka   Prefektura Fukuoka   Fukuoka    &lt;NA&gt;   Fukuoka prefektur
4     &lt;NA&gt;      Saga      Prefektura Saga      Saga    &lt;NA&gt;      Saga prefektur
5     &lt;NA&gt;  Nagasaki  Prefektura Nagasaki  Nagasaki    &lt;NA&gt;  Nagasaki prefektur
6     &lt;NA&gt;  Kumamoto  Prefektura Kumamoto  Kumamoto    &lt;NA&gt;  Kumamoto prefektur
7     &lt;NA&gt;  Miyazaki  Prefektura Miyazaki  Miyazaki    &lt;NA&gt;  Miyazaki prefektur
8     &lt;NA&gt; Tokushima Prefektura Tokushima Tokushima    &lt;NA&gt; Tokushima prefektur
9     &lt;NA&gt;    Kagawa    Prefektura Kagawa    Kagawa    &lt;NA&gt;    Kagawa prefektur
10    &lt;NA&gt;     Ehime     Prefektura Ehime     Ehime    &lt;NA&gt;     Ehime prefektur
        name_tr   name_vi name_zh      ne_id Code     Name Density
1  Kagosima ili Kagoshima    &lt;NA&gt; 1159315225   46 鹿児島県   172.9
2          Oita      Oita    &lt;NA&gt; 1159311905   44   大分県   177.2
3       Fukuoka   Fukuoka    &lt;NA&gt; 1159311899   40   福岡県  1029.8
4          Saga      Saga    &lt;NA&gt; 1159311895   41   佐賀県   332.5
5      Nagasaki  Nagasaki    &lt;NA&gt; 1159315235   42   長崎県   317.7
6      Kumamoto  Kumamoto    &lt;NA&gt; 1159311901   43   熊本県   234.6
7      Miyazaki  Miyazaki    &lt;NA&gt; 1159311903   45   宮崎県   138.3
8     Tokushima Tokushima    &lt;NA&gt; 1159311909   36   徳島県   173.5
9        Kagawa    Kagawa    &lt;NA&gt; 1159311907   37   香川県   506.3
10        Ehime     Ehime    &lt;NA&gt; 1159311139   38   愛媛県   235.2
                         geometry
1  MULTIPOLYGON (((129.7832 31...
2  MULTIPOLYGON (((131.2009 33...
3  MULTIPOLYGON (((130.0363 33...
4  MULTIPOLYGON (((129.8145 33...
5  MULTIPOLYGON (((130.2041 32...
6  MULTIPOLYGON (((130.3446 32...
7  MULTIPOLYGON (((131.8723 32...
8  MULTIPOLYGON (((134.4424 34...
9  MULTIPOLYGON (((133.5919 34...
10 MULTIPOLYGON (((132.6399 32...</code></pre>
</div>
</div>
<p>　それではマッピングをしてみましょう。人口密度を5つのカテゴリーに順序付きfactor化してから、そのカテゴリーに応じて色塗りをします。</p>
<div class="cell" data-layout-align="center" data-hash="ggplot_intro4_cache/html/visual4-map18_92d8ee1f62c8cf7f923bc3426f5a4e1d">
<div class="sourceCode cell-code" id="cb93"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb93-1"><a href="#cb93-1"></a>Japan_Map <span class="sc">%&gt;%</span></span>
<span id="cb93-2"><a href="#cb93-2"></a>    <span class="fu">mutate</span>(<span class="at">Density2 =</span> <span class="fu">case_when</span>(Density <span class="sc">&gt;=</span> <span class="dv">3000</span> <span class="sc">~</span> <span class="st">"3000人以上"</span>,</span>
<span id="cb93-3"><a href="#cb93-3"></a>                                Density <span class="sc">&gt;=</span> <span class="dv">1000</span> <span class="sc">~</span> <span class="st">"1000人以上"</span>,</span>
<span id="cb93-4"><a href="#cb93-4"></a>                                Density <span class="sc">&gt;=</span>  <span class="dv">500</span> <span class="sc">~</span> <span class="st">"500人以上"</span>,</span>
<span id="cb93-5"><a href="#cb93-5"></a>                                Density <span class="sc">&gt;=</span>  <span class="dv">100</span> <span class="sc">~</span> <span class="st">"100人以上"</span>,</span>
<span id="cb93-6"><a href="#cb93-6"></a>                                <span class="cn">TRUE</span>            <span class="sc">~</span> <span class="st">"100人未満"</span>),</span>
<span id="cb93-7"><a href="#cb93-7"></a>           <span class="at">Density2 =</span> <span class="fu">factor</span>(Density2, <span class="at">ordered =</span> <span class="cn">TRUE</span>,</span>
<span id="cb93-8"><a href="#cb93-8"></a>                             <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"3000人以上"</span>, <span class="st">"1000人以上"</span>, <span class="st">"500人以上"</span>,</span>
<span id="cb93-9"><a href="#cb93-9"></a>                                        <span class="st">"100人以上"</span>, <span class="st">"100人未満"</span>))) <span class="sc">%&gt;%</span></span>
<span id="cb93-10"><a href="#cb93-10"></a>    <span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb93-11"><a href="#cb93-11"></a>    <span class="fu">geom_sf</span>(<span class="fu">aes</span>(<span class="at">fill =</span> Density2)) <span class="sc">+</span></span>
<span id="cb93-12"><a href="#cb93-12"></a>    <span class="fu">labs</span>(<span class="at">fill =</span> <span class="st">"人口密度 (km^2)"</span>) <span class="sc">+</span></span>
<span id="cb93-13"><a href="#cb93-13"></a>    <span class="fu">theme_void</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="ggplot_intro4_files/figure-html/visual4-map18-1.png" class="img-fluid figure-img" width="2100"></p>
</figure>
</div>
</div>
</div>
<p>　世界地図でも同じやり方でデータの結合が可能です。この場合はISO3コードかISO2コードがキー変数となります。ISO3コードは<code>iso_a3</code>、ISO2コードは<code>iso_a2</code>列に格納されています。他に使用可能なキー変数は<code>iso_n3</code>であり、こちらは各国を識別する3桁の数字となります。</p>
</section>
<section id="日本地図特定の都道府県" class="level3">
<h3 class="anchored" data-anchor-id="日本地図特定の都道府県">日本地図（特定の都道府県）</h3>
<p>　また日本地図のマッピングですが、今回は市区町村レベルまで見てみましょう。<code>ne_states()</code>では市区町村までマッピングすることはできませんので、今回は徳島大学の<a href="https://twitter.com/u_ribo">瓜生真也</a>先生が公開しました{jpndistrict}を使います。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb94"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb94-1"><a href="#cb94-1"></a>pacman<span class="sc">::</span><span class="fu">p_load_gh</span>(<span class="st">"uribo/jpndistrict"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>　今回は大阪府の地図を出力してみましょう。特定の都道府県の地図を読み込むためには<code>jpn_pref()</code>関数を使用します。都道府県は<code>pref_code</code>または<code>admin_name</code>で指定します。大阪のコードは27であるため、<code>pref_code = 27</code>でも良いですし、<code>admin_name = "大阪府"</code>でも同じです。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb95"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb95-1"><a href="#cb95-1"></a><span class="co"># Osaka_map &lt;- jpn_pref(admin_name = "大阪府") でも同じ</span></span>
<span id="cb95-2"><a href="#cb95-2"></a>Osaka_map <span class="ot">&lt;-</span> <span class="fu">jpn_pref</span>(<span class="at">pref_code =</span> <span class="dv">27</span>)</span>
<span id="cb95-3"><a href="#cb95-3"></a></span>
<span id="cb95-4"><a href="#cb95-4"></a><span class="fu">class</span>(Osaka_map)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "sf"         "tbl_df"     "tbl"        "data.frame"</code></pre>
</div>
</div>
<p>　プロットの方法は同じです。</p>
<div class="cell" data-layout-align="center" data-hash="ggplot_intro4_cache/html/visual4-map21_506880e2a94b9d9e81b4dc400c5c556a">
<div class="sourceCode cell-code" id="cb97"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb97-1"><a href="#cb97-1"></a>Osaka_map <span class="sc">%&gt;%</span></span>
<span id="cb97-2"><a href="#cb97-2"></a>  <span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb97-3"><a href="#cb97-3"></a>  <span class="fu">geom_sf</span>() <span class="sc">+</span></span>
<span id="cb97-4"><a href="#cb97-4"></a>  <span class="fu">theme_minimal</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="ggplot_intro4_files/figure-html/visual4-map21-1.png" class="img-fluid figure-img" width="2100"></p>
</figure>
</div>
</div>
</div>
<p>　ここでもデータの結合&amp;マッピングが可能です。大阪府内自治体の人口と学生数が格納された<a href="data/Osaka_Student.csv">データ</a>を読み込んでみましょう。こちらは2015年国勢調査の結果から取得したデータです。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb98"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb98-1"><a href="#cb98-1"></a>Osaka_Student <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">"data/Osaka_Student.csv"</span>)</span>
<span id="cb98-2"><a href="#cb98-2"></a></span>
<span id="cb98-3"><a href="#cb98-3"></a>Osaka_Student</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 75 × 4
    Code Name                Pop Student
   &lt;dbl&gt; &lt;chr&gt;             &lt;dbl&gt;   &lt;dbl&gt;
 1 27000 大阪府          8839469  438901
 2 27100 大阪市          2691185  104208
 3 27102 大阪市 都島区    104727    3889
 4 27103 大阪市 福島区     72484    2448
 5 27104 大阪市 此花区     66656    2478
 6 27106 大阪市 西区       92430    2633
 7 27107 大阪市 港区       82035    3072
 8 27108 大阪市 大正区     65141    2627
 9 27109 大阪市 天王寺区   75729    3480
10 27111 大阪市 浪速区     69766    1409
# ℹ 65 more rows</code></pre>
</div>
</div>
<p>　各市区町村にもコードが指定されており、<code>Osaka_Student</code>では<code>Code</code>列、<code>Osaka_map</code>では<code>citi_code</code>列となります。<code>Osaka_map</code>の<code>city_code</code>は文字列であるため、こちらを数値型に変換し<code>Code</code>という名の列として追加しておきましょう。続いて、<code>Code</code>列をキー変数とし、2つのデータセットを結合します。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb100"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb100-1"><a href="#cb100-1"></a>Osaka_map <span class="ot">&lt;-</span> Osaka_map <span class="sc">%&gt;%</span></span>
<span id="cb100-2"><a href="#cb100-2"></a>    <span class="fu">mutate</span>(<span class="at">Code =</span> <span class="fu">as.numeric</span>(city_code))</span>
<span id="cb100-3"><a href="#cb100-3"></a></span>
<span id="cb100-4"><a href="#cb100-4"></a>Osaka_map <span class="ot">&lt;-</span> <span class="fu">left_join</span>(Osaka_map, Osaka_Student, <span class="at">by =</span> <span class="st">"Code"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>　最後にマッピングです。ここでは人口1万人当たり学生数を<code>Student_Ratio</code>という列として追加し、こちらの値に合わせて色塗りをしてみましょう。<code>scale_fill_gradient()</code>を使用し、人口1万人当たり学生数が少ないほど白、多いほど黒塗りします。</p>
<div class="cell" data-layout-align="center" data-hash="ggplot_intro4_cache/html/visual4-map24_52ea20fa0d5ea7ecbe4770e157de9bcb">
<div class="sourceCode cell-code" id="cb101"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb101-1"><a href="#cb101-1"></a>Osaka_map <span class="sc">%&gt;%</span></span>
<span id="cb101-2"><a href="#cb101-2"></a>  <span class="fu">mutate</span>(<span class="at">Student_Ratio =</span> Student <span class="sc">/</span> Pop <span class="sc">*</span> <span class="dv">10000</span>) <span class="sc">%&gt;%</span></span>
<span id="cb101-3"><a href="#cb101-3"></a>  <span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb101-4"><a href="#cb101-4"></a>  <span class="fu">geom_sf</span>(<span class="fu">aes</span>(<span class="at">fill =</span> Student_Ratio)) <span class="sc">+</span></span>
<span id="cb101-5"><a href="#cb101-5"></a>  <span class="fu">scale_fill_gradient</span>(<span class="at">low =</span> <span class="st">"white"</span>, <span class="at">high =</span> <span class="st">"black"</span>) <span class="sc">+</span></span>
<span id="cb101-6"><a href="#cb101-6"></a>  <span class="fu">labs</span>(<span class="at">fill =</span> <span class="st">"1万人当たり学生数 (人)"</span>) <span class="sc">+</span></span>
<span id="cb101-7"><a href="#cb101-7"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb101-8"><a href="#cb101-8"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"bottom"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="ggplot_intro4_files/figure-html/visual4-map24-1.png" class="img-fluid figure-img" width="2100"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="visual4-dag" class="level2">
<h2 class="anchored" data-anchor-id="visual4-dag">非巡回有向グラフ</h2>
<p>　近年、因果推論の界隈でよく登場する非巡回有向グラフ（DAG）ですが、「グラフ」からも分かるように、DAGの考え方に基づく因果推論の研究には多くの図が登場します。DAGを作図するには{ggplot2}のみでも可能ですが、{dagitty}パッケージでDAGの情報を含むオブジェクトを生成し、{ggdag}で作図した方が簡単です。以下の図はDAGの一例です。</p>
<div class="cell" data-layout-align="center" data-hash="ggplot_intro4_cache/html/visual4-dag1_acc1a43b500e02bdc6818119b0674dc7">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="ggplot_intro4_files/figure-html/visual4-dag1-1.png" class="img-fluid figure-img" width="2100"></p>
</figure>
</div>
</div>
</div>
<p>　ここでX、Y、Zはノード（node）と呼ばれ、それぞれのノードをつなぐ線のことをエッジ（edge）と呼びます。また、これらのエッジには方向があります（有向）。簡単に言うと原因と結果といった関係ですが、DAGを描く際は、各ノード間の関係を記述する必要があります。</p>
<p>　それではまず、以上の図を作ってみましょう。最初のステップとして{dagitty}と{ggdag}をインストールし、読み込みましょう。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb102"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb102-1"><a href="#cb102-1"></a>pacman<span class="sc">::</span><span class="fu">p_load</span>(dagitty, ggdag)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>　つづいて、DAGの情報を含むオブジェクトを作成します。使用する関数は<code>dagify()</code>であり、ここには<code>結果 ~ 原因</code>の形式で各ノード間の関係を記述します。先ほどの図では<code>X</code>は<code>Y</code>の原因（<code>X ~ Y</code>）、<code>Z</code>は<code>X</code>と<code>Y</code>の原因（<code>X ~ Z</code>と<code>Y ~ Z</code>）です。これらの情報を<code>dagify()</code>内で指定します。</p>
<div class="cell" data-layout-align="center" data-hash="ggplot_intro4_cache/html/visual4-dag3_e66076f980ef743a9ee219e1efdc3fe7">
<div class="sourceCode cell-code" id="cb103"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb103-1"><a href="#cb103-1"></a>DAG_data1 <span class="ot">&lt;-</span> <span class="fu">dagify</span>(X <span class="sc">~</span> Z,</span>
<span id="cb103-2"><a href="#cb103-2"></a>                    Y <span class="sc">~</span> Z,</span>
<span id="cb103-3"><a href="#cb103-3"></a>                    Y <span class="sc">~</span> X,</span>
<span id="cb103-4"><a href="#cb103-4"></a>                    <span class="at">exposure =</span> <span class="st">"X"</span>,</span>
<span id="cb103-5"><a href="#cb103-5"></a>                    <span class="at">outcome  =</span> <span class="st">"Y"</span>)</span>
<span id="cb103-6"><a href="#cb103-6"></a></span>
<span id="cb103-7"><a href="#cb103-7"></a>DAG_data1</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>dag {
X [exposure]
Y [outcome]
Z
X -&gt; Y
Z -&gt; X
Z -&gt; Y
}</code></pre>
</div>
</div>
<p>　<code>Y ~ X</code>と<code>Y ~ Z</code>は<code>Y ~ X + Z</code>とまとめることも可能です。これは「<code>Y</code>の原因は<code>X</code>と<code>Z</code>である」という意味であり、「<code>Y</code>の原因は<code>X</code>であり、<code>Y</code>の原因は<code>Z</code>である」と同じ意味です。また、DAGを作図する際、<code>dagify()</code>内に<code>exposure</code>と<code>outcome</code>は不要ですが、もし<code>adjustmentSets()</code>関数などを使って統制変数を特定したい場合は処置変数（<code>exposure</code>）と応答変数（<code>outcome</code>）にそれぞれ変数名を指定します。ちなみに、以上のコードは以下のように書くことも可能です。</p>
<div class="cell" data-layout-align="center" data-hash="ggplot_intro4_cache/html/visual4-dag4_e63e2ae5795a9d987fb3e5dd9ff46ad3">
<div class="sourceCode cell-code" id="cb105"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb105-1"><a href="#cb105-1"></a>DAG_data1 <span class="ot">&lt;-</span> <span class="fu">dagitty</span>(</span>
<span id="cb105-2"><a href="#cb105-2"></a>  <span class="st">"dag{</span></span>
<span id="cb105-3"><a href="#cb105-3"></a><span class="st">  X -&gt; Y</span></span>
<span id="cb105-4"><a href="#cb105-4"></a><span class="st">  X &lt;- Z -&gt; Y</span></span>
<span id="cb105-5"><a href="#cb105-5"></a><span class="st">  X [exposure]</span></span>
<span id="cb105-6"><a href="#cb105-6"></a><span class="st">  Y [outcome]</span></span>
<span id="cb105-7"><a href="#cb105-7"></a><span class="st">  }"</span>)</span>
<span id="cb105-8"><a href="#cb105-8"></a></span>
<span id="cb105-9"><a href="#cb105-9"></a>DAG_data1</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>dag {
X [exposure]
Y [outcome]
Z
X -&gt; Y
Z -&gt; X
Z -&gt; Y
}</code></pre>
</div>
</div>
<p>　格納された<code>DAG_data1</code>オブジェクトのクラスは<code>"dagitty"</code>です。<code>"dagitty"</code>の可視化には{ggdag}の<code>ggdag()</code>を使用します。</p>
<div class="cell" data-layout-align="center" data-hash="ggplot_intro4_cache/html/visual4-dag5_fecf0a913a00471d8428bd0fd678e766">
<div class="sourceCode cell-code" id="cb107"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb107-1"><a href="#cb107-1"></a>DAG_data1 <span class="sc">%&gt;%</span></span>
<span id="cb107-2"><a href="#cb107-2"></a>  <span class="fu">ggdag</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="ggplot_intro4_files/figure-html/visual4-dag5-1.png" class="img-fluid figure-img" width="2100"></p>
</figure>
</div>
</div>
</div>
<p>　DAGにおいて背景、軸の目盛り、ラベルは不要ですので、<code>theme_dag_blank()</code>テーマを指定して全て除去します。</p>
<div class="cell" data-layout-align="center" data-hash="ggplot_intro4_cache/html/visual4-dag6_a5d611c1d9fe28a910bd06909c2c7b38">
<div class="sourceCode cell-code" id="cb108"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb108-1"><a href="#cb108-1"></a>DAG_data1 <span class="sc">%&gt;%</span></span>
<span id="cb108-2"><a href="#cb108-2"></a>  <span class="fu">ggdag</span>() <span class="sc">+</span></span>
<span id="cb108-3"><a href="#cb108-3"></a>  <span class="fu">theme_dag_blank</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="ggplot_intro4_files/figure-html/visual4-dag6-1.png" class="img-fluid figure-img" width="2100"></p>
</figure>
</div>
</div>
</div>
<section id="ノードの位置を指定する" class="level3">
<h3 class="anchored" data-anchor-id="ノードの位置を指定する">ノードの位置を指定する</h3>
<p>　読者の多くは以上のグラフと異なるものが得られたかも知れません。ノード間の関係は同じはずですが、ノードの位置が異なるでしょう。また、同じコードを実行する度にノードの位置は変わります。以下ではノードの位置を固定する方法について紹介します。位置を指定するには<code>dagify()</code>内で<code>coords</code>引数に各ノードの情報が格納されたリスト型オブジェクトを指定する必要があります。リストの長さは2であり、それぞれの名前は<code>x</code>と<code>y</code>です。そしてリストの各要素にはベクトルが入ります。たとえば、ノード<code>X</code>の位置を (1, 1)、<code>Y</code>の位置を (3, 1)、<code>Z</code>の位置を (2, 2)に指定してみましょう。<code>dagify()</code>内で直接リストを書くことも可能ですが、コードの可読性が落ちるため、別途のオブジェクト（<code>DAG_Pos2</code>）として格納しておきます。</p>
<div class="cell" data-layout-align="center" data-hash="ggplot_intro4_cache/html/visual4-dag7_cb418bc407291d222a7222e02ac73424">
<div class="sourceCode cell-code" id="cb109"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb109-1"><a href="#cb109-1"></a>DAG_Pos2  <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">x =</span> <span class="fu">c</span>(<span class="at">X =</span> <span class="dv">1</span>, <span class="at">Y =</span> <span class="dv">3</span>, <span class="at">Z =</span> <span class="dv">2</span>),</span>
<span id="cb109-2"><a href="#cb109-2"></a>                  <span class="at">y =</span> <span class="fu">c</span>(<span class="at">X =</span> <span class="dv">1</span>, <span class="at">Y =</span> <span class="dv">1</span>, <span class="at">Z =</span> <span class="dv">2</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>　続いて、<code>dagify()</code>内で<code>coords</code>引数を追加し、ノードの位置情報が格納されている<code>DAG_Pos2</code>を指定します。</p>
<div class="cell" data-layout-align="center" data-hash="ggplot_intro4_cache/html/visual4-dag8_28c336254dd31bad73c0b9e413268765">
<div class="sourceCode cell-code" id="cb110"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb110-1"><a href="#cb110-1"></a>DAG_data2 <span class="ot">&lt;-</span> <span class="fu">dagify</span>(X <span class="sc">~</span> Z,</span>
<span id="cb110-2"><a href="#cb110-2"></a>                    Y <span class="sc">~</span> X <span class="sc">+</span> Z,</span>
<span id="cb110-3"><a href="#cb110-3"></a>                    <span class="at">exposure =</span> <span class="st">"X"</span>,</span>
<span id="cb110-4"><a href="#cb110-4"></a>                    <span class="at">outcome  =</span> <span class="st">"Y"</span>,</span>
<span id="cb110-5"><a href="#cb110-5"></a>                    <span class="at">coords   =</span> DAG_Pos2)</span>
<span id="cb110-6"><a href="#cb110-6"></a></span>
<span id="cb110-7"><a href="#cb110-7"></a>DAG_data2</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>dag {
X [exposure,pos="1.000,1.000"]
Y [outcome,pos="3.000,1.000"]
Z [pos="2.000,2.000"]
X -&gt; Y
Z -&gt; X
Z -&gt; Y
}</code></pre>
</div>
</div>
<p>　可視化の方法は同じです。</p>
<div class="cell" data-layout-align="center" data-hash="ggplot_intro4_cache/html/visual4-dag9_e851634eb05143789f5d8a806c1a7b31">
<div class="sourceCode cell-code" id="cb112"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb112-1"><a href="#cb112-1"></a>DAG_data2 <span class="sc">%&gt;%</span></span>
<span id="cb112-2"><a href="#cb112-2"></a>  <span class="fu">ggdag</span>() <span class="sc">+</span></span>
<span id="cb112-3"><a href="#cb112-3"></a>  <span class="fu">theme_dag_blank</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="ggplot_intro4_files/figure-html/visual4-dag9-1.png" class="img-fluid figure-img" width="2100"></p>
</figure>
</div>
</div>
</div>
<p>　以上の使い方だけでも、ほとんどのDAGは描けるでしょう。また、ノードを若干オシャレ（?）にするには、<code>ggdag()</code>内で<code>stylized = TRUE</code>を指定します。</p>
<div class="cell" data-layout-align="center" data-hash="ggplot_intro4_cache/html/visual4-dag10_afc6f6d2bad9b51cd355c05e42703dc7">
<div class="sourceCode cell-code" id="cb113"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb113-1"><a href="#cb113-1"></a>DAG_Pos3  <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">x =</span> <span class="fu">c</span>(<span class="at">X1 =</span> <span class="dv">3</span>, <span class="at">X2 =</span> <span class="dv">3</span>, <span class="at">X3 =</span> <span class="dv">1</span>, <span class="at">T =</span> <span class="dv">2</span>, <span class="at">Y =</span> <span class="dv">4</span>),</span>
<span id="cb113-2"><a href="#cb113-2"></a>                  <span class="at">y =</span> <span class="fu">c</span>(<span class="at">X1 =</span> <span class="dv">1</span>, <span class="at">X2 =</span> <span class="dv">2</span>, <span class="at">X3 =</span> <span class="dv">2</span>, <span class="at">T =</span> <span class="dv">3</span>, <span class="at">Y =</span> <span class="dv">3</span>))</span>
<span id="cb113-3"><a href="#cb113-3"></a></span>
<span id="cb113-4"><a href="#cb113-4"></a>DAG_data3 <span class="ot">&lt;-</span> <span class="fu">dagify</span>(Y  <span class="sc">~</span> T <span class="sc">+</span> X1 <span class="sc">+</span> X2,</span>
<span id="cb113-5"><a href="#cb113-5"></a>                    T  <span class="sc">~</span> X3,</span>
<span id="cb113-6"><a href="#cb113-6"></a>                    X2 <span class="sc">~</span> T <span class="sc">+</span>X1 <span class="sc">+</span> X3,</span>
<span id="cb113-7"><a href="#cb113-7"></a>                    <span class="at">exposure =</span> <span class="st">"T"</span>,</span>
<span id="cb113-8"><a href="#cb113-8"></a>                    <span class="at">outcome  =</span> <span class="st">"Y"</span>,</span>
<span id="cb113-9"><a href="#cb113-9"></a>                    <span class="at">coords   =</span> DAG_Pos3)</span>
<span id="cb113-10"><a href="#cb113-10"></a></span>
<span id="cb113-11"><a href="#cb113-11"></a>DAG_data3 <span class="sc">%&gt;%</span></span>
<span id="cb113-12"><a href="#cb113-12"></a>  <span class="fu">ggdag</span>(<span class="at">stylized =</span> <span class="cn">TRUE</span>) <span class="sc">+</span></span>
<span id="cb113-13"><a href="#cb113-13"></a>  <span class="fu">theme_dag_blank</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="ggplot_intro4_files/figure-html/visual4-dag10-1.png" class="img-fluid figure-img" width="2100"></p>
</figure>
</div>
</div>
</div>
<p>　可視化の話ではありませんが、<code>adjustmentSets()</code>関数を用いると、処置変数<code>T</code>の総効果（total effect）を推定するためにはどの変数を統制（調整）する必要があるかを調べることも可能です。</p>
<div class="cell" data-layout-align="center" data-hash="ggplot_intro4_cache/html/visual4-dag11_2e6f000e6df7c394ae037f9261b3b06b">
<div class="sourceCode cell-code" id="cb114"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb114-1"><a href="#cb114-1"></a><span class="fu">adjustmentSets</span>(DAG_data3, <span class="at">effect =</span> <span class="st">"total"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>{ X3 }</code></pre>
</div>
</div>
<p>　<code>X3</code>変数のみ統制すれば良いという結果が得られました。また、<code>T</code>から<code>Y</code>への直接効果（direct effect）の場合、<code>effect = "direct"</code>を指定します。</p>
<div class="cell" data-layout-align="center" data-hash="ggplot_intro4_cache/html/visual4-dag12_ea69dbcef60ed4edc21c620484ee7047">
<div class="sourceCode cell-code" id="cb116"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb116-1"><a href="#cb116-1"></a><span class="fu">adjustmentSets</span>(DAG_data3, <span class="at">effect =</span> <span class="st">"direct"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>{ X1, X2 }</code></pre>
</div>
</div>
<p>　<code>X1</code>と<code>X2</code>を統制する必要があることが分かりますね。</p>
</section>
</section>
<section id="visual4-bump" class="level2">
<h2 class="anchored" data-anchor-id="visual4-bump">バンプチャート</h2>
<p>　バンプチャート (bump chart)は順位の変化などを示す時に有効なグラフです。たとえば、G7構成国の新型コロナ感染者数の順位の変化を示すにはどうすれば良いでしょうか。そもそもどのような形式のデータが必要でしょうか。まずは必要なデータ形式を紹介したいと思います。</p>
<p>　まず、{ggplot2}によるバンプチャートの作成を支援する{ggbump}パッケージをインストールし、読み込みましょう<a href="#fn2" class="footnote-ref" id="fnref2" role="doc-noteref"><sup>2</sup></a>。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb118"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb118-1"><a href="#cb118-1"></a>pacman<span class="sc">::</span><span class="fu">p_load</span>(ggbump)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>　ここではG7構成国の100万人当り新型コロナ感染者数の順位がどのように変化したのかを2020年4月から7月まで1ヶ月単位で表したデータが必要です。データは以下のようなコードで作成しますが、<a href="https://github.com/JaehyunSong/RBook">本書のサポートページ</a>からもダウンロード可能です。</p>
<div class="cell" data-layout-align="center" data-hash="ggplot_intro4_cache/html/visual4-bump2_cb404733c8947d86a5add751017d6156">
<div class="sourceCode cell-code" id="cb119"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb119-1"><a href="#cb119-1"></a>Bump_df <span class="ot">&lt;-</span> <span class="fu">left_join</span>(COVID19_df, Country_df, <span class="at">by =</span> <span class="st">"Country"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb119-2"><a href="#cb119-2"></a>  <span class="fu">select</span>(Country, Date, Population, Confirmed_Total, G7) <span class="sc">%&gt;%</span></span>
<span id="cb119-3"><a href="#cb119-3"></a>  <span class="fu">separate</span>(Date, <span class="at">into =</span> <span class="fu">c</span>(<span class="st">"Year"</span>, <span class="st">"Month"</span>, <span class="st">"Day"</span>), <span class="at">sep =</span> <span class="st">"/"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb119-4"><a href="#cb119-4"></a>  <span class="fu">mutate</span>(<span class="at">Month =</span> <span class="fu">as.numeric</span>(Month)) <span class="sc">%&gt;%</span></span>
<span id="cb119-5"><a href="#cb119-5"></a>  <span class="fu">filter</span>(Month <span class="sc">&gt;=</span> <span class="dv">4</span>, G7 <span class="sc">==</span> <span class="dv">1</span>) <span class="sc">%&gt;%</span></span>
<span id="cb119-6"><a href="#cb119-6"></a>  <span class="fu">group_by</span>(Country, Month) <span class="sc">%&gt;%</span></span>
<span id="cb119-7"><a href="#cb119-7"></a>  <span class="fu">summarise</span>(<span class="at">Population            =</span> <span class="fu">mean</span>(Population),</span>
<span id="cb119-8"><a href="#cb119-8"></a>            <span class="at">New_Cases             =</span> <span class="fu">sum</span>(Confirmed_Total, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb119-9"><a href="#cb119-9"></a>            <span class="at">New_Cases_per_million =</span> New_Cases <span class="sc">/</span> Population <span class="sc">*</span> <span class="dv">1000000</span>,</span>
<span id="cb119-10"><a href="#cb119-10"></a>            <span class="at">.groups               =</span> <span class="st">"drop"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb119-11"><a href="#cb119-11"></a>  <span class="fu">select</span>(Country, Month, New_Cases_per_million)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-layout-align="center" data-hash="ggplot_intro4_cache/html/visual4-bump3_6393b9fbe35276e28924878206514565">
<div class="sourceCode cell-code" id="cb120"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb120-1"><a href="#cb120-1"></a>Bump_df <span class="ot">&lt;-</span> Bump_df <span class="sc">%&gt;%</span></span>
<span id="cb120-2"><a href="#cb120-2"></a>  <span class="fu">group_by</span>(Month) <span class="sc">%&gt;%</span></span>
<span id="cb120-3"><a href="#cb120-3"></a>  <span class="fu">mutate</span>(<span class="at">Rank =</span> <span class="fu">rank</span>(New_Cases_per_million, <span class="at">ties.method =</span> <span class="st">"random"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb120-4"><a href="#cb120-4"></a>  <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span></span>
<span id="cb120-5"><a href="#cb120-5"></a>  <span class="fu">select</span>(Country, Month, Rank, New_Cases_per_million)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>　必要なデータは以下のような形式です。ちなみにバンプチャートを作成するためには最後の<code>New_Cases_per_million</code>列 (100万人当り新型コロナ感染者数)は不要です。つまり、国名、月、順位のみで十分です。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb121"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb121-1"><a href="#cb121-1"></a><span class="co"># 以上のコードを省略し、加工済みのデータを読み込んでもOK</span></span>
<span id="cb121-2"><a href="#cb121-2"></a><span class="co"># Bump_df &lt;- read_csv("Data/Bumpchart.csv")</span></span>
<span id="cb121-3"><a href="#cb121-3"></a>Bump_df</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>　それでは{ggbump}が提供する<code>geom_bump()</code>幾何オブジェクトを使用し、簡単なバンプチャートを作成してみましょう。必要なマッピング要素は<code>x</code>と<code>y</code>、<code>color</code>です。<code>x</code>には時間を表す変数である<code>Month</code>を、<code>y</code>には順位を表す<code>Rank</code>をマッピングします。また、7本の線が出るため、月と順位、それぞれの値がどの国の値かを特定する必要があります。<code>groups</code>に国名である<code>Country</code>をマッピングしても線は引けますが、どの線がどの国かが分からなくなるため、<code>color</code>に<code>Country</code>をマッピングし、線の色分けをします。</p>
<div class="cell" data-layout-align="center" data-hash="ggplot_intro4_cache/html/visual4-bump5_a795498159c488063eaabeb78890808d">
<div class="sourceCode cell-code" id="cb122"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb122-1"><a href="#cb122-1"></a>Bump_df <span class="sc">%&gt;%</span></span>
<span id="cb122-2"><a href="#cb122-2"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> Month, <span class="at">y =</span> Rank, <span class="at">color =</span> Country)) <span class="sc">+</span></span>
<span id="cb122-3"><a href="#cb122-3"></a>  <span class="fu">geom_bump</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="ggplot_intro4_files/figure-html/visual4-bump5-1.png" class="img-fluid figure-img" width="2100"></p>
</figure>
</div>
</div>
</div>
<p>　これで最低限のバンプチャートはできましたが、もう少し見やすく、可愛くしてみましょう。今は線が細いのでややぶ厚めにします。これは<code>geom_bump()</code>レイヤーの<code>size</code>引数で指定可能です。また、各月に点を付けることによって、同時期における順位の比較をよりしやすくしてみましょう。これは散布図と同じであるため、<code>geom_point()</code>幾何オブジェクトを使用します。</p>
<div class="cell" data-layout-align="center" data-hash="ggplot_intro4_cache/html/visual4-bump6_5ae61275534c838e4094579876635212">
<div class="sourceCode cell-code" id="cb123"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb123-1"><a href="#cb123-1"></a>Bump_df <span class="sc">%&gt;%</span></span>
<span id="cb123-2"><a href="#cb123-2"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> Month, <span class="at">y =</span> Rank, <span class="at">color =</span> Country)) <span class="sc">+</span></span>
<span id="cb123-3"><a href="#cb123-3"></a>  <span class="fu">geom_point</span>(<span class="at">size =</span> <span class="dv">7</span>) <span class="sc">+</span></span>
<span id="cb123-4"><a href="#cb123-4"></a>  <span class="fu">geom_bump</span>(<span class="at">size =</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb123-5"><a href="#cb123-5"></a>  <span class="fu">theme_minimal</span>(<span class="at">base_size =</span> <span class="dv">14</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="ggplot_intro4_files/figure-html/visual4-bump6-1.png" class="img-fluid figure-img" width="2100"></p>
</figure>
</div>
</div>
</div>
<p>　これでだいぶ見やすくなりましたが、凡例における国名の順番がやや気になりますね。7月の時点において順位が最も高い国はアメリカ、最も低い国は日本ですが、凡例の順番はアルファベット順となっています。この凡例の順番を7月時点における<code>Rank</code>の値に合わせた方がより見やすいでしょう。ここで<a href="../../tutorial/R/dplyr_intro.html">dplyr入門</a>で紹介しました<code>fct_reorder2()</code>を使って<code>Country</code>変数の水準 (level)を7月時点における<code>Rank</code>の順位に合わせます。この場合、<code>Country</code>変数 (<code>.f = Country</code>)の水準を<code>Month</code>が (<code>.x = Month</code>)最も大きい (<code>.fun = last2</code>)時点における<code>Rank</code>の順番に合わせる (<code>.y = Rank</code>)こととなります。<code>fct_reorder2()</code>内の引数の順番の既定値は<code>.f</code>、<code>.x</code>、<code>.y</code>、<code>.fun</code>となります。</p>
<div class="cell" data-layout-align="center" data-hash="ggplot_intro4_cache/html/visual4-bump7_7fb65de3d08a67b1ec7976e329b60a55">
<div class="sourceCode cell-code" id="cb124"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb124-1"><a href="#cb124-1"></a>Bump_df <span class="sc">%&gt;%</span></span>
<span id="cb124-2"><a href="#cb124-2"></a>  <span class="fu">mutate</span>(<span class="at">Country =</span> <span class="fu">fct_reorder2</span>(Country, Month, Rank, last2)) <span class="sc">%&gt;%</span></span>
<span id="cb124-3"><a href="#cb124-3"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> Month, <span class="at">y =</span> Rank, <span class="at">color =</span> Country)) <span class="sc">+</span></span>
<span id="cb124-4"><a href="#cb124-4"></a>  <span class="fu">geom_point</span>(<span class="at">size =</span> <span class="dv">7</span>) <span class="sc">+</span></span>
<span id="cb124-5"><a href="#cb124-5"></a>  <span class="fu">geom_bump</span>(<span class="at">size =</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb124-6"><a href="#cb124-6"></a>  <span class="fu">theme_minimal</span>(<span class="at">base_size =</span> <span class="dv">14</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="ggplot_intro4_files/figure-html/visual4-bump7-1.png" class="img-fluid figure-img" width="2100"></p>
</figure>
</div>
</div>
</div>
<p>　最後に縦軸の目盛りラベルを付けます。上に行くほど順位が高くなりますので、1を7に、2を6に、…、7を1に変更します。また、図内のグリッドも不要ですので、<code>theme()</code>を使用し、グリッドを削除します (<code>panel.grid = element_blank()</code>)。</p>
<div class="cell" data-layout-align="center" data-hash="ggplot_intro4_cache/html/visual4-bump8_612e34057fa3ebff02485793205f5a81">
<div class="sourceCode cell-code" id="cb125"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb125-1"><a href="#cb125-1"></a>Bump_df <span class="sc">%&gt;%</span></span>
<span id="cb125-2"><a href="#cb125-2"></a>  <span class="fu">mutate</span>(<span class="at">Country =</span> <span class="fu">fct_reorder2</span>(Country, Month, Rank, last2)) <span class="sc">%&gt;%</span></span>
<span id="cb125-3"><a href="#cb125-3"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> Month, <span class="at">y =</span> Rank, <span class="at">color =</span> Country)) <span class="sc">+</span></span>
<span id="cb125-4"><a href="#cb125-4"></a>  <span class="fu">geom_point</span>(<span class="at">size =</span> <span class="dv">7</span>) <span class="sc">+</span></span>
<span id="cb125-5"><a href="#cb125-5"></a>  <span class="fu">geom_bump</span>(<span class="at">size =</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb125-6"><a href="#cb125-6"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">breaks =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">7</span>, <span class="at">labels =</span> <span class="dv">7</span><span class="sc">:</span><span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb125-7"><a href="#cb125-7"></a>  <span class="fu">theme_minimal</span>(<span class="at">base_size =</span> <span class="dv">14</span>) <span class="sc">+</span></span>
<span id="cb125-8"><a href="#cb125-8"></a>  <span class="fu">theme</span>(<span class="at">panel.grid =</span> <span class="fu">element_blank</span>())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="ggplot_intro4_files/figure-html/visual4-bump8-1.png" class="img-fluid figure-img" width="2100"></p>
</figure>
</div>
</div>
</div>
<p>　これでバンプチャートの完成です。このままでの良いかも知れませんが、もう少し手間を掛けることでより読みやすいグラフが作れます。たとえば、今のままだと「日本のトレンド」を確認したい場合、まず凡例から日本の色を確認し、その色に該当する点と線を見つけてトレンドを見る必要がありますね。もし、ここで図の左端と右端の点の横に国名を出力すると、凡例がなくても良いですし、4月の時点から日本のトレンドを確認することも、7月の時点から遡る形で日本のトレンドを確認することも可能かも知れません。</p>
<p>　図に文字列を追加するためには<code>geom_text()</code>幾何オブジェクトを使用します。マッピング要素は文字列の横軸上の位置 (<code>x</code>)、縦軸上の位置 (<code>y</code>)、そして出力する文字列 (<code>label</code>)です。左端に文字列を出力するのであれば、横軸上の位置は4 (= 4月)よりも若干左側が良いでしょう。ぴったり4になると、点と文字列が重なって読みにくくなりますね。縦軸上の位置は<strong>4月の時点</strong>での順位 (<code>Rank</code>)で、出力する文字列は国名 (<code>Country</code>)です。現在、使用しているデータは4月から7月までのデータですが、4月に限定したデータを使いたいので、<code>geom_text()</code>内に<code>data</code>引数を追加し、<code>Bump_df</code>から<code>Month</code>の値が4の行のみを抽出したデータを割り当てます (<code>data = filter(Bump_df, Month == 4</code>)、または<code>data = Bump_df %&gt;% filter(Month == 4)</code>)。右端についても同じです。横軸上の位置は7から右方向へずらし、使用するデータは7月のデータとなります。</p>
<p>　最後にもう一点調整が必要ですが、それは座標系です。図の座標系は<code>ggplot()</code>関数で使用するデータに基づきます。<code>Bump_df</code>の場合、横軸 (<code>Month</code>)は4から7です。しかし、文字列を追加した場合、文字列がすべて出力されないかも知れません。したがって、座標系を横方向に広める必要があります。今回は3から8までに調整します。座標系や文字列の位置調整は出力結果を見ながら、少しずつ調整していきましょう。</p>
<div class="cell" data-layout-align="center" data-hash="ggplot_intro4_cache/html/visual4-bump9_30241bfd187d30822d68dda37645ef6d">
<div class="sourceCode cell-code" id="cb126"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb126-1"><a href="#cb126-1"></a>Bump_df <span class="sc">%&gt;%</span></span>
<span id="cb126-2"><a href="#cb126-2"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> Month, <span class="at">y =</span> Rank, <span class="at">color =</span> Country)) <span class="sc">+</span></span>
<span id="cb126-3"><a href="#cb126-3"></a>  <span class="fu">geom_point</span>(<span class="at">size =</span> <span class="dv">7</span>) <span class="sc">+</span></span>
<span id="cb126-4"><a href="#cb126-4"></a>  <span class="fu">geom_bump</span>(<span class="at">size =</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb126-5"><a href="#cb126-5"></a>  <span class="co"># 4月の時点での行のみ抽出し、xはMonthより0.15分左方向、</span></span>
<span id="cb126-6"><a href="#cb126-6"></a>  <span class="co"># yはRankの値の位置に国名を出力する。揃える方向は右揃え (hjust = 1)</span></span>
<span id="cb126-7"><a href="#cb126-7"></a>  <span class="fu">geom_text</span>(<span class="at">data =</span> <span class="fu">filter</span>(Bump_df, Month <span class="sc">==</span> <span class="dv">4</span>),</span>
<span id="cb126-8"><a href="#cb126-8"></a>            <span class="fu">aes</span>(<span class="at">x =</span> Month <span class="sc">-</span> <span class="fl">0.15</span>, <span class="at">y =</span> Rank, <span class="at">label =</span> Country), <span class="at">hjust =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb126-9"><a href="#cb126-9"></a>  <span class="co"># 7月の時点での行のみ抽出し、xはMonthより0.15分右方向、</span></span>
<span id="cb126-10"><a href="#cb126-10"></a>  <span class="co"># yはRankの値の位置に国名を出力する。揃える方向は左揃え (hjust = 0)</span></span>
<span id="cb126-11"><a href="#cb126-11"></a>  <span class="fu">geom_text</span>(<span class="at">data =</span> <span class="fu">filter</span>(Bump_df, Month <span class="sc">==</span> <span class="dv">7</span>),</span>
<span id="cb126-12"><a href="#cb126-12"></a>            <span class="fu">aes</span>(<span class="at">x =</span> Month <span class="sc">+</span> <span class="fl">0.15</span>, <span class="at">y =</span> Rank, <span class="at">label =</span> Country), <span class="at">hjust =</span> <span class="dv">0</span>) <span class="sc">+</span></span>
<span id="cb126-13"><a href="#cb126-13"></a>  <span class="co"># 座標系の調整</span></span>
<span id="cb126-14"><a href="#cb126-14"></a>  <span class="fu">coord_cartesian</span>(<span class="at">xlim =</span> <span class="fu">c</span>(<span class="dv">3</span>, <span class="dv">8</span>)) <span class="sc">+</span></span>
<span id="cb126-15"><a href="#cb126-15"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">breaks =</span> <span class="dv">4</span><span class="sc">:</span><span class="dv">7</span>, <span class="at">labels =</span> <span class="dv">4</span><span class="sc">:</span><span class="dv">7</span>) <span class="sc">+</span></span>
<span id="cb126-16"><a href="#cb126-16"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">breaks =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">7</span>, <span class="at">labels =</span> <span class="dv">7</span><span class="sc">:</span><span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb126-17"><a href="#cb126-17"></a>  <span class="fu">labs</span>(<span class="at">y =</span> <span class="st">"Rank"</span>, <span class="at">x =</span> <span class="st">"Month"</span>) <span class="sc">+</span></span>
<span id="cb126-18"><a href="#cb126-18"></a>  <span class="fu">theme_minimal</span>(<span class="at">base_size =</span> <span class="dv">14</span>) <span class="sc">+</span></span>
<span id="cb126-19"><a href="#cb126-19"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"none"</span>,</span>
<span id="cb126-20"><a href="#cb126-20"></a>        <span class="at">panel.grid      =</span> <span class="fu">element_blank</span>())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="ggplot_intro4_files/figure-html/visual4-bump9-1.png" class="img-fluid figure-img" width="2100"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="visual4-alluvial" class="level2">
<h2 class="anchored" data-anchor-id="visual4-alluvial">沖積図</h2>
<p>　沖積図 (alluvial plot)は同じ対象を複数回観察したデータ（パネル・データなど）から変化を示すことに適したグラフです。たとえば、同じ回答者を対象に2回世論調査を実施し、1回目調査時の支持政党と2回目調査時の支持政党を変化を見ることも可能です。もし、変化が大きい場合は政党支持態度は弱いこととなりますし、変化が小さい場合は安定していると解釈できるでしょう。</p>
<p>　ここでは2020年の選挙と2021年の選挙における有権者の投票先の変化を沖積図で確認してみたいと思います。まずは、沖積図の作成に特化した{ggalluvial}パッケージをインストールし、読み込みます。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb127"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb127-1"><a href="#cb127-1"></a>pacman<span class="sc">::</span><span class="fu">p_load</span>(ggalluvial)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>　続きまして、実習用データを読み込みます。データは架空のデータです。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb128"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb128-1"><a href="#cb128-1"></a>Vote_2021 <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">"Data/Vote_20_21.csv"</span>)</span>
<span id="cb128-2"><a href="#cb128-2"></a></span>
<span id="cb128-3"><a href="#cb128-3"></a><span class="fu">head</span>(Vote_2021, <span class="dv">20</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 20 × 3
      ID Vote20 Vote21
   &lt;dbl&gt; &lt;chr&gt;  &lt;chr&gt; 
 1     1 棄権   棄権  
 2     2 政党A  政党A 
 3     3 政党A  政党A 
 4     4 政党B  政党A 
 5     5 政党B  政党C 
 6     6 政党A  政党C 
 7     7 その他 その他
 8     8 政党B  政党B 
 9     9 政党A  政党A 
10    10 政党C  政党C 
11    11 棄権   政党B 
12    12 政党B  政党A 
13    13 棄権   棄権  
14    14 政党B  政党B 
15    15 政党C  政党C 
16    16 DK     政党C 
17    17 政党B  DK    
18    18 政党A  政党A 
19    19 政党A  政党A 
20    20 政党A  政党A </code></pre>
</div>
</div>
<table class="table">
<thead>
<tr class="header">
<th style="text-align: left;">変数名</th>
<th style="text-align: left;">説明</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;"><code>ID</code></td>
<td style="text-align: left;">回答者ID</td>
</tr>
<tr class="even">
<td style="text-align: left;"><code>Vote20</code></td>
<td style="text-align: left;">2020年選挙における当該回答者の投票先</td>
</tr>
<tr class="odd">
<td style="text-align: left;"><code>Vote21</code></td>
<td style="text-align: left;">2021年選挙における当該回答者の投票先</td>
</tr>
</tbody>
</table>
<p>　たとえば、1番目の回答者は2020年に棄権し、2021年も棄権したことを意味する。また、5番目の回答者は2020年に政党Bに投票し、2021年は政党Cに投票したことを意味する。続いて、このデータを{ggalluvial}に適した形式のデータに加工します。具体的には「2020年棄権、かつ2021年棄権」、「2020年棄権、かつ2021年政党Aへ投票」、…、「2020年政党Bへ投票、かつ2021年政党Aへ投票」のように全ての組み合わせに対し、該当するケース数を計算する必要があります。今回のデータだと、投票先はいずれも政党A、政党B、政党C、政党D、その他、棄権、DK (わからない)の7であるため、49パターンができます。それぞれのパターンに該当するケース数を計算するためには<code>Vote20</code>と<code>Vote21</code>でデータをグループ化し、ケース数を計算します。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb130"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb130-1"><a href="#cb130-1"></a>Vote_2021 <span class="ot">&lt;-</span> Vote_2021 <span class="sc">%&gt;%</span></span>
<span id="cb130-2"><a href="#cb130-2"></a>  <span class="fu">group_by</span>(Vote20, Vote21) <span class="sc">%&gt;%</span></span>
<span id="cb130-3"><a href="#cb130-3"></a>  <span class="fu">summarise</span>(<span class="at">Freq    =</span> <span class="fu">n</span>(),</span>
<span id="cb130-4"><a href="#cb130-4"></a>            <span class="at">.groups =</span> <span class="st">"drop"</span>)</span>
<span id="cb130-5"><a href="#cb130-5"></a></span>
<span id="cb130-6"><a href="#cb130-6"></a>Vote_2021</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 47 × 3
   Vote20 Vote21  Freq
   &lt;chr&gt;  &lt;chr&gt;  &lt;int&gt;
 1 DK     DK       111
 2 DK     その他     8
 3 DK     政党A    116
 4 DK     政党B     29
 5 DK     政党C     15
 6 DK     政党D      7
 7 DK     棄権      57
 8 その他 DK        18
 9 その他 その他    73
10 その他 政党A    121
# ℹ 37 more rows</code></pre>
</div>
</div>
<p>　2020年の調査で「わからない」と回答し、2021年の調査でも「わからない」と回答した回答者数は111名、2020年の調査で「わからない」と回答し、2021年の調査では「その他」と回答した回答者数は8名、…といったことが分かりますね。</p>
<p>　続いて、グラフを作成する前に投票先変数 (<code>Vote20</code>と<code>Vote21</code>)をfactor化します。可視化の際、投票先が出力される順番に決まりはありませんが、政党A、政党B、政党C、…、DKの順が自然かと思います。むろん、こちらは自分から見て分かりやいように順番を決めましょう。ただし、2変数における水準 (level)の順番は一致させた方が良いでしょう。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb132"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb132-1"><a href="#cb132-1"></a>Vote_2021 <span class="ot">&lt;-</span> Vote_2021 <span class="sc">%&gt;%</span></span>
<span id="cb132-2"><a href="#cb132-2"></a>  <span class="fu">mutate</span>(<span class="at">Vote20 =</span> <span class="fu">factor</span>(Vote20, <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"政党A"</span>, <span class="st">"政党B"</span>, <span class="st">"政党C"</span>, <span class="st">"政党D"</span>, </span>
<span id="cb132-3"><a href="#cb132-3"></a>                                            <span class="st">"その他"</span>, <span class="st">"棄権"</span>, <span class="st">"DK"</span>)),</span>
<span id="cb132-4"><a href="#cb132-4"></a>         <span class="at">Vote21 =</span> <span class="fu">factor</span>(Vote21, <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"政党A"</span>, <span class="st">"政党B"</span>, <span class="st">"政党C"</span>, <span class="st">"政党D"</span>, </span>
<span id="cb132-5"><a href="#cb132-5"></a>                                            <span class="st">"その他"</span>, <span class="st">"棄権"</span>, <span class="st">"DK"</span>)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>　それでは沖積図を描いてみましょう。使用する幾何オブジェクトは<code>geom_alluvium()</code>と<code>geom_stratum()</code>です。必ずこの順番でレイヤーを重ねてください。マッピングは<code>y</code>、<code>axis1</code>、<code>axis2</code>に対し、<code>y</code>には当該パターン内のケース数 (<code>Freq</code>)、<code>axis1</code>は2009年の投票先 (<code>Vote20</code>)、<code>axis2</code>は2010年の投票先 (<code>Vote21</code>)を指定します<a href="#fn3" class="footnote-ref" id="fnref3" role="doc-noteref"><sup>3</sup></a>。これらのマッピングは<code>geom_stratum()</code>と<code>geom_alluvim()</code>共通であるため、<code>ggplot()</code>内でマッピングした方が効率的です。</p>
<div class="cell" data-layout-align="center" data-hash="ggplot_intro4_cache/html/visual4-alluvial5_16c0ecc98858394b32911fe556126c72">
<div class="sourceCode cell-code" id="cb133"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb133-1"><a href="#cb133-1"></a>Vote_2021 <span class="sc">%&gt;%</span></span>
<span id="cb133-2"><a href="#cb133-2"></a>    <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">y =</span> Freq, <span class="at">axis1 =</span> Vote20, <span class="at">axis2 =</span> Vote21)) <span class="sc">+</span></span>
<span id="cb133-3"><a href="#cb133-3"></a>    <span class="fu">geom_alluvium</span>() <span class="sc">+</span></span>
<span id="cb133-4"><a href="#cb133-4"></a>    <span class="fu">geom_stratum</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="ggplot_intro4_files/figure-html/visual4-alluvial5-1.png" class="img-fluid figure-img" width="2100"></p>
</figure>
</div>
</div>
</div>
<p>　何かの図は出てきましたが、これだけだと、それぞれの四角形がどの政党を示しているのかが分かりませんね。四角形内に政党名を出力するためには{ggplot2}内蔵の<code>geom_text()</code>を使用します。マッピング要素は<code>ggplot()</code>内でマッピングしたものに加え、<code>label</code>が必要ですが、ここでは<code>after_stat(stratum)</code>を指定します。そして、<code>aes()</code>のその側に<code>stat = "stratum"</code>を指定するだけです。もし、文字化けが生じる場合は、<code>geom_text()</code>内にフォントの指定が必要があり、<code>family</code>を使います (たとえば、<code>family = "HiraginoSans-W3"</code>など)。<code>theme_*()</code>内で<code>base_family</code>を指定した場合でも必要です。</p>
<div class="cell" data-layout-align="center" data-hash="ggplot_intro4_cache/html/visual4-alluvial6_1705a3825f7b211fcd5086dc5223917e">
<div class="sourceCode cell-code" id="cb134"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb134-1"><a href="#cb134-1"></a>Vote_2021 <span class="sc">%&gt;%</span></span>
<span id="cb134-2"><a href="#cb134-2"></a>    <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">y =</span> Freq, <span class="at">axis1 =</span> Vote20, <span class="at">axis2 =</span> Vote21)) <span class="sc">+</span></span>
<span id="cb134-3"><a href="#cb134-3"></a>    <span class="fu">geom_alluvium</span>() <span class="sc">+</span></span>
<span id="cb134-4"><a href="#cb134-4"></a>    <span class="fu">geom_stratum</span>() <span class="sc">+</span></span>
<span id="cb134-5"><a href="#cb134-5"></a>    <span class="fu">geom_text</span>(<span class="fu">aes</span>(<span class="at">label =</span> <span class="fu">after_stat</span>(stratum)), </span>
<span id="cb134-6"><a href="#cb134-6"></a>              <span class="at">stat =</span> <span class="st">"stratum"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="ggplot_intro4_files/figure-html/visual4-alluvial6-1.png" class="img-fluid figure-img" width="2100"></p>
</figure>
</div>
</div>
</div>
<p>　これで沖積図はとりあえず完成ですが、少し読みやすく加工してみましょう。たとえば、2020年に政党Aに投票した回答者における2021年の投票先の割合を見たいとした場合、<code>geom_alluvium()</code>内に<code>fill = Vote20</code>をマッピングします。これで帯に2020年の投票先ごとの色付けができます。</p>
<div class="cell" data-layout-align="center" data-hash="ggplot_intro4_cache/html/visual4-alluvial7_ad72da4b1894f7b1fdc9ffb68b8c00b0">
<div class="sourceCode cell-code" id="cb135"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb135-1"><a href="#cb135-1"></a>Vote_2021 <span class="sc">%&gt;%</span></span>
<span id="cb135-2"><a href="#cb135-2"></a>    <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">y =</span> Freq, <span class="at">axis1 =</span> Vote20, <span class="at">axis2 =</span> Vote21)) <span class="sc">+</span></span>
<span id="cb135-3"><a href="#cb135-3"></a>    <span class="fu">geom_alluvium</span>(<span class="fu">aes</span>(<span class="at">fill =</span> Vote20)) <span class="sc">+</span></span>
<span id="cb135-4"><a href="#cb135-4"></a>    <span class="fu">geom_stratum</span>() <span class="sc">+</span></span>
<span id="cb135-5"><a href="#cb135-5"></a>    <span class="fu">geom_text</span>(<span class="fu">aes</span>(<span class="at">label =</span> <span class="fu">after_stat</span>(stratum)), </span>
<span id="cb135-6"><a href="#cb135-6"></a>              <span class="at">stat =</span> <span class="st">"stratum"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="ggplot_intro4_files/figure-html/visual4-alluvial7-1.png" class="img-fluid figure-img" width="2100"></p>
</figure>
</div>
</div>
</div>
<p>　<code>fill = Vote21</code>とマッピングした場合は、感覚が変わります。実際にやってみましょう。</p>
<div class="cell" data-layout-align="center" data-hash="ggplot_intro4_cache/html/visual4-alluvial8_3b832c71b220d1fb54fd158747ec2b23">
<div class="sourceCode cell-code" id="cb136"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb136-1"><a href="#cb136-1"></a>Alluvial_Plot <span class="ot">&lt;-</span> Vote_2021 <span class="sc">%&gt;%</span></span>
<span id="cb136-2"><a href="#cb136-2"></a>    <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">y =</span> Freq, <span class="at">axis1 =</span> Vote20, <span class="at">axis2 =</span> Vote21)) <span class="sc">+</span></span>
<span id="cb136-3"><a href="#cb136-3"></a>    <span class="fu">geom_alluvium</span>(<span class="fu">aes</span>(<span class="at">fill =</span> Vote21)) <span class="sc">+</span></span>
<span id="cb136-4"><a href="#cb136-4"></a>    <span class="fu">geom_stratum</span>() <span class="sc">+</span></span>
<span id="cb136-5"><a href="#cb136-5"></a>    <span class="fu">geom_text</span>(<span class="fu">aes</span>(<span class="at">label =</span> <span class="fu">after_stat</span>(stratum)), </span>
<span id="cb136-6"><a href="#cb136-6"></a>              <span class="at">stat =</span> <span class="st">"stratum"</span>, <span class="at">family =</span> <span class="st">"HiraginoSans-W3"</span>)</span>
<span id="cb136-7"><a href="#cb136-7"></a></span>
<span id="cb136-8"><a href="#cb136-8"></a>Alluvial_Plot</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="ggplot_intro4_files/figure-html/visual4-alluvial8-1.png" class="img-fluid figure-img" width="2100"></p>
</figure>
</div>
</div>
</div>
<p>　この場合、2020年に政党Aに投票した人が2021年にどこに流れたかが分かりやすくなります。<code>Vote20</code>に色分けするか、<code>Vote21</code>に色分けするかは作成する人が決める問題であり、自分の主張・メッセージに適したマッピングをしましょう。</p>
<p>　最後に、図をもう少し加工してみましょう。まず、横軸に0.8、1.2、1.6、2.0となっている目盛りを修正し、1と2の箇所に「2020年選挙」と「2021年選挙」を出力します。これは<code>scale_x_continuous()</code>で調整可能です。そして、<code>theme_minimal()</code>で余計なものを排除したテーマを適用します。最後に<code>theme()</code>内で全ての凡例を削除 (<code>legend.position = "none"</code>)し、パネルのグリッド (<code>panel.grid</code>)と縦軸・横軸のタイトル (<code>axis.title</code>)、縦軸の目盛りラベル (<code>axis.text.y</code>)を削除 (<code>element_blank()</code>)します。</p>
<div class="cell" data-layout-align="center" data-hash="ggplot_intro4_cache/html/visual4-alluvial9_e04a5f0a58c9074257ee620eb645e74a">
<div class="sourceCode cell-code" id="cb137"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb137-1"><a href="#cb137-1"></a>Alluvial_Plot <span class="sc">+</span></span>
<span id="cb137-2"><a href="#cb137-2"></a>    <span class="fu">scale_x_continuous</span>(<span class="at">breaks =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>, </span>
<span id="cb137-3"><a href="#cb137-3"></a>                       <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"2020年選挙"</span>, <span class="st">"2021年選挙"</span>)) <span class="sc">+</span></span>
<span id="cb137-4"><a href="#cb137-4"></a>    <span class="fu">theme_minimal</span>(<span class="at">base_size =</span> <span class="dv">16</span>) <span class="sc">+</span></span>
<span id="cb137-5"><a href="#cb137-5"></a>    <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"none"</span>,</span>
<span id="cb137-6"><a href="#cb137-6"></a>          <span class="at">panel.grid =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb137-7"><a href="#cb137-7"></a>          <span class="at">axis.title =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb137-8"><a href="#cb137-8"></a>          <span class="at">axis.text.y =</span> <span class="fu">element_blank</span>())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="ggplot_intro4_files/figure-html/visual4-alluvial9-1.png" class="img-fluid figure-img" width="2100"></p>
</figure>
</div>
</div>
</div>
<p>　これでだいぶスッキリした沖積図が出来上がりました。</p>
</section>
<section id="visual4-tree" class="level2">
<h2 class="anchored" data-anchor-id="visual4-tree">ツリーマップ</h2>
<p>　ツリーマップ（tree map）は変数の値の大きさを長方形の面積として表すグラフです。全体におけるシェアを示す時に使う点で、円グラフの代替案の一つになります。円グラフは項目が多すぎると読みにくいデメリットがありますが、ツリーマップは項目が多い場合でも有効です。むろん、多すぎると読みにくいことは同じですので、注意が必要です。</p>
<p>　ツリーマップを作成するためには{treemapify}パッケージの<code>geom_treemap()</code>幾何オブジェクトを使用します。まず、{treemapify}をインストールし、読み込みます。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb138"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb138-1"><a href="#cb138-1"></a>pacman<span class="sc">::</span><span class="fu">p_load</span>(treemapify)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>　ここでは<code>Country_df</code>からアジア諸国の人口（<code>Population</code>）をツリーマップをして可視化したいと思います。<code>geom_treemap()</code>の場合、各長方形は面積の情報のみを持ちます。この面積の情報を<code>area</code>にマッピングします。</p>
<div class="cell" data-layout-align="center" data-hash="ggplot_intro4_cache/html/visual4-tree2_1884cd1a701337f4cf8e978ed1d0c3db">
<div class="sourceCode cell-code" id="cb139"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb139-1"><a href="#cb139-1"></a>Country_df <span class="sc">%&gt;%</span></span>
<span id="cb139-2"><a href="#cb139-2"></a>  <span class="fu">filter</span>(Continent <span class="sc">==</span> <span class="st">"Asia"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb139-3"><a href="#cb139-3"></a>  <span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb139-4"><a href="#cb139-4"></a>  <span class="fu">geom_treemap</span>(<span class="fu">aes</span>(<span class="at">area =</span> Population))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="ggplot_intro4_files/figure-html/visual4-tree2-1.png" class="img-fluid figure-img" width="2100"></p>
</figure>
</div>
</div>
</div>
<p>　これだけだと各長方形がどの国を指しているのかが分かりませんね。長方形の上に国名（<code>Country</code>）を追加するためには<code>geom_treemap_text()</code>幾何オブジェクトを使用します。マッピングは<code>area</code>と<code>label</code>に対し、それぞれ面積を表す<code>Population</code>と国名を表す<code>Country</code>を指定します。<code>area</code>は<code>geom_treemap()</code>と<code>geom_treemap_text()</code>両方で使われるので<code>ggplot()</code>の内部でマッピングしても問題ありません<a href="#fn4" class="footnote-ref" id="fnref4" role="doc-noteref"><sup>4</sup></a>。また、<code>aes()</code>の外側に<code>color = "white"</code>で文字を白に指定し、<code>place = "center"</code>で長方形の真ん中にラベルが付くようにします。</p>
<div class="cell" data-layout-align="center" data-hash="ggplot_intro4_cache/html/visual4-tree3_c9362f0fc1eaa4c7a73aed2982669616">
<div class="sourceCode cell-code" id="cb140"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb140-1"><a href="#cb140-1"></a>Country_df <span class="sc">%&gt;%</span></span>
<span id="cb140-2"><a href="#cb140-2"></a>  <span class="fu">filter</span>(Continent <span class="sc">==</span> <span class="st">"Asia"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb140-3"><a href="#cb140-3"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">area =</span> Population)) <span class="sc">+</span></span>
<span id="cb140-4"><a href="#cb140-4"></a>  <span class="fu">geom_treemap</span>() <span class="sc">+</span></span>
<span id="cb140-5"><a href="#cb140-5"></a>  <span class="fu">geom_treemap_text</span>(<span class="fu">aes</span>(<span class="at">label =</span> Country), <span class="at">color =</span> <span class="st">"white"</span>, <span class="at">place =</span> <span class="st">"center"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="ggplot_intro4_files/figure-html/visual4-tree3-1.png" class="img-fluid figure-img" width="2100"></p>
</figure>
</div>
</div>
</div>
<p>　これでツリーマップが完成しました。インドと中国の存在感がかなり大きいですね。更にラベルのサイズを長方形に合わせると、その存在感をより高めることができます。ラベルの大きさを長方形に合わせるには<code>geom_treepmap_text()</code>の内部に<code>grow = TRUE</code>を指定します。</p>
<div class="cell" data-layout-align="center" data-hash="ggplot_intro4_cache/html/visual4-tree4_3885e3542ceb16cc6a8054b7abf0d385">
<div class="sourceCode cell-code" id="cb141"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb141-1"><a href="#cb141-1"></a>Country_df <span class="sc">%&gt;%</span></span>
<span id="cb141-2"><a href="#cb141-2"></a>  <span class="fu">filter</span>(Continent <span class="sc">==</span> <span class="st">"Asia"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb141-3"><a href="#cb141-3"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">area =</span> Population, <span class="at">label =</span> Country)) <span class="sc">+</span></span>
<span id="cb141-4"><a href="#cb141-4"></a>  <span class="fu">geom_treemap</span>() <span class="sc">+</span></span>
<span id="cb141-5"><a href="#cb141-5"></a>  <span class="fu">geom_treemap_text</span>(<span class="at">color =</span> <span class="st">"white"</span>, <span class="at">place =</span> <span class="st">"center"</span>,</span>
<span id="cb141-6"><a href="#cb141-6"></a>                    <span class="at">grow =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="ggplot_intro4_files/figure-html/visual4-tree4-1.png" class="img-fluid figure-img" width="2100"></p>
</figure>
</div>
</div>
</div>
<p>　ここで更に次元を追加するために、色塗りをしてみましょう。たとえば、G20加盟国か否かで色分けをしたい場合、<code>fill</code>に<code>G20</code>をマッピングします。ただし、今のままだと<code>G20</code>は連続変数扱いになりますので、character型、またはfactor型に変換します。</p>
<div class="cell" data-layout-align="center" data-hash="ggplot_intro4_cache/html/visual4-tree5_5fd10e2cc540f12365fac063e0154361">
<div class="sourceCode cell-code" id="cb142"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb142-1"><a href="#cb142-1"></a>Country_df <span class="sc">%&gt;%</span></span>
<span id="cb142-2"><a href="#cb142-2"></a>  <span class="fu">mutate</span>(<span class="at">G20 =</span> <span class="fu">if_else</span>(G20 <span class="sc">==</span> <span class="dv">1</span>, <span class="st">"Member"</span>, <span class="st">"Non-member"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb142-3"><a href="#cb142-3"></a>  <span class="fu">filter</span>(Continent <span class="sc">==</span> <span class="st">"Asia"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb142-4"><a href="#cb142-4"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">area =</span> Population, <span class="at">fill =</span> G20,</span>
<span id="cb142-5"><a href="#cb142-5"></a>             <span class="at">label =</span> Country)) <span class="sc">+</span></span>
<span id="cb142-6"><a href="#cb142-6"></a>  <span class="fu">geom_treemap</span>() <span class="sc">+</span></span>
<span id="cb142-7"><a href="#cb142-7"></a>  <span class="fu">geom_treemap_text</span>(<span class="at">color =</span> <span class="st">"white"</span>, <span class="at">place =</span> <span class="st">"centre"</span>,</span>
<span id="cb142-8"><a href="#cb142-8"></a>                    <span class="at">grow =</span> <span class="cn">TRUE</span>) <span class="sc">+</span></span>
<span id="cb142-9"><a href="#cb142-9"></a>  <span class="fu">labs</span>(<span class="at">fill =</span> <span class="st">"G20"</span>) <span class="sc">+</span></span>
<span id="cb142-10"><a href="#cb142-10"></a>  <span class="fu">ggtitle</span>(<span class="st">"Population in Asia"</span>) <span class="sc">+</span></span>
<span id="cb142-11"><a href="#cb142-11"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"bottom"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="ggplot_intro4_files/figure-html/visual4-tree5-1.png" class="img-fluid figure-img" width="2100"></p>
</figure>
</div>
</div>
</div>
<p>　色塗りは連続変数に対して行うことも可能です。ここでは2018年人間開発指数（<code>HDI_2108</code>）の値に応じて色塗りをしてみます。また、<code>HDI_2018</code>が低い（<code>low</code>）と<span style="color:#CD3333;"><strong>brown3</strong></span>、高い（<code>high</code>）と<span style="color:#6495ED;"><strong>cornflowerblue</strong></span>色にします。真ん中の値（<code>midpoint</code>）は0.7とし、色（<code>mid</code>）は<span style="color:#FFF8DC;background-color:#7F7F7F;"><strong>cornsilk</strong></span>を使います。</p>
<p>　連続変数でマッピングされた色塗り（<code>fill</code>）の調整には<code>scale_fill_gradient()</code>、または<code>scale_fill_gradient2()</code>を使います。前者は中間点なし、後者は中間点ありです。これらの使い方は<a href="../../tutorial/R/ggplot_intro3.html">応用編</a>で紹介しました<code>scale_color_gradient()</code>と同じです。</p>
<div class="cell" data-layout-align="center" data-hash="ggplot_intro4_cache/html/visual4-tree6_cf8e757fa24b21d7731d2b768952ce98">
<div class="sourceCode cell-code" id="cb143"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb143-1"><a href="#cb143-1"></a>Country_df <span class="sc">%&gt;%</span></span>
<span id="cb143-2"><a href="#cb143-2"></a>  <span class="fu">filter</span>(Continent <span class="sc">==</span> <span class="st">"Asia"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb143-3"><a href="#cb143-3"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">area =</span> Population, <span class="at">fill =</span> HDI_2018,</span>
<span id="cb143-4"><a href="#cb143-4"></a>             <span class="at">label =</span> Country)) <span class="sc">+</span></span>
<span id="cb143-5"><a href="#cb143-5"></a>  <span class="fu">geom_treemap</span>() <span class="sc">+</span></span>
<span id="cb143-6"><a href="#cb143-6"></a>  <span class="fu">geom_treemap_text</span>(<span class="at">color =</span> <span class="st">"white"</span>, <span class="at">place =</span> <span class="st">"centre"</span>,</span>
<span id="cb143-7"><a href="#cb143-7"></a>                    <span class="at">grow =</span> <span class="cn">TRUE</span>) <span class="sc">+</span></span>
<span id="cb143-8"><a href="#cb143-8"></a>  <span class="fu">scale_fill_gradient2</span>(<span class="at">low =</span> <span class="st">"brown3"</span>,</span>
<span id="cb143-9"><a href="#cb143-9"></a>                       <span class="at">mid =</span> <span class="st">"cornsilk"</span>,</span>
<span id="cb143-10"><a href="#cb143-10"></a>                       <span class="at">high =</span> <span class="st">"cornflowerblue"</span>,</span>
<span id="cb143-11"><a href="#cb143-11"></a>                       <span class="at">midpoint =</span> <span class="fl">0.7</span>) <span class="sc">+</span></span>
<span id="cb143-12"><a href="#cb143-12"></a>  <span class="fu">labs</span>(<span class="at">fill =</span> <span class="st">"UN Human Development Index (2018)"</span>) <span class="sc">+</span></span>
<span id="cb143-13"><a href="#cb143-13"></a>  <span class="fu">ggtitle</span>(<span class="st">"Population in Asia"</span>) <span class="sc">+</span></span>
<span id="cb143-14"><a href="#cb143-14"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"bottom"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="ggplot_intro4_files/figure-html/visual4-tree6-1.png" class="img-fluid figure-img" width="2100"></p>
</figure>
</div>
</div>
</div>
<p>　ちなみに以上の図を円グラフにすると以下のようになります（国名は人口の割合が2.5%を超える国のみ表示）。ツリーマップと比較してかなり読みにくいことが分かります。</p>
<div class="cell" data-layout-align="center" data-hash="ggplot_intro4_cache/html/visual4-tree7_8323cdc383f2327e2439cb81806e2ae8">
<div class="sourceCode cell-code" id="cb144"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb144-1"><a href="#cb144-1"></a>Country_df <span class="sc">%&gt;%</span></span>
<span id="cb144-2"><a href="#cb144-2"></a>  <span class="fu">filter</span>(Continent <span class="sc">==</span> <span class="st">"Asia"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb144-3"><a href="#cb144-3"></a>  <span class="fu">arrange</span>(Population) <span class="sc">%&gt;%</span></span>
<span id="cb144-4"><a href="#cb144-4"></a>  <span class="fu">mutate</span>(<span class="at">Prop        =</span> Population <span class="sc">/</span> <span class="fu">sum</span>(Population) <span class="sc">*</span> <span class="dv">100</span>,</span>
<span id="cb144-5"><a href="#cb144-5"></a>         <span class="at">LabelY      =</span> <span class="dv">100</span> <span class="sc">-</span> (<span class="fu">cumsum</span>(Prop) <span class="sc">-</span> <span class="fl">0.5</span> <span class="sc">*</span> Prop),</span>
<span id="cb144-6"><a href="#cb144-6"></a>         <span class="at">CountryName =</span> <span class="fu">if_else</span>(Prop <span class="sc">&lt;</span> <span class="fl">2.5</span>, <span class="st">""</span>, Country),</span>
<span id="cb144-7"><a href="#cb144-7"></a>         <span class="at">Country     =</span> <span class="fu">fct_inorder</span>(Country)) <span class="sc">%&gt;%</span></span>
<span id="cb144-8"><a href="#cb144-8"></a>  <span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb144-9"><a href="#cb144-9"></a>  <span class="fu">geom_bar</span>(<span class="fu">aes</span>(<span class="at">x =</span> <span class="dv">1</span>, <span class="at">y =</span> Prop, <span class="at">group =</span> Country, <span class="at">fill =</span> HDI_2018), </span>
<span id="cb144-10"><a href="#cb144-10"></a>           <span class="at">color =</span> <span class="st">"black"</span>, <span class="at">stat =</span> <span class="st">"identity"</span>, <span class="at">width =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb144-11"><a href="#cb144-11"></a>  <span class="fu">geom_text</span>(<span class="fu">aes</span>(<span class="at">x =</span> <span class="dv">1</span>, <span class="at">y =</span> LabelY, <span class="at">label =</span> CountryName)) <span class="sc">+</span></span>
<span id="cb144-12"><a href="#cb144-12"></a>  <span class="fu">coord_polar</span>(<span class="st">"y"</span>, <span class="at">start =</span> <span class="dv">0</span>) <span class="sc">+</span></span>
<span id="cb144-13"><a href="#cb144-13"></a>  <span class="fu">scale_fill_gradient2</span>(<span class="at">low =</span> <span class="st">"brown3"</span>,</span>
<span id="cb144-14"><a href="#cb144-14"></a>                       <span class="at">mid =</span> <span class="st">"cornsilk"</span>,</span>
<span id="cb144-15"><a href="#cb144-15"></a>                       <span class="at">high =</span> <span class="st">"cornflowerblue"</span>,</span>
<span id="cb144-16"><a href="#cb144-16"></a>                       <span class="at">midpoint =</span> <span class="fl">0.7</span>) <span class="sc">+</span></span>
<span id="cb144-17"><a href="#cb144-17"></a>  <span class="fu">labs</span>(<span class="at">fill =</span> <span class="st">"UN Human Development Index (2018)"</span>) <span class="sc">+</span></span>
<span id="cb144-18"><a href="#cb144-18"></a>  <span class="fu">ggtitle</span>(<span class="st">"Population in Asia"</span>) <span class="sc">+</span></span>
<span id="cb144-19"><a href="#cb144-19"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb144-20"><a href="#cb144-20"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"bottom"</span>,</span>
<span id="cb144-21"><a href="#cb144-21"></a>        <span class="at">panel.grid =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb144-22"><a href="#cb144-22"></a>        <span class="at">axis.title =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb144-23"><a href="#cb144-23"></a>        <span class="at">axis.text  =</span> <span class="fu">element_blank</span>())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="ggplot_intro4_files/figure-html/visual4-tree7-1.png" class="img-fluid figure-img" width="2100"></p>
</figure>
</div>
</div>
</div>
<p>　ただし、ツリーマップが必ずしも円グラフより優れているとは言えません。たとえば、 <span class="citation" data-cites="Heer_Bostock:2010">Heer と Bostock (<a href="#ref-Heer_Bostock:2010" role="doc-biblioref">2010</a>)</span> の研究では円グラフとツリーマップを含む9種類のグラフを用い、被験者に大小関係を判断してもらう実験を行いましたが、ツリーマップ（四角形の面積）は円グラフ（角度）よりも判断までの所要時間が長いことが述べています。</p>
</section>
<section id="visual4-mosaic" class="level2">
<h2 class="anchored" data-anchor-id="visual4-mosaic">モザイクプロット</h2>
<p>モザイクプロットは2つの離散変数（おもに名目変数）の関係を可視化するために <span class="citation" data-cites="Hargian_Kleiner:1984">Hartigan と Kleiner (<a href="#ref-Hargian_Kleiner:1984" role="doc-biblioref">1984</a>)</span> が考案した図です。2つの名目変数間の関係を見る際によく使われるものはクロス表（クロス集計表）でしょう。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb145"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb145-1"><a href="#cb145-1"></a>pacman<span class="sc">::</span><span class="fu">p_load</span>(ggmosaic)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-layout-align="center" data-hash="ggplot_intro4_cache/html/visual4-mosaic2_01c29fc436a1459a4c77e34cce10aaed">
<div class="sourceCode cell-code" id="cb146"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb146-1"><a href="#cb146-1"></a>Mosaic_df <span class="ot">&lt;-</span> Country_df <span class="sc">%&gt;%</span></span>
<span id="cb146-2"><a href="#cb146-2"></a>    <span class="fu">select</span>(Country, Continent, <span class="at">Polity =</span> Polity_Type, <span class="at">PPP =</span> PPP_per_capita) <span class="sc">%&gt;%</span></span>
<span id="cb146-3"><a href="#cb146-3"></a>    <span class="fu">mutate</span>(<span class="at">Continent =</span> <span class="fu">factor</span>(Continent, </span>
<span id="cb146-4"><a href="#cb146-4"></a>                              <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"Africa"</span>, <span class="st">"America"</span>, <span class="st">"Asia"</span>,</span>
<span id="cb146-5"><a href="#cb146-5"></a>                                         <span class="st">"Europe"</span>, <span class="st">"Oceania"</span>)),</span>
<span id="cb146-6"><a href="#cb146-6"></a>           <span class="at">Polity    =</span> <span class="fu">factor</span>(Polity,</span>
<span id="cb146-7"><a href="#cb146-7"></a>                              <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"Autocracy"</span>, <span class="st">"Closed Anocracy"</span>,</span>
<span id="cb146-8"><a href="#cb146-8"></a>                                         <span class="st">"Open Anocracy"</span>, <span class="st">"Democracy"</span>,</span>
<span id="cb146-9"><a href="#cb146-9"></a>                                         <span class="st">"Full Democracy"</span>)),</span>
<span id="cb146-10"><a href="#cb146-10"></a>           <span class="at">PPP       =</span> <span class="fu">if_else</span>(PPP <span class="sc">&gt;=</span> <span class="dv">15000</span>, <span class="st">"High PPP"</span>, <span class="st">"Low PPP"</span>),</span>
<span id="cb146-11"><a href="#cb146-11"></a>           <span class="at">PPP       =</span> <span class="fu">factor</span>(PPP, <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"Low PPP"</span>, <span class="st">"High PPP"</span>))) <span class="sc">%&gt;%</span></span>
<span id="cb146-12"><a href="#cb146-12"></a>    <span class="fu">drop_na</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-layout-align="center" data-hash="ggplot_intro4_cache/html/visual4-mosaic3_05180967e504fe7930444f6201737ea9">
<div class="sourceCode cell-code" id="cb147"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb147-1"><a href="#cb147-1"></a><span class="fu">head</span>(Mosaic_df)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 4
  Country     Continent Polity          PPP     
  &lt;chr&gt;       &lt;fct&gt;     &lt;fct&gt;           &lt;fct&gt;   
1 Afghanistan Asia      Closed Anocracy Low PPP 
2 Albania     Europe    Democracy       Low PPP 
3 Algeria     Africa    Open Anocracy   Low PPP 
4 Angola      Africa    Closed Anocracy Low PPP 
5 Argentina   America   Democracy       High PPP
6 Armenia     Europe    Democracy       Low PPP </code></pre>
</div>
</div>
<p>　クロス表を作成する内蔵関数としては<code>table()</code>があります。2つの変数が必要となり、第一引数が行、第二引数が列を表します。</p>
<div class="cell" data-layout-align="center" data-hash="ggplot_intro4_cache/html/visual4-mosaic4_0a35e925bc98482f8f0f137a0ddc7f30">
<div class="sourceCode cell-code" id="cb149"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb149-1"><a href="#cb149-1"></a>Mosaic_Tab <span class="ot">&lt;-</span> <span class="fu">table</span>(Mosaic_df<span class="sc">$</span>Continent, Mosaic_df<span class="sc">$</span>Polity)</span>
<span id="cb149-2"><a href="#cb149-2"></a>Mosaic_Tab</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>         
          Autocracy Closed Anocracy Open Anocracy Democracy Full Democracy
  Africa          3              14            11        18              1
  America         0               1             4        16              5
  Asia           13               6             0        15              3
  Europe          2               1             2        16             20
  Oceania         0               0             2         0              2</code></pre>
</div>
</div>
<p>　この<code>Mosaic_Tab</code>のクラスは<code>"table"</code>ですが、<code>"table"</code>クラスのオブジェクトを<code>plot()</code>に渡すと別途のパッケージを使わずモザイクプロットを作成することができます。</p>
<div class="cell" data-layout-align="center" data-hash="ggplot_intro4_cache/html/visual4-mosaic6_054fd5a54f7cfaecd96ef8a5fe825311">
<div class="sourceCode cell-code" id="cb151"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb151-1"><a href="#cb151-1"></a><span class="fu">plot</span>(Mosaic_Tab)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="ggplot_intro4_files/figure-html/visual4-mosaic6-1.png" class="img-fluid figure-img" width="1500"></p>
</figure>
</div>
</div>
</div>
<p>　やや地味ではありますが、モザイクプロットが出来ました。ここからはより読みやすいモザイクプロットを作成するために{ggmosaic}パッケージの<code>geom_mosaic()</code>関数を使います。</p>
<p>　<code>geom_mosaic()</code>の場合、<code>x</code>のみのマッピングで十分です。ただし、特定の変数を指定するのではなく、<code>product(変数1, 変数2)</code>を<code>x</code>にマッピングする必要があります。<code>table()</code>関数同様、変数1は行、変数2は列です。また、欠損値が含まれている行がある場合は、<code>aes()</code>の外側に<code>na.rm = TRUE</code>を指定する必要があります。今回は<code>drop_na()</code>で欠損値をすべて除外しましたが、念の為に指定しておきます。</p>
<div class="cell" data-layout-align="center" data-hash="ggplot_intro4_cache/html/visual4-mosaic7_fbe40c18e2843da3ec2a6e4e9ac115b3">
<div class="sourceCode cell-code" id="cb152"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb152-1"><a href="#cb152-1"></a>Mosaic_df <span class="sc">%&gt;%</span></span>
<span id="cb152-2"><a href="#cb152-2"></a>    <span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb152-3"><a href="#cb152-3"></a>    <span class="fu">geom_mosaic</span>(<span class="fu">aes</span>(<span class="at">x =</span> <span class="fu">product</span>(Polity, Continent)), <span class="at">na.rm =</span> <span class="cn">TRUE</span>) <span class="sc">+</span></span>
<span id="cb152-4"><a href="#cb152-4"></a>    <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Continent"</span>, <span class="at">y =</span> <span class="st">"Polity Type"</span>) <span class="sc">+</span></span>
<span id="cb152-5"><a href="#cb152-5"></a>    <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb152-6"><a href="#cb152-6"></a>    <span class="fu">theme</span>(<span class="at">panel.grid =</span> <span class="fu">element_blank</span>())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: `unite_()` was deprecated in tidyr 1.2.0.
Please use `unite()` instead.
This warning is displayed once every 8 hours.
Call `lifecycle::last_lifecycle_warnings()` to see where this warning was generated.</code></pre>
</div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="ggplot_intro4_files/figure-html/visual4-mosaic7-1.png" class="img-fluid figure-img" width="1500"></p>
</figure>
</div>
</div>
</div>
<p>　これで出来上がりですが、<code>"table"</code>オブジェクトを<code>plot()</code>に渡した結果とあまり変わらないですね。続いて、この図を少し改良してみましょう。まずはセルの色分けですが、これは<code>fill</code>に色分けする変数をマッピングするだけです。今回は政治体制ごとにセルを色分けしましょう。また、文字を大きめにし、横軸の目盛りラベルを回転します。</p>
<div class="cell" data-layout-align="center" data-hash="ggplot_intro4_cache/html/visual4-mosaic8_3c979be1b46b2d643b68cfd763d4de24">
<div class="sourceCode cell-code" id="cb154"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb154-1"><a href="#cb154-1"></a>Mosaic_df <span class="sc">%&gt;%</span></span>
<span id="cb154-2"><a href="#cb154-2"></a>    <span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb154-3"><a href="#cb154-3"></a>    <span class="fu">geom_mosaic</span>(<span class="fu">aes</span>(<span class="at">x =</span> <span class="fu">product</span>(Polity, Continent), <span class="at">fill =</span> Polity), </span>
<span id="cb154-4"><a href="#cb154-4"></a>                <span class="at">na.rm =</span> <span class="cn">TRUE</span>) <span class="sc">+</span></span>
<span id="cb154-5"><a href="#cb154-5"></a>    <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Continent"</span>, <span class="at">y =</span> <span class="st">"Polity Type"</span>) <span class="sc">+</span></span>
<span id="cb154-6"><a href="#cb154-6"></a>    <span class="fu">theme_minimal</span>(<span class="at">base_size =</span> <span class="dv">16</span>) <span class="sc">+</span></span>
<span id="cb154-7"><a href="#cb154-7"></a>    <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"none"</span>,</span>
<span id="cb154-8"><a href="#cb154-8"></a>          <span class="at">panel.grid      =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb154-9"><a href="#cb154-9"></a>          <span class="at">axis.text.x     =</span> <span class="fu">element_text</span>(<span class="at">angle =</span> <span class="dv">90</span>, <span class="at">vjust =</span> <span class="fl">0.5</span>, <span class="at">hjust =</span> <span class="dv">1</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="ggplot_intro4_files/figure-html/visual4-mosaic8-1.png" class="img-fluid figure-img" width="1500"></p>
</figure>
</div>
</div>
</div>
<p>　次元を追加するためにはファセット分割を使います。たとえば、一人当たりPPP GDPの高低（<code>PPP</code>）でファセットを分割する場合、<code>facet_wrap(~PPP)</code>レイヤーを足すだけです。</p>
<div class="cell" data-layout-align="center" data-hash="ggplot_intro4_cache/html/visual4-mosaic9_e2b6059c1c5e6130ff2ba3b75ee221c0">
<div class="sourceCode cell-code" id="cb155"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb155-1"><a href="#cb155-1"></a>Mosaic_df <span class="sc">%&gt;%</span></span>
<span id="cb155-2"><a href="#cb155-2"></a>    <span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb155-3"><a href="#cb155-3"></a>    <span class="fu">geom_mosaic</span>(<span class="fu">aes</span>(<span class="at">x =</span> <span class="fu">product</span>(Polity, Continent), <span class="at">fill =</span> Polity), </span>
<span id="cb155-4"><a href="#cb155-4"></a>                <span class="at">na.rm =</span> <span class="cn">TRUE</span>) <span class="sc">+</span></span>
<span id="cb155-5"><a href="#cb155-5"></a>    <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Continent"</span>, <span class="at">y =</span> <span class="st">"Polity Type"</span>) <span class="sc">+</span></span>
<span id="cb155-6"><a href="#cb155-6"></a>    <span class="fu">facet_wrap</span>(<span class="sc">~</span>PPP, <span class="at">ncol =</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb155-7"><a href="#cb155-7"></a>    <span class="fu">theme_minimal</span>(<span class="at">base_size =</span> <span class="dv">16</span>) <span class="sc">+</span></span>
<span id="cb155-8"><a href="#cb155-8"></a>    <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"none"</span>,</span>
<span id="cb155-9"><a href="#cb155-9"></a>          <span class="at">panel.grid      =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb155-10"><a href="#cb155-10"></a>          <span class="at">axis.text.x     =</span> <span class="fu">element_text</span>(<span class="at">angle =</span> <span class="dv">90</span>, <span class="at">vjust =</span> <span class="fl">0.5</span>, <span class="at">hjust =</span> <span class="dv">1</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="ggplot_intro4_files/figure-html/visual4-mosaic9-1.png" class="img-fluid figure-img" width="2400"></p>
</figure>
</div>
</div>
</div>
<p>　ただし、一つ問題があります。それは目盛りラベルの位置です。例えば、右側の横軸目盛りラベルの場合、セルの位置とラベルの位置がずれています。これは2つのファセットが同じ目盛りを共有し、左側の方に合わせられたため生じるものです。よく見ると横軸も縦軸も目盛りラベルに位置が同じであることが分かります。これを解消するためには、<code>facet_wrap()</code>の内部に<code>scale = "free"</code>を指定します<a href="#fn5" class="footnote-ref" id="fnref5" role="doc-noteref"><sup>5</sup></a>。これは各ファセットが独自のスケールを有することを意味します。</p>
<div class="cell" data-layout-align="center" data-hash="ggplot_intro4_cache/html/visual4-mosaic10_f48635641e307fbf4db8a74408b1be27">
<div class="sourceCode cell-code" id="cb156"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb156-1"><a href="#cb156-1"></a>Mosaic_df <span class="sc">%&gt;%</span></span>
<span id="cb156-2"><a href="#cb156-2"></a>    <span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb156-3"><a href="#cb156-3"></a>    <span class="fu">geom_mosaic</span>(<span class="fu">aes</span>(<span class="at">x =</span> <span class="fu">product</span>(Polity, Continent), <span class="at">fill =</span> Polity), </span>
<span id="cb156-4"><a href="#cb156-4"></a>                <span class="at">na.rm =</span> <span class="cn">TRUE</span>) <span class="sc">+</span></span>
<span id="cb156-5"><a href="#cb156-5"></a>    <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Continent"</span>, <span class="at">y =</span> <span class="st">"Polity Type"</span>) <span class="sc">+</span></span>
<span id="cb156-6"><a href="#cb156-6"></a>    <span class="fu">facet_wrap</span>(<span class="sc">~</span>PPP, <span class="at">ncol =</span> <span class="dv">2</span>, <span class="at">scale =</span> <span class="st">"free"</span>) <span class="sc">+</span></span>
<span id="cb156-7"><a href="#cb156-7"></a>    <span class="fu">theme_minimal</span>(<span class="at">base_size =</span> <span class="dv">16</span>) <span class="sc">+</span></span>
<span id="cb156-8"><a href="#cb156-8"></a>    <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"none"</span>,</span>
<span id="cb156-9"><a href="#cb156-9"></a>          <span class="at">panel.grid      =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb156-10"><a href="#cb156-10"></a>          <span class="at">axis.text.x     =</span> <span class="fu">element_text</span>(<span class="at">angle =</span> <span class="dv">90</span>, <span class="at">vjust =</span> <span class="fl">0.5</span>, <span class="at">hjust =</span> <span class="dv">1</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="ggplot_intro4_files/figure-html/visual4-mosaic10-1.png" class="img-fluid figure-img" width="2400"></p>
</figure>
</div>
</div>
</div>
<p>　右側ファセットの横軸ラベルが重なってしまいましたが、これでとりあえず完成です。アフリカにおけるOpen AnocracyとClosed Anocracyの頻度が0であるため、これは仕方ありません。一つの対処方法としては以下のように縦軸目盛りを削除し、凡例で代替することが考えられます。</p>
<div class="cell" data-layout-align="center" data-hash="ggplot_intro4_cache/html/visual4-mosaic11_c280ef9cf8fdf65fd44d92759f14e122">
<div class="sourceCode cell-code" id="cb157"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb157-1"><a href="#cb157-1"></a>Mosaic_df <span class="sc">%&gt;%</span></span>
<span id="cb157-2"><a href="#cb157-2"></a>    <span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb157-3"><a href="#cb157-3"></a>    <span class="fu">geom_mosaic</span>(<span class="fu">aes</span>(<span class="at">x =</span> <span class="fu">product</span>(Polity, Continent), <span class="at">fill =</span> Polity), </span>
<span id="cb157-4"><a href="#cb157-4"></a>                <span class="at">na.rm =</span> <span class="cn">TRUE</span>) <span class="sc">+</span></span>
<span id="cb157-5"><a href="#cb157-5"></a>    <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Continent"</span>, <span class="at">y =</span> <span class="st">"Polity Type"</span>, <span class="at">fill =</span> <span class="st">"Polity Type"</span>) <span class="sc">+</span></span>
<span id="cb157-6"><a href="#cb157-6"></a>    <span class="fu">facet_wrap</span>(<span class="sc">~</span>PPP, <span class="at">ncol =</span> <span class="dv">2</span>, <span class="at">scale =</span> <span class="st">"free_x"</span>) <span class="sc">+</span></span>
<span id="cb157-7"><a href="#cb157-7"></a>    <span class="fu">theme_minimal</span>(<span class="at">base_size =</span> <span class="dv">16</span>) <span class="sc">+</span></span>
<span id="cb157-8"><a href="#cb157-8"></a>    <span class="fu">theme</span>(<span class="at">panel.grid  =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb157-9"><a href="#cb157-9"></a>          <span class="at">axis.text.y =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb157-10"><a href="#cb157-10"></a>          <span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">angle =</span> <span class="dv">90</span>, <span class="at">vjust =</span> <span class="fl">0.5</span>, <span class="at">hjust =</span> <span class="dv">1</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="ggplot_intro4_files/figure-html/visual4-mosaic11-1.png" class="img-fluid figure-img" width="2700"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="visual4-further" class="level2">
<h2 class="anchored" data-anchor-id="visual4-further">その他のグラフ</h2>
<p><a href="https://www.r-graph-gallery.com/">The R Graph Gallery</a>では本書で紹介できなかった様々な図のサンプルおよびコードを見ることができます。ここまで読み終わった方なら問題なくコードの意味が理解できるでしょう。{ggplot2}では作成できないグラフ（アニメーションや3次元図、インタラクティブなグラフ）についても、他のパッケージを利用した作成方法について紹介されているので、「こんな図が作りたいけど、作り方が分からん！」の時には、まず<a href="https://www.r-graph-gallery.com/">The R Graph Gallery</a>に目を通してみましょう。</p>



</section>


<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents" role="doc-bibliography"><h2 class="anchored quarto-appendix-heading">参考文献</h2><div id="refs" class="references csl-bib-body hanging-indent" role="list">
<div id="ref-Hargian_Kleiner:1984" class="csl-entry" role="listitem">
Hartigan, J. A., と Beat Kleiner. 1984. <span>「A Mosaic of Television Ratings」</span>. <em>The American Statistician</em> 38: 32–35.
</div>
<div id="ref-Heer_Bostock:2010" class="csl-entry" role="listitem">
Heer, Jeffrey, と Michael Bostock. 2010. <span>「Crowdsourcing Graphical Perception: Using Mechanical Turk to Assess Visualization Design」</span>. <em>Proceedings of the SIGCHI Conference on Human Factors in Computing Systems</em>.
</div>
</div></section><aside id="footnotes" class="footnotes footnotes-end-of-document" role="doc-endnotes"><h2 class="anchored quarto-appendix-heading">注</h2>

<ol>
<li id="fn1"><p>最後の<code>_c</code>はマッピングする変数（ここでは<code>HDI_2018</code>）が連続変数（<strong>c</strong>ontinuous）であることを意味します。<a href="#fnref1" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn2"><p>これから登場する<code>geom_bump()</code>幾何オブジェクトが使えるようになります。{ggbump}を使用せず、{ggplot2}が提供する<code>geom_line()</code>でも代替可能です。<code>geom_line()</code>の場合、直線で順位の変化が表示され、<code>geom_bump()</code>の場合は曲線で表示されます。丸い感じの図を好まない方なら、{ggbump}を読み込まず、<code>geom_bump()</code>を<code>geom_line()</code>に書き換えてください。<a href="#fnref2" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn3"><p>今回は2期間の変化を示していますが、3期以上の場合、<code>axis3</code>、<code>axis4</code>、…と追加してください。<a href="#fnref3" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn4"><p>今回の例だと、<code>label</code>も<code>ggplot()</code>内部でマッピング可能です。<a href="#fnref4" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn5"><p>他にも<strong>縦</strong>軸のみ共有する<code>"free_x"</code>、横軸のみ共有する<code>"free_y"</code>があり、既定値は<code>"fixed"</code>です。<a href="#fnref5" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
</ol>
</aside></div></main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const disableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'prefetch';
    }
  }
  const enableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'stylesheet';
    }
  }
  const manageTransitions = (selector, allowTransitions) => {
    const els = window.document.querySelectorAll(selector);
    for (let i=0; i < els.length; i++) {
      const el = els[i];
      if (allowTransitions) {
        el.classList.remove('notransition');
      } else {
        el.classList.add('notransition');
      }
    }
  }
  const toggleGiscusIfUsed = (isAlternate, darkModeDefault) => {
    const baseTheme = document.querySelector('#giscus-base-theme')?.value ?? 'light';
    const alternateTheme = document.querySelector('#giscus-alt-theme')?.value ?? 'dark';
    let newTheme = '';
    if(darkModeDefault) {
      newTheme = isAlternate ? baseTheme : alternateTheme;
    } else {
      newTheme = isAlternate ? alternateTheme : baseTheme;
    }
    const changeGiscusTheme = () => {
      // From: https://github.com/giscus/giscus/issues/336
      const sendMessage = (message) => {
        const iframe = document.querySelector('iframe.giscus-frame');
        if (!iframe) return;
        iframe.contentWindow.postMessage({ giscus: message }, 'https://giscus.app');
      }
      sendMessage({
        setConfig: {
          theme: newTheme
        }
      });
    }
    const isGiscussLoaded = window.document.querySelector('iframe.giscus-frame') !== null;
    if (isGiscussLoaded) {
      changeGiscusTheme();
    }
  }
  const toggleColorMode = (alternate) => {
    // Switch the stylesheets
    const alternateStylesheets = window.document.querySelectorAll('link.quarto-color-scheme.quarto-color-alternate');
    manageTransitions('#quarto-margin-sidebar .nav-link', false);
    if (alternate) {
      enableStylesheet(alternateStylesheets);
      for (const sheetNode of alternateStylesheets) {
        if (sheetNode.id === "quarto-bootstrap") {
          toggleBodyColorMode(sheetNode);
        }
      }
    } else {
      disableStylesheet(alternateStylesheets);
      toggleBodyColorPrimary();
    }
    manageTransitions('#quarto-margin-sidebar .nav-link', true);
    // Switch the toggles
    const toggles = window.document.querySelectorAll('.quarto-color-scheme-toggle');
    for (let i=0; i < toggles.length; i++) {
      const toggle = toggles[i];
      if (toggle) {
        if (alternate) {
          toggle.classList.add("alternate");     
        } else {
          toggle.classList.remove("alternate");
        }
      }
    }
    // Hack to workaround the fact that safari doesn't
    // properly recolor the scrollbar when toggling (#1455)
    if (navigator.userAgent.indexOf('Safari') > 0 && navigator.userAgent.indexOf('Chrome') == -1) {
      manageTransitions("body", false);
      window.scrollTo(0, 1);
      setTimeout(() => {
        window.scrollTo(0, 0);
        manageTransitions("body", true);
      }, 40);  
    }
  }
  const isFileUrl = () => { 
    return window.location.protocol === 'file:';
  }
  const hasAlternateSentinel = () => {  
    let styleSentinel = getColorSchemeSentinel();
    if (styleSentinel !== null) {
      return styleSentinel === "alternate";
    } else {
      return false;
    }
  }
  const setStyleSentinel = (alternate) => {
    const value = alternate ? "alternate" : "default";
    if (!isFileUrl()) {
      window.localStorage.setItem("quarto-color-scheme", value);
    } else {
      localAlternateSentinel = value;
    }
  }
  const getColorSchemeSentinel = () => {
    if (!isFileUrl()) {
      const storageValue = window.localStorage.getItem("quarto-color-scheme");
      return storageValue != null ? storageValue : localAlternateSentinel;
    } else {
      return localAlternateSentinel;
    }
  }
  const darkModeDefault = false;
  let localAlternateSentinel = darkModeDefault ? 'alternate' : 'default';
  // Dark / light mode switch
  window.quartoToggleColorScheme = () => {
    // Read the current dark / light value 
    let toAlternate = !hasAlternateSentinel();
    toggleColorMode(toAlternate);
    setStyleSentinel(toAlternate);
    toggleGiscusIfUsed(toAlternate, darkModeDefault);
  };
  // Ensure there is a toggle, if there isn't float one in the top right
  if (window.document.querySelector('.quarto-color-scheme-toggle') === null) {
    const a = window.document.createElement('a');
    a.classList.add('top-right');
    a.classList.add('quarto-color-scheme-toggle');
    a.href = "";
    a.onclick = function() { try { window.quartoToggleColorScheme(); } catch {} return false; };
    const i = window.document.createElement("i");
    i.classList.add('bi');
    a.appendChild(i);
    window.document.body.appendChild(a);
  }
  // Switch to dark mode if need be
  if (hasAlternateSentinel()) {
    toggleColorMode(true);
  } else {
    toggleColorMode(false);
  }
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    if (id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        for (let i = 0; i < 2; i++) {
          container.appendChild(note.children[i].cloneNode(true));
        }
        return container.innerHTML
      } else {
        return note.innerHTML;
      }
    } else {
      return note.innerHTML;
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note);
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var filterRegex = new RegExp("https:\/\/www\.jaysong\.net\/");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
          // target, if specified
          link.setAttribute("target", "_blank");
      }
    }
});
</script>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">
      &nbsp;
    </div>   
    <div class="nav-footer-center">
<p>Copyright 2023, Jaehyun Song. Powered by <a href="https://quarto.org/">Quarto</a></p>
</div>
    <div class="nav-footer-right">
      &nbsp;
    </div>
  </div>
</footer>




</body></html>