<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-0.9.587">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="dcterms.date" content="2022-06-17">

<title>Jaehyun Song, Ph.D.&nbsp;- dplyr入門</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
span.underline{text-decoration: underline;}
div.column{display: inline-block; vertical-align: top; width: 50%;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<link href="../../imgs/favicon.png" rel="icon" type="image/png">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>
<script async="" src="https://www.googletagmanager.com/gtag/js?id=G-BCE61P2YP7"></script>

<script type="text/javascript">

window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-BCE61P2YP7', { 'anonymize_ip': true});
</script>

  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<link rel="stylesheet" href="../../styles.css">
<meta property="og:title" content="Jaehyun Song, Ph.D.&nbsp;- dplyr入門">
<meta property="og:description" content="Jaehyun Song's personal…">
<meta property="og:image" content="https://www.jaysong.net/tutorial/R/imgs/favicon.png">
<meta property="og:site-name" content="Jaehyun Song, Ph.D.">
<meta name="twitter:title" content="Jaehyun Song, Ph.D.&nbsp;- dplyr入門">
<meta name="twitter:description" content="Jaehyun Song's personal…">
<meta name="twitter:image" content="https://www.jaysong.net/tutorial/R/imgs/favicon.png">
<meta name="twitter:creator" content="@Tintstyle">
<meta name="twitter:card" content="summary">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">Jaehyun Song, Ph.D.</span>
  </a>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../cv/index.html">CV</a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../research/index.html">Research</a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../teaching/index.html">Teaching</a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../seminar/index.html">Seminar</a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../software/index.html">Software</a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../notes/index.html">Notes</a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../tutorial/index.html">Tutorials</a>
  </li>  
</ul>
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item compact">
    <a class="nav-link" href="https://twitter.com/Tintstyle"><i class="bi bi-twitter" role="img">
</i> 
 </a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://www.facebook.com/tintstyle"><i class="bi bi-facebook" role="img">
</i> 
 </a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://www.instagram.com/tintstyle/"><i class="bi bi-instagram" role="img">
</i> 
 </a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/JaehyunSong"><i class="bi bi-github" role="img">
</i> 
 </a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://scholar.google.com/citations?user=8a-NxjkAAAAJ&amp;hl=ja"><i class="bi bi-mortarboard-fill" role="img">
</i> 
 </a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://researchmap.jp/jaysong"><i class="bi bi-map" role="img">
</i> 
 </a>
  </li>  
</ul>
              <div id="quarto-search" class="" title="Search"></div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc">
    <h2 id="toc-title">目次</h2>
   
  <ul>
  <li><a href="#はじめに" id="toc-はじめに" class="nav-link active" data-scroll-target="#はじめに">はじめに</a></li>
  <li><a href="#パッケージと実習用データの読み込み" id="toc-パッケージと実習用データの読み込み" class="nav-link" data-scroll-target="#パッケージと実習用データの読み込み">パッケージと実習用データの読み込み</a></li>
  <li><a href="#パイプ演算子" id="toc-パイプ演算子" class="nav-link" data-scroll-target="#パイプ演算子">パイプ演算子 (<code>%&gt;%</code>)</a></li>
  <li><a href="#列の抽出" id="toc-列の抽出" class="nav-link" data-scroll-target="#列の抽出">列の抽出</a>
  <ul class="collapse">
  <li><a href="#特定の列を抽出する" id="toc-特定の列を抽出する" class="nav-link" data-scroll-target="#特定の列を抽出する">特定の列を抽出する</a></li>
  <li><a href="#特定の列を抽出し列名を変更する" id="toc-特定の列を抽出し列名を変更する" class="nav-link" data-scroll-target="#特定の列を抽出し列名を変更する">特定の列を抽出し、列名を変更する</a></li>
  <li><a href="#特定の列を除外する" id="toc-特定の列を除外する" class="nav-link" data-scroll-target="#特定の列を除外する">特定の列を除外する</a></li>
  <li><a href="#隣接した列を指定する" id="toc-隣接した列を指定する" class="nav-link" data-scroll-target="#隣接した列を指定する">隣接した列を指定する</a></li>
  <li><a href="#一部の列の順番だけを変える" id="toc-一部の列の順番だけを変える" class="nav-link" data-scroll-target="#一部の列の順番だけを変える">一部の列の順番だけを変える</a></li>
  <li><a href="#selectの便利な機能" id="toc-selectの便利な機能" class="nav-link" data-scroll-target="#selectの便利な機能"><code>select()</code>の便利な機能</a></li>
  </ul></li>
  <li><a href="#行の抽出" id="toc-行の抽出" class="nav-link" data-scroll-target="#行の抽出">行の抽出</a>
  <ul class="collapse">
  <li><a href="#指定した行を抽出する" id="toc-指定した行を抽出する" class="nav-link" data-scroll-target="#指定した行を抽出する">指定した行を抽出する</a></li>
  <li><a href="#条件に合致する行を抽出する" id="toc-条件に合致する行を抽出する" class="nav-link" data-scroll-target="#条件に合致する行を抽出する">条件に合致する行を抽出する</a></li>
  </ul></li>
  <li><a href="#行のソート" id="toc-行のソート" class="nav-link" data-scroll-target="#行のソート">行のソート</a></li>
  <li><a href="#記述統計量の計算" id="toc-記述統計量の計算" class="nav-link" data-scroll-target="#記述統計量の計算">記述統計量の計算</a>
  <ul class="collapse">
  <li><a href="#summariseによる記述統計量の計算" id="toc-summariseによる記述統計量の計算" class="nav-link" data-scroll-target="#summariseによる記述統計量の計算"><code>summarise()</code>による記述統計量の計算</a></li>
  <li><a href="#summariseに使える便利な関数" id="toc-summariseに使える便利な関数" class="nav-link" data-scroll-target="#summariseに使える便利な関数"><code>summarise()</code>に使える便利な関数</a></li>
  </ul></li>
  <li><a href="#グルーピング" id="toc-グルーピング" class="nav-link" data-scroll-target="#グルーピング">グルーピング</a>
  <ul class="collapse">
  <li><a href="#group_byによるグループ化" id="toc-group_byによるグループ化" class="nav-link" data-scroll-target="#group_byによるグループ化"><code>group_by()</code>によるグループ化</a></li>
  <li><a href="#複数の変数を用いたグループ化" id="toc-複数の変数を用いたグループ化" class="nav-link" data-scroll-target="#複数の変数を用いたグループ化">複数の変数を用いたグループ化</a></li>
  </ul></li>
  <li><a href="#変数の計算" id="toc-変数の計算" class="nav-link" data-scroll-target="#変数の計算">変数の計算</a>
  <ul class="collapse">
  <li><a href="#mutate関数の使い方" id="toc-mutate関数の使い方" class="nav-link" data-scroll-target="#mutate関数の使い方"><code>mutate()</code>関数の使い方</a></li>
  </ul></li>
  <li><a href="#factor型の処理に便利な関数" id="toc-factor型の処理に便利な関数" class="nav-link" data-scroll-target="#factor型の処理に便利な関数">factor型の処理に便利な関数</a>
  <ul class="collapse">
  <li><a href="#factor型の必要性" id="toc-factor型の必要性" class="nav-link" data-scroll-target="#factor型の必要性">factor型の必要性</a></li>
  <li><a href="#forcatsパッケージについて" id="toc-forcatsパッケージについて" class="nav-link" data-scroll-target="#forcatsパッケージについて">{forcats}パッケージについて</a></li>
  </ul></li>
  <li><a href="#行単位の操作" id="toc-行単位の操作" class="nav-link" data-scroll-target="#行単位の操作">行単位の操作</a></li>
  <li><a href="#データの結合" id="toc-データの結合" class="nav-link" data-scroll-target="#データの結合">データの結合</a>
  <ul class="collapse">
  <li><a href="#行の結合" id="toc-行の結合" class="nav-link" data-scroll-target="#行の結合">行の結合</a></li>
  <li><a href="#列の結合" id="toc-列の結合" class="nav-link" data-scroll-target="#列の結合">列の結合</a></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">dplyr入門</h1>
</div>



<div class="quarto-title-meta">

    
    <div>
    <div class="quarto-title-meta-heading">作成・改訂</div>
    <div class="quarto-title-meta-contents">
      <p class="date">June 17, 2022</p>
    </div>
  </div>
    
  </div>
  

</header>

<section id="はじめに" class="level2">
<h2 class="anchored" data-anchor-id="はじめに">はじめに</h2>
<ul>
<li>以下の内容は現在執筆中の内容の一部となります。
<ul>
<li><a href="https://www.jaysong.net/RBook/">Song Jaehyun・矢内勇生『私たちのR: ベストプラクティスの探求』(E-book)</a></li>
</ul></li>
<li>いきなり<strong>オブジェクト</strong>、<strong>関数</strong>、<strong>引数</strong>といった馴染みのない概念が出てきます。これらの概念に馴染みのない方は、予め「<a href="../../tutorial/R/rprogramming.html">Rプログラミング入門の入門</a>」をご一読ください。</li>
<li>実習用データ: <span class="jay_btn"> <a href="Data/Ramen.csv">Ramen.csv</a> <a href="Data/Ramen2.csv">Ramen2.csv</a></span></li>
</ul>
</section>
<section id="パッケージと実習用データの読み込み" class="level2">
<h2 class="anchored" data-anchor-id="パッケージと実習用データの読み込み">パッケージと実習用データの読み込み</h2>
<p>　パッケージは{dplyr}でも、{tidyverse}でもどれでも構いません。ここではデータをtibble型として読み込むため、{tidyverse}を読み込んでおきます。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1"></a><span class="fu">library</span>(tidyverse)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>　それでは今回の実習用データを読み込みましょう。<a href="Data/Ramen.csv">Ramen.csv</a>には「<a href="https://www.gnavi.co.jp">ぐるなび</a>」から取得したラーメン屋6292店舗の情報が入っています。具体的には東京、神奈川、千葉、埼玉、大阪、京都、兵庫、奈良、和歌山それぞれ都府県にあるラーメン屋の中から最大1000店舗の情報を抽出したものです。東京都は、ぐるなびに登録したラーメン屋が3000店舗以上ですが、1000店舗の基準はぐるなびの「おすすめ」の順で上位1000店舗となります。また、店側またはぐるなびが登録したカテゴリを基準に抽出したため、実際はラーメン屋ではないにもかかわらずラーメン屋としてデータ内に含まれている可能性があります。</p>
<p>　まず、このデータを読み込み、<code>df</code>という名付けます。R内蔵関数である<code>read.csv()</code>を使ってデータを読み込んでも以下の内容を実習するにあたって全く問題はございません。<code>read.csv()</code>から読み込まれたデータのクラスはデータフレーム、<code>read_csv()</code>の場合はtibbleです。tibbleはデータフレームの拡張版であり、データフレームで可能な操作は全てtibbleにおいても可能です。ここではtibbleを使いますが、こちらの方が、結果が読みやすく出力されるからです。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1"></a><span class="co"># ファイルのパスは適宜修正してください</span></span>
<span id="cb2-2"><a href="#cb2-2"></a>df <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">"Data/Ramen.csv"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>　本サンプルデータはUTF-8で保存されており、文字化けが生じる場合、以下のように対処してください。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1"></a><span class="co"># readrパッケージのread_csv()を使う場合</span></span>
<span id="cb3-2"><a href="#cb3-2"></a>df <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">"Data/Ramen.csv"</span>, <span class="at">locale =</span> <span class="fu">locale</span>(<span class="at">encoding =</span> <span class="st">"utf8"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>　データの中身を確認してみましょう。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1"></a>df</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6,292 × 14
   ID     Name  Pref  Zipcode Latitude Longitude Line  Station  Walk   Bus   Car
   &lt;chr&gt;  &lt;chr&gt; &lt;chr&gt;   &lt;dbl&gt;    &lt;dbl&gt;     &lt;dbl&gt; &lt;chr&gt; &lt;chr&gt;   &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;
 1 e5396… 居酒… 東京… 1040031     35.7      140. 地下… 銀座一…     3    NA    NA
 2 gfeb6… 本格… 東京… 1100005     35.7      140. 地下… 仲御徒…     1    NA    NA
 3 ggt59… 食べ… 東京… 1250041     35.8      140. ＪＲ… 金町駅      2    NA    NA
 4 g1813… 博多… 東京… 1920904     35.7      139. ＪＲ  八王子…     1    NA    NA
 5 ggww1… まさ… 東京… 1500042     35.7      140. 地下… 渋谷駅      7    NA    NA
 6 gdzk5… 完全… 東京… 1000013     35.7      140. 地下… 虎ノ門…     3    NA    NA
 7 ga2g2… 鶏そ… 東京… 1760006     35.7      140. 西武… 江古田…     2    NA    NA
 8 gg9m1… 宴会… 東京… 1010021     35.7      140. ＪＲ  秋葉原…     4    NA    NA
 9 gdvk2… 中国… 東京… 1000006     35.7      140. ＪＲ  有楽町…     1    NA    NA
10 gggb2… 中国… 東京… 1140002     35.8      140. 地下… 王子駅      2    NA    NA
# … with 6,282 more rows, and 3 more variables: Budget &lt;dbl&gt;, ScoreN &lt;dbl&gt;,
#   Score &lt;dbl&gt;</code></pre>
</div>
</div>
<p>　1行目の<code># A tibble: 6,292 x 14</code>から、ケース数 (店舗数)は6292、変数は14個あることが分かります。各変数の詳細は以下の通りです。</p>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">

<div id="cbdkkmywpf" style="overflow-x:auto;overflow-y:auto;width:auto;height:auto;">
<style>html {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Helvetica Neue', 'Fira Sans', 'Droid Sans', Arial, sans-serif;
}

#cbdkkmywpf .gt_table {
  display: table;
  border-collapse: collapse;
  margin-left: auto;
  margin-right: auto;
  color: #333333;
  font-size: 16px;
  font-weight: normal;
  font-style: normal;
  background-color: #FFFFFF;
  width: auto;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #A8A8A8;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #A8A8A8;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
}

#cbdkkmywpf .gt_heading {
  background-color: #FFFFFF;
  text-align: center;
  border-bottom-color: #FFFFFF;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#cbdkkmywpf .gt_title {
  color: #333333;
  font-size: 125%;
  font-weight: initial;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-color: #FFFFFF;
  border-bottom-width: 0;
}

#cbdkkmywpf .gt_subtitle {
  color: #333333;
  font-size: 85%;
  font-weight: initial;
  padding-top: 0;
  padding-bottom: 6px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-color: #FFFFFF;
  border-top-width: 0;
}

#cbdkkmywpf .gt_bottom_border {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#cbdkkmywpf .gt_col_headings {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#cbdkkmywpf .gt_col_heading {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 6px;
  padding-left: 5px;
  padding-right: 5px;
  overflow-x: hidden;
}

#cbdkkmywpf .gt_column_spanner_outer {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  padding-top: 0;
  padding-bottom: 0;
  padding-left: 4px;
  padding-right: 4px;
}

#cbdkkmywpf .gt_column_spanner_outer:first-child {
  padding-left: 0;
}

#cbdkkmywpf .gt_column_spanner_outer:last-child {
  padding-right: 0;
}

#cbdkkmywpf .gt_column_spanner {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 5px;
  overflow-x: hidden;
  display: inline-block;
  width: 100%;
}

#cbdkkmywpf .gt_group_heading {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
}

#cbdkkmywpf .gt_empty_group_heading {
  padding: 0.5px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: middle;
}

#cbdkkmywpf .gt_from_md > :first-child {
  margin-top: 0;
}

#cbdkkmywpf .gt_from_md > :last-child {
  margin-bottom: 0;
}

#cbdkkmywpf .gt_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  margin: 10px;
  border-top-style: solid;
  border-top-width: 1px;
  border-top-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  overflow-x: hidden;
}

#cbdkkmywpf .gt_stub {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 5px;
  padding-right: 5px;
}

#cbdkkmywpf .gt_stub_row_group {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 5px;
  padding-right: 5px;
  vertical-align: top;
}

#cbdkkmywpf .gt_row_group_first td {
  border-top-width: 2px;
}

#cbdkkmywpf .gt_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#cbdkkmywpf .gt_first_summary_row {
  border-top-style: solid;
  border-top-color: #D3D3D3;
}

#cbdkkmywpf .gt_first_summary_row.thick {
  border-top-width: 2px;
}

#cbdkkmywpf .gt_last_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#cbdkkmywpf .gt_grand_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#cbdkkmywpf .gt_first_grand_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-style: double;
  border-top-width: 6px;
  border-top-color: #D3D3D3;
}

#cbdkkmywpf .gt_striped {
  background-color: rgba(128, 128, 128, 0.05);
}

#cbdkkmywpf .gt_table_body {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#cbdkkmywpf .gt_footnotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#cbdkkmywpf .gt_footnote {
  margin: 0px;
  font-size: 90%;
  padding-left: 4px;
  padding-right: 4px;
  padding-left: 5px;
  padding-right: 5px;
}

#cbdkkmywpf .gt_sourcenotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#cbdkkmywpf .gt_sourcenote {
  font-size: 90%;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
}

#cbdkkmywpf .gt_left {
  text-align: left;
}

#cbdkkmywpf .gt_center {
  text-align: center;
}

#cbdkkmywpf .gt_right {
  text-align: right;
  font-variant-numeric: tabular-nums;
}

#cbdkkmywpf .gt_font_normal {
  font-weight: normal;
}

#cbdkkmywpf .gt_font_bold {
  font-weight: bold;
}

#cbdkkmywpf .gt_font_italic {
  font-style: italic;
}

#cbdkkmywpf .gt_super {
  font-size: 65%;
}

#cbdkkmywpf .gt_two_val_uncert {
  display: inline-block;
  line-height: 1em;
  text-align: right;
  font-size: 60%;
  vertical-align: -0.25em;
  margin-left: 0.1em;
}

#cbdkkmywpf .gt_footnote_marks {
  font-style: italic;
  font-weight: normal;
  font-size: 75%;
  vertical-align: 0.4em;
}

#cbdkkmywpf .gt_asterisk {
  font-size: 100%;
  vertical-align: 0;
}

#cbdkkmywpf .gt_slash_mark {
  font-size: 0.7em;
  line-height: 0.7em;
  vertical-align: 0.15em;
}

#cbdkkmywpf .gt_fraction_numerator {
  font-size: 0.6em;
  line-height: 0.6em;
  vertical-align: 0.45em;
}

#cbdkkmywpf .gt_fraction_denominator {
  font-size: 0.6em;
  line-height: 0.6em;
  vertical-align: -0.05em;
}
</style>
<table class="gt_table">
  
  <thead class="gt_col_headings">
    <tr>
      <th class="gt_col_heading gt_columns_bottom_border gt_left" rowspan="1" colspan="1">変数名</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_left" rowspan="1" colspan="1">説明</th>
    </tr>
  </thead>
  <tbody class="gt_table_body">
    <tr><td class="gt_row gt_left">ID</td>
<td class="gt_row gt_left">店舗ID</td></tr>
    <tr><td class="gt_row gt_left">Name</td>
<td class="gt_row gt_left">店舗名</td></tr>
    <tr><td class="gt_row gt_left">Pref</td>
<td class="gt_row gt_left">店舗の所在地 (都府県)</td></tr>
    <tr><td class="gt_row gt_left">Zipcode</td>
<td class="gt_row gt_left">店舗の郵便番号</td></tr>
    <tr><td class="gt_row gt_left">Latitude</td>
<td class="gt_row gt_left">緯度</td></tr>
    <tr><td class="gt_row gt_left">Longitude</td>
<td class="gt_row gt_left">経度</td></tr>
    <tr><td class="gt_row gt_left">Line</td>
<td class="gt_row gt_left">最寄りの駅の路線</td></tr>
    <tr><td class="gt_row gt_left">Station</td>
<td class="gt_row gt_left">最寄りの駅</td></tr>
    <tr><td class="gt_row gt_left">Walk</td>
<td class="gt_row gt_left">最寄りの駅からの距離 (徒歩; 分)</td></tr>
    <tr><td class="gt_row gt_left">Bus</td>
<td class="gt_row gt_left">最寄りの駅からの距離 (バス; 分)</td></tr>
    <tr><td class="gt_row gt_left">Car</td>
<td class="gt_row gt_left">最寄りの駅からの距離 (車; 分)</td></tr>
    <tr><td class="gt_row gt_left">Budget</td>
<td class="gt_row gt_left">平均予算 (円)</td></tr>
    <tr><td class="gt_row gt_left">ScoreN</td>
<td class="gt_row gt_left">口コミの数</td></tr>
    <tr><td class="gt_row gt_left">Score</td>
<td class="gt_row gt_left">口コミ評価の平均値</td></tr>
  </tbody>
  
  
</table>
</div>
</div>
</div>
<p>　それではここからは<code>df</code>を用いた{dplyr}の様々な機能を紹介していきます。</p>
</section>
<section id="パイプ演算子" class="level2">
<h2 class="anchored" data-anchor-id="パイプ演算子">パイプ演算子 (<code>%&gt;%</code>)</h2>
<div class="callout-important callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
新しいパイプ演算子<code>|&gt;</code>
</div>
</div>
<div class="callout-body-container callout-body">
<p>これまでのパイプ演算子 (<code>%&gt;%</code>) は{magrittr}パッケージから提供されましたが、R 4.1からはR内蔵のパイプ演算子 (<code>|&gt;</code>) が追加されました。使い方はやや異なりますが、本ページの内容であれば、<code>%&gt;%</code>の代わりに<code>|&gt;</code>を使って頂いても問題有りません。</p>
</div>
</div>
<p>　{dplyr}パッケージを利用する前にパイプ演算子について説明します。パイプ演算子は{dplyr}に含まれている演算子ではなく、{magrittr}という別のパッケージから提供される演算子ですが、{tidyverse}パッケージを読み込むと自動的に読み込まれます。パイプ演算子は<code>x %&gt;% y()</code>のような書き方となりますが、これは「<code>x</code>を<code>y()</code>の第一引数として渡す」ことを意味します。<code>x</code>の部分はベクトルやデータフレームのようなオブジェクトでも、関数でも構いません。なぜなら、関数から得られた結果もまたベクトルやデータフレームといったものになるからです。つまり、<code>x() %&gt;% y()</code>という使い方も可能です。そして、パイプは無限に繋ぐこともできます。「データ<code>df</code>を関数<code>x()</code>で処理をし、その結果をまた関数<code>y()</code>で処理する」ことは、パイプを使うと<code>df %&gt;% x() %&gt;% y()</code>のような書き方となります。</p>
<p>　たとえば、「<code>paste(3, "+", 5, "=", 8)</code>を実行し、その結果を<code>rep()</code>関数を使って3回複製し、それを<code>print()</code>を使って出力する」コードを考えてみましょう。方法としては2つ考えられます。まずは、それぞれの処理を別途のオブジェクトに格納する方法です。そして二つ目は関数の中に関数を使う方法です。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1"></a><span class="co"># 方法1: 一関数一オブジェクト</span></span>
<span id="cb6-2"><a href="#cb6-2"></a>Result1 <span class="ot">&lt;-</span> <span class="fu">paste</span>(<span class="dv">3</span>, <span class="st">"+"</span>, <span class="dv">5</span>, <span class="st">"="</span>, <span class="dv">8</span>)</span>
<span id="cb6-3"><a href="#cb6-3"></a>Result2 <span class="ot">&lt;-</span> <span class="fu">rep</span>(Result1, <span class="dv">3</span>)</span>
<span id="cb6-4"><a href="#cb6-4"></a><span class="fu">print</span>(Result2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "3 + 5 = 8" "3 + 5 = 8" "3 + 5 = 8"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1"></a><span class="co"># 方法2: 関数の中に関数の中に関数</span></span>
<span id="cb8-2"><a href="#cb8-2"></a><span class="fu">print</span>(<span class="fu">rep</span>(<span class="fu">paste</span>(<span class="dv">3</span>, <span class="st">"+"</span>, <span class="dv">5</span>, <span class="st">"="</span>, <span class="dv">8</span>), <span class="dv">3</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "3 + 5 = 8" "3 + 5 = 8" "3 + 5 = 8"</code></pre>
</div>
</div>
<p>　どれも結果は同じです。コードを書く手間を考えれば、後者の方が楽かも知れませんが、可読性があまりよくありません。一方、前者は可読性は良いものの、コードも長くなり、オブジェクトを2つも作ってしまうのでメモリの無駄遣いになります。</p>
<p>　コードの可読性と書く手間、両方を満足する書き方がパイプ演算子<code>%&gt;%</code>です。まずは、例から見ましょう。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1"></a><span class="co"># %&gt;%を使う</span></span>
<span id="cb10-2"><a href="#cb10-2"></a><span class="fu">paste</span>(<span class="dv">3</span>, <span class="st">"+"</span>, <span class="dv">5</span>, <span class="st">"="</span>, <span class="dv">8</span>) <span class="sc">%&gt;%</span> <span class="fu">rep</span>(<span class="dv">3</span>) <span class="sc">%&gt;%</span> <span class="fu">print</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "3 + 5 = 8" "3 + 5 = 8" "3 + 5 = 8"</code></pre>
</div>
</div>
<p>　まず、結果は先ほどと同じです。それではコードの説明をしましょう。まずは、<code>paste(3, "+", 5, "=", 8)</code>を実行します。そしてその結果をそのまま<code>rep()</code>関数の第一引数として渡されます。つまり、<code>rep(paste(3, "+", 5, "=", 8), 3)</code>になるわけです。ここでは<code>rep(3)</code>と書きましたが、第一引数が渡されたため、<code>3</code>は第二引数扱いになります (パイプ演算子前のオブジェクトを第二、三引数として渡す方法は適宜説明します。)。そして、これをまた<code>print()</code>関数に渡します。結果としては<code>print(rep(paste(3, "+", 5, "=", 8), 3))</code>となります。</p>
<p>　関数を重ねると読む順番は「カッコの内側から外側へ」になりますが、パイプ演算子を使うと「左 (上)から右 (下)へ」といったより自然な読み方が可能になります。また、以下のコードのように、パイプ演算子後に改行を行うことでより読みやすいコードになります。これからはパイプ演算子の後は必ず改行をします。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1"></a><span class="co"># 改行 (+字下げ)したらもっと読みやすくなる</span></span>
<span id="cb12-2"><a href="#cb12-2"></a><span class="fu">paste</span>(<span class="dv">3</span>, <span class="st">"+"</span>, <span class="dv">5</span>, <span class="st">"="</span>, <span class="dv">8</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-3"><a href="#cb12-3"></a>    <span class="fu">rep</span>(<span class="dv">3</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-4"><a href="#cb12-4"></a>    <span class="fu">print</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>　パイプ演算子を使わない方法 <a href="#fig-pipe1">図&nbsp;1</a> のようにイメージできます。一回の処理ごとに結果を保存し、それをまた次の処理時においてデータとして使うイメージです。</p>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div id="fig-pipe1" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="Figs/Handling1/Pipeline1.png" class="img-fluid figure-img" style="width:100.0%"></p>
<p></p><figcaption aria-hidden="true" class="figure-caption">図 1: パイプ演算子を使わない場合</figcaption><p></p>
</figure>
</div>
</div>
</div>
<p>　一方、 <a href="#fig-pipe2">図&nbsp;2</a> はパイプ演算子を使う場合のプロセスです。処理後の結果を保存せず、すぐに次のプロセスに渡すことで、メモリ (図だとボウル)や時間、コードの無駄を減らすことができます。むろん、 <a href="#fig-pipe1">図&nbsp;1</a> の結果1を使って色々試してみたい場合は、一旦結果1までは格納し、適宜引き出して使った方が効率的でしょう。パイプ演算子はたしかに便利で、「今どき」のRの書き方を象徴するようなものですが、一つの結果を出すまであまりにも多くのパイプ演算子を使うことはあ望ましくありません。</p>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div id="fig-pipe2" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="Figs/Handling1/Pipeline2.png" class="img-fluid figure-img" style="width:100.0%"></p>
<p></p><figcaption aria-hidden="true" class="figure-caption">図 2: パイプ演算子を使う場合</figcaption><p></p>
</figure>
</div>
</div>
</div>
<p>　データハンドリングもこれど同様に、様々な作業を順に沿って行う必要があります。例えば、「(1) 列を選択して、(2) 欠損値を含む列を除去して、 (3) ある変数の値を100倍にして、(4) ある変数の値がが小さい行から大きい順へ並び替える」といった手順です。これらの作業はパイプ演算子を使えば、スムーズに行うことが可能です。</p>
</section>
<section id="列の抽出" class="level2">
<h2 class="anchored" data-anchor-id="列の抽出">列の抽出</h2>
<section id="特定の列を抽出する" class="level3">
<h3 class="anchored" data-anchor-id="特定の列を抽出する">特定の列を抽出する</h3>
<p>　まずは、データフレーム (または、tibble)から特定の列のみを残す、除去する方法について紹介します。たとえば、<code>df</code>から<code>ID</code>、<code>Name</code>、<code>Pref</code>、<code>Score</code>のみを残すとします。{dplyr}を使わない方法と{dplyr}の<code>select()</code>関数を使った方法を紹介します。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1"></a><span class="co"># dplyrを使わない方法</span></span>
<span id="cb13-2"><a href="#cb13-2"></a>df[, <span class="fu">c</span>(<span class="st">"ID"</span>, <span class="st">"Name"</span>, <span class="st">"Pref"</span>, <span class="st">"Score"</span>)]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6,292 × 4
   ID      Name                                                     Pref   Score
   &lt;chr&gt;   &lt;chr&gt;                                                    &lt;chr&gt;  &lt;dbl&gt;
 1 e539604 居酒屋 龍記 京橋店                                       東京都 NA   
 2 gfeb600 本格上海料理 新錦江 上野御徒町本店                       東京都  4.5 
 3 ggt5900 食べ飲み放題×中華ビストロ NOZOMI（のぞみ）               東京都 NA   
 4 g181340 博多餃子軒 八王子店 タピオカ店 Bull Pulu（ブルプル）併設 東京都 NA   
 5 ggww100 まさ屋 渋谷店                                            東京都 NA   
 6 gdzk500 完全個室 上海レストラン 檸檬 霞ヶ関ビル内店              東京都 NA   
 7 ga2g202 鶏そば きらり                                            東京都 NA   
 8 gg9m100 宴会個室×餃子酒場 北京飯店 秋葉原本店                    東京都  3.33
 9 gdvk200 中国料理 宝龍                                            東京都  2.5 
10 gggb200 中国料理 天安門                                          東京都 NA   
# … with 6,282 more rows</code></pre>
</div>
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1"></a><span class="co"># dplyr::select()を使う方法</span></span>
<span id="cb15-2"><a href="#cb15-2"></a><span class="co"># select(df, ID, Name, Pref, Score)でもOK</span></span>
<span id="cb15-3"><a href="#cb15-3"></a>df <span class="sc">%&gt;%</span></span>
<span id="cb15-4"><a href="#cb15-4"></a>  <span class="fu">select</span>(ID, Name, Pref, Score)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6,292 × 4
   ID      Name                                                     Pref   Score
   &lt;chr&gt;   &lt;chr&gt;                                                    &lt;chr&gt;  &lt;dbl&gt;
 1 e539604 居酒屋 龍記 京橋店                                       東京都 NA   
 2 gfeb600 本格上海料理 新錦江 上野御徒町本店                       東京都  4.5 
 3 ggt5900 食べ飲み放題×中華ビストロ NOZOMI（のぞみ）               東京都 NA   
 4 g181340 博多餃子軒 八王子店 タピオカ店 Bull Pulu（ブルプル）併設 東京都 NA   
 5 ggww100 まさ屋 渋谷店                                            東京都 NA   
 6 gdzk500 完全個室 上海レストラン 檸檬 霞ヶ関ビル内店              東京都 NA   
 7 ga2g202 鶏そば きらり                                            東京都 NA   
 8 gg9m100 宴会個室×餃子酒場 北京飯店 秋葉原本店                    東京都  3.33
 9 gdvk200 中国料理 宝龍                                            東京都  2.5 
10 gggb200 中国料理 天安門                                          東京都 NA   
# … with 6,282 more rows</code></pre>
</div>
</div>
<p>　どれも結果は同じですが、<code>select()</code>関数を使った方がより読みやすいコードになっているでしょう。むろん、<code>select()</code>関数を使わない方がスッキリする方も知るかも知れません。実際、自分でパッケージなどを作成する際は<code>select()</code>を使わない場合が多いです。ただし、一般的な分析の流れでは<code>select()</code>の方がコードも意味も明確となり、パイプ演算子でつなぐのも容易です。</p>
<p>　<code>select()</code>関数の使い方は非常に簡単です。第一引数はデータフレーム (または、tibble)ですが、パイプ演算子を使う場合は省略可能です。第二引数以降の引数はデータフレーム/tibble内の変数名です。つまり、ここには残す変数名のみを書くだけで十分です。</p>
<p>　また、<code>select()</code>関数を使って列の順番を変えることもできます。たとえば、<code>ID</code>、<code>Pref</code>、<code>Name</code>、<code>Score</code>の順で列を残すなら、この順番で引数を書くだけです。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1"></a>df <span class="sc">%&gt;%</span></span>
<span id="cb17-2"><a href="#cb17-2"></a>  <span class="fu">select</span>(ID, Pref, Name)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6,292 × 3
   ID      Pref   Name                                                    
   &lt;chr&gt;   &lt;chr&gt;  &lt;chr&gt;                                                   
 1 e539604 東京都 居酒屋 龍記 京橋店                                      
 2 gfeb600 東京都 本格上海料理 新錦江 上野御徒町本店                      
 3 ggt5900 東京都 食べ飲み放題×中華ビストロ NOZOMI（のぞみ）              
 4 g181340 東京都 博多餃子軒 八王子店 タピオカ店 Bull Pulu（ブルプル）併設
 5 ggww100 東京都 まさ屋 渋谷店                                           
 6 gdzk500 東京都 完全個室 上海レストラン 檸檬 霞ヶ関ビル内店             
 7 ga2g202 東京都 鶏そば きらり                                           
 8 gg9m100 東京都 宴会個室×餃子酒場 北京飯店 秋葉原本店                   
 9 gdvk200 東京都 中国料理 宝龍                                           
10 gggb200 東京都 中国料理 天安門                                         
# … with 6,282 more rows</code></pre>
</div>
</div>
</section>
<section id="特定の列を抽出し列名を変更する" class="level3">
<h3 class="anchored" data-anchor-id="特定の列を抽出し列名を変更する">特定の列を抽出し、列名を変更する</h3>
<p>　また、特定の列を残す際、変数名を変更することも可能です。今回も<code>ID</code>、<code>Name</code>、<code>Pref</code>、<code>Score</code>のみを残しますが、<code>Pref</code>列は<code>Prefecture</code>に変えてみましょう。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1"></a>df <span class="sc">%&gt;%</span></span>
<span id="cb19-2"><a href="#cb19-2"></a>  <span class="fu">select</span>(ID, Name, <span class="at">Prefecture =</span> Pref, Score)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6,292 × 4
   ID      Name                                                Prefecture Score
   &lt;chr&gt;   &lt;chr&gt;                                               &lt;chr&gt;      &lt;dbl&gt;
 1 e539604 居酒屋 龍記 京橋店                                  東京都     NA   
 2 gfeb600 本格上海料理 新錦江 上野御徒町本店                  東京都      4.5 
 3 ggt5900 食べ飲み放題×中華ビストロ NOZOMI（のぞみ）          東京都     NA   
 4 g181340 博多餃子軒 八王子店 タピオカ店 Bull Pulu（ブルプル… 東京都     NA   
 5 ggww100 まさ屋 渋谷店                                       東京都     NA   
 6 gdzk500 完全個室 上海レストラン 檸檬 霞ヶ関ビル内店         東京都     NA   
 7 ga2g202 鶏そば きらり                                       東京都     NA   
 8 gg9m100 宴会個室×餃子酒場 北京飯店 秋葉原本店               東京都      3.33
 9 gdvk200 中国料理 宝龍                                       東京都      2.5 
10 gggb200 中国料理 天安門                                     東京都     NA   
# … with 6,282 more rows</code></pre>
</div>
</div>
<p>　抽出する際、変数を<code>新しい変数名 = 既存の変数名</code>にするだけで、変数名が簡単に変更できました。もし、特定の列は抽出しないものの、変数名を変えるにはどうすれば良いでしょうか。ここでは<code>df</code>の<code>Pref</code>を<code>Prefecture</code>に、<code>Walk</code>を<code>Distance</code>に変更してみます。{dplyr}を使わない場合と{dplyr}の<code>rename()</code>関数を使う場合を両方紹介します。</p>
<p>　まずは、<code>name()</code>関数についてですが、これはデータフレーム (または、tibble)の変数名をベクトルとして出力する関数です。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1"></a><span class="fu">names</span>(df)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> [1] "ID"        "Name"      "Pref"      "Zipcode"   "Latitude"  "Longitude"
 [7] "Line"      "Station"   "Walk"      "Bus"       "Car"       "Budget"   
[13] "ScoreN"    "Score"    </code></pre>
</div>
</div>
<p>　察しの良い読者は気づいたかも知れませんが、<code>names(データフレーム/tibble名)</code>の結果はベクトルであり、上書きも可能です。つまり、<code>names(df)</code>の3番目と9番目の要素を<code>"Prefecture"</code>と<code>"Distance"</code>に上書きすることができるということです。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1"></a><span class="co"># dplyrを使わずに列名を変更する方法</span></span>
<span id="cb23-2"><a href="#cb23-2"></a><span class="fu">names</span>(df)[<span class="fu">c</span>(<span class="dv">3</span>, <span class="dv">9</span>)] <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"Prefecture"</span>, <span class="st">"Distance"</span>)</span>
<span id="cb23-3"><a href="#cb23-3"></a></span>
<span id="cb23-4"><a href="#cb23-4"></a><span class="co"># dfの中身を出力</span></span>
<span id="cb23-5"><a href="#cb23-5"></a>df</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6,292 × 14
   ID      Name     Prefecture Zipcode Latitude Longitude Line  Station Distance
   &lt;chr&gt;   &lt;chr&gt;    &lt;chr&gt;        &lt;dbl&gt;    &lt;dbl&gt;     &lt;dbl&gt; &lt;chr&gt; &lt;chr&gt;      &lt;dbl&gt;
 1 e539604 居酒屋 … 東京都     1040031     35.7      140. 地下… 銀座一…        3
 2 gfeb600 本格上…  東京都     1100005     35.7      140. 地下… 仲御徒…        1
 3 ggt5900 食べ飲…  東京都     1250041     35.8      140. ＪＲ… 金町駅         2
 4 g181340 博多餃…  東京都     1920904     35.7      139. ＪＲ  八王子…        1
 5 ggww100 まさ屋 … 東京都     1500042     35.7      140. 地下… 渋谷駅         7
 6 gdzk500 完全個…  東京都     1000013     35.7      140. 地下… 虎ノ門…        3
 7 ga2g202 鶏そば … 東京都     1760006     35.7      140. 西武… 江古田…        2
 8 gg9m100 宴会個…  東京都     1010021     35.7      140. ＪＲ  秋葉原…        4
 9 gdvk200 中国料…  東京都     1000006     35.7      140. ＪＲ  有楽町…        1
10 gggb200 中国料…  東京都     1140002     35.8      140. 地下… 王子駅         2
# … with 6,282 more rows, and 5 more variables: Bus &lt;dbl&gt;, Car &lt;dbl&gt;,
#   Budget &lt;dbl&gt;, ScoreN &lt;dbl&gt;, Score &lt;dbl&gt;</code></pre>
</div>
</div>
<p>　簡単に変数名の変更ができました。続いて、{dplyr}の<code>rename()</code>関数を使った方法です。今回は、<code>Prefecture</code>を<code>Pref</code>に、<code>Distance</code>を<code>Walk</code>に戻して見ましょう。そして、出力するだけにとどまらず、<code>df</code>に上書きしましょう。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1"></a><span class="co"># dfのPrefectureをPrefに、DistanceをWalkに変更し、上書きする</span></span>
<span id="cb25-2"><a href="#cb25-2"></a>df <span class="ot">&lt;-</span> df <span class="sc">%&gt;%</span></span>
<span id="cb25-3"><a href="#cb25-3"></a>  <span class="fu">rename</span>(<span class="at">Pref =</span> Prefecture, <span class="at">Walk =</span> Distance)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>　これで終わりです。実は<code>select()</code>関数と使い方がほぼ同じです。ただし、残す変数名を指定する必要がなく、名前を変更する変数名と新しい変数名を入れるだけです。変数が少ないデータなら<code>select()</code>でもあまり不便は感じないかも知れませんが、変数が多くなると<code>rename()</code>関数は非常に便利です。</p>
</section>
<section id="特定の列を除外する" class="level3">
<h3 class="anchored" data-anchor-id="特定の列を除外する">特定の列を除外する</h3>
<p>　逆に、一部の変数をデータフレーム (または、tibble)から除去したい場合もあるでしょう。たとえば、緯度 (<code>Latitude</code>)と経度 (<code>Longitude</code>)はラーメン屋の情報としては不要かもしれません。この2つの変数を除外するためにはどうすれば良いでしょうか。まず考えられるのは、この2つの変数を除いた変数を指定・抽出する方法です。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1"></a>df <span class="sc">%&gt;%</span></span>
<span id="cb26-2"><a href="#cb26-2"></a>  <span class="fu">select</span>(ID, Name, Pref, Zipcode, </span>
<span id="cb26-3"><a href="#cb26-3"></a>         Line, Station, Walk, Bus, Car, Budget, ScoreN, Score)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6,292 × 12
   ID    Name  Pref  Zipcode Line  Station  Walk   Bus   Car Budget ScoreN Score
   &lt;chr&gt; &lt;chr&gt; &lt;chr&gt;   &lt;dbl&gt; &lt;chr&gt; &lt;chr&gt;   &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt;
 1 e539… 居酒… 東京… 1040031 地下… 銀座一…     3    NA    NA   3000      0 NA   
 2 gfeb… 本格… 東京… 1100005 地下… 仲御徒…     1    NA    NA   2000      2  4.5 
 3 ggt5… 食べ… 東京… 1250041 ＪＲ… 金町駅      2    NA    NA   2980      0 NA   
 4 g181… 博多… 東京… 1920904 ＪＲ  八王子…     1    NA    NA   2000      0 NA   
 5 ggww… まさ… 東京… 1500042 地下… 渋谷駅      7    NA    NA    380      0 NA   
 6 gdzk… 完全… 東京… 1000013 地下… 虎ノ門…     3    NA    NA   2980      0 NA   
 7 ga2g… 鶏そ… 東京… 1760006 西武… 江古田…     2    NA    NA    850      0 NA   
 8 gg9m… 宴会… 東京… 1010021 ＪＲ  秋葉原…     4    NA    NA   2000      3  3.33
 9 gdvk… 中国… 東京… 1000006 ＪＲ  有楽町…     1    NA    NA   1000      2  2.5 
10 gggb… 中国… 東京… 1140002 地下… 王子駅      2    NA    NA   2000      0 NA   
# … with 6,282 more rows</code></pre>
</div>
</div>
<p>　かなり長いコードになりましたね。しかし、もっと簡単な方法があります。それは<code>-</code>を使う方法です。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1"></a>df <span class="sc">%&gt;%</span></span>
<span id="cb28-2"><a href="#cb28-2"></a>  <span class="fu">select</span>(<span class="sc">-</span>Latitude, <span class="sc">-</span>Longitude) <span class="co"># select(-c(Latitude, Longitude))</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6,292 × 12
   ID    Name  Pref  Zipcode Line  Station  Walk   Bus   Car Budget ScoreN Score
   &lt;chr&gt; &lt;chr&gt; &lt;chr&gt;   &lt;dbl&gt; &lt;chr&gt; &lt;chr&gt;   &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt;
 1 e539… 居酒… 東京… 1040031 地下… 銀座一…     3    NA    NA   3000      0 NA   
 2 gfeb… 本格… 東京… 1100005 地下… 仲御徒…     1    NA    NA   2000      2  4.5 
 3 ggt5… 食べ… 東京… 1250041 ＪＲ… 金町駅      2    NA    NA   2980      0 NA   
 4 g181… 博多… 東京… 1920904 ＪＲ  八王子…     1    NA    NA   2000      0 NA   
 5 ggww… まさ… 東京… 1500042 地下… 渋谷駅      7    NA    NA    380      0 NA   
 6 gdzk… 完全… 東京… 1000013 地下… 虎ノ門…     3    NA    NA   2980      0 NA   
 7 ga2g… 鶏そ… 東京… 1760006 西武… 江古田…     2    NA    NA    850      0 NA   
 8 gg9m… 宴会… 東京… 1010021 ＪＲ  秋葉原…     4    NA    NA   2000      3  3.33
 9 gdvk… 中国… 東京… 1000006 ＪＲ  有楽町…     1    NA    NA   1000      2  2.5 
10 gggb… 中国… 東京… 1140002 地下… 王子駅      2    NA    NA   2000      0 NA   
# … with 6,282 more rows</code></pre>
</div>
</div>
<p>　除外したい変数名の前に<code>-</code>を付けただけです。また、<code>-Latitude</code>と<code>-Longitude</code>をそれぞれ指定せず、<code>-c(Latitude, Longitude)</code>のように<code>c()</code>でまとめるのも可能です。</p>
</section>
<section id="隣接した列を指定する" class="level3">
<h3 class="anchored" data-anchor-id="隣接した列を指定する">隣接した列を指定する</h3>
<p>　先ほど、<code>df</code>から緯度 (<code>Latitude</code>)と経度 (<code>Longitude</code>)を除外する例を考えてみましょう。<code>-</code>を使うと簡単ですが、場合によっては残す変数名を指定する必要もあります。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1"></a>df <span class="sc">%&gt;%</span></span>
<span id="cb30-2"><a href="#cb30-2"></a>  <span class="fu">select</span>(ID, Name, Pref, Zipcode, </span>
<span id="cb30-3"><a href="#cb30-3"></a>         Line, Station, Walk, Bus, Car, Budget, ScoreN, Score)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>　よく考えてみれば、<code>ID</code>から<code>Zipcode</code>は隣接した列ですし、<code>Line</code>から<code>Score</code>までもそうです。これは<code>names()</code>関数で確認できます。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1"></a><span class="fu">names</span>(df)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> [1] "ID"        "Name"      "Pref"      "Zipcode"   "Latitude"  "Longitude"
 [7] "Line"      "Station"   "Walk"      "Bus"       "Car"       "Budget"   
[13] "ScoreN"    "Score"    </code></pre>
</div>
</div>
<p>　ここで便利な演算子が<code>:</code>です。これまで、<code>x</code>から<code>y</code>までの公差1の等差数列を作成する際に<code>x:y</code>を使って来ましたが、これに非常に似ています。データフレーム (または、tibble)の「<code>x</code>列から<code>y</code>列まで」の表記も<code>select()</code>関数内では<code>:</code>と書くことができます。したがって、上記のコードは以下のように短縮可能です。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1"></a>df <span class="sc">%&gt;%</span></span>
<span id="cb33-2"><a href="#cb33-2"></a>  <span class="fu">select</span>(ID<span class="sc">:</span>Zipcode, Line<span class="sc">:</span>Score)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>　「<code>df</code>の<code>ID</code>から<code>Zipcode</code>まで、そして<code>Line</code>から<code>Score</code>までの列を選択する」という意味です。非常に便利な演算子ですので、<code>-</code>と合わせて覚えておきましょう。</p>
</section>
<section id="一部の列の順番だけを変える" class="level3">
<h3 class="anchored" data-anchor-id="一部の列の順番だけを変える">一部の列の順番だけを変える</h3>
<p>　ある列の位置を替えたいとします。たとえば、<code>Score</code>と<code>ScoreN</code>をそれぞれ1列目、2列目にしたい場合、どうすれば良いでしょうか。これまで勉強したことを考えると、以下のようなコードで問題ないでしょう。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1"></a>df <span class="sc">%&gt;%</span></span>
<span id="cb34-2"><a href="#cb34-2"></a>  <span class="fu">select</span>(Score, ScoreN, ID<span class="sc">:</span>Budget)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6,292 × 14
   Score ScoreN ID    Name  Pref  Zipcode Latitude Longitude Line  Station  Walk
   &lt;dbl&gt;  &lt;dbl&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt;   &lt;dbl&gt;    &lt;dbl&gt;     &lt;dbl&gt; &lt;chr&gt; &lt;chr&gt;   &lt;dbl&gt;
 1 NA         0 e539… 居酒… 東京… 1040031     35.7      140. 地下… 銀座一…     3
 2  4.5       2 gfeb… 本格… 東京… 1100005     35.7      140. 地下… 仲御徒…     1
 3 NA         0 ggt5… 食べ… 東京… 1250041     35.8      140. ＪＲ… 金町駅      2
 4 NA         0 g181… 博多… 東京… 1920904     35.7      139. ＪＲ  八王子…     1
 5 NA         0 ggww… まさ… 東京… 1500042     35.7      140. 地下… 渋谷駅      7
 6 NA         0 gdzk… 完全… 東京… 1000013     35.7      140. 地下… 虎ノ門…     3
 7 NA         0 ga2g… 鶏そ… 東京… 1760006     35.7      140. 西武… 江古田…     2
 8  3.33      3 gg9m… 宴会… 東京… 1010021     35.7      140. ＪＲ  秋葉原…     4
 9  2.5       2 gdvk… 中国… 東京… 1000006     35.7      140. ＪＲ  有楽町…     1
10 NA         0 gggb… 中国… 東京… 1140002     35.8      140. 地下… 王子駅      2
# … with 6,282 more rows, and 3 more variables: Bus &lt;dbl&gt;, Car &lt;dbl&gt;,
#   Budget &lt;dbl&gt;</code></pre>
</div>
</div>
<p>　しかし、{dplyr}には<code>relocate()</code>というより便利な専用関数を提供しています。<code>relocate()</code>には変数名を指定するだけですが、ここで指定した変数がデータフレーム (または、tibble)の最初列の方に移動します。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1"></a>df <span class="sc">%&gt;%</span></span>
<span id="cb36-2"><a href="#cb36-2"></a>  <span class="fu">relocate</span>(Score, ScoreN)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6,292 × 14
   Score ScoreN ID    Name  Pref  Zipcode Latitude Longitude Line  Station  Walk
   &lt;dbl&gt;  &lt;dbl&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt;   &lt;dbl&gt;    &lt;dbl&gt;     &lt;dbl&gt; &lt;chr&gt; &lt;chr&gt;   &lt;dbl&gt;
 1 NA         0 e539… 居酒… 東京… 1040031     35.7      140. 地下… 銀座一…     3
 2  4.5       2 gfeb… 本格… 東京… 1100005     35.7      140. 地下… 仲御徒…     1
 3 NA         0 ggt5… 食べ… 東京… 1250041     35.8      140. ＪＲ… 金町駅      2
 4 NA         0 g181… 博多… 東京… 1920904     35.7      139. ＪＲ  八王子…     1
 5 NA         0 ggww… まさ… 東京… 1500042     35.7      140. 地下… 渋谷駅      7
 6 NA         0 gdzk… 完全… 東京… 1000013     35.7      140. 地下… 虎ノ門…     3
 7 NA         0 ga2g… 鶏そ… 東京… 1760006     35.7      140. 西武… 江古田…     2
 8  3.33      3 gg9m… 宴会… 東京… 1010021     35.7      140. ＪＲ  秋葉原…     4
 9  2.5       2 gdvk… 中国… 東京… 1000006     35.7      140. ＪＲ  有楽町…     1
10 NA         0 gggb… 中国… 東京… 1140002     35.8      140. 地下… 王子駅      2
# … with 6,282 more rows, and 3 more variables: Bus &lt;dbl&gt;, Car &lt;dbl&gt;,
#   Budget &lt;dbl&gt;</code></pre>
</div>
</div>
<p>　<code>relocate()</code>を使うと<code>ID:Budget</code>が省略可能となり、より短いコードになります。もう一つの例は、最初に持ってくるのではなく、「ある変数の前」または「ある変数の後」に移動させるケースです。これも<code>relocate()</code>で可能ですが、もう一つの引数が必要です。<code>Pref</code>と<code>Zipcdoe</code>の順番を変えるなら、まずは以下のような方法が考えられます。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1"></a>df <span class="sc">%&gt;%</span></span>
<span id="cb38-2"><a href="#cb38-2"></a>  <span class="fu">select</span>(ID<span class="sc">:</span>Name, Zipcode, Pref, Latitude<span class="sc">:</span>Score)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6,292 × 14
   ID     Name  Zipcode Pref  Latitude Longitude Line  Station  Walk   Bus   Car
   &lt;chr&gt;  &lt;chr&gt;   &lt;dbl&gt; &lt;chr&gt;    &lt;dbl&gt;     &lt;dbl&gt; &lt;chr&gt; &lt;chr&gt;   &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;
 1 e5396… 居酒… 1040031 東京…     35.7      140. 地下… 銀座一…     3    NA    NA
 2 gfeb6… 本格… 1100005 東京…     35.7      140. 地下… 仲御徒…     1    NA    NA
 3 ggt59… 食べ… 1250041 東京…     35.8      140. ＪＲ… 金町駅      2    NA    NA
 4 g1813… 博多… 1920904 東京…     35.7      139. ＪＲ  八王子…     1    NA    NA
 5 ggww1… まさ… 1500042 東京…     35.7      140. 地下… 渋谷駅      7    NA    NA
 6 gdzk5… 完全… 1000013 東京…     35.7      140. 地下… 虎ノ門…     3    NA    NA
 7 ga2g2… 鶏そ… 1760006 東京…     35.7      140. 西武… 江古田…     2    NA    NA
 8 gg9m1… 宴会… 1010021 東京…     35.7      140. ＪＲ  秋葉原…     4    NA    NA
 9 gdvk2… 中国… 1000006 東京…     35.7      140. ＪＲ  有楽町…     1    NA    NA
10 gggb2… 中国… 1140002 東京…     35.8      140. 地下… 王子駅      2    NA    NA
# … with 6,282 more rows, and 3 more variables: Budget &lt;dbl&gt;, ScoreN &lt;dbl&gt;,
#   Score &lt;dbl&gt;</code></pre>
</div>
</div>
<p>　これを<code>relocate()</code>で書き換えるなら、<code>.after</code>または<code>.before</code>引数が必要になります。<code>relocate(変数名1, .after = 変数名2)</code>は「変数1を変数2の直後に移動させる」 ことを意味します。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1"></a>df <span class="sc">%&gt;%</span></span>
<span id="cb40-2"><a href="#cb40-2"></a>  <span class="fu">relocate</span>(Pref, <span class="at">.after =</span> Zipcode)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6,292 × 14
   ID     Name  Zipcode Pref  Latitude Longitude Line  Station  Walk   Bus   Car
   &lt;chr&gt;  &lt;chr&gt;   &lt;dbl&gt; &lt;chr&gt;    &lt;dbl&gt;     &lt;dbl&gt; &lt;chr&gt; &lt;chr&gt;   &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;
 1 e5396… 居酒… 1040031 東京…     35.7      140. 地下… 銀座一…     3    NA    NA
 2 gfeb6… 本格… 1100005 東京…     35.7      140. 地下… 仲御徒…     1    NA    NA
 3 ggt59… 食べ… 1250041 東京…     35.8      140. ＪＲ… 金町駅      2    NA    NA
 4 g1813… 博多… 1920904 東京…     35.7      139. ＪＲ  八王子…     1    NA    NA
 5 ggww1… まさ… 1500042 東京…     35.7      140. 地下… 渋谷駅      7    NA    NA
 6 gdzk5… 完全… 1000013 東京…     35.7      140. 地下… 虎ノ門…     3    NA    NA
 7 ga2g2… 鶏そ… 1760006 東京…     35.7      140. 西武… 江古田…     2    NA    NA
 8 gg9m1… 宴会… 1010021 東京…     35.7      140. ＪＲ  秋葉原…     4    NA    NA
 9 gdvk2… 中国… 1000006 東京…     35.7      140. ＪＲ  有楽町…     1    NA    NA
10 gggb2… 中国… 1140002 東京…     35.8      140. 地下… 王子駅      2    NA    NA
# … with 6,282 more rows, and 3 more variables: Budget &lt;dbl&gt;, ScoreN &lt;dbl&gt;,
#   Score &lt;dbl&gt;</code></pre>
</div>
</div>
<p>　<code>.before</code>を使うことできます。この場合は「<code>Zipcode</code>を<code>Pref</code>の直前に移動させる」 ことを指定する必要があります。結果は省略しますが、自分でコードを走らせ、上と同じ結果が得られるかを確認してみてください。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb42-1"><a href="#cb42-1"></a>df <span class="sc">%&gt;%</span></span>
<span id="cb42-2"><a href="#cb42-2"></a>  <span class="fu">relocate</span>(Zipcode, <span class="at">.before =</span> Pref)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="selectの便利な機能" class="level3">
<h3 class="anchored" data-anchor-id="selectの便利な機能"><code>select()</code>の便利な機能</h3>
<p>　<code>select()</code>関数は他にも便利な機能がいくつかあります。ここではいくつの機能を紹介しますが、より詳しい内容は<code>?dplyr::select</code>を参照してください。</p>
<p><strong><code>starts_with()</code>と<code>ends_with()</code>、<code>contains()</code>、<code>num_range()</code>: 特定の文字を含む変数を選択する</strong></p>
<p>　まずは、特定の文字を含む変数名を指定する方法です。<code>starts_with("X")</code>、<code>ends_with("X")</code>、<code>contains("X")</code>は変数名が<code>"X"</code>で始まるか、<code>"X"</code>で終わるか、<code>"X"</code>を含むかを判断し、条件に合う変数名を返す関数です。実際の例を見ましょう。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1"></a><span class="co"># ID、Nameに続いて、Scoreで始まる変数名を抽出</span></span>
<span id="cb43-2"><a href="#cb43-2"></a>df <span class="sc">%&gt;%</span></span>
<span id="cb43-3"><a href="#cb43-3"></a>  <span class="fu">select</span>(ID, Name, <span class="fu">starts_with</span>(<span class="st">"Score"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6,292 × 4
   ID      Name                                                     ScoreN Score
   &lt;chr&gt;   &lt;chr&gt;                                                     &lt;dbl&gt; &lt;dbl&gt;
 1 e539604 居酒屋 龍記 京橋店                                            0 NA   
 2 gfeb600 本格上海料理 新錦江 上野御徒町本店                            2  4.5 
 3 ggt5900 食べ飲み放題×中華ビストロ NOZOMI（のぞみ）                    0 NA   
 4 g181340 博多餃子軒 八王子店 タピオカ店 Bull Pulu（ブルプル）併設      0 NA   
 5 ggww100 まさ屋 渋谷店                                                 0 NA   
 6 gdzk500 完全個室 上海レストラン 檸檬 霞ヶ関ビル内店                   0 NA   
 7 ga2g202 鶏そば きらり                                                 0 NA   
 8 gg9m100 宴会個室×餃子酒場 北京飯店 秋葉原本店                         3  3.33
 9 gdvk200 中国料理 宝龍                                                 2  2.5 
10 gggb200 中国料理 天安門                                               0 NA   
# … with 6,282 more rows</code></pre>
</div>
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb45-1"><a href="#cb45-1"></a><span class="co"># eで終わる変数名を除去</span></span>
<span id="cb45-2"><a href="#cb45-2"></a>df <span class="sc">%&gt;%</span></span>
<span id="cb45-3"><a href="#cb45-3"></a>  <span class="fu">select</span>(<span class="sc">-</span><span class="fu">ends_with</span>(<span class="st">"e"</span>)) <span class="co"># !ends_with("e")も可能</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6,292 × 8
   ID      Pref   Station       Walk   Bus   Car Budget ScoreN
   &lt;chr&gt;   &lt;chr&gt;  &lt;chr&gt;        &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;
 1 e539604 東京都 銀座一丁目駅     3    NA    NA   3000      0
 2 gfeb600 東京都 仲御徒町駅       1    NA    NA   2000      2
 3 ggt5900 東京都 金町駅           2    NA    NA   2980      0
 4 g181340 東京都 八王子駅         1    NA    NA   2000      0
 5 ggww100 東京都 渋谷駅           7    NA    NA    380      0
 6 gdzk500 東京都 虎ノ門駅         3    NA    NA   2980      0
 7 ga2g202 東京都 江古田駅         2    NA    NA    850      0
 8 gg9m100 東京都 秋葉原駅         4    NA    NA   2000      3
 9 gdvk200 東京都 有楽町駅         1    NA    NA   1000      2
10 gggb200 東京都 王子駅           2    NA    NA   2000      0
# … with 6,282 more rows</code></pre>
</div>
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb47-1"><a href="#cb47-1"></a><span class="co"># reを含む変数名を抽出するが、ScoreNは除去する</span></span>
<span id="cb47-2"><a href="#cb47-2"></a>df <span class="sc">%&gt;%</span></span>
<span id="cb47-3"><a href="#cb47-3"></a>  <span class="fu">select</span>(<span class="fu">contains</span>(<span class="st">"re"</span>), <span class="sc">-</span>ScoreN)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6,292 × 2
   Pref   Score
   &lt;chr&gt;  &lt;dbl&gt;
 1 東京都 NA   
 2 東京都  4.5 
 3 東京都 NA   
 4 東京都 NA   
 5 東京都 NA   
 6 東京都 NA   
 7 東京都 NA   
 8 東京都  3.33
 9 東京都  2.5 
10 東京都 NA   
# … with 6,282 more rows</code></pre>
</div>
</div>
<p>　他の使い方としては<code>X1</code>、<code>X2</code>のような「文字+数字」の変数を選択する際、<code>starts_with()</code>が活躍します。たとえば、以下のような<code>myDF1</code>があるとします。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb49-1"><a href="#cb49-1"></a><span class="co"># tibble()の代わりにdata.frame()も使用可能</span></span>
<span id="cb49-2"><a href="#cb49-2"></a>myDF1 <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb49-3"><a href="#cb49-3"></a>  <span class="at">ID  =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>,</span>
<span id="cb49-4"><a href="#cb49-4"></a>  <span class="at">X1  =</span> <span class="fu">c</span>(<span class="dv">2</span>, <span class="dv">4</span>, <span class="dv">6</span>, <span class="dv">2</span>, <span class="dv">7</span>),</span>
<span id="cb49-5"><a href="#cb49-5"></a>  <span class="at">Y1  =</span> <span class="fu">c</span>(<span class="dv">3</span>, <span class="dv">5</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">0</span>),</span>
<span id="cb49-6"><a href="#cb49-6"></a>  <span class="at">X1D =</span> <span class="fu">c</span>(<span class="dv">4</span>, <span class="dv">2</span>, <span class="dv">1</span>, <span class="dv">6</span>, <span class="dv">9</span>),</span>
<span id="cb49-7"><a href="#cb49-7"></a>  <span class="at">X2  =</span> <span class="fu">c</span>(<span class="dv">5</span>, <span class="dv">5</span>, <span class="dv">6</span>, <span class="dv">0</span>, <span class="dv">2</span>),</span>
<span id="cb49-8"><a href="#cb49-8"></a>  <span class="at">Y2  =</span> <span class="fu">c</span>(<span class="dv">3</span>, <span class="dv">3</span>, <span class="dv">2</span>, <span class="dv">3</span>, <span class="dv">1</span>),</span>
<span id="cb49-9"><a href="#cb49-9"></a>  <span class="at">X2D =</span> <span class="fu">c</span>(<span class="dv">8</span>, <span class="dv">9</span>, <span class="dv">5</span>, <span class="dv">0</span>, <span class="dv">1</span>),</span>
<span id="cb49-10"><a href="#cb49-10"></a>  <span class="at">X3  =</span> <span class="fu">c</span>(<span class="dv">3</span>, <span class="dv">0</span>, <span class="dv">3</span>, <span class="dv">0</span>, <span class="dv">2</span>),</span>
<span id="cb49-11"><a href="#cb49-11"></a>  <span class="at">Y3  =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">5</span>, <span class="dv">9</span>, <span class="dv">1</span>, <span class="dv">3</span>),</span>
<span id="cb49-12"><a href="#cb49-12"></a>  <span class="at">X3D =</span> <span class="fu">c</span>(<span class="dv">9</span>, <span class="dv">1</span>, <span class="dv">3</span>, <span class="dv">3</span>, <span class="dv">8</span>)</span>
<span id="cb49-13"><a href="#cb49-13"></a>)</span>
<span id="cb49-14"><a href="#cb49-14"></a></span>
<span id="cb49-15"><a href="#cb49-15"></a>myDF1</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 5 × 10
     ID    X1    Y1   X1D    X2    Y2   X2D    X3    Y3   X3D
  &lt;int&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;
1     1     2     3     4     5     3     8     3     1     9
2     2     4     5     2     5     3     9     0     5     1
3     3     6     1     1     6     2     5     3     9     3
4     4     2     1     6     0     3     0     0     1     3
5     5     7     0     9     2     1     1     2     3     8</code></pre>
</div>
</div>
<p>　この<code>myDF1</code>から<code>ID</code>、<code>Y1</code>、<code>Y2</code>、<code>Y3</code>を抽出するにはどうすれば良いでしょうか。これらの変数は隣接していないため、<code>:</code>も使えませんが、<code>starts_with()</code>を使えば簡単です。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb51-1"><a href="#cb51-1"></a>myDF1 <span class="sc">%&gt;%</span></span>
<span id="cb51-2"><a href="#cb51-2"></a>  <span class="fu">select</span>(ID, <span class="fu">starts_with</span>(<span class="st">"Y"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 5 × 4
     ID    Y1    Y2    Y3
  &lt;int&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;
1     1     3     3     1
2     2     5     3     5
3     3     1     2     9
4     4     1     3     1
5     5     0     1     3</code></pre>
</div>
</div>
<p>　それでは、<code>ID</code>、<code>X1</code>、<code>X2</code>、<code>X3</code>はどうでしょうか。<code>starts_with("X")</code>だと、<code>X1c</code>なども選択されてしまいますね。ここで<code>-ends_with()</code>の出番です。つまり、「まずは<code>starts_with("X")</code>で<code>X</code>で始まる変数を選択し、続いて、<code>D</code>で終わるものを除外すればいいじゃん？」です。それでは、やってみましょうか。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb53-1"><a href="#cb53-1"></a>myDF1 <span class="sc">%&gt;%</span></span>
<span id="cb53-2"><a href="#cb53-2"></a>  <span class="fu">select</span>(ID, <span class="fu">starts_with</span>(<span class="st">"X"</span>), <span class="sc">-</span><span class="fu">ends_with</span>(<span class="st">"D"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 5 × 3
     X1    X2    X3
  &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;
1     2     5     3
2     4     5     0
3     6     6     3
4     2     0     0
5     7     2     2</code></pre>
</div>
</div>
<p>　あらら、<code>ID</code>も同時になくなりましたね<a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a>。実はこのような時のために用意された関数があり、それが<code>num_range()</code>です。<code>num_range()</code>の第一引数は<code>starts_with()</code>関数と同じですが、第二引数も必要です。この第二引数にはnumeric型のベクトルが必要です。<code>1:3</code>でも、<code>c(1, 2, 3)</code>でも構いません。たとえば、<code>ID</code>、<code>X1</code>、<code>X2</code>、<code>X3</code>するには以下のように書きます。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb55-1"><a href="#cb55-1"></a>myDF1 <span class="sc">%&gt;%</span></span>
<span id="cb55-2"><a href="#cb55-2"></a>  <span class="fu">select</span>(ID, <span class="fu">num_range</span>(<span class="st">"X"</span>, <span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 5 × 4
     ID    X1    X2    X3
  &lt;int&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;
1     1     2     5     3
2     2     4     5     0
3     3     6     6     3
4     4     2     0     0
5     5     7     2     2</code></pre>
</div>
</div>
<p><strong><code>all_of()</code>と<code>any_of()</code>: 文字型ベクトルを用いた変数の選択</strong></p>
<p>　<code>all_of()</code>と<code>any_of()</code>は<code>select()</code>内の変数名として文字型ベクトルを使う際に用いる関数です。これは抽出したい列名が既にcharacter型ベクトルとして用意されている場合、便利な関数です。たとえば、以下の<code>Name_Vec</code>を考えてみましょう。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb57"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb57-1"><a href="#cb57-1"></a>Name_Vec <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"X1"</span>, <span class="st">"X2"</span>, <span class="st">"X3"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>　この<code>Name_Vec</code>の要素と同じ列名を持つ列と<code>ID</code>列を<code>myDF1</code>から抽出する方法は以下の2通りです。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb58"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb58-1"><a href="#cb58-1"></a>myDF1[, <span class="fu">c</span>(<span class="st">"ID"</span>, Name_Vec)]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 5 × 4
     ID    X1    X2    X3
  &lt;int&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;
1     1     2     5     3
2     2     4     5     0
3     3     6     6     3
4     4     2     0     0
5     5     7     2     2</code></pre>
</div>
<div class="sourceCode cell-code" id="cb60"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb60-1"><a href="#cb60-1"></a>myDF1 <span class="sc">%&gt;%</span></span>
<span id="cb60-2"><a href="#cb60-2"></a>  <span class="fu">select</span>(ID, <span class="fu">all_of</span>(Name_Vec))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 5 × 4
     ID    X1    X2    X3
  &lt;int&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;
1     1     2     5     3
2     2     4     5     0
3     3     6     6     3
4     4     2     0     0
5     5     7     2     2</code></pre>
</div>
</div>
<p>　今の例だと、<code>select()</code>を使わない前者の方が便利かも知れませんが、<code>select()</code>内に外の変数名も指定する場合も多いので、後者の方が汎用性は高いです。私から見れば、今の例でも後者の方が読みやすく、使いやすいと思います。</p>
<p>　それでは以下のような<code>Name_Vec</code>はどうでしょう。今回は、<code>myDF1</code>に含まれていない<code>X4</code>と<code>X5</code>もあります。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb62"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb62-1"><a href="#cb62-1"></a>Name_Vec <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"X1"</span>, <span class="st">"X2"</span>, <span class="st">"X3"</span>, <span class="st">"X4"</span>, <span class="st">"X5"</span>)</span>
<span id="cb62-2"><a href="#cb62-2"></a></span>
<span id="cb62-3"><a href="#cb62-3"></a>myDF1 <span class="sc">%&gt;%</span></span>
<span id="cb62-4"><a href="#cb62-4"></a>  <span class="fu">select</span>(<span class="fu">all_of</span>(Name_Vec))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-error">
<pre><code>Error in `select()`:
! Can't subset columns that don't exist.
✖ Columns `X4` and `X5` don't exist.</code></pre>
</div>
</div>
<p>　このようにエラーが出てしまします。つまり、<code>all_of()</code>の場合、引数の要素全てがデータフレーム (または、tibble)に存在する必要があります。もし、ないものは無視して、合致する列だけ取り出したいはどうすれば良いでしょうか。そこで登場するのが<code>any_of()</code>です。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb64"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb64-1"><a href="#cb64-1"></a>myDF1 <span class="sc">%&gt;%</span></span>
<span id="cb64-2"><a href="#cb64-2"></a>  <span class="fu">select</span>(<span class="fu">any_of</span>(Name_Vec))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 5 × 3
     X1    X2    X3
  &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;
1     2     5     3
2     4     5     0
3     6     6     3
4     2     0     0
5     7     2     2</code></pre>
</div>
</div>
<p>　<code>any_of()</code>の方がより使いやすいと思う方も多いでしょうが、必ずしもそうとは限りません。たとえば、<code>Name_Vec</code>に誤字などが含まれる場合、<code>any_of()</code>だと誤字が含まれている変数は取り出しません。この場合はむしろちゃんとエラーを表示してくれた方が嬉しいですね。</p>
<p><strong><code>last_col()</code>: 最後の列を選択する</strong></p>
<p>　普段あまり使わない機能ですが、最後の列を選択する<code>last_col()</code>という関数もあります。たとえば、<code>last_col(0)</code>にすると最後の列を選択し、<code>last_col(1)</code>なら最後から2番目の列を選択します。たとえば、<code>df</code>から<code>ID</code>と最後の列を取り出してみましょう。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb66"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb66-1"><a href="#cb66-1"></a><span class="co"># IDと最後の列のみを抽出</span></span>
<span id="cb66-2"><a href="#cb66-2"></a>df <span class="sc">%&gt;%</span></span>
<span id="cb66-3"><a href="#cb66-3"></a>  <span class="fu">select</span>(ID, <span class="fu">last_col</span>(<span class="dv">0</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6,292 × 2
   ID      Score
   &lt;chr&gt;   &lt;dbl&gt;
 1 e539604 NA   
 2 gfeb600  4.5 
 3 ggt5900 NA   
 4 g181340 NA   
 5 ggww100 NA   
 6 gdzk500 NA   
 7 ga2g202 NA   
 8 gg9m100  3.33
 9 gdvk200  2.5 
10 gggb200 NA   
# … with 6,282 more rows</code></pre>
</div>
</div>
<p>　最後の2行分を取り出すことも可能です。この場合は<code>last_col()</code>の引数を長さ1ベクトルでなく、長さ2以上のベクトルにします。最後の行が<code>0</code>、その手前の行が<code>1</code>ですから、中の引数は<code>1:0</code>となります。<code>0:1</code>でも可能ですが、結果が若干異なります。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb68"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb68-1"><a href="#cb68-1"></a><span class="co"># IDと最後の2列分を抽出 (引数を1:0と設定)</span></span>
<span id="cb68-2"><a href="#cb68-2"></a>df <span class="sc">%&gt;%</span></span>
<span id="cb68-3"><a href="#cb68-3"></a>  <span class="fu">select</span>(ID, <span class="fu">last_col</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">0</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in offset &amp;&amp; n &lt;= offset: 'length(x) = 2 &gt; 1' in coercion to
'logical(1)'

Warning in offset &amp;&amp; n &lt;= offset: 'length(x) = 2 &gt; 1' in coercion to
'logical(1)'</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6,292 × 3
   ID      ScoreN Score
   &lt;chr&gt;    &lt;dbl&gt; &lt;dbl&gt;
 1 e539604      0 NA   
 2 gfeb600      2  4.5 
 3 ggt5900      0 NA   
 4 g181340      0 NA   
 5 ggww100      0 NA   
 6 gdzk500      0 NA   
 7 ga2g202      0 NA   
 8 gg9m100      3  3.33
 9 gdvk200      2  2.5 
10 gggb200      0 NA   
# … with 6,282 more rows</code></pre>
</div>
</div>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb71"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb71-1"><a href="#cb71-1"></a><span class="co"># IDと最後の2列分を抽出 (引数を0:1と設定)</span></span>
<span id="cb71-2"><a href="#cb71-2"></a>df <span class="sc">%&gt;%</span></span>
<span id="cb71-3"><a href="#cb71-3"></a>  <span class="fu">select</span>(ID, <span class="fu">last_col</span>(<span class="dv">0</span><span class="sc">:</span><span class="dv">1</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in offset &amp;&amp; n &lt;= offset: 'length(x) = 2 &gt; 1' in coercion to
'logical(1)'</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6,292 × 3
   ID      Score ScoreN
   &lt;chr&gt;   &lt;dbl&gt;  &lt;dbl&gt;
 1 e539604 NA         0
 2 gfeb600  4.5       2
 3 ggt5900 NA         0
 4 g181340 NA         0
 5 ggww100 NA         0
 6 gdzk500 NA         0
 7 ga2g202 NA         0
 8 gg9m100  3.33      3
 9 gdvk200  2.5       2
10 gggb200 NA         0
# … with 6,282 more rows</code></pre>
</div>
</div>
<p>　<code>last_col()</code>の引数を<code>1:0</code>にするか<code>0:1</code>にするかによって抽出される順番が異なります。<code>1:0</code>は<code>c(1, 0)</code>、<code>0:1</code>は<code>c(0, 1)</code>と同じであることを考えると理由は簡単です。<code>c(1, 0)</code>の場合、<code>last_col(1), last_col(0)</code>の順番で処理をし、<code>c(0, 1)</code>は<code>last_col(0)</code>、<code>last_col(1)</code>の順番で処理を行うからです。</p>
<p>　この<code>last_col()</code>の引数を空っぽにするとそれは最後の列を意味します。これを利用すれば、「ある変数の最後の列へ移動させる」こともできます。たとえば、<code>ID</code>を最後の列に移動させたい場合、<code>relocate(ID, .after = last_col())</code>のように書きます。</p>
<p><strong><code>where()</code>: データ型から変数を選択する</strong></p>
<p>　最後に、「numeric型の列のみ抽出したい」、「character型の列だけほしい」場合に便利な<code>where()</code>関数を紹介します。<code>where()</code>の中に入る引数は一つだけであり、データ型を判定する関数名が入ります。たとえば、numeric型か否かを判断する関数は<code>is.numeric</code>です。<code>df</code>からnumeric型の変数のみを抽出したい場合は以下のように書きます。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb74"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb74-1"><a href="#cb74-1"></a><span class="co"># numeric型の列を抽出する</span></span>
<span id="cb74-2"><a href="#cb74-2"></a>df <span class="sc">%&gt;%</span></span>
<span id="cb74-3"><a href="#cb74-3"></a>  <span class="fu">select</span>(<span class="fu">where</span>(is.numeric))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6,292 × 9
   Zipcode Latitude Longitude  Walk   Bus   Car Budget ScoreN Score
     &lt;dbl&gt;    &lt;dbl&gt;     &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt;
 1 1040031     35.7      140.     3    NA    NA   3000      0 NA   
 2 1100005     35.7      140.     1    NA    NA   2000      2  4.5 
 3 1250041     35.8      140.     2    NA    NA   2980      0 NA   
 4 1920904     35.7      139.     1    NA    NA   2000      0 NA   
 5 1500042     35.7      140.     7    NA    NA    380      0 NA   
 6 1000013     35.7      140.     3    NA    NA   2980      0 NA   
 7 1760006     35.7      140.     2    NA    NA    850      0 NA   
 8 1010021     35.7      140.     4    NA    NA   2000      3  3.33
 9 1000006     35.7      140.     1    NA    NA   1000      2  2.5 
10 1140002     35.8      140.     2    NA    NA   2000      0 NA   
# … with 6,282 more rows</code></pre>
</div>
</div>
<p>　<code>!</code>を使って条件に合致する列を除外することも可能です。もし、character型の列を除外する場合は以下のように<code>!where(is.character)</code>を指定します。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb76"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb76-1"><a href="#cb76-1"></a><span class="co"># character型でない列を抽出する</span></span>
<span id="cb76-2"><a href="#cb76-2"></a>df <span class="sc">%&gt;%</span></span>
<span id="cb76-3"><a href="#cb76-3"></a>  <span class="fu">select</span>(<span class="sc">!</span><span class="fu">where</span>(is.character))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6,292 × 9
   Zipcode Latitude Longitude  Walk   Bus   Car Budget ScoreN Score
     &lt;dbl&gt;    &lt;dbl&gt;     &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt;
 1 1040031     35.7      140.     3    NA    NA   3000      0 NA   
 2 1100005     35.7      140.     1    NA    NA   2000      2  4.5 
 3 1250041     35.8      140.     2    NA    NA   2980      0 NA   
 4 1920904     35.7      139.     1    NA    NA   2000      0 NA   
 5 1500042     35.7      140.     7    NA    NA    380      0 NA   
 6 1000013     35.7      140.     3    NA    NA   2980      0 NA   
 7 1760006     35.7      140.     2    NA    NA    850      0 NA   
 8 1010021     35.7      140.     4    NA    NA   2000      3  3.33
 9 1000006     35.7      140.     1    NA    NA   1000      2  2.5 
10 1140002     35.8      140.     2    NA    NA   2000      0 NA   
# … with 6,282 more rows</code></pre>
</div>
</div>
<p>　<code>&amp;</code>を使って複数の条件を使うことも可能です。たとえば、<code>ID</code>変数に加えて「<code>"L"</code>で始まる変数の中でnumeric型の列を抽出」するコードは以下のようになります。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb78"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb78-1"><a href="#cb78-1"></a><span class="co"># IDと、Lで始まるnumeric型の列を抽出する</span></span>
<span id="cb78-2"><a href="#cb78-2"></a>df <span class="sc">%&gt;%</span></span>
<span id="cb78-3"><a href="#cb78-3"></a>  <span class="fu">select</span>(ID, <span class="fu">starts_with</span>(<span class="st">"L"</span>) <span class="sc">&amp;</span> <span class="fu">where</span>(is.numeric))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6,292 × 3
   ID      Latitude Longitude
   &lt;chr&gt;      &lt;dbl&gt;     &lt;dbl&gt;
 1 e539604     35.7      140.
 2 gfeb600     35.7      140.
 3 ggt5900     35.8      140.
 4 g181340     35.7      139.
 5 ggww100     35.7      140.
 6 gdzk500     35.7      140.
 7 ga2g202     35.7      140.
 8 gg9m100     35.7      140.
 9 gdvk200     35.7      140.
10 gggb200     35.8      140.
# … with 6,282 more rows</code></pre>
</div>
</div>
</section>
</section>
<section id="行の抽出" class="level2">
<h2 class="anchored" data-anchor-id="行の抽出">行の抽出</h2>
<section id="指定した行を抽出する" class="level3">
<h3 class="anchored" data-anchor-id="指定した行を抽出する">指定した行を抽出する</h3>
<p>　他にも特定の行を抽出する場合があります。たとえば、「<code>df</code>の最初の5行」や「<code>df</code>の8行目のケース」といった場合です。この操作には{dplyr}の<code>slice_*()</code>関数群が便利です。それではそれぞれの関数の使い方について紹介していきます。その前に、実習用データとして<code>df</code>から一部の列のみを抽出した<code>selelct.df</code>を作成します。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb80"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb80-1"><a href="#cb80-1"></a>select.df <span class="ot">&lt;-</span> df <span class="sc">%&gt;%</span> </span>
<span id="cb80-2"><a href="#cb80-2"></a>  <span class="fu">select</span>(ID, Name, Pref, Budget, Score)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><strong><code>slice()</code>: 指定した番号の行のみ抽出する</strong></p>
<p>　<code>select.df</code>から2, 8, 9行目の行を抽出したいとします。このような簡単な操作はパッケージを使わず、以下のように抽出することができます。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb81"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb81-1"><a href="#cb81-1"></a><span class="co"># select.dfから2, 8, 9行目の行を抽出し、出力する</span></span>
<span id="cb81-2"><a href="#cb81-2"></a>select.df[<span class="fu">c</span>(<span class="dv">2</span>, <span class="dv">8</span>, <span class="dv">9</span>),]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 3 × 5
  ID      Name                                  Pref   Budget Score
  &lt;chr&gt;   &lt;chr&gt;                                 &lt;chr&gt;   &lt;dbl&gt; &lt;dbl&gt;
1 gfeb600 本格上海料理 新錦江 上野御徒町本店    東京都   2000  4.5 
2 gg9m100 宴会個室×餃子酒場 北京飯店 秋葉原本店 東京都   2000  3.33
3 gdvk200 中国料理 宝龍                         東京都   1000  2.5 </code></pre>
</div>
</div>
<p>　しかし、以下の<code>slice()</code>関数を使うとパイプ演算子を前後に付けることが可能であり<a href="#fn2" class="footnote-ref" id="fnref2" role="doc-noteref"><sup>2</sup></a>、コードの可読性も高いです。<code>slice()</code>関数には以下のように抽出したい行の番号を入れるだけです。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb83"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb83-1"><a href="#cb83-1"></a><span class="co"># select.dfから2, 8, 9行目の行を抽出し、出力する</span></span>
<span id="cb83-2"><a href="#cb83-2"></a>select.df <span class="sc">%&gt;%</span> </span>
<span id="cb83-3"><a href="#cb83-3"></a>  <span class="fu">slice</span>(<span class="dv">2</span>, <span class="dv">8</span>, <span class="dv">9</span>) <span class="co"># slice(c(2, 8, 9))もOK</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 3 × 5
  ID      Name                                  Pref   Budget Score
  &lt;chr&gt;   &lt;chr&gt;                                 &lt;chr&gt;   &lt;dbl&gt; &lt;dbl&gt;
1 gfeb600 本格上海料理 新錦江 上野御徒町本店    東京都   2000  4.5 
2 gg9m100 宴会個室×餃子酒場 北京飯店 秋葉原本店 東京都   2000  3.33
3 gdvk200 中国料理 宝龍                         東京都   1000  2.5 </code></pre>
</div>
</div>
<p>　<code>slice(2, 8, 9)</code>でも<code>slice(c(2, 8, 9))</code>でも構いません。また、隣接した行でしたら<code>:</code>を使うことも可能です。たとえば、10行目から15行目まで抽出する場合は<code>slice(10:15)</code>のような書き方も出来ます。</p>
<p><strong><code>slice_head()</code>: 最初のn行を抽出する</strong></p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb85"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb85-1"><a href="#cb85-1"></a><span class="co"># select.dfから最初の3行抽出し、出力する</span></span>
<span id="cb85-2"><a href="#cb85-2"></a>select.df <span class="sc">%&gt;%</span> </span>
<span id="cb85-3"><a href="#cb85-3"></a>  <span class="fu">slice_head</span>(<span class="at">n =</span> <span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 3 × 5
  ID      Name                                       Pref   Budget Score
  &lt;chr&gt;   &lt;chr&gt;                                      &lt;chr&gt;   &lt;dbl&gt; &lt;dbl&gt;
1 e539604 居酒屋 龍記 京橋店                         東京都   3000  NA  
2 gfeb600 本格上海料理 新錦江 上野御徒町本店         東京都   2000   4.5
3 ggt5900 食べ飲み放題×中華ビストロ NOZOMI（のぞみ） 東京都   2980  NA  </code></pre>
</div>
</div>
<p>　これは<code>head(データ名, n = 出力する個数)</code>と同じ動きをする関数です。注意点としては引数<code>n =</code>を必ず付ける点です。たとえば、<code>slice_head(3)</code>にすると、<code>select.df</code>の3行目のみ抽出されます。</p>
<p><strong><code>slice_tail()</code>: 最後のn行を抽出する</strong></p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb87"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb87-1"><a href="#cb87-1"></a><span class="co"># select.dfから最後の7行を抽出し、出力する</span></span>
<span id="cb87-2"><a href="#cb87-2"></a>select.df <span class="sc">%&gt;%</span> </span>
<span id="cb87-3"><a href="#cb87-3"></a>  <span class="fu">slice_tail</span>(<span class="at">n =</span> <span class="dv">7</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 7 × 5
  ID      Name                    Pref     Budget Score
  &lt;chr&gt;   &lt;chr&gt;                   &lt;chr&gt;     &lt;dbl&gt; &lt;dbl&gt;
1 5508852 場鶴                    和歌山県     NA    NA
2 7113351 来来亭 橋本店           和歌山県     NA    NA
3 6364939 ばり馬 和歌山紀三井寺店 和歌山県     NA    NA
4 7103349 ramen BIRDMAN           和歌山県     NA    NA
5 7315303 薩摩ラーメン 斗天王     和歌山県     NA    NA
6 7703472 まるしげ                和歌山県     NA    NA
7 6395035 暴豚製麺所              和歌山県     NA    NA</code></pre>
</div>
</div>
<p>　これは<code>tail(データ名, n = 出力する個数)</code>と同じ動きをする関数です。ちなみに、この<code>n</code>引数も<code>n =</code>を明記する必要があります。</p>
<p><strong><code>slice_max()</code>: 指定した変数が大きい順でn行抽出する</strong></p>
<p>　<code>slice_max()</code>は指定した変数が大きい順で<code>n</code>行抽出する関数です。たとえば、<code>Budget</code>が高い順で4店舗を抽出する場合は以下のように書きます。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb89"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb89-1"><a href="#cb89-1"></a><span class="co"># select.dfからScoreの値が高い順で5行を抽出し、出力する</span></span>
<span id="cb89-2"><a href="#cb89-2"></a>select.df <span class="sc">%&gt;%</span> </span>
<span id="cb89-3"><a href="#cb89-3"></a>  <span class="fu">slice_max</span>(Budget, <span class="at">n =</span> <span class="dv">4</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 4 × 5
  ID      Name                                              Pref    Budget Score
  &lt;chr&gt;   &lt;chr&gt;                                             &lt;chr&gt;    &lt;dbl&gt; &lt;dbl&gt;
1 g670609 横浜ベイシェラトン ホテル＆タワーズ 中国料理 彩龍 神奈川…   8000    NA
2 g910420 JASMINE 憶江南                                    東京都    7000    NA
3 7176666 赤坂焼鳥 鳳                                       東京都    7000    NA
4 b612800 羽衣 銀座本店                                     東京都    6000    NA</code></pre>
</div>
</div>
<p><strong><code>slice_min()</code>: 指定した変数が小さい順でn行抽出する</strong></p>
<p>　一方、<code>slice_min()</code>関数が小さい順で抽出します。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb91"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb91-1"><a href="#cb91-1"></a><span class="co"># select.dfからScoreの値が低い順で3行を抽出し、出力する</span></span>
<span id="cb91-2"><a href="#cb91-2"></a>select.df <span class="sc">%&gt;%</span> </span>
<span id="cb91-3"><a href="#cb91-3"></a>  <span class="fu">slice_min</span>(Score, <span class="at">n =</span> <span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 4 × 5
  ID      Name                        Pref   Budget Score
  &lt;chr&gt;   &lt;chr&gt;                       &lt;chr&gt;   &lt;dbl&gt; &lt;dbl&gt;
1 6384909 葛西大勝軒                  東京都     NA     1
2 6929243 由丸 アトレヴィ大塚店       東京都     NA     1
3 5816075 ラーメン戯拉戯拉            千葉県     NA     1
4 5495086 らあめん花月嵐 坂戸わかば店 埼玉県     NA     1</code></pre>
</div>
</div>
<p>　ただし、<code>n = 3</code>と指定したはずなのに、4行が抽出されました。これは同点のケースがあるからです。実際、<code>select.df</code>には<code>Score</code>が1のケースが4つあります。もし、同点の存在により<code>n</code>に収まらない場合、<code>slice_max()</code>、<code>slice_min()</code>関数は<code>n</code>を超える行を出力します。これを強制的に<code>n</code>行に合わせるためには<code>with_ties = FALSE</code>引数を付けます。この場合、データで格納されている順で<code>n</code>個のみ出力されます。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb93"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb93-1"><a href="#cb93-1"></a>select.df <span class="sc">%&gt;%</span> </span>
<span id="cb93-2"><a href="#cb93-2"></a>  <span class="fu">slice_min</span>(Score, <span class="at">n =</span> <span class="dv">3</span>, <span class="at">with_ties =</span> <span class="cn">FALSE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 3 × 5
  ID      Name                  Pref   Budget Score
  &lt;chr&gt;   &lt;chr&gt;                 &lt;chr&gt;   &lt;dbl&gt; &lt;dbl&gt;
1 6384909 葛西大勝軒            東京都     NA     1
2 6929243 由丸 アトレヴィ大塚店 東京都     NA     1
3 5816075 ラーメン戯拉戯拉      千葉県     NA     1</code></pre>
</div>
</div>
<p><strong><code>slice_sample()</code>: 無作為にn行を抽出する</strong></p>
<p>　最後に無作為に<code>n</code>行を抽出する<code>slice_sample()</code>関数です。引数は<code>n</code>であり、抽出したい行数を指定します。たとえば、<code>select.df</code>から無作為に10行抽出したい場合は、</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb95"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb95-1"><a href="#cb95-1"></a><span class="co"># select.dfから無作為に5行を抽出し、出力する</span></span>
<span id="cb95-2"><a href="#cb95-2"></a>select.df <span class="sc">%&gt;%</span> </span>
<span id="cb95-3"><a href="#cb95-3"></a>  <span class="fu">slice_sample</span>(<span class="at">n =</span> <span class="dv">10</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 10 × 5
   ID      Name                             Pref     Budget Score
   &lt;chr&gt;   &lt;chr&gt;                            &lt;chr&gt;     &lt;dbl&gt; &lt;dbl&gt;
 1 7327304 なかむら家                       埼玉県       NA NA   
 2 5713280 蝦夷らーめん 太志                東京都       NA NA   
 3 6284736 炙り鯛だしらーめん つけ麺 サクラ 奈良県       NA NA   
 4 6715292 保盛軒                           埼玉県       NA NA   
 5 7640541 in EZO 絆                        埼玉県       NA NA   
 6 7691208 喜喜ラーメン 本店                千葉県       NA NA   
 7 6332389 横濱家 高尾店                    東京都       NA NA   
 8 7459805 MENYA BIBIRI                     奈良県       NA NA   
 9 5508054 山神山人 大倉山店                兵庫県       NA  3.75
10 7084598 らぁめん元住家                   神奈川県     NA NA   </code></pre>
</div>
</div>
<p>　のように書きます。ブートストラップ法や機械学習における交差検証 (cross-validation)の際に有用な関数ですが、ブートストラップや機械学習のパッケージの多くはサンプル分割の関数を提供しているため、あまり使う機会はないでしょう。また、<code>slice_sample()</code>関数をブートストラップ法のために用いる場合は、ケースを反復抽出する必要があり、<code>replace = TRUE</code>を付けると反復抽出を行います。デフォルト値は<code>FALSE</code>です。</p>
</section>
<section id="条件に合致する行を抽出する" class="level3">
<h3 class="anchored" data-anchor-id="条件に合致する行を抽出する">条件に合致する行を抽出する</h3>
<p>　これまで見てきた<code>slice()</code>を用いる行の抽出は、実際あまり使う機会がありません。多くの場合、「何かの条件と合致するケースのみ抽出する」または、「何かの条件と合致しないケースのみを抽出する」やこれらの組み合わせで行の抽出を行います。そこで登場するのが<code>dplyr()</code>パッケージの<code>filter()</code>関数です。<code>filter()</code>関数の使い方は以下の通りです。</p>
<div class="sourceCode" id="cb97"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb97-1"><a href="#cb97-1" aria-hidden="true" tabindex="-1"></a><span class="co"># dplyr::filter()の使い方</span></span>
<span id="cb97-2"><a href="#cb97-2" aria-hidden="true" tabindex="-1"></a><span class="fu">filter</span>(データフレーム<span class="sc">/</span>tibble名, 条件1, 条件2, ...)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>　むろん、第一引数がデータですから、<code>%&gt;%</code>を使うことも可能です。</p>
<div class="sourceCode" id="cb98"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb98-1"><a href="#cb98-1" aria-hidden="true" tabindex="-1"></a><span class="co"># dplyr::filter()の使い方 (パイプを使う方法)</span></span>
<span id="cb98-2"><a href="#cb98-2" aria-hidden="true" tabindex="-1"></a>データフレーム<span class="sc">/</span>tibble名 <span class="sc">%&gt;%</span></span>
<span id="cb98-3"><a href="#cb98-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(条件1, 条件2, ...)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>　まずは、条件が一つの場合を考えてみましょう。ここでは「<code>Pref</code>が<code>"京都府"</code>であるケースのみに絞り、<code>Name</code>と<code>Station</code>、<code>Score</code>列のみを出力する」ケースを考えてみましょう。まず、<code>filter()</code>関数で行を抽出し、続いて<code>select()</code>関数で抽出する列を指定します。むろん、今回の場合、<code>filter()</code>と<code>select()</code>の順番は替えても構いません。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb99"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb99-1"><a href="#cb99-1"></a><span class="co"># dfからPrefが"京都府"であるケースのみ残し、df2という名で保存</span></span>
<span id="cb99-2"><a href="#cb99-2"></a>df2 <span class="ot">&lt;-</span> df <span class="sc">%&gt;%</span></span>
<span id="cb99-3"><a href="#cb99-3"></a>  <span class="fu">filter</span>(Pref <span class="sc">==</span> <span class="st">"京都府"</span>)</span>
<span id="cb99-4"><a href="#cb99-4"></a></span>
<span id="cb99-5"><a href="#cb99-5"></a><span class="co"># df2からName, Station, Score列を抽出</span></span>
<span id="cb99-6"><a href="#cb99-6"></a>df2 <span class="sc">%&gt;%</span></span>
<span id="cb99-7"><a href="#cb99-7"></a>  <span class="fu">select</span>(Name, Station, Score)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 414 × 3
   Name                                                    Station    Score
   &lt;chr&gt;                                                   &lt;chr&gt;      &lt;dbl&gt;
 1 中国料理 鳳麟                                           くいな橋駅 NA   
 2 黒毛和牛一頭買い焼肉と 炊き立て土鍋ご飯 市場小路 烏丸店 四条駅      3.19
 3 京の中華 ハマムラ みやこみち店                          京都駅     NA   
 4 焼肉処 真 桂店                                          桂駅       NA   
 5 祇園京都ラーメン                                        祇園四条駅 NA   
 6 創作料理 串カツ トンカツ jiro                           新田辺駅   NA   
 7 祇園 晩餐のあと                                         祇園四条駅 NA   
 8 DETAIL                                                  東山駅     NA   
 9 めんや龍神                                              北大路駅   NA   
10 無尽蔵 京都八条家                                       京都駅      3.5 
# … with 404 more rows</code></pre>
</div>
</div>
<p>　これは<code>df</code>から<code>Pref == "京都府"</code>のケースのみ残したものを<code>df2</code>として格納し、それをまた<code>select()</code>関数を使って列を抽出するコードです。これでも問題ありませんが、これだとパイプ演算子の便利さが分かりません。パイプ演算子は複数使うことが可能です。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb101"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb101-1"><a href="#cb101-1"></a>df <span class="sc">%&gt;%</span></span>
<span id="cb101-2"><a href="#cb101-2"></a>  <span class="fu">filter</span>(Pref <span class="sc">==</span> <span class="st">"京都府"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb101-3"><a href="#cb101-3"></a>  <span class="fu">select</span>(Name, Station, Score)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 414 × 3
   Name                                                    Station    Score
   &lt;chr&gt;                                                   &lt;chr&gt;      &lt;dbl&gt;
 1 中国料理 鳳麟                                           くいな橋駅 NA   
 2 黒毛和牛一頭買い焼肉と 炊き立て土鍋ご飯 市場小路 烏丸店 四条駅      3.19
 3 京の中華 ハマムラ みやこみち店                          京都駅     NA   
 4 焼肉処 真 桂店                                          桂駅       NA   
 5 祇園京都ラーメン                                        祇園四条駅 NA   
 6 創作料理 串カツ トンカツ jiro                           新田辺駅   NA   
 7 祇園 晩餐のあと                                         祇園四条駅 NA   
 8 DETAIL                                                  東山駅     NA   
 9 めんや龍神                                              北大路駅   NA   
10 無尽蔵 京都八条家                                       京都駅      3.5 
# … with 404 more rows</code></pre>
</div>
</div>
<p>　全く同じ結果ですが、無駄に<code>df2</code>というデータフレーム (または、tibble)を作らず済むので、メモリの観点からも嬉しいですし、何よりコードが短く、しかも可読性も上がりました。</p>
<p>　今回は<code>==</code>を使って<strong>合致する</strong>ものに絞りましたが、<code>!=</code>を使って<strong>合致しない</strong>ものに絞ることも可能です。または、比較演算子 (<code>&lt;</code>、<code>&gt;</code>、<code>&gt;=</code>、<code>&lt;=</code>など)を使うことも可能です。それでは、組み込み数 (<code>ScoreN</code>)が<em>0ではない</em>ケースを取り出し、<code>Name</code>、<code>Station</code>、<code>ScoreN</code>、<code>Score</code>列を出力させてみましょう。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb103"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb103-1"><a href="#cb103-1"></a>df <span class="sc">%&gt;%</span></span>
<span id="cb103-2"><a href="#cb103-2"></a>  <span class="fu">filter</span>(ScoreN <span class="sc">!=</span> <span class="dv">0</span>) <span class="sc">%&gt;%</span></span>
<span id="cb103-3"><a href="#cb103-3"></a>  <span class="fu">select</span>(Name, Station, <span class="fu">starts_with</span>(<span class="st">"Score"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1,344 × 4
   Name                                              Station       ScoreN Score
   &lt;chr&gt;                                             &lt;chr&gt;          &lt;dbl&gt; &lt;dbl&gt;
 1 本格上海料理 新錦江 上野御徒町本店                仲御徒町駅         2  4.5 
 2 宴会個室×餃子酒場 北京飯店 秋葉原本店             秋葉原駅           3  3.33
 3 中国料理 宝龍                                     有楽町駅           2  2.5 
 4 麺達 うま家                                       高田馬場駅         2  3   
 5 刀削麺・火鍋・西安料理 XI’AN（シーアン） 後楽園店 後楽園駅           1 NA   
 6 七志らーめん 渋谷道玄坂店                         渋谷駅             7  4.5 
 7 永楽                                              京成小岩駅         6  4.42
 8 よってこや お台場店                               お台場海浜公…      1  4   
 9 ラーメン武藤製麺所                                竹ノ塚駅           4  3.5 
10 桂花ラーメン 新宿末広店                           新宿三丁目駅       8  3   
# … with 1,334 more rows</code></pre>
</div>
</div>
<p>　これで口コミ数が1以上の店舗のみに絞ることができました。ただし、店によっては口コミはあっても、評価 (<code>Score</code>)が付いていないところもあります。たとえば、「刀削麺・火鍋・西安料理 XI’AN（シーアン） 後楽園店」の場合、口コミはありますが、評価はありません。したがって、今回は評価が付いている店舗に絞ってみましょう。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb105"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb105-1"><a href="#cb105-1"></a>df <span class="sc">%&gt;%</span></span>
<span id="cb105-2"><a href="#cb105-2"></a>  <span class="fu">filter</span>(Score <span class="sc">!=</span> <span class="cn">NA</span>) <span class="sc">%&gt;%</span></span>
<span id="cb105-3"><a href="#cb105-3"></a>  <span class="fu">select</span>(Name, Station, <span class="fu">starts_with</span>(<span class="st">"Score"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 0 × 4
# … with 4 variables: Name &lt;chr&gt;, Station &lt;chr&gt;, ScoreN &lt;dbl&gt;, Score &lt;dbl&gt;</code></pre>
</div>
</div>
<p>　あらら、何の結果も表示されませんでした。これは<code>filter()</code>内の条件に合致するケースが存在しないことを意味します。しかし、先ほどの結果を見ても、評価が付いている店はいっぱいありましたね。これはなぜでしょう。</p>
<p>　察しの良い読者さんは気づいているかと思いますが、<code>NA</code>か否かを判定する際は<code>==</code>や<code>!=</code>は使えません。<code>is.na()</code>を使います。<code>filter(is.na(Score))</code>なら「<code>Score</code>が<code>NA</code><strong>である</strong>ケースに絞る」ことを意味しますが、今回は「<code>Score</code>が<code>NA</code><strong>でない</strong>ケースに絞る」ことが目的ですので、<code>is.na()</code>の前に<code>!</code>を付けます。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb107"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb107-1"><a href="#cb107-1"></a>df <span class="sc">%&gt;%</span></span>
<span id="cb107-2"><a href="#cb107-2"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(Score)) <span class="sc">%&gt;%</span></span>
<span id="cb107-3"><a href="#cb107-3"></a>  <span class="fu">select</span>(Name, Station, <span class="fu">starts_with</span>(<span class="st">"Score"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1,134 × 4
   Name                                  Station          ScoreN Score
   &lt;chr&gt;                                 &lt;chr&gt;             &lt;dbl&gt; &lt;dbl&gt;
 1 本格上海料理 新錦江 上野御徒町本店    仲御徒町駅            2  4.5 
 2 宴会個室×餃子酒場 北京飯店 秋葉原本店 秋葉原駅              3  3.33
 3 中国料理 宝龍                         有楽町駅              2  2.5 
 4 麺達 うま家                           高田馬場駅            2  3   
 5 七志らーめん 渋谷道玄坂店             渋谷駅                7  4.5 
 6 永楽                                  京成小岩駅            6  4.42
 7 よってこや お台場店                   お台場海浜公園駅      1  4   
 8 ラーメン武藤製麺所                    竹ノ塚駅              4  3.5 
 9 桂花ラーメン 新宿末広店               新宿三丁目駅          8  3   
10 北斗 新橋店                           新橋駅                4  2.5 
# … with 1,124 more rows</code></pre>
</div>
</div>
<p>　これで口コミ評価が登録された店舗に絞ることができました。</p>
<p>　続いて、複数の条件を持つケースを考えてみましょう。例えば、「京都府内の店舗で、口コミ評価が3.5以上の店舗」を出力したい場合、以下のようなコードとなります。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb109"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb109-1"><a href="#cb109-1"></a>df <span class="sc">%&gt;%</span></span>
<span id="cb109-2"><a href="#cb109-2"></a>  <span class="fu">filter</span>(Pref <span class="sc">==</span> <span class="st">"京都府"</span>, Score <span class="sc">&gt;=</span> <span class="fl">3.5</span>) <span class="sc">%&gt;%</span></span>
<span id="cb109-3"><a href="#cb109-3"></a>  <span class="fu">select</span>(Name, Station, ScoreN, Score)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 53 × 4
   Name               Station    ScoreN Score
   &lt;chr&gt;              &lt;chr&gt;       &lt;dbl&gt; &lt;dbl&gt;
 1 無尽蔵 京都八条家  京都駅          2  3.5 
 2 一蘭 京都河原町店  河原町駅        2  3.75
 3 ミスター・ギョーザ 西大路駅        8  4.06
 4 一蘭 京都八幡店    樟葉駅          3  4   
 5 中華料理 清華園    京都駅          3  5   
 6 まがり             &lt;NA&gt;            2  4   
 7 魁力屋 北山店      北大路駅        2  4.25
 8 大中BAL横店        &lt;NA&gt;            7  4.1 
 9 こうちゃん         西舞鶴駅        1  5   
10 大黒ラーメン       伏見桃山駅      4  4.25
# … with 43 more rows</code></pre>
</div>
</div>
<p>　条件を<code>filter()</code>内に追加するだけです。今回は<code>!is.na(Score)</code>は不要です。なぜなら、<code>Score &gt;= 3.5</code>という条件で既に欠損値は対象外になるからです。条件文が複数ある場合、ANDかORかを指定する必要があります。つまり、条件文AとBがある場合、「AとB両方満たすものを出力する」か「AとBどちらかを満たすものを出力するか」を指定する必要があります。今の結果ってANDでしたよね。<code>filter()</code>関数は、別途の指定がない場合、全てAND扱いになります。RのAND演算子は<code>&amp;</code>ですので、以上のコードは以下のコードと同じです。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb111"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb111-1"><a href="#cb111-1"></a>df <span class="sc">%&gt;%</span></span>
<span id="cb111-2"><a href="#cb111-2"></a>  <span class="fu">filter</span>(Pref <span class="sc">==</span> <span class="st">"京都府"</span> <span class="sc">&amp;</span> Score <span class="sc">&gt;=</span> <span class="fl">3.5</span>) <span class="sc">%&gt;%</span></span>
<span id="cb111-3"><a href="#cb111-3"></a>  <span class="fu">select</span>(Name, Station, ScoreN, Score)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 53 × 4
   Name               Station    ScoreN Score
   &lt;chr&gt;              &lt;chr&gt;       &lt;dbl&gt; &lt;dbl&gt;
 1 無尽蔵 京都八条家  京都駅          2  3.5 
 2 一蘭 京都河原町店  河原町駅        2  3.75
 3 ミスター・ギョーザ 西大路駅        8  4.06
 4 一蘭 京都八幡店    樟葉駅          3  4   
 5 中華料理 清華園    京都駅          3  5   
 6 まがり             &lt;NA&gt;            2  4   
 7 魁力屋 北山店      北大路駅        2  4.25
 8 大中BAL横店        &lt;NA&gt;            7  4.1 
 9 こうちゃん         西舞鶴駅        1  5   
10 大黒ラーメン       伏見桃山駅      4  4.25
# … with 43 more rows</code></pre>
</div>
</div>
<p>　AND演算子 (<code>&amp;</code>)が使えるということはOR演算子 (<code>|</code>)も使えることを意味します。たとえば、<code>Station</code>が<code>"高田馬場駅"</code>か<code>"三田駅"</code>の条件を指定したい場合、</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb113"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb113-1"><a href="#cb113-1"></a>df <span class="sc">%&gt;%</span> </span>
<span id="cb113-2"><a href="#cb113-2"></a>  <span class="fu">filter</span>(Station <span class="sc">==</span> <span class="st">"高田馬場駅"</span> <span class="sc">|</span> Station <span class="sc">==</span> <span class="st">"三田駅"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb113-3"><a href="#cb113-3"></a>  <span class="fu">select</span>(Name, Station, ScoreN, Score)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 14 × 4
   Name                                 Station    ScoreN Score
   &lt;chr&gt;                                &lt;chr&gt;       &lt;dbl&gt; &lt;dbl&gt;
 1 麺達 うま家                          高田馬場駅      2  3   
 2 らぁ麺 やまぐち                      高田馬場駅      7  4.08
 3 博多一瑞亭 三田店                    三田駅          0 NA   
 4 つけ麺屋 ひまわり                    高田馬場駅      4  2.75
 5 石器ラーメン 高田馬場                高田馬場駅      0 NA   
 6 旨辛らーめん 表裏                    高田馬場駅      0 NA   
 7 三歩一                               高田馬場駅      8  4.56
 8 えぞ菊 戸塚店                        高田馬場駅      4  3.62
 9 麺屋　宗                             高田馬場駅      5  4.2 
10 とんこつラーメン 博多風龍 高田馬場店 高田馬場駅      2  3   
11 横浜家系ラーメン 馬場壱家            高田馬場駅      0 NA   
12 らーめん よし丸                      高田馬場駅      1  5   
13 札幌ラーメン どさん子 三田店         三田駅          0 NA   
14 天下一品 三田店                      三田駅          0 NA   </code></pre>
</div>
</div>
<p>　のように書きます（ちなみに高田馬場の「やまぐち」は本当に美味しいです）。むろん、複数の変数を用いたORも可能です。たとえば、「<code>Pref</code>が<code>"京都府"</code>か<code>Score</code>が3以上」のような条件も可能ですが (<code>Pref == "京都府" | Score &gt;= 3</code>)、実際、このような例はあまりありません。よく使うのは「変数<code>X</code>が<code>a</code>か<code>b</code>か<code>c</code>か」のような例です。ただし、この場合は<code>|</code>を使わないもっと簡単な方法があります。それは<code>%in%</code>演算子です。以下のコードは上のコードと同じものです。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb115"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb115-1"><a href="#cb115-1"></a>df <span class="sc">%&gt;%</span> </span>
<span id="cb115-2"><a href="#cb115-2"></a>  <span class="fu">filter</span>(Station <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"高田馬場駅"</span>, <span class="st">"三田駅"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb115-3"><a href="#cb115-3"></a>  <span class="fu">select</span>(Name, Station, ScoreN, Score)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 14 × 4
   Name                                 Station    ScoreN Score
   &lt;chr&gt;                                &lt;chr&gt;       &lt;dbl&gt; &lt;dbl&gt;
 1 麺達 うま家                          高田馬場駅      2  3   
 2 らぁ麺 やまぐち                      高田馬場駅      7  4.08
 3 博多一瑞亭 三田店                    三田駅          0 NA   
 4 つけ麺屋 ひまわり                    高田馬場駅      4  2.75
 5 石器ラーメン 高田馬場                高田馬場駅      0 NA   
 6 旨辛らーめん 表裏                    高田馬場駅      0 NA   
 7 三歩一                               高田馬場駅      8  4.56
 8 えぞ菊 戸塚店                        高田馬場駅      4  3.62
 9 麺屋　宗                             高田馬場駅      5  4.2 
10 とんこつラーメン 博多風龍 高田馬場店 高田馬場駅      2  3   
11 横浜家系ラーメン 馬場壱家            高田馬場駅      0 NA   
12 らーめん よし丸                      高田馬場駅      1  5   
13 札幌ラーメン どさん子 三田店         三田駅          0 NA   
14 天下一品 三田店                      三田駅          0 NA   </code></pre>
</div>
</div>
<p>　結局、<code>|</code>が使われるケースがかなり限定されます。あるとすれば、「変数<code>X</code>が<code>a</code>以下か、<code>b</code>以上か」のようなケースですね。ただし、<code>&amp;</code>と<code>|</code>を同時に使うケースは考えられます。たとえば、大阪駅と京都駅周辺のうまいラーメン屋を調べるとします。問題は美味しさの基準ですが、3.5点以上としましょう。ただし、京都府民はラーメンに非常に厳しく、3点以上なら美味しいと仮定します。この場合、「(<code>Station</code>が<code>"大阪駅"</code>かつ<code>Score &gt;= 3.5</code>)、または(<code>Station</code>が<code>"京都駅"</code>かつ<code>Score &gt;= 3</code>)」のような条件が必要になります。<code>()</code>は「<code>()</code>の中から判定せよ」という、普通の算数での使い方と同じです。それでは、実際に検索してみましょう。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb117"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb117-1"><a href="#cb117-1"></a>df <span class="sc">%&gt;%</span></span>
<span id="cb117-2"><a href="#cb117-2"></a>  <span class="fu">filter</span>((Station <span class="sc">==</span> <span class="st">"大阪駅"</span> <span class="sc">&amp;</span> Score <span class="sc">&gt;=</span> <span class="fl">3.5</span>) <span class="sc">|</span> (Station <span class="sc">==</span> <span class="st">"京都駅"</span> <span class="sc">&amp;</span> Score <span class="sc">&gt;=</span> <span class="dv">3</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb117-3"><a href="#cb117-3"></a>  <span class="fu">select</span>(Name, Station, Walk, ScoreN, Score)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 5
  Name                      Station  Walk ScoreN Score
  &lt;chr&gt;                     &lt;chr&gt;   &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt;
1 Lei can ting 大阪ルクア店 大阪駅      3      3  4   
2 神座 ルクア大阪店         大阪駅      1     10  3.94
3 みつか坊主 醸             大阪駅     10      4  5   
4 無尽蔵 京都八条家         京都駅      5      2  3.5 
5 中華料理 清華園           京都駅     10      3  5   
6 ますたに 京都拉麺小路店   京都駅      9      3  3.67</code></pre>
</div>
</div>
<p>　Songが大好きな神座がヒットして嬉しいです。</p>
</section>
</section>
<section id="行のソート" class="level2">
<h2 class="anchored" data-anchor-id="行のソート">行のソート</h2>
<p>　続いて、行のソートについて解説します。「食べログ」などのレビューサービスを利用する場合、口コミ評価が高い順で見るのが一般的でしょう<a href="#fn3" class="footnote-ref" id="fnref3" role="doc-noteref"><sup>3</sup></a>。また、サッカーのランキングも多くは1位から下の順位で掲載されるのが一般的です。ここではこのようにある変数の値順に行を並び替える方法について説明します。</p>
<p>　ソートには{dplyr}パッケージの<code>arrange()</code>関数を使います。引数は変数名のみです。たとえば、奈良県のラーメン屋を検索してみましょう。並び替える順は駅から近い店舗を上位に、遠い店舗を下位に並べます。このような順は<strong>昇順 (ascending)</strong>と呼ばれ、ランキング表などでよく見ます。駅から近い順にソートするので、まず最寄りの駅情報が欠損でないことが必要です。また、ラーメン屋の評価も気になるので口コミが1つ以上付いている店舗に絞りましょう。表示する列は店舗名、最寄りの駅、徒歩距離、口コミ数、点数です。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb119"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb119-1"><a href="#cb119-1"></a>df <span class="sc">%&gt;%</span></span>
<span id="cb119-2"><a href="#cb119-2"></a>  <span class="fu">filter</span>(Pref <span class="sc">==</span> <span class="st">"奈良県"</span>, <span class="sc">!</span><span class="fu">is.na</span>(Station), ScoreN <span class="sc">&gt;</span> <span class="dv">0</span>) <span class="sc">%&gt;%</span></span>
<span id="cb119-3"><a href="#cb119-3"></a>  <span class="fu">select</span>(Name, Station, Walk, ScoreN, Score) <span class="sc">%&gt;%</span></span>
<span id="cb119-4"><a href="#cb119-4"></a>  <span class="fu">arrange</span>(Walk) <span class="sc">%&gt;%</span></span>
<span id="cb119-5"><a href="#cb119-5"></a>  <span class="fu">print</span>(<span class="at">n =</span> <span class="cn">Inf</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 24 × 5
   Name                                  Station             Walk ScoreN Score
   &lt;chr&gt;                                 &lt;chr&gt;              &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt;
 1 麺屋 あまのじゃく 本店                富雄駅                 2      2  4.5 
 2 紀州和歌山らーめんきぶんや 奈良富雄店 富雄駅                 4      1  4   
 3 ラーメン家 みつ葉                     富雄駅                 4      1  3.5 
 4 天下一品 新大宮店                     新大宮駅               6      1  3   
 5 麺屋 一徳                             天理駅                 7      1  3   
 6 丸源ラーメン 橿原店                   金橋駅                 8      1  3.5 
 7 らーめん食堂 よってこや 平群店        元山上口駅            10      1  4   
 8 天理スタミナラーメン本店              櫟本駅                11      2  3.25
 9 博多長浜らーめん夢街道 奈良土橋店     真菅駅                11      1  3.5 
10 ぶ～け                                奈良駅                11      1  5   
11 つけめん らーめん元喜神 押熊店        学研奈良登美ヶ丘駅    12      4  4.12
12 彩華ラーメン 本店                     前栽駅                12      5  3.6 
13 力皇                                  天理駅                13      1  3.5 
14 らーめん きみちゃん                   京終駅                14      2  4.5 
15 無鉄砲がむしゃら                      帯解駅                15      2  4   
16 彩華ラーメン 田原本店                 石見駅                15      1  4   
17 神座 大和高田店                       大和高田駅            17      2  3.75
18 彩華ラーメン 奈良店                   尼ヶ辻駅              17      3  4.33
19 彩華ラーメン 桜井店                   大福駅                18      1  3   
20 天下一品 東生駒店                     東生駒駅              19      1  3.5 
21 まりお流ラーメン                      新大宮駅              20      1  5   
22 どうとんぼり神座 奈良柏木店           西ノ京駅              22      1  3   
23 河童ラーメン本舗 押熊店               学研奈良登美ヶ丘駅    28      1  4   
24 博多長浜らーめん 夢街道 四条大路店    新大宮駅              29      4  2.88</code></pre>
</div>
</div>
<p>　3行まではこれまで習ってきたもので、4行目がソートの関数、<code>arrange()</code>です。引数はソートの基準となる変数で、今回は最寄りの駅からの徒歩距離を表す<code>Walk</code>です。5行目は省略可能ですが、<code>tibble</code>クラスの場合、10行までしか出力されないので、<code>print(n = Inf)</code>で「すべての行を表示」させます。<code>n</code>を指定することで出力される行数が調整可能です。奈良県のラーメン屋の中で最寄りの駅から最も近い店は「<a href="https://www.menya-amanojaku.com">麺屋 あまのじゃく 本店</a>」で徒歩2分でした。京田辺店も駅から約2分ですし、近いですね。ちなみにSongはここの塩とんこつが好きです。世界一こってりなラーメンとも言われる「チョモランマ」で有名な「<a href="http://www.marioramen.com">まりお流ラーメン</a>」は新大宮駅から徒歩20分でかなり遠いことが分かります。</p>
<p>　続いて、駅からの距離ではなく、評価が高い順にしてみましょう。評価が高いほど上に来るので、今回は昇順でなく、<strong>降順 (descending)</strong>でソートする必要があります。<code>arrange()</code>関数は基本的に、指定された変数を基準に昇順でソートします。降順にするためには<code>desc()</code>関数を更に用います。たとえば、<code>arrange(desc(変数名))</code>のようにです。それでは実際にやってみましょう。上のコードの4行目を<code>arange(Walk)</code>から<code>arrange(desc(Score))</code>にちょっと修正するだけです。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb121"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb121-1"><a href="#cb121-1"></a>df <span class="sc">%&gt;%</span></span>
<span id="cb121-2"><a href="#cb121-2"></a>  <span class="fu">filter</span>(Pref <span class="sc">==</span> <span class="st">"奈良県"</span>, <span class="sc">!</span><span class="fu">is.na</span>(Station), ScoreN <span class="sc">&gt;</span> <span class="dv">0</span>) <span class="sc">%&gt;%</span></span>
<span id="cb121-3"><a href="#cb121-3"></a>  <span class="fu">select</span>(Name, Station, Walk, ScoreN, Score) <span class="sc">%&gt;%</span></span>
<span id="cb121-4"><a href="#cb121-4"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(Score)) <span class="sc">%&gt;%</span></span>
<span id="cb121-5"><a href="#cb121-5"></a>  <span class="fu">print</span>(<span class="at">n =</span> <span class="cn">Inf</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 24 × 5
   Name                                  Station             Walk ScoreN Score
   &lt;chr&gt;                                 &lt;chr&gt;              &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt;
 1 まりお流ラーメン                      新大宮駅              20      1  5   
 2 ぶ～け                                奈良駅                11      1  5   
 3 麺屋 あまのじゃく 本店                富雄駅                 2      2  4.5 
 4 らーめん きみちゃん                   京終駅                14      2  4.5 
 5 彩華ラーメン 奈良店                   尼ヶ辻駅              17      3  4.33
 6 つけめん らーめん元喜神 押熊店        学研奈良登美ヶ丘駅    12      4  4.12
 7 河童ラーメン本舗 押熊店               学研奈良登美ヶ丘駅    28      1  4   
 8 無鉄砲がむしゃら                      帯解駅                15      2  4   
 9 紀州和歌山らーめんきぶんや 奈良富雄店 富雄駅                 4      1  4   
10 彩華ラーメン 田原本店                 石見駅                15      1  4   
11 らーめん食堂 よってこや 平群店        元山上口駅            10      1  4   
12 神座 大和高田店                       大和高田駅            17      2  3.75
13 彩華ラーメン 本店                     前栽駅                12      5  3.6 
14 天下一品 東生駒店                     東生駒駅              19      1  3.5 
15 力皇                                  天理駅                13      1  3.5 
16 博多長浜らーめん夢街道 奈良土橋店     真菅駅                11      1  3.5 
17 ラーメン家 みつ葉                     富雄駅                 4      1  3.5 
18 丸源ラーメン 橿原店                   金橋駅                 8      1  3.5 
19 天理スタミナラーメン本店              櫟本駅                11      2  3.25
20 麺屋 一徳                             天理駅                 7      1  3   
21 どうとんぼり神座 奈良柏木店           西ノ京駅              22      1  3   
22 彩華ラーメン 桜井店                   大福駅                18      1  3   
23 天下一品 新大宮店                     新大宮駅               6      1  3   
24 博多長浜らーめん 夢街道 四条大路店    新大宮駅              29      4  2.88</code></pre>
</div>
</div>
<p>　よく考えてみれば、「評価が同点の場合、どうなるの?」と疑問を抱く方がいるかも知れません。たとえば、7行目の「河童ラーメン本舗 押熊店」と8行目の「無鉄砲がむしゃら」はどれも評価が4点ですが、「河童ラーメン本舗 押熊店」が先に表示されます。そのこれは簡単です。同点の場合、データセット内で上に位置する行が先に表示されます。これを確認するには<code>which()</code>関数を使います。<code>()</code>内に条件文を指定することで、この条件に合致する要素の位置を返します。もし、条件に合致するものが複数あった場合は全ての位置を返します<a href="#fn4" class="footnote-ref" id="fnref4" role="doc-noteref"><sup>4</sup></a>。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb123"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb123-1"><a href="#cb123-1"></a><span class="fu">which</span>(df<span class="sc">$</span>Name <span class="sc">==</span> <span class="st">"河童ラーメン本舗 押熊店"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 6021</code></pre>
</div>
<div class="sourceCode cell-code" id="cb125"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb125-1"><a href="#cb125-1"></a><span class="fu">which</span>(df<span class="sc">$</span>Name <span class="sc">==</span> <span class="st">"無鉄砲がむしゃら"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 6040</code></pre>
</div>
</div>
<p>　データ内に「河童ラーメン本舗 押熊店」がより上に位置することが分かります。「もし同点なら口コミ評価数が多いところにしたい」場合はどうすれば良いでしょうか。これは<code>arrange()</code>内に変数名を足すだけで十分です。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb127"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb127-1"><a href="#cb127-1"></a>df <span class="sc">%&gt;%</span></span>
<span id="cb127-2"><a href="#cb127-2"></a>  <span class="fu">filter</span>(Pref <span class="sc">==</span> <span class="st">"奈良県"</span>, <span class="sc">!</span><span class="fu">is.na</span>(Station), ScoreN <span class="sc">&gt;</span> <span class="dv">0</span>) <span class="sc">%&gt;%</span></span>
<span id="cb127-3"><a href="#cb127-3"></a>  <span class="fu">select</span>(Name, Station, Walk, ScoreN, Score) <span class="sc">%&gt;%</span></span>
<span id="cb127-4"><a href="#cb127-4"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(Score), <span class="fu">desc</span>(ScoreN)) <span class="sc">%&gt;%</span></span>
<span id="cb127-5"><a href="#cb127-5"></a>  <span class="fu">print</span>(<span class="at">n =</span> <span class="cn">Inf</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 24 × 5
   Name                                  Station             Walk ScoreN Score
   &lt;chr&gt;                                 &lt;chr&gt;              &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt;
 1 まりお流ラーメン                      新大宮駅              20      1  5   
 2 ぶ～け                                奈良駅                11      1  5   
 3 麺屋 あまのじゃく 本店                富雄駅                 2      2  4.5 
 4 らーめん きみちゃん                   京終駅                14      2  4.5 
 5 彩華ラーメン 奈良店                   尼ヶ辻駅              17      3  4.33
 6 つけめん らーめん元喜神 押熊店        学研奈良登美ヶ丘駅    12      4  4.12
 7 無鉄砲がむしゃら                      帯解駅                15      2  4   
 8 河童ラーメン本舗 押熊店               学研奈良登美ヶ丘駅    28      1  4   
 9 紀州和歌山らーめんきぶんや 奈良富雄店 富雄駅                 4      1  4   
10 彩華ラーメン 田原本店                 石見駅                15      1  4   
11 らーめん食堂 よってこや 平群店        元山上口駅            10      1  4   
12 神座 大和高田店                       大和高田駅            17      2  3.75
13 彩華ラーメン 本店                     前栽駅                12      5  3.6 
14 天下一品 東生駒店                     東生駒駅              19      1  3.5 
15 力皇                                  天理駅                13      1  3.5 
16 博多長浜らーめん夢街道 奈良土橋店     真菅駅                11      1  3.5 
17 ラーメン家 みつ葉                     富雄駅                 4      1  3.5 
18 丸源ラーメン 橿原店                   金橋駅                 8      1  3.5 
19 天理スタミナラーメン本店              櫟本駅                11      2  3.25
20 麺屋 一徳                             天理駅                 7      1  3   
21 どうとんぼり神座 奈良柏木店           西ノ京駅              22      1  3   
22 彩華ラーメン 桜井店                   大福駅                18      1  3   
23 天下一品 新大宮店                     新大宮駅               6      1  3   
24 博多長浜らーめん 夢街道 四条大路店    新大宮駅              29      4  2.88</code></pre>
</div>
</div>
<p>　ソートの基準は<code>arrange()</code>内において先に指定された変数の順番となります。「口コミ評価も評価数も同じなら、駅から近いところにしたい」場合は変数が3つとなり、<code>Score</code>、<code>ScoreN</code>、<code>Walk</code>の順で入れます。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb129"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb129-1"><a href="#cb129-1"></a>df <span class="sc">%&gt;%</span></span>
<span id="cb129-2"><a href="#cb129-2"></a>  <span class="fu">filter</span>(Pref <span class="sc">==</span> <span class="st">"奈良県"</span>, <span class="sc">!</span><span class="fu">is.na</span>(Station), ScoreN <span class="sc">&gt;</span> <span class="dv">0</span>) <span class="sc">%&gt;%</span></span>
<span id="cb129-3"><a href="#cb129-3"></a>  <span class="fu">select</span>(Name, Station, Walk, ScoreN, Score) <span class="sc">%&gt;%</span></span>
<span id="cb129-4"><a href="#cb129-4"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(Score), <span class="fu">desc</span>(ScoreN), Walk) <span class="sc">%&gt;%</span></span>
<span id="cb129-5"><a href="#cb129-5"></a>  <span class="fu">print</span>(<span class="at">n =</span> <span class="cn">Inf</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 24 × 5
   Name                                  Station             Walk ScoreN Score
   &lt;chr&gt;                                 &lt;chr&gt;              &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt;
 1 ぶ～け                                奈良駅                11      1  5   
 2 まりお流ラーメン                      新大宮駅              20      1  5   
 3 麺屋 あまのじゃく 本店                富雄駅                 2      2  4.5 
 4 らーめん きみちゃん                   京終駅                14      2  4.5 
 5 彩華ラーメン 奈良店                   尼ヶ辻駅              17      3  4.33
 6 つけめん らーめん元喜神 押熊店        学研奈良登美ヶ丘駅    12      4  4.12
 7 無鉄砲がむしゃら                      帯解駅                15      2  4   
 8 紀州和歌山らーめんきぶんや 奈良富雄店 富雄駅                 4      1  4   
 9 らーめん食堂 よってこや 平群店        元山上口駅            10      1  4   
10 彩華ラーメン 田原本店                 石見駅                15      1  4   
11 河童ラーメン本舗 押熊店               学研奈良登美ヶ丘駅    28      1  4   
12 神座 大和高田店                       大和高田駅            17      2  3.75
13 彩華ラーメン 本店                     前栽駅                12      5  3.6 
14 ラーメン家 みつ葉                     富雄駅                 4      1  3.5 
15 丸源ラーメン 橿原店                   金橋駅                 8      1  3.5 
16 博多長浜らーめん夢街道 奈良土橋店     真菅駅                11      1  3.5 
17 力皇                                  天理駅                13      1  3.5 
18 天下一品 東生駒店                     東生駒駅              19      1  3.5 
19 天理スタミナラーメン本店              櫟本駅                11      2  3.25
20 天下一品 新大宮店                     新大宮駅               6      1  3   
21 麺屋 一徳                             天理駅                 7      1  3   
22 彩華ラーメン 桜井店                   大福駅                18      1  3   
23 どうとんぼり神座 奈良柏木店           西ノ京駅              22      1  3   
24 博多長浜らーめん 夢街道 四条大路店    新大宮駅              29      4  2.88</code></pre>
</div>
</div>
</section>
<section id="記述統計量の計算" class="level2">
<h2 class="anchored" data-anchor-id="記述統計量の計算">記述統計量の計算</h2>
<section id="summariseによる記述統計量の計算" class="level3">
<h3 class="anchored" data-anchor-id="summariseによる記述統計量の計算"><code>summarise()</code>による記述統計量の計算</h3>
<p>　ある変数の平均値や標準偏差、最小値、最大値などの記述統計量 (要約統計量)を計算することも可能です。これは<code>summarize()</code>または<code>summarise()</code>関数を使いますが、この関数は後で紹介する<code>group_by()</code>関数と組み合わせることで力を発揮します。ここではグルーピングを考えずに、全データの記述統計量を計算する方法を紹介します。</p>
<p>　<code>summarise()</code>関数の使い方は以下の通りです。</p>
<div class="sourceCode" id="cb131"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb131-1"><a href="#cb131-1" aria-hidden="true" tabindex="-1"></a><span class="co"># summarise()関数の使い方</span></span>
<span id="cb131-2"><a href="#cb131-2" aria-hidden="true" tabindex="-1"></a>データフレーム<span class="sc">/</span>tibble名 <span class="sc">%&gt;%</span></span>
<span id="cb131-3"><a href="#cb131-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(新しい変数名 <span class="ot">=</span> 関数名(計算の対象となる変数名))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>　もし、<code>Score</code>変数の平均値を計算し、その結果を<code>Mean</code>という列にしたい場合は以下のようなコードになります。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb132"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb132-1"><a href="#cb132-1"></a>df <span class="sc">%&gt;%</span></span>
<span id="cb132-2"><a href="#cb132-2"></a>  <span class="fu">summarise</span>(<span class="at">Mean =</span> <span class="fu">mean</span>(Score))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 × 1
   Mean
  &lt;dbl&gt;
1    NA</code></pre>
</div>
</div>
<p>　ただし、<code>mean()</code>関数は欠損値が含まれるベクトルの場合、<code>NA</code>を返します。この場合方法は2つ考えられます。</p>
<ol type="1">
<li><code>filter()</code>関数を使って<code>Score</code>が欠損しているケースを予め除去する。</li>
<li><code>na.rm</code>引数を指定し、欠損値を除去した平均値を求める。</li>
</ol>
<p>　ここでは2番目の方法を使います。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb134"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb134-1"><a href="#cb134-1"></a>df <span class="sc">%&gt;%</span></span>
<span id="cb134-2"><a href="#cb134-2"></a>  <span class="fu">summarise</span>(<span class="at">Mean =</span> <span class="fu">mean</span>(Score, <span class="at">na.rm =</span> <span class="cn">TRUE</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 × 1
   Mean
  &lt;dbl&gt;
1  3.66</code></pre>
</div>
</div>
<p>　<code>df</code>の<code>Score</code>変数の平均値はNAであることが分かります。また、<code>summarise()</code>関数は複数の記述統計量を同時に計算することも可能です。以下は<code>Score</code>変数の平均値、中央値、標準偏差、最小値、最大値、第一四分位点、第三四分位点を計算し、<code>Score.Desc</code>という名のデータフレーム (または、tibble)に格納するコードです。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb136"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb136-1"><a href="#cb136-1"></a>Score.Desc <span class="ot">&lt;-</span> df <span class="sc">%&gt;%</span></span>
<span id="cb136-2"><a href="#cb136-2"></a>  <span class="fu">summarize</span>(<span class="at">Mean   =</span>     <span class="fu">mean</span>(Score,       <span class="at">na.rm =</span> <span class="cn">TRUE</span>),  <span class="co"># 平均値</span></span>
<span id="cb136-3"><a href="#cb136-3"></a>            <span class="at">Median =</span>   <span class="fu">median</span>(Score,       <span class="at">na.rm =</span> <span class="cn">TRUE</span>),  <span class="co"># 中央値</span></span>
<span id="cb136-4"><a href="#cb136-4"></a>            <span class="at">SD     =</span>       <span class="fu">sd</span>(Score,       <span class="at">na.rm =</span> <span class="cn">TRUE</span>),  <span class="co"># 標準偏差</span></span>
<span id="cb136-5"><a href="#cb136-5"></a>            <span class="at">Min    =</span>      <span class="fu">min</span>(Score,       <span class="at">na.rm =</span> <span class="cn">TRUE</span>),  <span class="co"># 最小値</span></span>
<span id="cb136-6"><a href="#cb136-6"></a>            <span class="at">Max    =</span>      <span class="fu">max</span>(Score,       <span class="at">na.rm =</span> <span class="cn">TRUE</span>),  <span class="co"># 最大値</span></span>
<span id="cb136-7"><a href="#cb136-7"></a>            <span class="at">Q1     =</span> <span class="fu">quantile</span>(Score, <span class="fl">0.25</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),  <span class="co"># 第一四分位点</span></span>
<span id="cb136-8"><a href="#cb136-8"></a>            <span class="at">Q3     =</span> <span class="fu">quantile</span>(Score, <span class="fl">0.75</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>))  <span class="co"># 第三四分位点</span></span>
<span id="cb136-9"><a href="#cb136-9"></a></span>
<span id="cb136-10"><a href="#cb136-10"></a>Score.Desc</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 × 7
   Mean Median    SD   Min   Max    Q1    Q3
  &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;
1  3.66   3.58 0.719     1     5     3     4</code></pre>
</div>
</div>
<p>　むろん、複数の変数に対して記述統計量を計算することも可能です。たとえば、平均予算 (<code>Budget</code>)、口コミ数 (<code>ScoreN</code>)、口コミ評価 (<code>Score</code>)の平均値を求めるとしたら、</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb138"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb138-1"><a href="#cb138-1"></a>df <span class="sc">%&gt;%</span></span>
<span id="cb138-2"><a href="#cb138-2"></a>  <span class="fu">summarize</span>(<span class="at">Budget_Mean =</span> <span class="fu">mean</span>(Budget, <span class="at">na.rm =</span> <span class="cn">TRUE</span>), <span class="co"># 平均予算の平均値</span></span>
<span id="cb138-3"><a href="#cb138-3"></a>            <span class="at">SocreN_Mean =</span> <span class="fu">mean</span>(ScoreN, <span class="at">na.rm =</span> <span class="cn">TRUE</span>), <span class="co"># 口コミ数の平均値</span></span>
<span id="cb138-4"><a href="#cb138-4"></a>            <span class="at">Score_Mean  =</span> <span class="fu">mean</span>(Score,  <span class="at">na.rm =</span> <span class="cn">TRUE</span>)) <span class="co"># 評価の平均値</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 × 3
  Budget_Mean SocreN_Mean Score_Mean
        &lt;dbl&gt;       &lt;dbl&gt;      &lt;dbl&gt;
1       1232.       0.537       3.66</code></pre>
</div>
</div>
<p>のように書きます。実は<code>summarise()</code>はこれくらいで十分便利です。ただし、以上の操作はもっと簡単なコードに置換できます。ただし、ラムダ式など、やや高度な内容になるため、以下の内容は飛ばして、次の節 (グルーピング)を読んでいただいても構いません。</p>
<p>　まずは、複数の変数に対して同じ記述統計量を求める例を考えてみましょう。たとえば、<code>Budget</code>、<code>ScoreN</code>、<code>Score</code>に対して平均値を求める例です。これは<code>across()</code>関数を使うとよりコードが短くなります。まずは<code>across()</code>関数の書き方から見ましょう。</p>
<div class="sourceCode" id="cb140"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb140-1"><a href="#cb140-1" aria-hidden="true" tabindex="-1"></a><span class="co"># across()の使い方</span></span>
<span id="cb140-2"><a href="#cb140-2" aria-hidden="true" tabindex="-1"></a>データフレーム<span class="sc">/</span>tibble名 <span class="sc">%&gt;%</span></span>
<span id="cb140-3"><a href="#cb140-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="fu">across</span>(変数名のベクトル, 記述統計を計算する関数名, 関数の引数))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>　<em>変数名のベクトル</em>は長さ1以上のベクトルです。たとえば、<code>Budget</code>、<code>ScoreN</code>、<code>Score</code>の場合<code>c(Budget, ScoreN, Score)</code>になります。これは<code>df</code>内で隣接する変数ですから<code>Budget:Score</code>の書き方も使えます。また、<code>where()</code>や<code>any_of()</code>、<code>starts_with()</code>のような関数を使って変数を指定することも可能です。<em>関数名</em>は<code>mean</code>や<code>sd</code>などの関数名です。ここは<code>関数名()</code>でななく、<code>関数名</code>であることに注意してください。<em>引数</em>は前の関数に必要な引数です。引数を必要としない関数なら省略可能ですが、<code>na.rm = TRUE</code>などの引数が必要な場合は指定する必要があります。それでは<code>Budget</code>、<code>ScoreN</code>、<code>Score</code>の平均値を計算してみましょう。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb141"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb141-1"><a href="#cb141-1"></a>df <span class="sc">%&gt;%</span></span>
<span id="cb141-2"><a href="#cb141-2"></a>  <span class="fu">summarize</span>(<span class="fu">across</span>(Budget<span class="sc">:</span>Score, mean, <span class="at">na.rm =</span> <span class="cn">TRUE</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 × 3
  Budget ScoreN Score
   &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt;
1  1232.  0.537  3.66</code></pre>
</div>
</div>
<p>　<code>across()</code>使わない場合、4行必要だったコードが2行になりました。変数が少ない場合は<code>across()</code>を使わない方が、可読性が高くなる場合もあります。しかし、変数が多くなる場合、可読性がやや落ちても<code>across()</code>を使った方が効率的でしょう。</p>
<p>　次は、ある変数に対して複数の記述統計量を計算したい場合について考えます。<code>Budget</code>、<code>ScoreN</code>、<code>Score</code>変数の第一四分位点と第三四分位点を<code>across()</code>を使わずに計算すると家のような7行のコードになります。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb143"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb143-1"><a href="#cb143-1"></a>df <span class="sc">%&gt;%</span></span>
<span id="cb143-2"><a href="#cb143-2"></a>  <span class="fu">summarize</span>(<span class="at">Budget_Q1 =</span> <span class="fu">quantile</span>(Budget, <span class="fl">0.25</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb143-3"><a href="#cb143-3"></a>            <span class="at">Budget_Q3 =</span> <span class="fu">quantile</span>(Budget, <span class="fl">0.75</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb143-4"><a href="#cb143-4"></a>            <span class="at">ScoreN_Q1 =</span> <span class="fu">quantile</span>(ScoreN, <span class="fl">0.25</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb143-5"><a href="#cb143-5"></a>            <span class="at">ScoreN_Q3 =</span> <span class="fu">quantile</span>(ScoreN, <span class="fl">0.75</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb143-6"><a href="#cb143-6"></a>            <span class="at">Score_Q1  =</span> <span class="fu">quantile</span>(Score,  <span class="fl">0.25</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb143-7"><a href="#cb143-7"></a>            <span class="at">Score_Q3  =</span> <span class="fu">quantile</span>(Score,  <span class="fl">0.75</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 × 6
  Budget_Q1 Budget_Q3 ScoreN_Q1 ScoreN_Q3 Score_Q1 Score_Q3
      &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;    &lt;dbl&gt;    &lt;dbl&gt;
1       800      1000         0         0        3        4</code></pre>
</div>
</div>
<p>　この作業も<code>across()</code>を使ってより短縮することができます。ここではラムダ式の知識が必要になります。ラムダ関数とは関数名を持たない<a href="https://ja.wikipedia.org/wiki/無名関数">無名関数 (anonymous functions)</a>を意味しますが、詳細は割愛します。興味のある読者は<a href="https://ja.wikipedia.org/wiki/無名関数">Wikipedia</a>などを参照してください。簡単にいうとその場で即席に関数を作成し、計算が終わったら破棄する関数です。ただ、Rは基本的にラムダ式を提供しているのではなく、{purrr}パッケージのラムダ式スタイルを使用します。まずは、書き方から確認します。</p>
<div class="sourceCode" id="cb145"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb145-1"><a href="#cb145-1" aria-hidden="true" tabindex="-1"></a><span class="co"># ラムダ式を用いたacross()の使い方</span></span>
<span id="cb145-2"><a href="#cb145-2" aria-hidden="true" tabindex="-1"></a>データフレーム<span class="sc">/</span>tibble名 <span class="sc">%&gt;%</span></span>
<span id="cb145-3"><a href="#cb145-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="fu">across</span>(変数名のベクトル, <span class="fu">list</span>(結果の変数名 <span class="ot">=</span> ラムダ式)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>　先ほどの書き方と似ていますが、関数を複数書く必要があるため、今回は関数名をlist型にまとめます。そして、<em>結果の変数名</em>は結果として出力されるデータフレーム (または、tibble)の列名を指定する引数です。たとえば、<code>Mean</code>にすると結果は<code>元の変数名1_Mean</code>、<code>元の変数名2_Mean</code>…のように出力されます。そして、ラムダ式が実際の関数が入る箇所です。とりあえず今回はコードを走らせ、結果から確認してみましょう。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb146"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb146-1"><a href="#cb146-1"></a>df <span class="sc">%&gt;%</span></span>
<span id="cb146-2"><a href="#cb146-2"></a>  <span class="fu">summarize</span>(<span class="fu">across</span>(Budget<span class="sc">:</span>Score, <span class="fu">list</span>(<span class="at">Q1 =</span> <span class="sc">~</span><span class="fu">quantile</span>(.x, <span class="fl">0.25</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb146-3"><a href="#cb146-3"></a>                                      <span class="at">Q3 =</span> <span class="sc">~</span><span class="fu">quantile</span>(.x, <span class="fl">0.75</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>))))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 × 6
  Budget_Q1 Budget_Q3 ScoreN_Q1 ScoreN_Q3 Score_Q1 Score_Q3
      &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;    &lt;dbl&gt;    &lt;dbl&gt;
1       800      1000         0         0        3        4</code></pre>
</div>
</div>
<p>　結果の列名が<code>Budget_Q1</code>、<code>Budget_Q3</code>、<code>ScoreN_Q1</code>…のようになり、それぞれの変数の第一四分位点と第三四分位点が出力されます。問題はラムダ式の方ですが、普通の関数に非常に近いことが分かります。<code>across()</code>内のラムダ式は<code>~関数名(.x, その他の引数)</code>のような書き方になります。関数名の前に<code>~</code>が付いていることに注意してください。分位数を求める関数は<code>quantile()</code>であり、<code>quantile(ベクトル, 分位数)</code>であり、必要に応じて<code>na.rm</code>を付けます。この分位数が0.25なら第一四分位点、0.5なら第二四分位点 (=中央値)、0.75なら第三四分位点になります。それではラムダ式<code>~quantile(.x, 0.25, na.rm = TRUE)</code>はどういう意味でしょうか。これは<code>.x</code>の箇所に<code>Budget</code>や<code>ScoreN</code>、<code>Score</code>が入ることを意味します。<code>.x</code>という書き方は決まりです。<code>.y</code>とか<code>.Song-san-Daisuki</code>などはダメです。そして、<code>0.25</code>を付けることによって第一四分位点を出力するように指定します。また、<code>Budget</code>、<code>ScoreN</code>、<code>Score</code>に欠損値がある場合、無視するように<code>na.rm = TRUE</code>を付けます。</p>
<p>　ラムダ式を自分で定義する関数で表現すると、以下のようになります。</p>
<div class="sourceCode" id="cb148"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb148-1"><a href="#cb148-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 以下の3つは同じ機能をする関数である</span></span>
<span id="cb148-2"><a href="#cb148-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb148-3"><a href="#cb148-3" aria-hidden="true" tabindex="-1"></a><span class="co"># ラムダ式</span></span>
<span id="cb148-4"><a href="#cb148-4" aria-hidden="true" tabindex="-1"></a><span class="sc">~</span><span class="fu">quantile</span>(.x, <span class="fl">0.25</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb148-5"><a href="#cb148-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb148-6"><a href="#cb148-6" aria-hidden="true" tabindex="-1"></a><span class="co"># 一般的な関数の書き方1</span></span>
<span id="cb148-7"><a href="#cb148-7" aria-hidden="true" tabindex="-1"></a>名無し関数 <span class="ot">&lt;-</span> <span class="cf">function</span>(x) {</span>
<span id="cb148-8"><a href="#cb148-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">quantile</span>(x, <span class="fl">0.25</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb148-9"><a href="#cb148-9" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb148-10"><a href="#cb148-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb148-11"><a href="#cb148-11" aria-hidden="true" tabindex="-1"></a><span class="co"># 一般的な関数の書き方2</span></span>
<span id="cb148-12"><a href="#cb148-12" aria-hidden="true" tabindex="-1"></a>名無し関数 <span class="ot">&lt;-</span> <span class="cf">function</span>(x) <span class="fu">quantile</span>(x, <span class="fl">0.25</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>　この3つは全て同じですが、ラムダ式は関数名を持たず、その場で使い捨てる関数です。むろん、ラムダ式を使わずに事前に第一四分位点と第三四分位点を求める関数を予め作成し、ラムダ式の代わりに使うことも可能です。まずは第一四分位点と第三四分位点を求める自作関数<code>FuncQ1</code>と<code>FuncQ2</code>を作成します。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb149"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb149-1"><a href="#cb149-1"></a><span class="co"># ラムダ式を使わない場合は事前に関数を定義しておく必要がある</span></span>
<span id="cb149-2"><a href="#cb149-2"></a>FuncQ1 <span class="ot">&lt;-</span> <span class="cf">function</span>(x) {</span>
<span id="cb149-3"><a href="#cb149-3"></a>  <span class="fu">quantile</span>(x, <span class="fl">0.25</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb149-4"><a href="#cb149-4"></a>}</span>
<span id="cb149-5"><a href="#cb149-5"></a>FuncQ3 <span class="ot">&lt;-</span> <span class="cf">function</span>(x) {</span>
<span id="cb149-6"><a href="#cb149-6"></a>  <span class="fu">quantile</span>(x, <span class="fl">0.75</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb149-7"><a href="#cb149-7"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>　後は先ほどのほぼ同じ書き方ですが、今回はラムダ式を使わないため関数名に<code>~</code>を付けず、関数名のみで十分です。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb150"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb150-1"><a href="#cb150-1"></a><span class="co"># やっておくと、summarise()文は簡潔になる</span></span>
<span id="cb150-2"><a href="#cb150-2"></a>df <span class="sc">%&gt;%</span></span>
<span id="cb150-3"><a href="#cb150-3"></a>  <span class="fu">summarize</span>(<span class="fu">across</span>(Budget<span class="sc">:</span>Score, <span class="fu">list</span>(<span class="at">Q1 =</span> FuncQ1, <span class="at">Q3 =</span> FuncQ3)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 × 6
  Budget_Q1 Budget_Q3 ScoreN_Q1 ScoreN_Q3 Score_Q1 Score_Q3
      &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;    &lt;dbl&gt;    &lt;dbl&gt;
1       800      1000         0         0        3        4</code></pre>
</div>
</div>
<p>　事前に関数を用意するのが面倒ですが、<code>across()</code>の中身はかなりスッキリしますね。もし、このような作業を何回も行うなら、ラムダ式を使わず、自作関数を用いることも可能です。ただし、自作関数であっても引数が2つ以上必要な場合はラムダ式を使います。</p>
</section>
<section id="summariseに使える便利な関数" class="level3">
<h3 class="anchored" data-anchor-id="summariseに使える便利な関数"><code>summarise()</code>に使える便利な関数</h3>
<p>　以下の内容は後で説明する<code>group_by()</code>関数を使っているため、まだ<code>group_by()</code>に馴染みのない読者はまずはここを読み飛ばし、グルーピングの節にお進みください。</p>
<p><strong><code>IQR()</code>: 四分位範囲を求める</strong></p>
<p>　四分位範囲は第三四分位点から第一四分位点を引いた値であり、Rの内蔵関数である<code>IQR()</code>を使えば便利です。この関数は<code>mean</code>や<code>sd()</code>関数と同じ使い方となります。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb152"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb152-1"><a href="#cb152-1"></a>df <span class="sc">%&gt;%</span></span>
<span id="cb152-2"><a href="#cb152-2"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(Walk)) <span class="sc">%&gt;%</span> <span class="co"># 予め欠損したケースを除くと、後でna.rm = TRUEが不要</span></span>
<span id="cb152-3"><a href="#cb152-3"></a>  <span class="fu">group_by</span>(Pref) <span class="sc">%&gt;%</span></span>
<span id="cb152-4"><a href="#cb152-4"></a>  <span class="fu">summarise</span>(<span class="at">Mean    =</span> <span class="fu">mean</span>(Walk),</span>
<span id="cb152-5"><a href="#cb152-5"></a>            <span class="at">SD      =</span> <span class="fu">sd</span>(Walk),</span>
<span id="cb152-6"><a href="#cb152-6"></a>            <span class="at">IQR     =</span> <span class="fu">IQR</span>(Walk),</span>
<span id="cb152-7"><a href="#cb152-7"></a>            <span class="at">N       =</span> <span class="fu">n</span>(),</span>
<span id="cb152-8"><a href="#cb152-8"></a>            <span class="at">.groups =</span> <span class="st">"drop"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb152-9"><a href="#cb152-9"></a>  <span class="fu">arrange</span>(Mean)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 9 × 5
  Pref      Mean    SD   IQR     N
  &lt;chr&gt;    &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;int&gt;
1 東京都    4.29  4.49     4   919
2 大阪府    5.92  6.08     6   932
3 神奈川県  8.21  7.91    10   878
4 京都府    8.38  6.95     9   339
5 兵庫県    8.52  7.27    10   484
6 奈良県   10.6   6.59    10   123
7 千葉県   10.6   8.21    12   776
8 埼玉県   11.6   8.99    14   817
9 和歌山県 12.8   6.83     9   107</code></pre>
</div>
</div>
<p><strong><code>first()</code>、<code>last()</code>、<code>nth()</code>: n番目の要素を求める</strong></p>
<p>　稀なケースかも知れませんが、データ内、またはグループ内の<code>n</code>番目の行を抽出する時があります。たとえば、市区町村の情報が格納されているデータセットで、人口が大きい順でデータがソートされているとします。各都道府県ごとに最も人口が大きい市区町村のデータ、あるいは最も少ない市区町村のデータが必要な際、<code>first()</code>と<code>last()</code>関数が有効です。</p>
<p>　それでは各都道府県ごとに「最も駅から遠いラーメン屋」の店舗名と最寄りの駅からの徒歩距離を出力したいとします。まずは、徒歩距離のデータが欠損しているケースを除去し、データを徒歩距離順でソートします。これは<code>filter()</code>と<code>arrange()</code>関数を使えば簡単です。続いて、<code>group_by()</code>を使って都府県単位でデータをグループ化します。最後に<code>summarise()</code>関数内に<code>last()</code>関数を使います。データは駅から近い順に鳴っているため、各都府県内の最後の行は駅から最も遠い店舗になるからです。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb154"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb154-1"><a href="#cb154-1"></a>df <span class="sc">%&gt;%</span></span>
<span id="cb154-2"><a href="#cb154-2"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(Walk)) <span class="sc">%&gt;%</span></span>
<span id="cb154-3"><a href="#cb154-3"></a>  <span class="fu">arrange</span>(Walk) <span class="sc">%&gt;%</span></span>
<span id="cb154-4"><a href="#cb154-4"></a>  <span class="fu">group_by</span>(Pref) <span class="sc">%&gt;%</span></span>
<span id="cb154-5"><a href="#cb154-5"></a>  <span class="fu">summarise</span>(<span class="at">Farthest  =</span> <span class="fu">last</span>(Name),</span>
<span id="cb154-6"><a href="#cb154-6"></a>            <span class="at">Distance  =</span> <span class="fu">last</span>(Walk),</span>
<span id="cb154-7"><a href="#cb154-7"></a>            <span class="at">.groups   =</span> <span class="st">"drop"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 9 × 3
  Pref     Farthest                           Distance
  &lt;chr&gt;    &lt;chr&gt;                                 &lt;dbl&gt;
1 京都府   熱烈らぁめん                             30
2 兵庫県   濃厚醤油 中華そば いせや 玉津店          43
3 千葉県   札幌ラーメン どさん子 佐原51号店         59
4 和歌山県 中華そば まる乃                          30
5 埼玉県   札幌ラーメン どさん子 小鹿野店          116
6 大阪府   河童ラーメン本舗 岸和田店                38
7 奈良県   博多長浜らーめん 夢街道 四条大路店       29
8 東京都   てんがら 青梅新町店                      30
9 神奈川県 札幌ラーメン どさん子 中津店             73</code></pre>
</div>
</div>
<p>　この<code>last()</code>を<code>first()</code>に変えると、最寄りの駅から最も近い店舗情報が表示されます。また、「<code>n</code>番目の情報」が必要な際は<code>nth()</code>関数を使います。<code>nth(Name, 2)</code>に変えることで2番目の店舗名が抽出できます。</p>
<p><strong><code>n_distinct()</code>: ユニーク値の個数を求める</strong></p>
<p>　<code>n_distinct()</code>は何種類の要素が含まれているかを計算する関数であり、<code>length(unique())</code>関数と同じ機能をします。たとえば、以下の<code>myVec1</code>に対して何種類の要素があるかを確認してみましょう。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb156"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb156-1"><a href="#cb156-1"></a>myVec1 <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"A"</span>, <span class="st">"B"</span>, <span class="st">"B"</span>, <span class="st">"D"</span>, <span class="st">"A"</span>, <span class="st">"B"</span>, <span class="st">"D"</span>, <span class="st">"C"</span>, <span class="st">"A"</span>)</span>
<span id="cb156-2"><a href="#cb156-2"></a></span>
<span id="cb156-3"><a href="#cb156-3"></a><span class="fu">unique</span>(myVec1)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "A" "B" "D" "C"</code></pre>
</div>
</div>
<p>　<code>myVec1</code>は<code>"A"</code>、<code>"B"</code>、<code>"D"</code>、<code>"C"</code>の要素で構成されていることが分かります。これが<code>myVec1</code>の<strong>ユニーク値 (unique values)</strong>です。そして、このユニーク値の個数を調べるために<code>length()</code>を使います。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb158"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb158-1"><a href="#cb158-1"></a><span class="fu">length</span>(<span class="fu">unique</span>(myVec1))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 4</code></pre>
</div>
</div>
<p>　これで<code>myVec1</code>は4種類の値が存在することが分かります。これと全く同じ機能をする関数が<code>n_distinct()</code>です。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb160"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb160-1"><a href="#cb160-1"></a><span class="fu">n_distinct</span>(myVec1)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 4</code></pre>
</div>
</div>
<p>　この関数を<code>summarise()</code>に使うことで、都府県ごとに駅の個数が分かります。あるいは「東京都内の選挙区に、これまでの衆院選において何人の候補者が存在したか」も分かります。ここでは<code>df</code>内の都府県ごとに駅の個数を計算してみましょう。最後の駅数が多い順でソートします。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb162"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb162-1"><a href="#cb162-1"></a>df <span class="sc">%&gt;%</span></span>
<span id="cb162-2"><a href="#cb162-2"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(Station)) <span class="sc">%&gt;%</span> <span class="co"># 最寄りの駅が欠損しているケースを除去</span></span>
<span id="cb162-3"><a href="#cb162-3"></a>  <span class="fu">group_by</span>(Pref) <span class="sc">%&gt;%</span></span>
<span id="cb162-4"><a href="#cb162-4"></a>  <span class="fu">summarise</span>(<span class="at">N_Station =</span> <span class="fu">n_distinct</span>(Station),</span>
<span id="cb162-5"><a href="#cb162-5"></a>            <span class="at">.groups   =</span> <span class="st">"drop"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb162-6"><a href="#cb162-6"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(N_Station))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 9 × 2
  Pref     N_Station
  &lt;chr&gt;        &lt;int&gt;
1 東京都         368
2 大阪府         341
3 千葉県         241
4 神奈川県       240
5 兵庫県         199
6 埼玉県         185
7 京都府         123
8 奈良県          52
9 和歌山県        46</code></pre>
</div>
</div>
<p>　当たり前かも知れませんが、駅数が最も多いのは東京都で次が大阪府であることが分かります。</p>
<p><strong><code>any()</code>、<code>all()</code>: 条件に合致するか否かを求める</strong></p>
<p>　<code>any()</code>と<code>all()</code>はベクトル内の全要素に対して条件に合致するか否かを判定する関数です。ただし、<code>any()</code>は一つの要素でも条件に合致すれば<code>TRUE</code>を、全要素が合致しない場合<code>FALSE</code>を返します。一方、<code>all()</code>は全要素に対して条件を満たせば<code>TRUE</code>、一つでも満たさない要素があれば<code>FALSE</code>を返します。以下は<code>any()</code>と<code>all()</code>の例です。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb164"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb164-1"><a href="#cb164-1"></a>myVec1 <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>, <span class="dv">4</span>, <span class="dv">5</span>)</span>
<span id="cb164-2"><a href="#cb164-2"></a>myVec2 <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">3</span>, <span class="dv">5</span>, <span class="dv">7</span>, <span class="dv">11</span>)</span>
<span id="cb164-3"><a href="#cb164-3"></a></span>
<span id="cb164-4"><a href="#cb164-4"></a><span class="fu">any</span>(myVec1 <span class="sc">%%</span> <span class="dv">2</span> <span class="sc">==</span> <span class="dv">0</span>) <span class="co"># myVec1を2で割った場合、一つでも余りが0か</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] TRUE</code></pre>
</div>
<div class="sourceCode cell-code" id="cb166"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb166-1"><a href="#cb166-1"></a><span class="fu">all</span>(myVec1 <span class="sc">%%</span> <span class="dv">2</span> <span class="sc">==</span> <span class="dv">0</span>) <span class="co"># myVec1を2で割った場合、全ての余りが0か</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] FALSE</code></pre>
</div>
<div class="sourceCode cell-code" id="cb168"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb168-1"><a href="#cb168-1"></a><span class="fu">all</span>(myVec2 <span class="sc">%%</span> <span class="dv">2</span> <span class="sc">!=</span> <span class="dv">0</span>) <span class="co"># myVec2を2で割った場合、全ての余りが0ではないか</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] TRUE</code></pre>
</div>
</div>
<p>　それでは実際に<code>df</code>に対して<code>any()</code>と<code>all()</code>関数を使ってみましょう。一つ目は「ある都府県に最寄りの駅から徒歩60分以上の店舗が<strong>一つでも</strong>あるか」であり、二つ目は「ある都府県の店舗は<strong>全て</strong>最寄りの駅から徒歩30分以下か」です。それぞれの結果を<code>Over60</code>と<code>Within30</code>という列で出力してみましょう。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb170"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb170-1"><a href="#cb170-1"></a>df <span class="sc">%&gt;%</span></span>
<span id="cb170-2"><a href="#cb170-2"></a>  <span class="fu">group_by</span>(Pref) <span class="sc">%&gt;%</span></span>
<span id="cb170-3"><a href="#cb170-3"></a>  <span class="fu">summarise</span>(<span class="at">Over60   =</span> <span class="fu">any</span>(Walk <span class="sc">&gt;=</span> <span class="dv">60</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb170-4"><a href="#cb170-4"></a>            <span class="at">Within30 =</span> <span class="fu">all</span>(Walk <span class="sc">&lt;=</span> <span class="dv">30</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb170-5"><a href="#cb170-5"></a>            <span class="at">.groups  =</span> <span class="st">"drop"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 9 × 3
  Pref     Over60 Within30
  &lt;chr&gt;    &lt;lgl&gt;  &lt;lgl&gt;   
1 京都府   FALSE  TRUE    
2 兵庫県   FALSE  FALSE   
3 千葉県   FALSE  FALSE   
4 和歌山県 FALSE  TRUE    
5 埼玉県   TRUE   FALSE   
6 大阪府   FALSE  FALSE   
7 奈良県   FALSE  TRUE    
8 東京都   FALSE  TRUE    
9 神奈川県 TRUE   FALSE   </code></pre>
</div>
</div>
<p>　埼玉県と神奈川県において、最寄りの駅から徒歩60以上の店がありました。また、京都府、東京都、奈良県、和歌山県の場合、全店舗が最寄りの駅から徒歩30分以下ということが分かります。当たり前ですが<code>Over60</code>が<code>TRUE</code>なら<code>Within30</code>は必ず<code>FALSE</code>になりますね。</p>
</section>
</section>
<section id="グルーピング" class="level2">
<h2 class="anchored" data-anchor-id="グルーピング">グルーピング</h2>
<section id="group_byによるグループ化" class="level3">
<h3 class="anchored" data-anchor-id="group_byによるグループ化"><code>group_by()</code>によるグループ化</h3>
<p>　先ほどの<code>summarise()</code>関数は確かに便利ですが、特段に便利とも言いにくいです。<code>df</code>の<code>Score</code>の平均値を計算するだけなら、<code>summarise()</code>関数を使わない方が楽です。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb172"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb172-1"><a href="#cb172-1"></a><span class="co"># これまでのやり方</span></span>
<span id="cb172-2"><a href="#cb172-2"></a>df <span class="sc">%&gt;%</span></span>
<span id="cb172-3"><a href="#cb172-3"></a>  <span class="fu">summarise</span>(<span class="at">Mean =</span> <span class="fu">mean</span>(Score, <span class="at">na.rm =</span> <span class="cn">TRUE</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 × 1
   Mean
  &lt;dbl&gt;
1  3.66</code></pre>
</div>
<div class="sourceCode cell-code" id="cb174"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb174-1"><a href="#cb174-1"></a><span class="co"># 普通にこれでええんちゃう?</span></span>
<span id="cb174-2"><a href="#cb174-2"></a><span class="fu">mean</span>(df<span class="sc">$</span>Score, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 3.663457</code></pre>
</div>
</div>
<p>　しかし、これをグループごとに計算するならどうでしょう。たとえば、<code>Score</code>の平均値を都府県ごとに計算するとします。この場合、以下のようなコードになります。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb176"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb176-1"><a href="#cb176-1"></a><span class="fu">mean</span>(df<span class="sc">$</span>Score[df<span class="sc">$</span>Pref <span class="sc">==</span> <span class="st">"東京都"</span>],   <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 3.674256</code></pre>
</div>
<div class="sourceCode cell-code" id="cb178"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb178-1"><a href="#cb178-1"></a><span class="fu">mean</span>(df<span class="sc">$</span>Score[df<span class="sc">$</span>Pref <span class="sc">==</span> <span class="st">"神奈川県"</span>], <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 3.533931</code></pre>
</div>
<div class="sourceCode cell-code" id="cb180"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb180-1"><a href="#cb180-1"></a><span class="fu">mean</span>(df<span class="sc">$</span>Score[df<span class="sc">$</span>Pref <span class="sc">==</span> <span class="st">"千葉県"</span>],   <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 3.715983</code></pre>
</div>
<div class="sourceCode cell-code" id="cb182"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb182-1"><a href="#cb182-1"></a><span class="fu">mean</span>(df<span class="sc">$</span>Score[df<span class="sc">$</span>Pref <span class="sc">==</span> <span class="st">"埼玉県"</span>],   <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 3.641573</code></pre>
</div>
<div class="sourceCode cell-code" id="cb184"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb184-1"><a href="#cb184-1"></a><span class="fu">mean</span>(df<span class="sc">$</span>Score[df<span class="sc">$</span>Pref <span class="sc">==</span> <span class="st">"大阪府"</span>],   <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 3.765194</code></pre>
</div>
<div class="sourceCode cell-code" id="cb186"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb186-1"><a href="#cb186-1"></a><span class="fu">mean</span>(df<span class="sc">$</span>Score[df<span class="sc">$</span>Pref <span class="sc">==</span> <span class="st">"京都府"</span>],   <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 3.684976</code></pre>
</div>
<div class="sourceCode cell-code" id="cb188"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb188-1"><a href="#cb188-1"></a><span class="fu">mean</span>(df<span class="sc">$</span>Score[df<span class="sc">$</span>Pref <span class="sc">==</span> <span class="st">"兵庫県"</span>],   <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 3.543936</code></pre>
</div>
<div class="sourceCode cell-code" id="cb190"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb190-1"><a href="#cb190-1"></a><span class="fu">mean</span>(df<span class="sc">$</span>Score[df<span class="sc">$</span>Pref <span class="sc">==</span> <span class="st">"奈良県"</span>],   <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 3.854762</code></pre>
</div>
<div class="sourceCode cell-code" id="cb192"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb192-1"><a href="#cb192-1"></a><span class="fu">mean</span>(df<span class="sc">$</span>Score[df<span class="sc">$</span>Pref <span class="sc">==</span> <span class="st">"和歌山県"</span>], <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 3.96999</code></pre>
</div>
</div>
<p>　変わったのは<code>df$Score</code>が<code>df$Score[df$Pref == "東京都"]</code>に変わっただけです。<code>df$Pref</code>が<code>"東京都"</code>であるか否かを<code>TRUE</code>と<code>FALSE</code>で判定し、これを基準に<code>df$Score</code>を抽出する仕組みです。<code>df$Score</code>と<code>df$Pref</code>は同じデータフレーム (または、tibble)ですから、このような書き方で問題ありません。</p>
<p>　これだけでもかなり書くのが面倒ですが、これが47都道府県なら、あるいは200ヶ国ならかなり骨の折れる作業でしょう。ここで大活躍するのが{dplyr}パッケージの<code>group_by()</code>関数です。引数はグループ化する変数名だけです。先ほどの作業を{dplyr}を使うなら<code>Pref</code>変数でグループ化し、<code>summarise()</code>関数で平均値を求めるだけです。今回は<code>Score</code>だけでなく、<code>ScoreN</code>の平均値も求めてみましょう。そして、評価が高い順にソートもしてみます。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb194"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb194-1"><a href="#cb194-1"></a><span class="co"># ScoreNとScoreの平均値をPrefごとに求める</span></span>
<span id="cb194-2"><a href="#cb194-2"></a>df <span class="sc">%&gt;%</span></span>
<span id="cb194-3"><a href="#cb194-3"></a>  <span class="fu">group_by</span>(Pref) <span class="sc">%&gt;%</span></span>
<span id="cb194-4"><a href="#cb194-4"></a>  <span class="fu">summarise</span>(<span class="at">ScoreN_Mean =</span> <span class="fu">mean</span>(ScoreN, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb194-5"><a href="#cb194-5"></a>            <span class="at">Score_Mean  =</span> <span class="fu">mean</span>(Score,  <span class="at">na.rm =</span> <span class="cn">TRUE</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb194-6"><a href="#cb194-6"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(Score_Mean))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 9 × 3
  Pref     ScoreN_Mean Score_Mean
  &lt;chr&gt;          &lt;dbl&gt;      &lt;dbl&gt;
1 和歌山県       0.593       3.97
2 奈良県         0.306       3.85
3 大阪府         0.516       3.77
4 千葉県         0.259       3.72
5 京都府         0.522       3.68
6 東京都         1.16        3.67
7 埼玉県         0.278       3.64
8 兵庫県         0.389       3.54
9 神奈川県       0.587       3.53</code></pre>
</div>
</div>
<p>　評判が最も高い都府県は和歌山県、最も低いのは神奈川県ですね。Songも和歌山ラーメンは井出系も車庫前系も好きです。しかし、大事なのは「井出系」と「車庫前系」といった分類が正しいかどうかではありません。コードが非常に簡潔となり、ソートなども自由自在であることです。都府県ごとに<code>ScoreN</code>と<code>Score</code>の平均値を求める場合、<code>dplyr()</code>を使わなかったら18行のコードとなり、ソートも自分でやる必要があります。一方、<code>group_by()</code>関数を使うことによってコードが5行になりました。</p>
<p>　また、これは2020年6月に公開された{dplyr}1.0.0からの問題ですが、<code>group_by()</code>の後に<code>summarise()</code>を使うと以下のようなメッセージが出力されます。</p>
<pre><code>## `summarise()` ungrouping output (override with `.groups` argument)</code></pre>
<p>　これは<code>group_by()</code>で指定された変数のグループ化が自動的に解除されたことを意味します。なぜなら<code>summarise()</code>をする際は<code>Pref</code>をグループ変数として使いましたが、出力された結果の<code>Pref</code>変数はもはやグループとして機能できなくなるからです。元の<code>df</code>には<code>Pref</code>が<code>"東京都"</code>だったケースが1000行、<code>"京都府"</code>だったのが414行あったので、<code>Pref</code>変数でグループ化する意味がありました。しかし、<code>summarise()</code>から得られたデータフレーム (または、tibble)は<code>Pref == "東京都"</code>の行が1つしかありません。これはグループ化する意味がなくなったことを意味します。したがって、自動的にグループを解除してくれます。自動的にやってくれるのはありがたいことですが、可能ならば関数内に自分で明記することが推奨されます。そこで使う引数が<code>.groups</code>であり、<code>"drop"</code>を指定すると<strong>全ての</strong>グループ化変数を解除します。以下のようなコードだと先ほどのメッセージが表示されません。今後、意識的に入れるようにしましょう。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb197"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb197-1"><a href="#cb197-1"></a><span class="co"># ScoreNとScoreの平均値をPrefごとに求める</span></span>
<span id="cb197-2"><a href="#cb197-2"></a>df <span class="sc">%&gt;%</span></span>
<span id="cb197-3"><a href="#cb197-3"></a>  <span class="fu">group_by</span>(Pref) <span class="sc">%&gt;%</span></span>
<span id="cb197-4"><a href="#cb197-4"></a>  <span class="fu">summarise</span>(<span class="at">ScoreN_Mean =</span> <span class="fu">mean</span>(ScoreN, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb197-5"><a href="#cb197-5"></a>            <span class="at">Score_Mean  =</span> <span class="fu">mean</span>(Score,  <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb197-6"><a href="#cb197-6"></a>            <span class="at">.groups     =</span> <span class="st">"drop"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb197-7"><a href="#cb197-7"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(Score_Mean))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 9 × 3
  Pref     ScoreN_Mean Score_Mean
  &lt;chr&gt;          &lt;dbl&gt;      &lt;dbl&gt;
1 和歌山県       0.593       3.97
2 奈良県         0.306       3.85
3 大阪府         0.516       3.77
4 千葉県         0.259       3.72
5 京都府         0.522       3.68
6 東京都         1.16        3.67
7 埼玉県         0.278       3.64
8 兵庫県         0.389       3.54
9 神奈川県       0.587       3.53</code></pre>
</div>
</div>
<p>　続いて、一つ便利な関数を紹介します。それはグループのサイズを計算する関数、<code>n()</code>です。この関数を<code>summarise()</code>内に使うと、各グループに属するケース数を出力します。先ほどのコードを修正し、各グループのサイズを<code>N</code>という名の列として追加してみましょう。そしてソートの順番は<code>N</code>を最優先とし、同じ場合は<code>Score_Mean</code>が高い方を上に出力させます。また、<code>ScoreN_Mean</code>の前に、口コミ数の合計も出してみましょう。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb199"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb199-1"><a href="#cb199-1"></a><span class="co"># Prefごとに口コミ数の合計、口コミ数の平均値、評価の平均値、店舗数を求める</span></span>
<span id="cb199-2"><a href="#cb199-2"></a><span class="co"># 店舗数-評価の平均値順でソートする</span></span>
<span id="cb199-3"><a href="#cb199-3"></a>df <span class="sc">%&gt;%</span></span>
<span id="cb199-4"><a href="#cb199-4"></a>  <span class="fu">group_by</span>(Pref) <span class="sc">%&gt;%</span></span>
<span id="cb199-5"><a href="#cb199-5"></a>  <span class="fu">summarise</span>(<span class="at">ScoreN_Sum  =</span> <span class="fu">sum</span>(ScoreN,  <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb199-6"><a href="#cb199-6"></a>            <span class="at">ScoreN_Mean =</span> <span class="fu">mean</span>(ScoreN, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb199-7"><a href="#cb199-7"></a>            <span class="at">Score_Mean  =</span> <span class="fu">mean</span>(Score,  <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb199-8"><a href="#cb199-8"></a>            <span class="at">N           =</span> <span class="fu">n</span>(),</span>
<span id="cb199-9"><a href="#cb199-9"></a>            <span class="at">.groups     =</span> <span class="st">"drop"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb199-10"><a href="#cb199-10"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(N), <span class="fu">desc</span>(Score_Mean))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 9 × 5
  Pref     ScoreN_Sum ScoreN_Mean Score_Mean     N
  &lt;chr&gt;         &lt;dbl&gt;       &lt;dbl&gt;      &lt;dbl&gt; &lt;int&gt;
1 大阪府          516       0.516       3.77  1000
2 千葉県          259       0.259       3.72  1000
3 東京都         1165       1.16        3.67  1000
4 埼玉県          278       0.278       3.64  1000
5 神奈川県        587       0.587       3.53  1000
6 兵庫県          230       0.389       3.54   591
7 京都府          216       0.522       3.68   414
8 奈良県           45       0.306       3.85   147
9 和歌山県         83       0.593       3.97   140</code></pre>
</div>
</div>
<p>　記述統計をグループごとに求めるのは普通にあり得るケースですし、実験データの場合はほぼ必須の作業でう。統制群と処置群間においてグループサイズが均一か、共変量のバラツキが十分に小さいかなどを判断する際に<code>group_by()</code>と<code>summarise()</code>関数の組み合わせは非常に便利です。</p>
</section>
<section id="複数の変数を用いたグループ化" class="level3">
<h3 class="anchored" data-anchor-id="複数の変数を用いたグループ化">複数の変数を用いたグループ化</h3>
<p>　グループ化変数は2つ以上指定することも可能です。たとえば、都府県 (<code>Pref</code>)と最寄りの駅の路線 (<code>Line</code>)でグループ化することも可能です。それでは<code>Pref</code>と<code>Line</code>でグループ化し、店舗数と口コミ数、評価の平均値を計算し、ソートの順番は店舗数、店舗数が同じなら評価の平均値が高い順にしましょう。今回も<code>summarise()</code>内に<code>.group = "drop"</code>を指定し、グループ化を解除します。今回はTop 20まで出してみましょう。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb201"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb201-1"><a href="#cb201-1"></a><span class="co"># ScoreNとScoreの平均値をPrefごとに求める</span></span>
<span id="cb201-2"><a href="#cb201-2"></a>df <span class="sc">%&gt;%</span></span>
<span id="cb201-3"><a href="#cb201-3"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(Line)) <span class="sc">%&gt;%</span> <span class="co"># Lineが欠損していないケースのみ残す</span></span>
<span id="cb201-4"><a href="#cb201-4"></a>  <span class="fu">group_by</span>(Pref, Line) <span class="sc">%&gt;%</span> <span class="co"># PrefとLineでグループ化</span></span>
<span id="cb201-5"><a href="#cb201-5"></a>  <span class="fu">summarise</span>(<span class="at">N           =</span> <span class="fu">n</span>(),</span>
<span id="cb201-6"><a href="#cb201-6"></a>            <span class="at">ScoreN_Sum  =</span> <span class="fu">sum</span>(ScoreN,  <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb201-7"><a href="#cb201-7"></a>            <span class="at">Score_Mean  =</span> <span class="fu">mean</span>(Score,  <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb201-8"><a href="#cb201-8"></a>            <span class="at">.groups     =</span> <span class="st">"drop"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb201-9"><a href="#cb201-9"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(N), <span class="fu">desc</span>(Score_Mean)) <span class="sc">%&gt;%</span></span>
<span id="cb201-10"><a href="#cb201-10"></a>  <span class="fu">print</span>(<span class="at">n =</span> <span class="dv">20</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 523 × 5
   Pref     Line                        N ScoreN_Sum Score_Mean
   &lt;chr&gt;    &lt;chr&gt;                   &lt;int&gt;      &lt;dbl&gt;      &lt;dbl&gt;
 1 埼玉県   東武東上線                122         27       3.68
 2 東京都   ＪＲ                      104        231       3.56
 3 神奈川県 小田急小田原線             96         31       3.59
 4 埼玉県   東武伊勢崎線               96         18       3.51
 5 神奈川県 横浜市営ブルーライン       82         77       3.66
 6 千葉県   京成本線                   82         29       3.34
 7 神奈川県 京急本線                   68         40       3.33
 8 千葉県   東武野田線                 63          2       4.75
 9 神奈川県 小田急江ノ島線             62          8       3.79
10 大阪府   阪急京都本線               53         32       3.67
11 大阪府   南海本線                   52         11       4.22
12 兵庫県   阪神本線                   52         23       3.80
13 埼玉県   JR高崎線                   51          5       4   
14 兵庫県   山陽電鉄本線               51         15       2.98
15 千葉県   JR総武本線（東京-銚子）    47          8       4   
16 埼玉県   西武新宿線                 45          8       4.17
17 埼玉県   秩父鉄道線                 43         10       3.82
18 大阪府   京阪本線                   43         10       3.69
19 千葉県   新京成電鉄                 43          6       3.6 
20 京都府   阪急京都本線               43         27       3.5 
# … with 503 more rows</code></pre>
</div>
</div>
<p>　ぐるなびに登録されているラーメン屋が最も多い路線は埼玉県内の東武東上線で122店舗があります。東武東上線は東京都と埼玉県をまたがる路線ですので、東武東上線だけならもっと多いかも知れませんね。</p>
<p>　ここで一つ考えたいのは<code>summarise()</code>内の<code>.groups</code>引数です。前回はグループ化に使った変数ごとに1行しか残っていなかったのでグループ化を全て解除しました。しかし、今回は状況がやや異なります。グループ化変数に使った<code>Pref</code>を考えると、まだ<code>Pref == "東京都"</code>であるケースがいくつかあります。やろうとすればまだグループ化出来る状態です。これは<code>Line</code>についても同じです。<code>Line == "東武東上線"</code>の行はここには表示されていないものの、まだデータに残っています。もし、これ以上グループ化しないなら今のように<code>.groups = "drop"</code>が正しいですが、もしもう一回グループ化したい場合はどうすればよいでしょうか。方法は2つ考えられます。</p>
<ol type="1">
<li>もう一度パイプ演算子を使って<code>group_by()</code>関数を使う (以下の9行目)。
<ul>
<li>結果を見ると<code>## # Groups:   Pref, Line [523]</code>で、ちゃんとグループ化されていることが分かります。</li>
</ul></li>
</ol>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb203"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb203-1"><a href="#cb203-1"></a>df <span class="sc">%&gt;%</span></span>
<span id="cb203-2"><a href="#cb203-2"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(Line)) <span class="sc">%&gt;%</span> </span>
<span id="cb203-3"><a href="#cb203-3"></a>  <span class="fu">group_by</span>(Pref, Line) <span class="sc">%&gt;%</span> </span>
<span id="cb203-4"><a href="#cb203-4"></a>  <span class="fu">summarise</span>(<span class="at">N           =</span> <span class="fu">n</span>(),</span>
<span id="cb203-5"><a href="#cb203-5"></a>            <span class="at">ScoreN_Sum  =</span> <span class="fu">sum</span>(ScoreN,  <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb203-6"><a href="#cb203-6"></a>            <span class="at">Score_Mean  =</span> <span class="fu">mean</span>(Score,  <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb203-7"><a href="#cb203-7"></a>            <span class="at">.groups     =</span> <span class="st">"drop"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb203-8"><a href="#cb203-8"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(N), <span class="fu">desc</span>(Score_Mean)) <span class="sc">%&gt;%</span></span>
<span id="cb203-9"><a href="#cb203-9"></a>  <span class="fu">group_by</span>(Pref, Line) <span class="sc">%&gt;%</span> <span class="co"># group_by()、もう一度</span></span>
<span id="cb203-10"><a href="#cb203-10"></a>  <span class="fu">print</span>(<span class="at">n =</span> <span class="dv">5</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 523 × 5
# Groups:   Pref, Line [523]
  Pref     Line                     N ScoreN_Sum Score_Mean
  &lt;chr&gt;    &lt;chr&gt;                &lt;int&gt;      &lt;dbl&gt;      &lt;dbl&gt;
1 埼玉県   東武東上線             122         27       3.68
2 東京都   ＪＲ                   104        231       3.56
3 神奈川県 小田急小田原線          96         31       3.59
4 埼玉県   東武伊勢崎線            96         18       3.51
5 神奈川県 横浜市営ブルーライン    82         77       3.66
# … with 518 more rows</code></pre>
</div>
</div>
<ol start="2" type="1">
<li><code>.groups</code>引数を何とかする。</li>
</ol>
<p>　推奨される方法は2番です。具体的には<code>.groups = "keep"</code>を指定するだけであり、こっちの方が無駄なコードを省けることができます。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb205"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb205-1"><a href="#cb205-1"></a>df <span class="sc">%&gt;%</span></span>
<span id="cb205-2"><a href="#cb205-2"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(Line)) <span class="sc">%&gt;%</span> </span>
<span id="cb205-3"><a href="#cb205-3"></a>  <span class="fu">group_by</span>(Pref, Line) <span class="sc">%&gt;%</span> </span>
<span id="cb205-4"><a href="#cb205-4"></a>  <span class="fu">summarise</span>(<span class="at">N           =</span> <span class="fu">n</span>(),</span>
<span id="cb205-5"><a href="#cb205-5"></a>            <span class="at">ScoreN_Sum  =</span> <span class="fu">sum</span>(ScoreN,  <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb205-6"><a href="#cb205-6"></a>            <span class="at">Score_Mean  =</span> <span class="fu">mean</span>(Score,  <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb205-7"><a href="#cb205-7"></a>            <span class="at">.groups     =</span> <span class="st">"keep"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb205-8"><a href="#cb205-8"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(N), <span class="fu">desc</span>(Score_Mean)) <span class="sc">%&gt;%</span></span>
<span id="cb205-9"><a href="#cb205-9"></a>  <span class="fu">print</span>(<span class="at">n =</span> <span class="dv">5</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 523 × 5
# Groups:   Pref, Line [523]
  Pref     Line                     N ScoreN_Sum Score_Mean
  &lt;chr&gt;    &lt;chr&gt;                &lt;int&gt;      &lt;dbl&gt;      &lt;dbl&gt;
1 埼玉県   東武東上線             122         27       3.68
2 東京都   ＪＲ                   104        231       3.56
3 神奈川県 小田急小田原線          96         31       3.59
4 埼玉県   東武伊勢崎線            96         18       3.51
5 神奈川県 横浜市営ブルーライン    82         77       3.66
# … with 518 more rows</code></pre>
</div>
</div>
<p>　<code>.groups</code>引数は<code>"drop"</code>と<code>"keep"</code>以外にも<code>"drop_last"</code>があります。実は<code>summarise()</code>に<code>.groups</code>引数を指定したい場合のデフォルト値は<code>.groups == "drop_last"</code>または<code>"keep"</code>ですが、ここがややこしいです。主なケースにおいてデフォルト値は<code>"drop"</code>となりますとなります。<code>.groups == "drop_last"</code>これは最後のグループ化変数のみ解除する意味です。今回の例だと、2番目のグループ化変数である<code>Line</code>がグループ化変数から外され、<code>Pref</code>のみがグループ化変数として残る仕組みです。</p>
<p>　それではデフォルト値が<code>"keep"</code>になるのはいつでしょうか。それは記述統計量の結果が長さ2以上のベクトルである場合です。平均値を求める<code>mean()</code>、標準偏差を求める<code>sd()</code>などは、結果として長さ1のベクトルを返します。しかし、長さ2以上ののベクトルを返す関数もあります。たとえば、分位数を求める<code>quantile()</code>関数があります。<code>quantile(ベクトル名, 0.25)</code>の場合、第一四分位点のみ返すため、結果は長さ1のベクトルです。しかし、<code>quantile(ベクトル名, c(0.25, 0.5, 0.75))</code>のように第一四分位点から第三四分位点を同時に計算し、長さ3のベクトルが返されるケースもありますし、第二引数を省略すると、最小値・第一四分位点・第二四分位点・第三四分位点・最大値、つまり、長さ5のベクトルが返される場合があります。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb207"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb207-1"><a href="#cb207-1"></a><span class="co"># 第一四分位点のみを求める (長さ1のベクトル)</span></span>
<span id="cb207-2"><a href="#cb207-2"></a><span class="fu">quantile</span>(df<span class="sc">$</span>Walk, <span class="fl">0.25</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>25% 
  2 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb209"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb209-1"><a href="#cb209-1"></a><span class="co"># 引数を省略する (長さ5のベクトル)</span></span>
<span id="cb209-2"><a href="#cb209-2"></a><span class="fu">quantile</span>(df<span class="sc">$</span>Walk, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  0%  25%  50%  75% 100% 
   1    2    5   12  116 </code></pre>
</div>
</div>
<p>　<code>.groups</code>のデフォルト値が<code>"keep"</code>になるのは、このように長さ2以上のベクトルが返されるケースです。たとえば、都府県と最寄りの駅の路線でグループ化し、店舗までの徒歩距離の平均値を求めるとします。デフォルト値の変化を見るために、ここではあえて<code>.groups</code>引数を省略しました。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb211"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb211-1"><a href="#cb211-1"></a>df <span class="sc">%&gt;%</span></span>
<span id="cb211-2"><a href="#cb211-2"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(Walk)) <span class="sc">%&gt;%</span></span>
<span id="cb211-3"><a href="#cb211-3"></a>  <span class="fu">group_by</span>(Pref, Line) <span class="sc">%&gt;%</span></span>
<span id="cb211-4"><a href="#cb211-4"></a>  <span class="fu">summarise</span>(<span class="at">Mean =</span> <span class="fu">mean</span>(Walk))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>`summarise()` has grouped output by 'Pref'. You can override using the
`.groups` argument.</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 509 × 3
# Groups:   Pref [9]
   Pref   Line                       Mean
   &lt;chr&gt;  &lt;chr&gt;                     &lt;dbl&gt;
 1 京都府 ＪＲ                       4   
 2 京都府 ＪＲ京都線                10   
 3 京都府 JR奈良線                   3.33
 4 京都府 ＪＲ奈良線                 8   
 5 京都府 JR小浜線                  16.5 
 6 京都府 ＪＲ小浜線                 9   
 7 京都府 ＪＲ山陰本線              19   
 8 京都府 JR山陰本線（京都-米子）    8.67
 9 京都府 ＪＲ山陰本線（京都-米子）  9.23
10 京都府 ＪＲ嵯峨野線               5   
# … with 499 more rows</code></pre>
</div>
</div>
<p>　最初は<code>Pref</code>と<code>Line</code>でグループ化しましたが、<code>summarise()</code>の後、<code>Line</code>がグループ化変数から外されました。つまり、引数が<code>"drop_last"</code>になっていることです。</p>
<p>　それでは、平均値に加えて、第一四分位点と第三四分位点も計算し、<code>Quantile</code>という名で格納してみましょう。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb214"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb214-1"><a href="#cb214-1"></a>df <span class="sc">%&gt;%</span></span>
<span id="cb214-2"><a href="#cb214-2"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(Walk)) <span class="sc">%&gt;%</span></span>
<span id="cb214-3"><a href="#cb214-3"></a>  <span class="fu">group_by</span>(Pref, Line) <span class="sc">%&gt;%</span></span>
<span id="cb214-4"><a href="#cb214-4"></a>  <span class="fu">summarise</span>(<span class="at">Mean     =</span> <span class="fu">mean</span>(Walk),</span>
<span id="cb214-5"><a href="#cb214-5"></a>            <span class="at">Quantile =</span> <span class="fu">quantile</span>(Walk, <span class="fu">c</span>(<span class="fl">0.25</span>, <span class="fl">0.75</span>)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>`summarise()` has grouped output by 'Pref', 'Line'. You can override using the
`.groups` argument.</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1,018 × 4
# Groups:   Pref, Line [509]
   Pref   Line        Mean Quantile
   &lt;chr&gt;  &lt;chr&gt;      &lt;dbl&gt;    &lt;dbl&gt;
 1 京都府 ＪＲ        4        1.25
 2 京都府 ＪＲ        4        5   
 3 京都府 ＪＲ京都線 10       10   
 4 京都府 ＪＲ京都線 10       10   
 5 京都府 JR奈良線    3.33     2   
 6 京都府 JR奈良線    3.33     5   
 7 京都府 ＪＲ奈良線  8        4   
 8 京都府 ＪＲ奈良線  8        9   
 9 京都府 JR小浜線   16.5      9.75
10 京都府 JR小浜線   16.5     23.2 
# … with 1,008 more rows</code></pre>
</div>
</div>
<p>　同じ<code>Pref</code>、<code>Line</code>のケースが2つずつ出来ています。最初に来る数値は第一四分位点、次に来るのが第三四分位点です。そして最初のグループ化変数であった<code>Pref</code>と<code>Line</code>が、<code>summarise()</code>後もグループ化変数として残っていることが分かります。</p>
<p>　<code>.groups</code>引数は記述統計量だけを計算する意味ではあまり意識する必要がありません。しかし、得られた記述統計量から何らかの計算をしたり、さらにもう一回記述統計量を求めたりする際、予期せぬ結果が得られる可能性があるため注意する必要があります。出来る限り<code>.groups</code>引数は指定するようにしましょう。</p>
</section>
</section>
<section id="変数の計算" class="level2">
<h2 class="anchored" data-anchor-id="変数の計算">変数の計算</h2>
<section id="mutate関数の使い方" class="level3">
<h3 class="anchored" data-anchor-id="mutate関数の使い方"><code>mutate()</code>関数の使い方</h3>
<p>　続いて、データフレーム (または、tibble)内の変数を用いて計算を行い、その結果を新しい列として格納する<code>mutate()</code>関数について紹介します。まず、<code>mutate()</code>関数の書き方からです。</p>
<div class="sourceCode" id="cb217"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb217-1"><a href="#cb217-1" aria-hidden="true" tabindex="-1"></a><span class="co"># mutate()関数の使い方</span></span>
<span id="cb217-2"><a href="#cb217-2" aria-hidden="true" tabindex="-1"></a>データフレーム<span class="sc">/</span>tibble名 <span class="sc">%&gt;%</span></span>
<span id="cb217-3"><a href="#cb217-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(新しい変数名 <span class="ot">=</span> 処理内容)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>　これは何らかの処理を行い、その結果を新しい変数としてデータフレーム (または、tibble)に追加することを意味します。新しく出来た変数は、基本的に最後の列になります。ここでは分単位である<code>Walk</code>を時間単位に変換した<code>Walk_Hour</code>変数を作成するとします。処理内容は<code>Walk / 60</code>です。最後に、都府県名、店舗名、徒歩距離 (分)、徒歩距離 (時間)のみを残し、遠い順にソートします。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb218"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb218-1"><a href="#cb218-1"></a>df <span class="sc">%&gt;%</span></span>
<span id="cb218-2"><a href="#cb218-2"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(Walk)) <span class="sc">%&gt;%</span></span>
<span id="cb218-3"><a href="#cb218-3"></a>  <span class="fu">mutate</span>(<span class="at">Walk_Hour =</span> Walk <span class="sc">/</span> <span class="dv">60</span>) <span class="sc">%&gt;%</span></span>
<span id="cb218-4"><a href="#cb218-4"></a>  <span class="fu">select</span>(Pref, Name, Walk, Walk_Hour) <span class="sc">%&gt;%</span></span>
<span id="cb218-5"><a href="#cb218-5"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(Walk_Hour))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 5,375 × 4
   Pref     Name                               Walk Walk_Hour
   &lt;chr&gt;    &lt;chr&gt;                             &lt;dbl&gt;     &lt;dbl&gt;
 1 埼玉県   札幌ラーメン どさん子 小鹿野店      116     1.93 
 2 神奈川県 札幌ラーメン どさん子 中津店         73     1.22 
 3 千葉県   札幌ラーメン どさん子 佐原51号店     59     0.983
 4 神奈川県 札幌ラーメン どさん子 山際店         50     0.833
 5 千葉県   札幌ラーメン どさん子 関宿店         49     0.817
 6 兵庫県   濃厚醤油 中華そば いせや 玉津店      43     0.717
 7 大阪府   河童ラーメン本舗 岸和田店            38     0.633
 8 埼玉県   ラーメン山岡家 上尾店                35     0.583
 9 兵庫県   濃厚醤油 中華そば いせや 大蔵谷店    35     0.583
10 大阪府   河童ラーメン本舗 松原店              31     0.517
# … with 5,365 more rows</code></pre>
</div>
</div>
<p>　<code>mutate()</code>は3行目に登場しますが、これは<code>Walk</code>を60に割った結果を<code>Walk_Hour</code>としてデータフレーム (または、tibble)の最後の列として格納することを意味します。もし、最後の列でなく、ある変数の前、または後にしたい場合は、<code>.before</code>または<code>.after</code>引数を追加します。これは<code>select()</code>関数の<code>.before</code>と<code>.after</code>と同じ使い方です。たとえば、新しく出来た<code>Walk_Hour</code>を<code>ID</code>と<code>Name</code>の間に入れたい場合は</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb220"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb220-1"><a href="#cb220-1"></a><span class="co"># コードの3行名を修正 (.before使用)</span></span>
<span id="cb220-2"><a href="#cb220-2"></a><span class="fu">mutate</span>(<span class="at">Walk_Hour =</span> Walk <span class="sc">/</span> <span class="dv">60</span>,</span>
<span id="cb220-3"><a href="#cb220-3"></a>       <span class="at">.before   =</span> Name)</span>
<span id="cb220-4"><a href="#cb220-4"></a></span>
<span id="cb220-5"><a href="#cb220-5"></a><span class="co"># コードの3行名を修正 (.after使用)</span></span>
<span id="cb220-6"><a href="#cb220-6"></a><span class="fu">mutate</span>(<span class="at">Walk_Hour =</span> Walk <span class="sc">/</span> <span class="dv">60</span>,</span>
<span id="cb220-7"><a href="#cb220-7"></a>       <span class="at">.after    =</span> ID)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>のようにコードを修正します。</p>
<p>　むろん、変数間同士の計算も可能です。たとえば、以下のような<code>df2</code>があり、1店舗当たりの平均口コミ数を計算し、<code>ScoreN_Mean</code>という変数名で<code>ScoreN_Sum</code>の後に格納うするとします。この場合、<code>ScoreN_Sum</code>変数を<code>N</code>で割るだけです。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb221"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb221-1"><a href="#cb221-1"></a>df2 <span class="ot">&lt;-</span> df <span class="sc">%&gt;%</span></span>
<span id="cb221-2"><a href="#cb221-2"></a>  <span class="fu">group_by</span>(Pref) <span class="sc">%&gt;%</span></span>
<span id="cb221-3"><a href="#cb221-3"></a>  <span class="fu">summarise</span>(<span class="at">Budget_Mean =</span> <span class="fu">mean</span>(Budget, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb221-4"><a href="#cb221-4"></a>            <span class="at">ScoreN_Sum  =</span> <span class="fu">sum</span>(ScoreN, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb221-5"><a href="#cb221-5"></a>            <span class="at">Score_Mean  =</span> <span class="fu">mean</span>(Score, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb221-6"><a href="#cb221-6"></a>            <span class="at">N           =</span> <span class="fu">n</span>(),</span>
<span id="cb221-7"><a href="#cb221-7"></a>            <span class="at">.groups     =</span> <span class="st">"drop"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb222"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb222-1"><a href="#cb222-1"></a>df2 <span class="sc">%&gt;%</span></span>
<span id="cb222-2"><a href="#cb222-2"></a>  <span class="fu">mutate</span>(<span class="at">ScoreN_Mean =</span> ScoreN_Sum <span class="sc">/</span> N,</span>
<span id="cb222-3"><a href="#cb222-3"></a>         <span class="at">.after      =</span> ScoreN_Sum)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 9 × 6
  Pref     Budget_Mean ScoreN_Sum ScoreN_Mean Score_Mean     N
  &lt;chr&gt;          &lt;dbl&gt;      &lt;dbl&gt;       &lt;dbl&gt;      &lt;dbl&gt; &lt;int&gt;
1 京都府         1399.        216       0.522       3.68   414
2 兵庫県         1197.        230       0.389       3.54   591
3 千葉県         1124.        259       0.259       3.72  1000
4 和歌山県       1252          83       0.593       3.97   140
5 埼玉県         1147.        278       0.278       3.64  1000
6 大阪府         1203.        516       0.516       3.77  1000
7 奈良県         1169.         45       0.306       3.85   147
8 東京都         1283.       1165       1.16        3.67  1000
9 神奈川県       1239.        587       0.587       3.53  1000</code></pre>
</div>
</div>
<p>　このように、データ内の変数を用いた計算結果を新しい列として追加する場合は、<code>mutate()</code>が便利です。これを<code>mutate()</code>を使わずに処理する場合、以下のようなコードになりますが、可読性が相対的に低いことが分かります。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb224"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb224-1"><a href="#cb224-1"></a>df2<span class="sc">$</span>ScoreN_Mean <span class="ot">&lt;-</span> df2<span class="sc">$</span>ScoreN_Sum <span class="sc">/</span> df2<span class="sc">$</span>N</span>
<span id="cb224-2"><a href="#cb224-2"></a>df2 <span class="ot">&lt;-</span> df2[, <span class="fu">c</span>(<span class="st">"Pref"</span>, <span class="st">"Budget_Mean"</span>, <span class="st">"Walk_Mean"</span>, </span>
<span id="cb224-3"><a href="#cb224-3"></a>               <span class="st">"ScoreN_Sum"</span>, <span class="st">"ScoreN_Mean"</span>, <span class="st">"Score_Mean"</span>, <span class="st">"N"</span>)]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>　むろん、計算には<code>+</code>や<code>/</code>のような演算子だけでなく、関数を使うことも可能です。たとえば、<code>Budget</code>が1000円未満なら<code>"Cheap"</code>、1000円以上なら<code>"Expensive"</code>と示す変数<code>Budget2</code>を作成する場合は<code>ifelse()</code>関数が使えます。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb225"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb225-1"><a href="#cb225-1"></a>df <span class="sc">%&gt;%</span> </span>
<span id="cb225-2"><a href="#cb225-2"></a>  <span class="fu">mutate</span>(<span class="at">Budget2 =</span> <span class="fu">ifelse</span>(Budget <span class="sc">&lt;</span> <span class="dv">1000</span>, <span class="st">"Cheap"</span>, <span class="st">"Expensive"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb225-3"><a href="#cb225-3"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(Budget2)) <span class="sc">%&gt;%</span> <span class="co"># Budget2が欠損した店舗を除外</span></span>
<span id="cb225-4"><a href="#cb225-4"></a>  <span class="fu">group_by</span>(Pref, Budget2) <span class="sc">%&gt;%</span> <span class="co"># PrefとBudget2でグループ化</span></span>
<span id="cb225-5"><a href="#cb225-5"></a>  <span class="fu">summarise</span>(<span class="at">N =</span> <span class="fu">n</span>(),          <span class="co"># 店舗数を表示</span></span>
<span id="cb225-6"><a href="#cb225-6"></a>            <span class="at">.groups =</span> <span class="st">"drop"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 18 × 3
   Pref     Budget2       N
   &lt;chr&gt;    &lt;chr&gt;     &lt;int&gt;
 1 京都府   Cheap        22
 2 京都府   Expensive    28
 3 兵庫県   Cheap        39
 4 兵庫県   Expensive    27
 5 千葉県   Cheap        64
 6 千葉県   Expensive    72
 7 和歌山県 Cheap        10
 8 和歌山県 Expensive     5
 9 埼玉県   Cheap        37
10 埼玉県   Expensive    45
11 大阪府   Cheap       104
12 大阪府   Expensive   115
13 奈良県   Cheap        11
14 奈良県   Expensive    10
15 東京都   Cheap       206
16 東京都   Expensive   236
17 神奈川県 Cheap        66
18 神奈川県 Expensive    54</code></pre>
</div>
</div>
<p>　これは各都府県ごとの予算1000円未満の店と以上の店の店舗数をまとめた表となります。もし、500円未満なら<code>"Cheap"</code>、500円以上~1000円未満なら<code>"Reasonable"</code>、1000円以上なら<code>"Expensive"</code>になる<code>Budget3</code>変数を作るにはどうすればよいでしょうか。これは<code>ifelse()</code>を重ねることも出来ますが、ここでは<code>case_when()</code>関数が便利です。まずは、<code>ifelse()</code>を使ったコードは以下の通りです。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb227"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb227-1"><a href="#cb227-1"></a><span class="co"># ifelse()を使う場合</span></span>
<span id="cb227-2"><a href="#cb227-2"></a>df <span class="sc">%&gt;%</span> </span>
<span id="cb227-3"><a href="#cb227-3"></a>  <span class="fu">mutate</span>(<span class="at">Budget3 =</span> <span class="fu">ifelse</span>(Budget <span class="sc">&lt;</span> <span class="dv">500</span>, <span class="st">"Cheap"</span>, </span>
<span id="cb227-4"><a href="#cb227-4"></a>                          <span class="fu">ifelse</span>(Budget <span class="sc">&gt;=</span> <span class="dv">500</span> <span class="sc">&amp;</span> Budget <span class="sc">&lt;</span> <span class="dv">1000</span>, <span class="st">"Reasonable"</span>,</span>
<span id="cb227-5"><a href="#cb227-5"></a>                                 <span class="st">"Expensive"</span>))) <span class="sc">%&gt;%</span></span>
<span id="cb227-6"><a href="#cb227-6"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(Budget3)) <span class="sc">%&gt;%</span></span>
<span id="cb227-7"><a href="#cb227-7"></a>  <span class="fu">group_by</span>(Pref, Budget3) <span class="sc">%&gt;%</span></span>
<span id="cb227-8"><a href="#cb227-8"></a>  <span class="fu">summarise</span>(<span class="at">N =</span> <span class="fu">n</span>(),         </span>
<span id="cb227-9"><a href="#cb227-9"></a>            <span class="at">.groups =</span> <span class="st">"drop"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>　<code>case_when()</code>を使うと以下のような書き方になります。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb228"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb228-1"><a href="#cb228-1"></a><span class="co"># case_when()を使う場合</span></span>
<span id="cb228-2"><a href="#cb228-2"></a>df <span class="sc">%&gt;%</span> </span>
<span id="cb228-3"><a href="#cb228-3"></a>  <span class="fu">mutate</span>(<span class="at">Budget3 =</span> <span class="fu">case_when</span>(Budget <span class="sc">&lt;</span> <span class="dv">500</span>                  <span class="sc">~</span> <span class="st">"Cheap"</span>,</span>
<span id="cb228-4"><a href="#cb228-4"></a>                             Budget <span class="sc">&gt;=</span> <span class="dv">500</span> <span class="sc">&amp;</span> Budget <span class="sc">&lt;</span> <span class="dv">1000</span> <span class="sc">~</span> <span class="st">"Reasonable"</span>,</span>
<span id="cb228-5"><a href="#cb228-5"></a>                             Budget <span class="sc">&gt;=</span> <span class="dv">1000</span>                <span class="sc">~</span> <span class="st">"Expensive"</span>),</span>
<span id="cb228-6"><a href="#cb228-6"></a>         <span class="co"># 新しく出来た変数をfactor型にその場で変換することも可能</span></span>
<span id="cb228-7"><a href="#cb228-7"></a>         <span class="at">Budget3 =</span> <span class="fu">factor</span>(Budget3, </span>
<span id="cb228-8"><a href="#cb228-8"></a>                          <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"Cheap"</span>, <span class="st">"Reasonable"</span>, <span class="st">"Expensive"</span>))) <span class="sc">%&gt;%</span></span>
<span id="cb228-9"><a href="#cb228-9"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(Budget3)) <span class="sc">%&gt;%</span></span>
<span id="cb228-10"><a href="#cb228-10"></a>  <span class="fu">group_by</span>(Pref, Budget3) <span class="sc">%&gt;%</span></span>
<span id="cb228-11"><a href="#cb228-11"></a>  <span class="fu">summarise</span>(<span class="at">N =</span> <span class="fu">n</span>(),         </span>
<span id="cb228-12"><a href="#cb228-12"></a>            <span class="at">.groups =</span> <span class="st">"drop"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>　書く手間の観点では<code>case_when()</code>は<code>ifelse()</code>と大きく違いはないかも知れませんが、コードが非常に読みやすくなっています。<code>case_when()</code>関数の書き方は以下の通りです。</p>
<div class="sourceCode" id="cb229"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb229-1"><a href="#cb229-1" aria-hidden="true" tabindex="-1"></a><span class="co"># case_when()の使い方</span></span>
<span id="cb229-2"><a href="#cb229-2" aria-hidden="true" tabindex="-1"></a>データフレーム<span class="sc">/</span>tibble名 <span class="sc">%&gt;%</span></span>
<span id="cb229-3"><a href="#cb229-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(新変数名 <span class="ot">=</span> <span class="fu">case_when</span>(条件1 <span class="sc">~</span> 条件1を満たす場合の結果値, </span>
<span id="cb229-4"><a href="#cb229-4" aria-hidden="true" tabindex="-1"></a>                             条件2 <span class="sc">~</span> 条件2を満たす場合の結果値, </span>
<span id="cb229-5"><a href="#cb229-5" aria-hidden="true" tabindex="-1"></a>                             条件3 <span class="sc">~</span> 条件3を満たす場合の結果値, </span>
<span id="cb229-6"><a href="#cb229-6" aria-hidden="true" tabindex="-1"></a>                             ...))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>　似たような機能をする関数として<code>recode()</code>関数があります。これは変数の値を単純に置換したい場合に便利な関数です。たとえば、都府県名をローマ字に変換するケースを考えてみましょう。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb230"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb230-1"><a href="#cb230-1"></a><span class="co"># recode()を使う場合</span></span>
<span id="cb230-2"><a href="#cb230-2"></a>df2 <span class="sc">%&gt;%</span> </span>
<span id="cb230-3"><a href="#cb230-3"></a>  <span class="fu">mutate</span>(<span class="at">Pref2 =</span> <span class="fu">recode</span>(Pref,</span>
<span id="cb230-4"><a href="#cb230-4"></a>                        <span class="st">"東京都"</span>   <span class="ot">=</span> <span class="st">"Tokyo"</span>,</span>
<span id="cb230-5"><a href="#cb230-5"></a>                        <span class="st">"神奈川県"</span> <span class="ot">=</span> <span class="st">"Kanagawa"</span>,</span>
<span id="cb230-6"><a href="#cb230-6"></a>                        <span class="st">"千葉県"</span>   <span class="ot">=</span> <span class="st">"Chiba"</span>,</span>
<span id="cb230-7"><a href="#cb230-7"></a>                        <span class="st">"埼玉県"</span>   <span class="ot">=</span> <span class="st">"Saitama"</span>,</span>
<span id="cb230-8"><a href="#cb230-8"></a>                        <span class="st">"大阪府"</span>   <span class="ot">=</span> <span class="st">"Osaka"</span>,</span>
<span id="cb230-9"><a href="#cb230-9"></a>                        <span class="st">"京都府"</span>   <span class="ot">=</span> <span class="st">"Kyoto"</span>,</span>
<span id="cb230-10"><a href="#cb230-10"></a>                        <span class="st">"兵庫県"</span>   <span class="ot">=</span> <span class="st">"Hyogo"</span>,</span>
<span id="cb230-11"><a href="#cb230-11"></a>                        <span class="st">"奈良県"</span>   <span class="ot">=</span> <span class="st">"Nara"</span>,</span>
<span id="cb230-12"><a href="#cb230-12"></a>                        <span class="st">"和歌山県"</span> <span class="ot">=</span> <span class="st">"Wakayama"</span>,</span>
<span id="cb230-13"><a href="#cb230-13"></a>                        <span class="at">.default   =</span> <span class="st">"NA"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 9 × 6
  Pref     Budget_Mean ScoreN_Sum Score_Mean     N Pref2   
  &lt;chr&gt;          &lt;dbl&gt;      &lt;dbl&gt;      &lt;dbl&gt; &lt;int&gt; &lt;chr&gt;   
1 京都府         1399.        216       3.68   414 Kyoto   
2 兵庫県         1197.        230       3.54   591 Hyogo   
3 千葉県         1124.        259       3.72  1000 Chiba   
4 和歌山県       1252          83       3.97   140 Wakayama
5 埼玉県         1147.        278       3.64  1000 Saitama 
6 大阪府         1203.        516       3.77  1000 Osaka   
7 奈良県         1169.         45       3.85   147 Nara    
8 東京都         1283.       1165       3.67  1000 Tokyo   
9 神奈川県       1239.        587       3.53  1000 Kanagawa</code></pre>
</div>
</div>
<p>　使い方は非常に直感的です。</p>
<div class="sourceCode" id="cb232"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb232-1"><a href="#cb232-1" aria-hidden="true" tabindex="-1"></a><span class="co"># recode()の使い方</span></span>
<span id="cb232-2"><a href="#cb232-2" aria-hidden="true" tabindex="-1"></a>データフレーム<span class="sc">/</span>tibble名 <span class="sc">%&gt;%</span></span>
<span id="cb232-3"><a href="#cb232-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(新変数名 <span class="ot">=</span> <span class="fu">recode</span>(元の変数名,</span>
<span id="cb232-4"><a href="#cb232-4" aria-hidden="true" tabindex="-1"></a>                            元の値1 <span class="ot">=</span>  新しい値1, </span>
<span id="cb232-5"><a href="#cb232-5" aria-hidden="true" tabindex="-1"></a>                            元の値2 <span class="ot">=</span>  新しい値2, </span>
<span id="cb232-6"><a href="#cb232-6" aria-hidden="true" tabindex="-1"></a>                            元の値3 <span class="ot">=</span>  新しい値3, </span>
<span id="cb232-7"><a href="#cb232-7" aria-hidden="true" tabindex="-1"></a>                            ...,</span>
<span id="cb232-8"><a href="#cb232-8" aria-hidden="true" tabindex="-1"></a>                            <span class="at">.default =</span> 該当しない場合の値))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>　最後の<code>.default</code>引数は、もし該当する値がない場合に返す値を意味し、長さ1のベクトルを指定します。もし、指定しない場合は<code>NA</code>が表示されます。また、ここには紹介しておりませんでしたが、<code>.missing</code>引数もあり、これは欠損値の場合に返す値を意味します。</p>
<p>　もう一つ注意すべきところは、今回はcharacter型変数をcharacter型へ変換したため、「<code>"東京都" = "Tokyo"</code>」のような書き方をしました。しかし、numeric型からcharacter型に変換する場合は数字の部分を<code>`</code>で囲む必要があります。たとえば、「<code>`1` = "Tokyo"</code>」といった形式です。ただし、character型からnumeric型への場合は「<code>"東京都" = 1</code>」で構いません。</p>
<p>　<code>recode()</code>は値をまとめる際にも便利です。たとえば、<code>EastJapan</code>という変数を作成し、関東なら<code>1</code>を、それ以外なら<code>0</code>を付けるとします。そして、これは<code>Pref</code>変数の後に位置づけます。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb233"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb233-1"><a href="#cb233-1"></a><span class="co"># 都府県を関東か否かでまとめる</span></span>
<span id="cb233-2"><a href="#cb233-2"></a>df2 <span class="sc">%&gt;%</span> </span>
<span id="cb233-3"><a href="#cb233-3"></a>  <span class="fu">mutate</span>(<span class="at">EastJapan =</span> <span class="fu">recode</span>(Pref,</span>
<span id="cb233-4"><a href="#cb233-4"></a>                            <span class="st">"東京都"</span>   <span class="ot">=</span> <span class="dv">1</span>,</span>
<span id="cb233-5"><a href="#cb233-5"></a>                            <span class="st">"神奈川県"</span> <span class="ot">=</span> <span class="dv">1</span>,</span>
<span id="cb233-6"><a href="#cb233-6"></a>                            <span class="st">"千葉県"</span>   <span class="ot">=</span> <span class="dv">1</span>,</span>
<span id="cb233-7"><a href="#cb233-7"></a>                            <span class="st">"埼玉県"</span>   <span class="ot">=</span> <span class="dv">1</span>,</span>
<span id="cb233-8"><a href="#cb233-8"></a>                            <span class="st">"大阪府"</span>   <span class="ot">=</span> <span class="dv">0</span>,</span>
<span id="cb233-9"><a href="#cb233-9"></a>                            <span class="st">"京都府"</span>   <span class="ot">=</span> <span class="dv">0</span>,</span>
<span id="cb233-10"><a href="#cb233-10"></a>                            <span class="st">"兵庫県"</span>   <span class="ot">=</span> <span class="dv">0</span>,</span>
<span id="cb233-11"><a href="#cb233-11"></a>                            <span class="st">"奈良県"</span>   <span class="ot">=</span> <span class="dv">0</span>,</span>
<span id="cb233-12"><a href="#cb233-12"></a>                            <span class="st">"和歌山県"</span> <span class="ot">=</span> <span class="dv">0</span>,</span>
<span id="cb233-13"><a href="#cb233-13"></a>                            <span class="at">.default  =</span> <span class="dv">0</span>),</span>
<span id="cb233-14"><a href="#cb233-14"></a>         <span class="at">.after =</span> Pref)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 9 × 6
  Pref     EastJapan Budget_Mean ScoreN_Sum Score_Mean     N
  &lt;chr&gt;        &lt;dbl&gt;       &lt;dbl&gt;      &lt;dbl&gt;      &lt;dbl&gt; &lt;int&gt;
1 京都府           0       1399.        216       3.68   414
2 兵庫県           0       1197.        230       3.54   591
3 千葉県           1       1124.        259       3.72  1000
4 和歌山県         0       1252          83       3.97   140
5 埼玉県           1       1147.        278       3.64  1000
6 大阪府           0       1203.        516       3.77  1000
7 奈良県           0       1169.         45       3.85   147
8 東京都           1       1283.       1165       3.67  1000
9 神奈川県         1       1239.        587       3.53  1000</code></pre>
</div>
</div>
<p>　ただし、関東以外は全て0になるため、以下のように省略することも可能です。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb235"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb235-1"><a href="#cb235-1"></a><span class="co"># .default引数を指定する場合</span></span>
<span id="cb235-2"><a href="#cb235-2"></a>df3 <span class="ot">&lt;-</span> df2 <span class="sc">%&gt;%</span> </span>
<span id="cb235-3"><a href="#cb235-3"></a>  <span class="fu">mutate</span>(<span class="at">EastJapan =</span> <span class="fu">recode</span>(Pref,</span>
<span id="cb235-4"><a href="#cb235-4"></a>                            <span class="st">"東京都"</span>   <span class="ot">=</span> <span class="dv">1</span>,</span>
<span id="cb235-5"><a href="#cb235-5"></a>                            <span class="st">"神奈川県"</span> <span class="ot">=</span> <span class="dv">1</span>,</span>
<span id="cb235-6"><a href="#cb235-6"></a>                            <span class="st">"千葉県"</span>   <span class="ot">=</span> <span class="dv">1</span>,</span>
<span id="cb235-7"><a href="#cb235-7"></a>                            <span class="st">"埼玉県"</span>   <span class="ot">=</span> <span class="dv">1</span>,</span>
<span id="cb235-8"><a href="#cb235-8"></a>                            <span class="at">.default  =</span> <span class="dv">0</span>),</span>
<span id="cb235-9"><a href="#cb235-9"></a>         <span class="at">.after =</span> Pref)</span>
<span id="cb235-10"><a href="#cb235-10"></a></span>
<span id="cb235-11"><a href="#cb235-11"></a>df3</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 9 × 6
  Pref     EastJapan Budget_Mean ScoreN_Sum Score_Mean     N
  &lt;chr&gt;        &lt;dbl&gt;       &lt;dbl&gt;      &lt;dbl&gt;      &lt;dbl&gt; &lt;int&gt;
1 京都府           0       1399.        216       3.68   414
2 兵庫県           0       1197.        230       3.54   591
3 千葉県           1       1124.        259       3.72  1000
4 和歌山県         0       1252          83       3.97   140
5 埼玉県           1       1147.        278       3.64  1000
6 大阪府           0       1203.        516       3.77  1000
7 奈良県           0       1169.         45       3.85   147
8 東京都           1       1283.       1165       3.67  1000
9 神奈川県         1       1239.        587       3.53  1000</code></pre>
</div>
</div>
<p>　新しく出来た<code>EastJapan</code>のデータ型はなんでしょうか。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb237"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb237-1"><a href="#cb237-1"></a><span class="fu">class</span>(df3<span class="sc">$</span>EastJapan)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "numeric"</code></pre>
</div>
</div>
<p>　<code>EastJapan</code>はnumeric型ですね。もし、これをfactor型にしたい場合はどうすればよいでしょうか。それは<code>mutate()</code>内で<code>EastJapan</code>を生成した後に<code>factor()</code>関数を使うだけです。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb239"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb239-1"><a href="#cb239-1"></a><span class="co"># EastJapan変数をfactor型にする</span></span>
<span id="cb239-2"><a href="#cb239-2"></a>df3 <span class="ot">&lt;-</span> df2 <span class="sc">%&gt;%</span> </span>
<span id="cb239-3"><a href="#cb239-3"></a>  <span class="fu">mutate</span>(<span class="at">EastJapan =</span> <span class="fu">recode</span>(Pref,</span>
<span id="cb239-4"><a href="#cb239-4"></a>                            <span class="st">"東京都"</span>   <span class="ot">=</span> <span class="dv">1</span>,</span>
<span id="cb239-5"><a href="#cb239-5"></a>                            <span class="st">"神奈川県"</span> <span class="ot">=</span> <span class="dv">1</span>,</span>
<span id="cb239-6"><a href="#cb239-6"></a>                            <span class="st">"千葉県"</span>   <span class="ot">=</span> <span class="dv">1</span>,</span>
<span id="cb239-7"><a href="#cb239-7"></a>                            <span class="st">"埼玉県"</span>   <span class="ot">=</span> <span class="dv">1</span>,</span>
<span id="cb239-8"><a href="#cb239-8"></a>                            <span class="at">.default  =</span> <span class="dv">0</span>),</span>
<span id="cb239-9"><a href="#cb239-9"></a>         <span class="at">EastJapan =</span> <span class="fu">factor</span>(EastJapan, <span class="at">levels =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>)),</span>
<span id="cb239-10"><a href="#cb239-10"></a>         <span class="at">.after =</span> Pref)</span>
<span id="cb239-11"><a href="#cb239-11"></a></span>
<span id="cb239-12"><a href="#cb239-12"></a>df3<span class="sc">$</span>EastJapan</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0 0 1 0 1 0 0 1 1
Levels: 0 1</code></pre>
</div>
</div>
<p>　<code>EastJapan</code>がfactor型になりました。実は、<code>recode</code>は再コーディングと同時にfactor化をしてくれる機能があります。ただし、<code>recode()</code>関数でなく、<code>recode_factor()</code>関数を使います。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb241"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb241-1"><a href="#cb241-1"></a><span class="co"># recode_factor()を使う方法</span></span>
<span id="cb241-2"><a href="#cb241-2"></a>df3 <span class="ot">&lt;-</span> df2 <span class="sc">%&gt;%</span> </span>
<span id="cb241-3"><a href="#cb241-3"></a>  <span class="fu">mutate</span>(<span class="at">EastJapan =</span> <span class="fu">recode_factor</span>(Pref,</span>
<span id="cb241-4"><a href="#cb241-4"></a>                                   <span class="st">"東京都"</span>   <span class="ot">=</span> <span class="dv">1</span>,</span>
<span id="cb241-5"><a href="#cb241-5"></a>                                   <span class="st">"神奈川県"</span> <span class="ot">=</span> <span class="dv">1</span>,</span>
<span id="cb241-6"><a href="#cb241-6"></a>                                   <span class="st">"千葉県"</span>   <span class="ot">=</span> <span class="dv">1</span>,</span>
<span id="cb241-7"><a href="#cb241-7"></a>                                   <span class="st">"埼玉県"</span>   <span class="ot">=</span> <span class="dv">1</span>,</span>
<span id="cb241-8"><a href="#cb241-8"></a>                                   <span class="at">.default  =</span> <span class="dv">0</span>),</span>
<span id="cb241-9"><a href="#cb241-9"></a>         <span class="at">.after =</span> Pref)</span>
<span id="cb241-10"><a href="#cb241-10"></a></span>
<span id="cb241-11"><a href="#cb241-11"></a>df3<span class="sc">$</span>EastJapan</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0 0 1 0 1 0 0 1 1
Levels: 1 0</code></pre>
</div>
</div>
<p>　ただし、levelの順番は<code>recode_factor()</code>内で定義された順番になることに注意してください。</p>
</section>
</section>
<section id="factor型の処理に便利な関数" class="level2">
<h2 class="anchored" data-anchor-id="factor型の処理に便利な関数">factor型の処理に便利な関数</h2>
<section id="factor型の必要性" class="level3">
<h3 class="anchored" data-anchor-id="factor型の必要性">factor型の必要性</h3>
<p>　話がずれますが、可視化における名目変数の扱いについて考えたいと思います。横軸、または縦軸が気温、成績、身長のような連続変数ではなく、都道府県や国、企業のような名目変数になる場合があります。たとえば、棒グラフの横軸は <a href="#fig-factor1">図&nbsp;3</a> のように、一般的に名目変数になる場合が多いです。</p>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div id="fig-factor1" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="dplyr_intro_files/figure-html/fig-factor1-1.png" class="img-fluid figure-img" width="1800"></p>
<p></p><figcaption aria-hidden="true" class="figure-caption">図 3: 横軸が名目変数の棒グラフ</figcaption><p></p>
</figure>
</div>
</div>
</div>
<p>　ここでは横軸の順番に注目してください。京都府、埼玉県、神奈川県、…の順番になっていますね。「この順番で大満足だよ!」という方がいるかも知れませんが、そうでない方もおおいでしょう。普通考えられるものとしては、都道府県コードの順か、縦軸が高い順 (低い順)でしょう。都道府県コードの順だと、埼玉県、千葉県、東京都、神奈川県、京都府、大阪府、兵庫県、奈良県、和歌山県の順番になります。または、縦軸 (口コミ評価の平均値)が高い順なら和歌山県、奈良県、大阪府、…の順番になります。あるいは50音順も考えられるでしょう。アメリカの場合、州を並べる際、アルファベット順で並べます。</p>
<p>　自分でこの順番をコントロールするには可視化の前の段階、つまりデータハンドリングの段階で順番を決めなくてはなりません。これを決めておかない場合、Rが勝手に順番を指定します。具体的にはロケール (locale)というパソコン内の空間に文字情報が含まれているわけですが、そこに保存されている文字の順番となります。たとえば、日本語ロケールには「京」が「埼」よりも先に保存されているわけです。</p>
<p>　したがって、名目変数がグラフに含まれる場合は、名目変数の表示順番を決める必要があり、そこで必要なのがfactor型です。名目変数がcharacter型の場合、ロケールに保存されている順でソートされますが、factor型の場合、予め指定した順番でソートされます。</p>
<p>　たとえば、<code>df</code>を用いて、都道府県ごとの口コミ評価の平均値を計算し、その結果を<code>Score_df</code>として保存します。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb243"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb243-1"><a href="#cb243-1"></a>Score_df <span class="ot">&lt;-</span> df <span class="sc">%&gt;%</span></span>
<span id="cb243-2"><a href="#cb243-2"></a>    <span class="fu">group_by</span>(Pref) <span class="sc">%&gt;%</span></span>
<span id="cb243-3"><a href="#cb243-3"></a>    <span class="fu">summarise</span>(<span class="at">Score   =</span> <span class="fu">mean</span>(Score, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb243-4"><a href="#cb243-4"></a>              <span class="at">.groups =</span> <span class="st">"drop"</span>)</span>
<span id="cb243-5"><a href="#cb243-5"></a></span>
<span id="cb243-6"><a href="#cb243-6"></a>Score_df</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 9 × 2
  Pref     Score
  &lt;chr&gt;    &lt;dbl&gt;
1 京都府    3.68
2 兵庫県    3.54
3 千葉県    3.72
4 和歌山県  3.97
5 埼玉県    3.64
6 大阪府    3.77
7 奈良県    3.85
8 東京都    3.67
9 神奈川県  3.53</code></pre>
</div>
</div>
<p>　この時点で勝手にロケール順になります。実際、表示された<code>Score_df</code>を見ると<code>Pref</code>の下に`<code>&lt;chr&gt;</code>と表記されており、<code>Pref</code>はcharacter型であることが分かります。これをこのまま棒グラフに出してみましょう。可視化の方法は執筆中のE-Bookで詳細に解説する予定ですので、ここでは結果だけに注目してください。</p>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div id="fig-factor2" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="dplyr_intro_files/figure-html/fig-factor2-1.png" class="img-fluid figure-img" width="1800"></p>
<p></p><figcaption aria-hidden="true" class="figure-caption">図 4: Prefがcharacter型の場合 (1)</figcaption><p></p>
</figure>
</div>
</div>
</div>
<p>　横軸の順番があまり直感的ではありませんね。それでは、<code>Score_df</code>を<code>Score</code>が高い順にソートし、<code>Score_df2</code>で保存してから、もう一回試してみます。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb245"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb245-1"><a href="#cb245-1"></a>Score_df2 <span class="ot">&lt;-</span> Score_df <span class="sc">%&gt;%</span></span>
<span id="cb245-2"><a href="#cb245-2"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(Score))</span>
<span id="cb245-3"><a href="#cb245-3"></a></span>
<span id="cb245-4"><a href="#cb245-4"></a>Score_df2</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 9 × 2
  Pref     Score
  &lt;chr&gt;    &lt;dbl&gt;
1 和歌山県  3.97
2 奈良県    3.85
3 大阪府    3.77
4 千葉県    3.72
5 京都府    3.68
6 東京都    3.67
7 埼玉県    3.64
8 兵庫県    3.54
9 神奈川県  3.53</code></pre>
</div>
</div>
<p>　ここでも<code>Pref</code>はcharacter型ですが、とりあえず、これで図を出してみます。</p>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div id="fig-factor3" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="dplyr_intro_files/figure-html/fig-factor3-1.png" class="img-fluid figure-img" width="1800"></p>
<p></p><figcaption aria-hidden="true" class="figure-caption">図 5: Prefがcharacter型の場合 (2)</figcaption><p></p>
</figure>
</div>
</div>
</div>
<p>　結果は全く変わっておりません。それでは、<code>Score_df</code>の<code>Pref</code>列をfactor型に変換し、順番は口コミ評価の平均値が高い順番にしてみましょう。結果は<code>Score_df_f1</code>という名で保存します。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb247"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb247-1"><a href="#cb247-1"></a>Score_df_f1 <span class="ot">&lt;-</span> Score_df <span class="sc">%&gt;%</span></span>
<span id="cb247-2"><a href="#cb247-2"></a>  <span class="fu">mutate</span>(<span class="at">Pref =</span> <span class="fu">factor</span>(Pref, <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"和歌山県"</span>, <span class="st">"奈良県"</span>, <span class="st">"大阪府"</span>,</span>
<span id="cb247-3"><a href="#cb247-3"></a>                                        <span class="st">"千葉県"</span>, <span class="st">"京都府"</span>, <span class="st">"東京都"</span>,</span>
<span id="cb247-4"><a href="#cb247-4"></a>                                        <span class="st">"埼玉県"</span>, <span class="st">"兵庫県"</span>, <span class="st">"神奈川県"</span>)))</span>
<span id="cb247-5"><a href="#cb247-5"></a></span>
<span id="cb247-6"><a href="#cb247-6"></a>Score_df_f1</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 9 × 2
  Pref     Score
  &lt;fct&gt;    &lt;dbl&gt;
1 京都府    3.68
2 兵庫県    3.54
3 千葉県    3.72
4 和歌山県  3.97
5 埼玉県    3.64
6 大阪府    3.77
7 奈良県    3.85
8 東京都    3.67
9 神奈川県  3.53</code></pre>
</div>
</div>
<p>　表示される順番は<code>Score_df</code>と<code>Score_df_f1</code>も同じですが、<code>Pref</code>のデータ型が<code>&lt;fct&gt;</code>、つまりfactor型であることが分かります。実際、<code>Pref</code>列だけ抽出した場合、factor型として、和歌山県から神奈川県の順になっていることが確認できます。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb249"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb249-1"><a href="#cb249-1"></a>Score_df_f1<span class="sc">$</span>Pref</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 京都府   兵庫県   千葉県   和歌山県 埼玉県   大阪府   奈良県   東京都  
[9] 神奈川県
9 Levels: 和歌山県 奈良県 大阪府 千葉県 京都府 東京都 埼玉県 ... 神奈川県</code></pre>
</div>
</div>
<p>　この<code>Score_df_f1</code>データを使って、 <a href="#fig-factor2">図&nbsp;4</a> と全く同じコードを実行した結果が <a href="#fig-factor4">図&nbsp;6</a> です。</p>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div id="fig-factor4" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="dplyr_intro_files/figure-html/fig-factor4-1.png" class="img-fluid figure-img" width="1800"></p>
<p></p><figcaption aria-hidden="true" class="figure-caption">図 6: Prefがfactor型の場合</figcaption><p></p>
</figure>
</div>
</div>
</div>
<p>　これまでの話をまとめるの以下の2点が分かります。</p>
<ol type="1">
<li>変数がcharacter型である場合、自動的にロケール順でソートされる。</li>
<li>変数がfactor型である場合、データ内の順番やロケール順と関係なく、指定されたレベル (水準)の順でソートされる。</li>
</ol>
<p>　特に2番目の点についてですが、これは必ずしも順序付きfactorである必要はありません。順序付きfactor型でなくても、<code>factor()</code>内で指定した順にソートされます。むろん、順序付きfactor型なら指定された順序でソートされます。</p>
<p>　これからはfactor型変換の際に便利な関数をいくつか紹介しますが、その前に数値として表現された名目変数について話します。たとえば、<code>Score_df_f1</code>に関東地域なら<code>1</code>を、その他の地域なら<code>0</code>を付けた<code>Kanto</code>という変数があるとします。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb251"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb251-1"><a href="#cb251-1"></a>Score_df_f1 <span class="ot">&lt;-</span> Score_df_f1 <span class="sc">%&gt;%</span></span>
<span id="cb251-2"><a href="#cb251-2"></a>  <span class="fu">mutate</span>(<span class="at">Kanto =</span> <span class="fu">ifelse</span>(Pref <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"東京都"</span>, <span class="st">"神奈川県"</span>, <span class="st">"千葉県"</span>, <span class="st">"埼玉県"</span>), <span class="dv">1</span>, <span class="dv">0</span>))</span>
<span id="cb251-3"><a href="#cb251-3"></a></span>
<span id="cb251-4"><a href="#cb251-4"></a>Score_df_f1</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 9 × 3
  Pref     Score Kanto
  &lt;fct&gt;    &lt;dbl&gt; &lt;dbl&gt;
1 京都府    3.68     0
2 兵庫県    3.54     0
3 千葉県    3.72     1
4 和歌山県  3.97     0
5 埼玉県    3.64     1
6 大阪府    3.77     0
7 奈良県    3.85     0
8 東京都    3.67     1
9 神奈川県  3.53     1</code></pre>
</div>
</div>
<p>　<code>Kanto</code>変数のデータ型は、<code>&lt;dbl&gt;</code>、つまりnumeric型です。しかし、これは明らかに名目変数ですね。これをこのまま<code>Kanto</code>を横軸にした図を出すと <a href="#fig-factor5">図&nbsp;7</a> のようになります。</p>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div id="fig-factor5" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="dplyr_intro_files/figure-html/fig-factor5-1.png" class="img-fluid figure-img" width="1800"></p>
<p></p><figcaption aria-hidden="true" class="figure-caption">図 7: Kantoがnumeric型の場合</figcaption><p></p>
</figure>
</div>
</div>
</div>
<p>　この場合、図の横軸は<code>Kanto</code>の値が小さい順でソートされます。ただし、このような図は非常に見にくいため、<code>1</code>に<code>"関東"</code>、<code>0</code>に<code>"関西"</code>とラベルを付けたfactor型に変換した方が望ましいです。numeric型をラベル付きのfactor型にするためには、<code>levels</code>引数には元の数値を、<code>labels</code>引数にはそれぞれの数値に対応したラベルを指定します。また、関東の方を先に出したいので、<code>factor()</code>内の<code>levels</code>引数は<code>c(0, 1)</code>でなく、<code>c(1, 0)</code>にします。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb253"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb253-1"><a href="#cb253-1"></a>Score_df_f1 <span class="ot">&lt;-</span> Score_df_f1 <span class="sc">%&gt;%</span></span>
<span id="cb253-2"><a href="#cb253-2"></a>  <span class="fu">mutate</span>(<span class="at">Kanto =</span> <span class="fu">factor</span>(Kanto, <span class="at">levels =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">0</span>), <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"関東"</span>, <span class="st">"その他"</span>)))</span>
<span id="cb253-3"><a href="#cb253-3"></a></span>
<span id="cb253-4"><a href="#cb253-4"></a>Score_df_f1</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 9 × 3
  Pref     Score Kanto 
  &lt;fct&gt;    &lt;dbl&gt; &lt;fct&gt; 
1 京都府    3.68 その他
2 兵庫県    3.54 その他
3 千葉県    3.72 関東  
4 和歌山県  3.97 その他
5 埼玉県    3.64 関東  
6 大阪府    3.77 その他
7 奈良県    3.85 その他
8 東京都    3.67 関東  
9 神奈川県  3.53 関東  </code></pre>
</div>
</div>
<p>　<code>Kanto</code>変数がfactor型に変換されたことが分かります。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb255"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb255-1"><a href="#cb255-1"></a>Score_df_f1<span class="sc">$</span>Kanto</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] その他 その他 関東   その他 関東   その他 その他 関東   関東  
Levels: 関東 その他</code></pre>
</div>
</div>
<p>　また、<code>"関東"</code>、<code>"その他"</code>の順になっていますね。これを図として出力した結果が <a href="#fig-factor6">図&nbsp;8</a> です。</p>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div id="fig-factor6" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="dplyr_intro_files/figure-html/fig-factor6-1.png" class="img-fluid figure-img" width="1800"></p>
<p></p><figcaption aria-hidden="true" class="figure-caption">図 8: Kantoがfactor型の場合</figcaption><p></p>
</figure>
</div>
</div>
</div>
<p>　このように数値型名目変数でも、factor化することによって、自由に横軸の順番を変えることができます。それでは、factor化に使える便利な関数をいくつか紹介します。</p>
</section>
<section id="forcatsパッケージについて" class="level3">
<h3 class="anchored" data-anchor-id="forcatsパッケージについて">{forcats}パッケージについて</h3>
<p>　実はfactor型への変換や、順番に変更などは全てR内蔵の<code>factor()</code>関数で対応可能ですが、ここでは{forcats}パッケージが提供している<code>fct_*()</code>関数を使用します。{forcats}パッケージは{tidyverse}を読み込む際、自動的に読み込まれるため、既に{tidyverse}を読み込んでいる場合、別途のコードは要りません。</p>
<p>　実はfactor型への変換や、順番に変更などは全てR内蔵の<code>factor()</code>関数で対応可能ですが、ここでは{forcats}パッケージが提供している<code>fct_*()</code>関数を使用します。{forcats}パッケージは{tidyverse}を読み込む際、自動的に読み込まれるため、既に{tidyverse}を読み込んでいる場合、別途のコードは要りません。</p>
<p><strong><code>fct_relevel()</code>: 水準の順番を変更する</strong></p>
<p>　<code>Score_df_f1</code>の<code>f1</code>は<code>Score</code>が高い順になっています。これを50音順に変更する際、<code>fct_relevel()</code>関数を使います。</p>
<div class="sourceCode" id="cb257"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb257-1"><a href="#cb257-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 新しい変数名と元となる変数名が一致すると上書きになる</span></span>
<span id="cb257-2"><a href="#cb257-2" aria-hidden="true" tabindex="-1"></a>データフレーム名 <span class="sc">%&gt;%</span></span>
<span id="cb257-3"><a href="#cb257-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(新しい変数名 <span class="ot">=</span> <span class="fu">fct_releve</span>(元となる変数名, </span>
<span id="cb257-4"><a href="#cb257-4" aria-hidden="true" tabindex="-1"></a>                                    <span class="st">"水準1"</span>, <span class="st">"水準2"</span>, <span class="st">"水準3"</span>, ...))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>　ここでは、<code>Pref</code>変数を再調整した<code>Pref2</code>変数を作ってみましょう。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb258"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb258-1"><a href="#cb258-1"></a>Score_df_f1 <span class="ot">&lt;-</span> Score_df_f1 <span class="sc">%&gt;%</span></span>
<span id="cb258-2"><a href="#cb258-2"></a>  <span class="fu">mutate</span>(<span class="at">Pref2 =</span> <span class="fu">fct_relevel</span>(Pref, <span class="st">"大阪府"</span>, <span class="st">"神奈川県"</span>, <span class="st">"京都府"</span>, </span>
<span id="cb258-3"><a href="#cb258-3"></a>                             <span class="st">"埼玉県"</span>, <span class="st">"千葉県"</span>, <span class="st">"東京都"</span>, </span>
<span id="cb258-4"><a href="#cb258-4"></a>                             <span class="st">"奈良県"</span>, <span class="st">"兵庫県"</span>, <span class="st">"和歌山県"</span>))</span>
<span id="cb258-5"><a href="#cb258-5"></a></span>
<span id="cb258-6"><a href="#cb258-6"></a>Score_df_f1</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 9 × 4
  Pref     Score Kanto  Pref2   
  &lt;fct&gt;    &lt;dbl&gt; &lt;fct&gt;  &lt;fct&gt;   
1 京都府    3.68 その他 京都府  
2 兵庫県    3.54 その他 兵庫県  
3 千葉県    3.72 関東   千葉県  
4 和歌山県  3.97 その他 和歌山県
5 埼玉県    3.64 関東   埼玉県  
6 大阪府    3.77 その他 大阪府  
7 奈良県    3.85 その他 奈良県  
8 東京都    3.67 関東   東京都  
9 神奈川県  3.53 関東   神奈川県</code></pre>
</div>
</div>
<p>　一見、<code>Pref</code>と<code>Pref2</code>変数は同じように見えますが、水準はどうなっているでしょうか。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb260"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb260-1"><a href="#cb260-1"></a><span class="fu">levels</span>(Score_df_f1<span class="sc">$</span>Pref)  <span class="co"># Prefの水準</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "和歌山県" "奈良県"   "大阪府"   "千葉県"   "京都府"   "東京都"   "埼玉県"  
[8] "兵庫県"   "神奈川県"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb262"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb262-1"><a href="#cb262-1"></a><span class="fu">levels</span>(Score_df_f1<span class="sc">$</span>Pref2) <span class="co"># Pref2の水準</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "大阪府"   "神奈川県" "京都府"   "埼玉県"   "千葉県"   "東京都"   "奈良県"  
[8] "兵庫県"   "和歌山県"</code></pre>
</div>
</div>
<p>　問題なく50音順になっていることが分かります。他にも<code>fct_relevel()</code>には全ての水準名を指定する必要がありません。一部の水準名も可能です。たとえば、「関東が関西の先に来るなんでけしからん！」と思う読者もいるでしょう。この場合、関西の府県名を入れると、指定した水準が最初に位置するようになります。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb264"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb264-1"><a href="#cb264-1"></a>Score_df_f1 <span class="ot">&lt;-</span> Score_df_f1 <span class="sc">%&gt;%</span></span>
<span id="cb264-2"><a href="#cb264-2"></a>  <span class="fu">mutate</span>(<span class="at">Pref3 =</span> <span class="fu">fct_relevel</span>(Pref, <span class="st">"京都府"</span>, <span class="st">"大阪府"</span>,</span>
<span id="cb264-3"><a href="#cb264-3"></a>                             <span class="st">"兵庫県"</span>, <span class="st">"奈良県"</span>, <span class="st">"和歌山県"</span>))</span>
<span id="cb264-4"><a href="#cb264-4"></a></span>
<span id="cb264-5"><a href="#cb264-5"></a><span class="fu">levels</span>(Score_df_f1<span class="sc">$</span>Pref3) <span class="co"># Pref3の水準</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "京都府"   "大阪府"   "兵庫県"   "奈良県"   "和歌山県" "千葉県"   "東京都"  
[8] "埼玉県"   "神奈川県"</code></pre>
</div>
</div>
<p>　一部の水準名のみを指定するとその水準が最初に移動されますが、<code>after</code>引数を指定すると、位置を調整することも可能です。<code>after = 2</code>の場合、元となる変数の1、3番目の水準は維持され、3番目以降に指定した水準、それに続いて指定されていない水準の順番になります。<code>Pref</code>は和歌山、奈良、大阪の順ですが、ここで京都と東京を、奈良と大阪の間に移動するなら、</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb266"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb266-1"><a href="#cb266-1"></a>Score_df_f1 <span class="ot">&lt;-</span> Score_df_f1 <span class="sc">%&gt;%</span></span>
<span id="cb266-2"><a href="#cb266-2"></a>  <span class="fu">mutate</span>(<span class="at">Pref4 =</span> <span class="fu">fct_relevel</span>(Pref, <span class="st">"京都府"</span>, <span class="st">"東京都"</span>, <span class="at">after =</span> <span class="dv">2</span>))</span>
<span id="cb266-3"><a href="#cb266-3"></a></span>
<span id="cb266-4"><a href="#cb266-4"></a><span class="fu">levels</span>(Score_df_f1<span class="sc">$</span>Pref4) <span class="co"># Pref4の水準</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "和歌山県" "奈良県"   "京都府"   "東京都"   "大阪府"   "千葉県"   "埼玉県"  
[8] "兵庫県"   "神奈川県"</code></pre>
</div>
</div>
<p>のように書きます。<code>after</code>を指定しない場合のデフォルト値は0であるため、最初に移動します。</p>
<p><strong><code>fct_recode()</code>: 水準のラベルを変更する</strong></p>
<p>　<code>fct_recode()</code>は水準のラベルを変更する時に使う関数で、以下のように使います。</p>
<div class="sourceCode" id="cb268"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb268-1"><a href="#cb268-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 新しい変数名と元となる変数名が一致すると上書きになる</span></span>
<span id="cb268-2"><a href="#cb268-2" aria-hidden="true" tabindex="-1"></a>データフレーム名 <span class="sc">%&gt;%</span></span>
<span id="cb268-3"><a href="#cb268-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(新しい変数名 <span class="ot">=</span> <span class="fu">fct_recode</span>(元となる変数名, </span>
<span id="cb268-4"><a href="#cb268-4" aria-hidden="true" tabindex="-1"></a>                                   新しいラベル1 <span class="ot">=</span> <span class="st">"既存のラベル1"</span>,</span>
<span id="cb268-5"><a href="#cb268-5" aria-hidden="true" tabindex="-1"></a>                                   新しいラベル2 <span class="ot">=</span> <span class="st">"既存のラベル2"</span>,</span>
<span id="cb268-6"><a href="#cb268-6" aria-hidden="true" tabindex="-1"></a>                                   新しいラベル3 <span class="ot">=</span> <span class="st">"既存のラベル3"</span>,</span>
<span id="cb268-7"><a href="#cb268-7" aria-hidden="true" tabindex="-1"></a>                                   ...))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>　注意点としては新しいラベルは<code>"</code>で囲まず、既存のラベルは<code>"</code>で囲む点です。それでは、<code>Pref</code>のラベルをローマ字に変更してみましょう。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb269"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb269-1"><a href="#cb269-1"></a>Score_df_f1 <span class="ot">&lt;-</span> Score_df_f1 <span class="sc">%&gt;%</span></span>
<span id="cb269-2"><a href="#cb269-2"></a>  <span class="fu">mutate</span>(<span class="at">Pref5 =</span> <span class="fu">fct_recode</span>(Pref,</span>
<span id="cb269-3"><a href="#cb269-3"></a>                            <span class="at">Saitama  =</span> <span class="st">"埼玉県"</span>,</span>
<span id="cb269-4"><a href="#cb269-4"></a>                            <span class="at">Wakayama =</span> <span class="st">"和歌山県"</span>,</span>
<span id="cb269-5"><a href="#cb269-5"></a>                            <span class="at">Kyoto    =</span> <span class="st">"京都府"</span>,</span>
<span id="cb269-6"><a href="#cb269-6"></a>                            <span class="at">Osaka    =</span> <span class="st">"大阪府"</span>,</span>
<span id="cb269-7"><a href="#cb269-7"></a>                            <span class="at">Tokyo    =</span> <span class="st">"東京都"</span>,</span>
<span id="cb269-8"><a href="#cb269-8"></a>                            <span class="at">Nara     =</span> <span class="st">"奈良県"</span>,</span>
<span id="cb269-9"><a href="#cb269-9"></a>                            <span class="at">Kanagawa =</span> <span class="st">"神奈川県"</span>,</span>
<span id="cb269-10"><a href="#cb269-10"></a>                            <span class="at">Hyogo    =</span> <span class="st">"兵庫県"</span>,</span>
<span id="cb269-11"><a href="#cb269-11"></a>                            <span class="at">Chiba    =</span> <span class="st">"千葉県"</span>))</span>
<span id="cb269-12"><a href="#cb269-12"></a></span>
<span id="cb269-13"><a href="#cb269-13"></a>Score_df_f1</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 9 × 7
  Pref     Score Kanto  Pref2    Pref3    Pref4    Pref5   
  &lt;fct&gt;    &lt;dbl&gt; &lt;fct&gt;  &lt;fct&gt;    &lt;fct&gt;    &lt;fct&gt;    &lt;fct&gt;   
1 京都府    3.68 その他 京都府   京都府   京都府   Kyoto   
2 兵庫県    3.54 その他 兵庫県   兵庫県   兵庫県   Hyogo   
3 千葉県    3.72 関東   千葉県   千葉県   千葉県   Chiba   
4 和歌山県  3.97 その他 和歌山県 和歌山県 和歌山県 Wakayama
5 埼玉県    3.64 関東   埼玉県   埼玉県   埼玉県   Saitama 
6 大阪府    3.77 その他 大阪府   大阪府   大阪府   Osaka   
7 奈良県    3.85 その他 奈良県   奈良県   奈良県   Nara    
8 東京都    3.67 関東   東京都   東京都   東京都   Tokyo   
9 神奈川県  3.53 関東   神奈川県 神奈川県 神奈川県 Kanagawa</code></pre>
</div>
</div>
<p>　<code>fct_recode()</code>の中に指定する水準の順番は無視されます。つまり、水準の順番はそのまま維持されるため、好きな順番で結構です。また、全ての水準を指定せず、一部のみ変更することも可能です。それでは<code>Pref5</code>の順番が<code>Pref</code>の順番と同じかを確認してみましょう。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb271"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb271-1"><a href="#cb271-1"></a><span class="fu">levels</span>(Score_df_f1<span class="sc">$</span>Pref)  <span class="co"># Prefの水準</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "和歌山県" "奈良県"   "大阪府"   "千葉県"   "京都府"   "東京都"   "埼玉県"  
[8] "兵庫県"   "神奈川県"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb273"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb273-1"><a href="#cb273-1"></a><span class="fu">levels</span>(Score_df_f1<span class="sc">$</span>Pref5) <span class="co"># Pref5の水準</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "Wakayama" "Nara"     "Osaka"    "Chiba"    "Kyoto"    "Tokyo"    "Saitama" 
[8] "Hyogo"    "Kanagawa"</code></pre>
</div>
</div>
<p><strong><code>fct_rev()</code>: 水準の順番を反転する</strong></p>
<p>　水準の順番を反転することは非常によくあります。たとえば、グラフの読みやすさのために、左右または上下を反転するケースがあります。既に何回も強調しましたように、名目変数は基本的にfactor型にすべきであり、ここで<code>fct_rev()</code>関数が非常に便利です。たとえば、<code>Pref2</code>の水準は50音順でありますが、これを反転し、<code>Pref6</code>という名の列として追加してみましょう。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb275"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb275-1"><a href="#cb275-1"></a>Score_df_f1 <span class="ot">&lt;-</span> Score_df_f1 <span class="sc">%&gt;%</span></span>
<span id="cb275-2"><a href="#cb275-2"></a>  <span class="fu">mutate</span>(<span class="at">Pref6 =</span> <span class="fu">fct_rev</span>(Pref2))</span>
<span id="cb275-3"><a href="#cb275-3"></a></span>
<span id="cb275-4"><a href="#cb275-4"></a><span class="fu">levels</span>(Score_df_f1<span class="sc">$</span>Pref6)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "和歌山県" "兵庫県"   "奈良県"   "東京都"   "千葉県"   "埼玉県"   "京都府"  
[8] "神奈川県" "大阪府"  </code></pre>
</div>
</div>
<p>　関数一つで水準の順番が反転されました。</p>
<p><strong><code>fct_infreq()</code>: 頻度順に順番を変更する</strong></p>
<p>　続いて、水準の順番を頻度順に合わせる<code>fct_infreq()</code>関数です。たとえば、<code>Score</code>が欠損でないケースのみで構成された<code>df2</code>を考えてみましょう。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb277"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb277-1"><a href="#cb277-1"></a>df2 <span class="ot">&lt;-</span> df <span class="sc">%&gt;%</span></span>
<span id="cb277-2"><a href="#cb277-2"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(Score))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>　そして、都府県ごとのケース数を計算します。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb278"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb278-1"><a href="#cb278-1"></a><span class="fu">table</span>(df2<span class="sc">$</span>Pref)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
  京都府   兵庫県   千葉県 和歌山県   埼玉県   大阪府   奈良県   東京都 
      79       85      108       24      118      175       28      298 
神奈川県 
     219 </code></pre>
</div>
</div>
<p>　ここで<code>Pref</code>をfactor化しますが、水準の順番を店舗数が多い方を先にするにはどうすれば良いでしょうか。<code>fct_infreq()</code>関数は指定された変数の各値の個数を計算し、多い順にfactorの水準を調整します。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb280"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb280-1"><a href="#cb280-1"></a>df2 <span class="ot">&lt;-</span> df2 <span class="sc">%&gt;%</span></span>
<span id="cb280-2"><a href="#cb280-2"></a>  <span class="co"># 多く出現した値順でfactor化する</span></span>
<span id="cb280-3"><a href="#cb280-3"></a>  <span class="fu">mutate</span>(<span class="at">Pref =</span> <span class="fu">fct_infreq</span>(Pref))</span>
<span id="cb280-4"><a href="#cb280-4"></a></span>
<span id="cb280-5"><a href="#cb280-5"></a><span class="fu">levels</span>(df2<span class="sc">$</span>Pref) <span class="co"># df2のPref変数の水準を出力</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "東京都"   "神奈川県" "大阪府"   "埼玉県"   "千葉県"   "兵庫県"   "京都府"  
[8] "奈良県"   "和歌山県"</code></pre>
</div>
</div>
<p>　<code>"東京都"</code>、<code>"神奈川県"</code>、<code>"大阪府"</code>、…の順で水準の順番が調整され、これは<code>table(df$Pref2)</code>の順位とも一致します。</p>
<p><strong><code>fct_inorder()</code>: データ内の出現順番に順番を変更する</strong></p>
<p>　続いて、<code>fct_inorder()</code>ですが、これは意外と頻繁に使われる関数です。たとえば、自分でデータフレームなどを作成し、ケースの順番も綺麗に整えたとします。しかし、既に指摘した通り、データフレーム (または、tibble)での順番とグラフにおける順番は一致するとは限りません。データフレームに格納された順番でfactorの水準が設定できれば非常に便利でしょう。そこで使うのが<code>fct_inorder()</code>です。</p>
<p>　たとえば、<code>df</code>の<code>Pref</code>は<code>"東京都"</code>が1000個並び、続いて<code>"神奈川県"</code>が1000個、<code>"千葉県"</code>が1000個、…の順番で格納されています。この順番をそのままfactorの順番にするには以下のように書きます。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb282"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb282-1"><a href="#cb282-1"></a>df3 <span class="ot">&lt;-</span> df <span class="sc">%&gt;%</span></span>
<span id="cb282-2"><a href="#cb282-2"></a>  <span class="co"># Pref変数をfactor化し、水準は出現順とする</span></span>
<span id="cb282-3"><a href="#cb282-3"></a>  <span class="co"># 変換後の結果はPrefに上書きする</span></span>
<span id="cb282-4"><a href="#cb282-4"></a>  <span class="fu">mutate</span>(<span class="at">Pref =</span> <span class="fu">fct_inorder</span>(Pref))</span>
<span id="cb282-5"><a href="#cb282-5"></a></span>
<span id="cb282-6"><a href="#cb282-6"></a><span class="fu">levels</span>(df3<span class="sc">$</span>Pref)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "東京都"   "神奈川県" "千葉県"   "埼玉県"   "大阪府"   "京都府"   "兵庫県"  
[8] "奈良県"   "和歌山県"</code></pre>
</div>
</div>
<p><strong><code>fct_shift()</code>: 水準の順番をずらす</strong></p>
<p>　続いて、水準の順番をずらす<code>fct_shift()</code>関数を紹介します。たとえば、「1:そう思う」〜「5:そう思わない」、「9:答えたくない」の6水準で構成された変数があるとします。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb284"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb284-1"><a href="#cb284-1"></a>df4 <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb284-2"><a href="#cb284-2"></a>  <span class="at">ID =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>,</span>
<span id="cb284-3"><a href="#cb284-3"></a>  <span class="at">Q1 =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">5</span>, <span class="dv">3</span>, <span class="dv">2</span>, <span class="dv">9</span>, <span class="dv">2</span>, <span class="dv">4</span>, <span class="dv">9</span>, <span class="dv">5</span>, <span class="dv">1</span>)</span>
<span id="cb284-4"><a href="#cb284-4"></a>) </span>
<span id="cb284-5"><a href="#cb284-5"></a></span>
<span id="cb284-6"><a href="#cb284-6"></a>df4 <span class="ot">&lt;-</span> df4 <span class="sc">%&gt;%</span></span>
<span id="cb284-7"><a href="#cb284-7"></a>  <span class="fu">mutate</span>(<span class="at">Q1 =</span> <span class="fu">factor</span>(Q1, <span class="at">levels =</span> <span class="fu">c</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>, <span class="dv">9</span>),</span>
<span id="cb284-8"><a href="#cb284-8"></a>                     <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"そう思う"</span>, </span>
<span id="cb284-9"><a href="#cb284-9"></a>                                <span class="st">"どちらかと言えばそう思う"</span>,</span>
<span id="cb284-10"><a href="#cb284-10"></a>                                <span class="st">"どちらとも言えない"</span>,</span>
<span id="cb284-11"><a href="#cb284-11"></a>                                <span class="st">"どちらかと言えばそう思わない"</span>,</span>
<span id="cb284-12"><a href="#cb284-12"></a>                                <span class="st">"そう思わない"</span>,</span>
<span id="cb284-13"><a href="#cb284-13"></a>                                <span class="st">"答えたくない"</span>)))</span>
<span id="cb284-14"><a href="#cb284-14"></a></span>
<span id="cb284-15"><a href="#cb284-15"></a>df4</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 10 × 2
      ID Q1                          
   &lt;int&gt; &lt;fct&gt;                       
 1     1 そう思う                    
 2     2 そう思わない                
 3     3 どちらとも言えない          
 4     4 どちらかと言えばそう思う    
 5     5 答えたくない                
 6     6 どちらかと言えばそう思う    
 7     7 どちらかと言えばそう思わない
 8     8 答えたくない                
 9     9 そう思わない                
10    10 そう思う                    </code></pre>
</div>
</div>
<p>　水準の順番も「そう思う」〜「答えたくない」順で綺麗に整っています。この水準を反転するには<code>fct_rev()</code>関数が便利です。<code>Q1</code>の水準を反転した変数を<code>Q1_R</code>という新しい列として追加し、水準を確認してみましょう。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb286"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb286-1"><a href="#cb286-1"></a>df4 <span class="ot">&lt;-</span> df4 <span class="sc">%&gt;%</span></span>
<span id="cb286-2"><a href="#cb286-2"></a>  <span class="fu">mutate</span>(<span class="at">Q1_R =</span> <span class="fu">fct_rev</span>(Q1))</span>
<span id="cb286-3"><a href="#cb286-3"></a></span>
<span id="cb286-4"><a href="#cb286-4"></a>df4</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 10 × 3
      ID Q1                           Q1_R                        
   &lt;int&gt; &lt;fct&gt;                        &lt;fct&gt;                       
 1     1 そう思う                     そう思う                    
 2     2 そう思わない                 そう思わない                
 3     3 どちらとも言えない           どちらとも言えない          
 4     4 どちらかと言えばそう思う     どちらかと言えばそう思う    
 5     5 答えたくない                 答えたくない                
 6     6 どちらかと言えばそう思う     どちらかと言えばそう思う    
 7     7 どちらかと言えばそう思わない どちらかと言えばそう思わない
 8     8 答えたくない                 答えたくない                
 9     9 そう思わない                 そう思わない                
10    10 そう思う                     そう思う                    </code></pre>
</div>
<div class="sourceCode cell-code" id="cb288"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb288-1"><a href="#cb288-1"></a><span class="fu">levels</span>(df4<span class="sc">$</span>Q1_R)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "答えたくない"                 "そう思わない"                
[3] "どちらかと言えばそう思わない" "どちらとも言えない"          
[5] "どちらかと言えばそう思う"     "そう思う"                    </code></pre>
</div>
</div>
<p>　「答えたくない」が最初の順番に来ましてね。できれば、「そう思わない」〜「そう思う」、「答えたくない」の順番にしたいところです。ここで使うのが<code>fct_shift()</code>ですが、書き方がややこしいので、噛み砕いて解説します。</p>
<div class="sourceCode" id="cb290"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb290-1"><a href="#cb290-1" aria-hidden="true" tabindex="-1"></a><span class="co"># fct_shift()の使い方</span></span>
<span id="cb290-2"><a href="#cb290-2" aria-hidden="true" tabindex="-1"></a>データ名 <span class="sc">%&gt;%</span></span>
<span id="cb290-3"><a href="#cb290-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(新しい変数名 <span class="ot">=</span> <span class="fu">fct_shift</span>(元の変数名, <span class="at">n =</span> 左方向へずらす個数))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>　問題は<code>n =</code>引数ですが、その挙動については以下の表を参照してください。</p>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">

<div id="aiuwqsjxyn" style="overflow-x:auto;overflow-y:auto;width:auto;height:auto;">
<style>html {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Helvetica Neue', 'Fira Sans', 'Droid Sans', Arial, sans-serif;
}

#aiuwqsjxyn .gt_table {
  display: table;
  border-collapse: collapse;
  margin-left: auto;
  margin-right: auto;
  color: #333333;
  font-size: 16px;
  font-weight: normal;
  font-style: normal;
  background-color: #FFFFFF;
  width: auto;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #A8A8A8;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #A8A8A8;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
}

#aiuwqsjxyn .gt_heading {
  background-color: #FFFFFF;
  text-align: center;
  border-bottom-color: #FFFFFF;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#aiuwqsjxyn .gt_title {
  color: #333333;
  font-size: 125%;
  font-weight: initial;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-color: #FFFFFF;
  border-bottom-width: 0;
}

#aiuwqsjxyn .gt_subtitle {
  color: #333333;
  font-size: 85%;
  font-weight: initial;
  padding-top: 0;
  padding-bottom: 6px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-color: #FFFFFF;
  border-top-width: 0;
}

#aiuwqsjxyn .gt_bottom_border {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#aiuwqsjxyn .gt_col_headings {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#aiuwqsjxyn .gt_col_heading {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 6px;
  padding-left: 5px;
  padding-right: 5px;
  overflow-x: hidden;
}

#aiuwqsjxyn .gt_column_spanner_outer {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  padding-top: 0;
  padding-bottom: 0;
  padding-left: 4px;
  padding-right: 4px;
}

#aiuwqsjxyn .gt_column_spanner_outer:first-child {
  padding-left: 0;
}

#aiuwqsjxyn .gt_column_spanner_outer:last-child {
  padding-right: 0;
}

#aiuwqsjxyn .gt_column_spanner {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 5px;
  overflow-x: hidden;
  display: inline-block;
  width: 100%;
}

#aiuwqsjxyn .gt_group_heading {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
}

#aiuwqsjxyn .gt_empty_group_heading {
  padding: 0.5px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: middle;
}

#aiuwqsjxyn .gt_from_md > :first-child {
  margin-top: 0;
}

#aiuwqsjxyn .gt_from_md > :last-child {
  margin-bottom: 0;
}

#aiuwqsjxyn .gt_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  margin: 10px;
  border-top-style: solid;
  border-top-width: 1px;
  border-top-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  overflow-x: hidden;
}

#aiuwqsjxyn .gt_stub {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 5px;
  padding-right: 5px;
}

#aiuwqsjxyn .gt_stub_row_group {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 5px;
  padding-right: 5px;
  vertical-align: top;
}

#aiuwqsjxyn .gt_row_group_first td {
  border-top-width: 2px;
}

#aiuwqsjxyn .gt_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#aiuwqsjxyn .gt_first_summary_row {
  border-top-style: solid;
  border-top-color: #D3D3D3;
}

#aiuwqsjxyn .gt_first_summary_row.thick {
  border-top-width: 2px;
}

#aiuwqsjxyn .gt_last_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#aiuwqsjxyn .gt_grand_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#aiuwqsjxyn .gt_first_grand_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-style: double;
  border-top-width: 6px;
  border-top-color: #D3D3D3;
}

#aiuwqsjxyn .gt_striped {
  background-color: rgba(128, 128, 128, 0.05);
}

#aiuwqsjxyn .gt_table_body {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#aiuwqsjxyn .gt_footnotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#aiuwqsjxyn .gt_footnote {
  margin: 0px;
  font-size: 90%;
  padding-left: 4px;
  padding-right: 4px;
  padding-left: 5px;
  padding-right: 5px;
}

#aiuwqsjxyn .gt_sourcenotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#aiuwqsjxyn .gt_sourcenote {
  font-size: 90%;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
}

#aiuwqsjxyn .gt_left {
  text-align: left;
}

#aiuwqsjxyn .gt_center {
  text-align: center;
}

#aiuwqsjxyn .gt_right {
  text-align: right;
  font-variant-numeric: tabular-nums;
}

#aiuwqsjxyn .gt_font_normal {
  font-weight: normal;
}

#aiuwqsjxyn .gt_font_bold {
  font-weight: bold;
}

#aiuwqsjxyn .gt_font_italic {
  font-style: italic;
}

#aiuwqsjxyn .gt_super {
  font-size: 65%;
}

#aiuwqsjxyn .gt_two_val_uncert {
  display: inline-block;
  line-height: 1em;
  text-align: right;
  font-size: 60%;
  vertical-align: -0.25em;
  margin-left: 0.1em;
}

#aiuwqsjxyn .gt_footnote_marks {
  font-style: italic;
  font-weight: normal;
  font-size: 75%;
  vertical-align: 0.4em;
}

#aiuwqsjxyn .gt_asterisk {
  font-size: 100%;
  vertical-align: 0;
}

#aiuwqsjxyn .gt_slash_mark {
  font-size: 0.7em;
  line-height: 0.7em;
  vertical-align: 0.15em;
}

#aiuwqsjxyn .gt_fraction_numerator {
  font-size: 0.6em;
  line-height: 0.6em;
  vertical-align: 0.45em;
}

#aiuwqsjxyn .gt_fraction_denominator {
  font-size: 0.6em;
  line-height: 0.6em;
  vertical-align: -0.05em;
}
</style>
<table class="gt_table">
  
  <thead class="gt_col_headings">
    <tr>
      <th class="gt_col_heading gt_columns_bottom_border gt_left" rowspan="1" colspan="1"></th>
      <th class="gt_col_heading gt_columns_bottom_border gt_left" rowspan="1" colspan="1">1番目</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_left" rowspan="1" colspan="1">2番目</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_left" rowspan="1" colspan="1">3番目</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_left" rowspan="1" colspan="1">4番目</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_left" rowspan="1" colspan="1">5番目</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_left" rowspan="1" colspan="1">6番目</th>
    </tr>
  </thead>
  <tbody class="gt_table_body">
    <tr><td class="gt_row gt_left">n = -2</td>
<td class="gt_row gt_left">"E"</td>
<td class="gt_row gt_left">"F"</td>
<td class="gt_row gt_left">"A"</td>
<td class="gt_row gt_left">"B"</td>
<td class="gt_row gt_left">"C"</td>
<td class="gt_row gt_left">"D"</td></tr>
    <tr><td class="gt_row gt_left">n = -1</td>
<td class="gt_row gt_left">"F"</td>
<td class="gt_row gt_left">"A"</td>
<td class="gt_row gt_left">"B"</td>
<td class="gt_row gt_left">"C"</td>
<td class="gt_row gt_left">"D"</td>
<td class="gt_row gt_left">"E"</td></tr>
    <tr><td class="gt_row gt_left">n = 0 (初期状態)</td>
<td class="gt_row gt_left">"A"</td>
<td class="gt_row gt_left">"B"</td>
<td class="gt_row gt_left">"C"</td>
<td class="gt_row gt_left">"D"</td>
<td class="gt_row gt_left">"E"</td>
<td class="gt_row gt_left">"F"</td></tr>
    <tr><td class="gt_row gt_left">n = 1</td>
<td class="gt_row gt_left">"B"</td>
<td class="gt_row gt_left">"C"</td>
<td class="gt_row gt_left">"D"</td>
<td class="gt_row gt_left">"E"</td>
<td class="gt_row gt_left">"F"</td>
<td class="gt_row gt_left">"A"</td></tr>
    <tr><td class="gt_row gt_left">n = 2</td>
<td class="gt_row gt_left">"C"</td>
<td class="gt_row gt_left">"D"</td>
<td class="gt_row gt_left">"E"</td>
<td class="gt_row gt_left">"F"</td>
<td class="gt_row gt_left">"A"</td>
<td class="gt_row gt_left">"B"</td></tr>
  </tbody>
  
  
</table>
</div>
</div>
</div>
<p>　具体的には水準は左方向へ<code>n</code>個移動します。元の水準が<code>A</code>, <code>B</code>, <code>C</code>, …, <code>F</code>の順で、<code>n = 1</code>の場合、<code>A</code>が<code>F</code>の後ろへ移動し、<code>B</code>, <code>C</code>, <code>D</code>, <code>E</code>, <code>F</code>が前の方へ1つずつ移動します。逆に右側へ1つ移動したい場合は<code>n = -1</code>のように書きます。今回は最初の水準を最後に移動させたいので、<code>n = 1</code>と指定します。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb291"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb291-1"><a href="#cb291-1"></a>df4 <span class="ot">&lt;-</span> df4 <span class="sc">%&gt;%</span></span>
<span id="cb291-2"><a href="#cb291-2"></a>  <span class="co"># Q1_Rの水準を左方向で1ずらす</span></span>
<span id="cb291-3"><a href="#cb291-3"></a>  <span class="fu">mutate</span>(<span class="at">Q1_R =</span> <span class="fu">fct_shift</span>(Q1_R, <span class="at">n =</span> <span class="dv">1</span>))</span>
<span id="cb291-4"><a href="#cb291-4"></a></span>
<span id="cb291-5"><a href="#cb291-5"></a><span class="fu">levels</span>(df4<span class="sc">$</span>Q1_R)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "そう思わない"                 "どちらかと言えばそう思わない"
[3] "どちらとも言えない"           "どちらかと言えばそう思う"    
[5] "そう思う"                     "答えたくない"                </code></pre>
</div>
</div>
<p>　これで水準の反転が完了しました。<code>fct_shift()</code>はこのように世論調査データの処理に便利ですが、他にも曜日の処理に使えます。例えば、1週間の始まりを月曜にするか日曜にするかによって、<code>fct_shift()</code>を使うケースがあります。</p>
<p><strong><code>fct_shuffle()</code>: 水準の順番をランダム化する</strong></p>
<p>　あまり使わない機能ですが、水準の順番をランダム化することも可能です。使い方は非常に簡単で、<code>fct_shuffle()</code>に元の変数名を入れるだけです。たとえば、<code>Score_df</code>の<code>Pref</code>の順番をランダム化し、<code>Pref2</code>として追加します。同じことをもう2回繰り返し、それぞれ<code>Pref3</code>と<code>Pref4</code>という名前で追加してみましょう。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb293"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb293-1"><a href="#cb293-1"></a>Score_df <span class="ot">&lt;-</span> Score_df <span class="sc">%&gt;%</span></span>
<span id="cb293-2"><a href="#cb293-2"></a>  <span class="fu">mutate</span>(<span class="at">Pref2 =</span> <span class="fu">fct_shuffle</span>(Pref),</span>
<span id="cb293-3"><a href="#cb293-3"></a>         <span class="at">Pref3 =</span> <span class="fu">fct_shuffle</span>(Pref),</span>
<span id="cb293-4"><a href="#cb293-4"></a>         <span class="at">Pref4 =</span> <span class="fu">fct_shuffle</span>(Pref))</span>
<span id="cb293-5"><a href="#cb293-5"></a></span>
<span id="cb293-6"><a href="#cb293-6"></a>Score_df</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 9 × 5
  Pref     Score Pref2    Pref3    Pref4   
  &lt;chr&gt;    &lt;dbl&gt; &lt;fct&gt;    &lt;fct&gt;    &lt;fct&gt;   
1 京都府    3.68 京都府   京都府   京都府  
2 兵庫県    3.54 兵庫県   兵庫県   兵庫県  
3 千葉県    3.72 千葉県   千葉県   千葉県  
4 和歌山県  3.97 和歌山県 和歌山県 和歌山県
5 埼玉県    3.64 埼玉県   埼玉県   埼玉県  
6 大阪府    3.77 大阪府   大阪府   大阪府  
7 奈良県    3.85 奈良県   奈良県   奈良県  
8 東京都    3.67 東京都   東京都   東京都  
9 神奈川県  3.53 神奈川県 神奈川県 神奈川県</code></pre>
</div>
<div class="sourceCode cell-code" id="cb295"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb295-1"><a href="#cb295-1"></a><span class="fu">levels</span>(Score_df<span class="sc">$</span>Pref2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "埼玉県"   "兵庫県"   "東京都"   "奈良県"   "京都府"   "和歌山県" "千葉県"  
[8] "神奈川県" "大阪府"  </code></pre>
</div>
<div class="sourceCode cell-code" id="cb297"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb297-1"><a href="#cb297-1"></a><span class="fu">levels</span>(Score_df<span class="sc">$</span>Pref3)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "和歌山県" "兵庫県"   "京都府"   "神奈川県" "大阪府"   "東京都"   "埼玉県"  
[8] "千葉県"   "奈良県"  </code></pre>
</div>
<div class="sourceCode cell-code" id="cb299"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb299-1"><a href="#cb299-1"></a><span class="fu">levels</span>(Score_df<span class="sc">$</span>Pref4)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "大阪府"   "奈良県"   "埼玉県"   "兵庫県"   "東京都"   "京都府"   "神奈川県"
[8] "和歌山県" "千葉県"  </code></pre>
</div>
</div>
<p>　<code>Pref</code>から<code>Pref4</code>まで同じように見えますが、水準の順番が異なります (<code>Pref</code>はcharacter型だから水準がありません)。</p>
<p><strong><code>fct_reorder()</code>: 別の1変数の値を基準に水準の順番を変更する</strong></p>
<p>　<code>fct_infreq()</code>は出現頻度順に並び替える関数でしたが、それと似たような関数として<code>fct_reorder()</code>があります。ただし、これは出現頻度を基準にするのではなく、ある変数の平均値が低い順、中央値が高い順などでソートされます。まずは使い方から確認します。</p>
<div class="sourceCode" id="cb301"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb301-1"><a href="#cb301-1" aria-hidden="true" tabindex="-1"></a>データ名 <span class="sc">%&gt;%</span></span>
<span id="cb301-2"><a href="#cb301-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(新しい変数名 <span class="ot">=</span> <span class="fu">fct_reorder</span>(元の変数名, 基準となる変数, </span>
<span id="cb301-3"><a href="#cb301-3" aria-hidden="true" tabindex="-1"></a>                                   関数名, 関数の引数))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>　必要な引数が多いですね。解説よりも実際の例を見ながら説明します。今回も<code>Pref</code>をfactor変数にし、<code>Pref_R</code>という列で格納しますが、平均予算が安い順でfactorの水準を決めたいと思います。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb302"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb302-1"><a href="#cb302-1"></a>df <span class="ot">&lt;-</span> df <span class="sc">%&gt;%</span></span>
<span id="cb302-2"><a href="#cb302-2"></a>  <span class="fu">mutate</span>(<span class="at">Pref_R =</span> <span class="fu">fct_reorder</span>(Pref, Budget, mean, <span class="at">na.rm =</span> <span class="cn">TRUE</span>))</span>
<span id="cb302-3"><a href="#cb302-3"></a></span>
<span id="cb302-4"><a href="#cb302-4"></a><span class="fu">levels</span>(df<span class="sc">$</span>Pref_R)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "千葉県"   "埼玉県"   "奈良県"   "兵庫県"   "大阪府"   "神奈川県" "和歌山県"
[8] "東京都"   "京都府"  </code></pre>
</div>
</div>
<p>　<code>Pref_R</code>の水準は千葉県、埼玉県、奈良県、…の順ですが、本当にそうでしょうか。<code>group_by()</code>と<code>summarise()</code>などを使って確認してみましょう。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb304"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb304-1"><a href="#cb304-1"></a>df <span class="sc">%&gt;%</span> </span>
<span id="cb304-2"><a href="#cb304-2"></a>  <span class="fu">group_by</span>(Pref) <span class="sc">%&gt;%</span></span>
<span id="cb304-3"><a href="#cb304-3"></a>  <span class="fu">summarise</span>(<span class="at">Budget  =</span> <span class="fu">mean</span>(Budget, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb304-4"><a href="#cb304-4"></a>            <span class="at">.groups =</span> <span class="st">"drop"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb304-5"><a href="#cb304-5"></a>  <span class="fu">arrange</span>(Budget)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 9 × 2
  Pref     Budget
  &lt;chr&gt;     &lt;dbl&gt;
1 千葉県    1124.
2 埼玉県    1147.
3 奈良県    1169.
4 兵庫県    1197.
5 大阪府    1203.
6 神奈川県  1239.
7 和歌山県  1252 
8 東京都    1283.
9 京都府    1399.</code></pre>
</div>
</div>
<p>　問題なくソートされましたね。注意点としては<code>fct_reorder()</code>内に関数名を書く際、<code>()</code>は不要という点です。関数名の次の引数としてはその関数に別途必要な引数を指定します。引数が省略可能、あるいは不要な関数を使う場合は、省略しても構いませんし、数に制限はありません。</p>
<p>　また、低い順ではなく、高い順にすることも可能です。次は<code>Score</code>の中央値が高い順に水準を設定した<code>Pref_R2</code>を作ってみましょう。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb306"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb306-1"><a href="#cb306-1"></a>df <span class="ot">&lt;-</span> df <span class="sc">%&gt;%</span></span>
<span id="cb306-2"><a href="#cb306-2"></a>  <span class="fu">mutate</span>(<span class="at">Pref_R2 =</span> <span class="fu">fct_reorder</span>(Pref, Score, median, <span class="at">na.rm =</span> <span class="cn">TRUE</span>, <span class="at">.desc =</span> <span class="cn">TRUE</span>))</span>
<span id="cb306-3"><a href="#cb306-3"></a></span>
<span id="cb306-4"><a href="#cb306-4"></a><span class="fu">levels</span>(df<span class="sc">$</span>Pref_R2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "和歌山県" "奈良県"   "千葉県"   "大阪府"   "東京都"   "埼玉県"   "京都府"  
[8] "兵庫県"   "神奈川県"</code></pre>
</div>
</div>
<p>　変わったのは<code>mean</code>の代わりに<code>median</code>を使ったこと、そして<code>.desc</code>引数が追加された点です。<code>fct_reorder()</code>には<code>.desc = FALSE</code>がデフォルトとして指定されており、省略した場合は昇順でfactorの水準が決まります。ここで<code>.desc = TRUE</code>を指定すると、降順となります。実際、<code>Score</code>の中央値順になっているかを確認してみましょう。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb308"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb308-1"><a href="#cb308-1"></a>df <span class="sc">%&gt;%</span> </span>
<span id="cb308-2"><a href="#cb308-2"></a>  <span class="fu">group_by</span>(Pref) <span class="sc">%&gt;%</span></span>
<span id="cb308-3"><a href="#cb308-3"></a>  <span class="fu">summarise</span>(<span class="at">Score   =</span> <span class="fu">median</span>(Score, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb308-4"><a href="#cb308-4"></a>            <span class="at">.groups =</span> <span class="st">"drop"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb308-5"><a href="#cb308-5"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(Score))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 9 × 2
  Pref     Score
  &lt;chr&gt;    &lt;dbl&gt;
1 和歌山県  4   
2 奈良県    3.88
3 千葉県    3.75
4 大阪府    3.75
5 東京都    3.64
6 埼玉県    3.61
7 京都府    3.5 
8 兵庫県    3.5 
9 神奈川県  3.5 </code></pre>
</div>
</div>
<p><strong><code>fct_reorder2()</code>: 別の2変数の値を基準に水準の順番を変更する</strong></p>
<p>　この関数は別の変数を基準に水準が調整される点では<code>fct_reorder()</code>と類似しています。ただし、よく誤解されるのは「変数Aの値が同じなら変数Bを基準に…」といったものではありません。たとえば、<code>fct_reorder(x, y, mean)</code>の場合、<code>y</code>の平均値 (<code>mean()</code>)の順で<code>x</code>の水準を調整するという意味です。この<code>mean()</code>関数に必要なデータはベクトル1つです。しかし、関数によっては2つの変数が必要な場合があります。</p>
<p>　これは頻繁に直面する問題ではありませんが、この<code>fct_reorder2()</code>関数が活躍するケースを紹介します。以下は6月27日から7月1日までの5日間、5地域におけるCOVID-19新規感染者数を表したデータです<a href="#fn5" class="footnote-ref" id="fnref5" role="doc-noteref"><sup>5</sup></a>。入力が面倒な方は<a href="../Data/COVID19.csv">ここ</a>からダウンロードして読み込んでください。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb310"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb310-1"><a href="#cb310-1"></a><span class="co"># 入力が面倒ならデータをダウンロードし、</span></span>
<span id="cb310-2"><a href="#cb310-2"></a><span class="co"># Reorder2_df &lt;- read_csv("Data/COVID19.csv")</span></span>
<span id="cb310-3"><a href="#cb310-3"></a>Reorder2_df <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb310-4"><a href="#cb310-4"></a>  <span class="at">Country =</span> <span class="fu">rep</span>(<span class="fu">c</span>(<span class="st">"日本"</span>, <span class="st">"韓国"</span>, <span class="st">"中国 (本土)"</span>, <span class="st">"台湾"</span>, <span class="st">"香港"</span>),</span>
<span id="cb310-5"><a href="#cb310-5"></a>                <span class="at">each =</span> <span class="dv">5</span>),</span>
<span id="cb310-6"><a href="#cb310-6"></a>  <span class="at">Date    =</span> <span class="fu">rep</span>(<span class="fu">c</span>(<span class="st">"2020/06/27"</span>, <span class="st">"2020/06/28"</span>, <span class="st">"2020/06/29"</span>,</span>
<span id="cb310-7"><a href="#cb310-7"></a>                  <span class="st">"2020/06/30"</span>, <span class="st">"2020/07/01"</span>), <span class="dv">5</span>),</span>
<span id="cb310-8"><a href="#cb310-8"></a>  <span class="at">NewPat  =</span> <span class="fu">c</span>(<span class="dv">100</span>, <span class="dv">93</span>, <span class="dv">86</span>, <span class="dv">117</span>, <span class="dv">130</span>, </span>
<span id="cb310-9"><a href="#cb310-9"></a>               <span class="dv">62</span>, <span class="dv">42</span>, <span class="dv">43</span>,  <span class="dv">50</span>,  <span class="dv">54</span>,</span>
<span id="cb310-10"><a href="#cb310-10"></a>               <span class="dv">17</span>, <span class="dv">12</span>, <span class="dv">19</span>,   <span class="dv">3</span>,   <span class="dv">5</span>,</span>
<span id="cb310-11"><a href="#cb310-11"></a>                <span class="dv">0</span>,  <span class="dv">0</span>,  <span class="dv">0</span>,   <span class="dv">0</span>,   <span class="dv">0</span>,</span>
<span id="cb310-12"><a href="#cb310-12"></a>                <span class="dv">1</span>,  <span class="dv">2</span>,  <span class="dv">4</span>,   <span class="dv">2</span>,  <span class="dv">28</span>)</span>
<span id="cb310-13"><a href="#cb310-13"></a>)</span>
<span id="cb310-14"><a href="#cb310-14"></a></span>
<span id="cb310-15"><a href="#cb310-15"></a>Reorder2_df <span class="ot">&lt;-</span> Reorder2_df <span class="sc">%&gt;%</span></span>
<span id="cb310-16"><a href="#cb310-16"></a>  <span class="fu">mutate</span>(<span class="at">Date =</span> <span class="fu">as.Date</span>(Date))</span>
<span id="cb310-17"><a href="#cb310-17"></a></span>
<span id="cb310-18"><a href="#cb310-18"></a>Reorder2_df</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 25 × 3
   Country Date       NewPat
   &lt;chr&gt;   &lt;date&gt;      &lt;dbl&gt;
 1 日本    2020-06-27    100
 2 日本    2020-06-28     93
 3 日本    2020-06-29     86
 4 日本    2020-06-30    117
 5 日本    2020-07-01    130
 6 韓国    2020-06-27     62
 7 韓国    2020-06-28     42
 8 韓国    2020-06-29     43
 9 韓国    2020-06-30     50
10 韓国    2020-07-01     54
# … with 15 more rows</code></pre>
</div>
</div>
<p>　可視化のコードはとりあえず無視し、グラフを出力してみましょう。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb312"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb312-1"><a href="#cb312-1"></a>Reorder2_df <span class="sc">%&gt;%</span></span>
<span id="cb312-2"><a href="#cb312-2"></a>  <span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb312-3"><a href="#cb312-3"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">x =</span> Date, <span class="at">y =</span> NewPat, <span class="at">color =</span> Country),</span>
<span id="cb312-4"><a href="#cb312-4"></a>            <span class="at">size =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb312-5"><a href="#cb312-5"></a>  <span class="fu">scale_x_date</span>(<span class="at">date_labels =</span> <span class="st">"%Y年%m月%d日"</span>) <span class="sc">+</span></span>
<span id="cb312-6"><a href="#cb312-6"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"年月日"</span>, <span class="at">y =</span> <span class="st">"新規感染者数 (人)"</span>, <span class="at">color =</span> <span class="st">""</span>) <span class="sc">+</span></span>
<span id="cb312-7"><a href="#cb312-7"></a>  <span class="fu">theme_gray</span>(<span class="at">base_family =</span> <span class="st">"HiraKakuProN-W3"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="dplyr_intro_files/figure-html/unnamed-chunk-134-1.png" class="img-fluid figure-img" width="2100"></p>
</figure>
</div>
</div>
</div>
<p>　このグラフに違和感はあまりありませんが、「読みやすさ」の麺では改善の余地があります。たとえば、7月1日の時点で、新規感染者数が多いのは日本、韓国、香港、中国 (本土)、台湾の順です。しかし、右側の凡例の順番はそうではありません。この順番が一致すれば、更に図は読みやすくなるでしょう。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb313"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb313-1"><a href="#cb313-1"></a><span class="fu">factor</span>(Reorder2_df<span class="sc">$</span>Country)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> [1] 日本        日本        日本        日本        日本        韓国       
 [7] 韓国        韓国        韓国        韓国        中国 (本土) 中国 (本土)
[13] 中国 (本土) 中国 (本土) 中国 (本土) 台湾        台湾        台湾       
[19] 台湾        台湾        香港        香港        香港        香港       
[25] 香港       
Levels: 中国 (本土) 台湾 日本 韓国 香港</code></pre>
</div>
</div>
<p>　実際、何も指定せずに<code>Reorder2_df</code>の<code>Country</code>をfactor化すると、韓国、香港、台湾、…の順であり、これは上のグラフと一致します。これをグラフにおける7月1日の新規感染者数の順で並べるためには、<code>Date</code>を昇順にソートし、そして最後の要素 (<code>"2020/07/01"</code>)内で新規感染者数 (<code>NewPat</code>)を降順に並べ替えた場合の順番にする必要があります。実際、<code>Reorder2_df</code>を<code>Date</code>で昇順、<code>NewPat</code>で降順にソートし、最後の5行を抽出した結果が以下のコードです。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb315"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb315-1"><a href="#cb315-1"></a>Reorder2_df <span class="sc">%&gt;%</span></span>
<span id="cb315-2"><a href="#cb315-2"></a>  <span class="fu">arrange</span>(Date, <span class="fu">desc</span>(NewPat)) <span class="sc">%&gt;%</span></span>
<span id="cb315-3"><a href="#cb315-3"></a>  <span class="fu">slice_tail</span>(<span class="at">n =</span> <span class="dv">5</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 5 × 3
  Country     Date       NewPat
  &lt;chr&gt;       &lt;date&gt;      &lt;dbl&gt;
1 日本        2020-07-01    130
2 韓国        2020-07-01     54
3 香港        2020-07-01     28
4 中国 (本土) 2020-07-01      5
5 台湾        2020-07-01      0</code></pre>
</div>
</div>
<p>　このように、水準を調整する際に2つの変数 (<code>Date</code>と<code>NewPat</code>)が使用されます。<code>fct_reorder2()</code>は<code>fct_reorder()</code>と買い方がほぼ同じですが、基準となる変数がもう一つ加わります。</p>
<div class="sourceCode" id="cb317"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb317-1"><a href="#cb317-1" aria-hidden="true" tabindex="-1"></a>データ名 <span class="sc">%&gt;%</span></span>
<span id="cb317-2"><a href="#cb317-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(新しい変数名 <span class="ot">=</span> <span class="fu">fct_reorder2</span>(元の変数名, </span>
<span id="cb317-3"><a href="#cb317-3" aria-hidden="true" tabindex="-1"></a>                                    基準となる変数1, 基準となる変数2,</span>
<span id="cb317-4"><a href="#cb317-4" aria-hidden="true" tabindex="-1"></a>                                    関数名, 関数の引数))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>　重要なのはここの関数のところですが、<code>fct_reorder2()</code>はデフォルトで<code>last2()</code>という関数が指定されており、まさに私たちに必要な関数です。したがって、ここでは関数名も省略できますが、ここでは一応明記しておきます。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb318"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb318-1"><a href="#cb318-1"></a>Reorder2_df <span class="ot">&lt;-</span> Reorder2_df <span class="sc">%&gt;%</span></span>
<span id="cb318-2"><a href="#cb318-2"></a>  <span class="fu">mutate</span>(<span class="at">Country2 =</span> <span class="fu">fct_reorder2</span>(Country, Date, NewPat, last2)) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>　それでは新しく出来た<code>Country2</code>の水準を確認してみましょう。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb319"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb319-1"><a href="#cb319-1"></a><span class="fu">levels</span>(Reorder2_df<span class="sc">$</span>Country2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "日本"        "韓国"        "香港"        "中国 (本土)" "台湾"       </code></pre>
</div>
</div>
<p>　ちゃんと7月1日の新規感染者数基準で水準の順番が調整されましたので、これを使ってグラフをもう一回作ってみます。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb321"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb321-1"><a href="#cb321-1"></a>Reorder2_df <span class="sc">%&gt;%</span></span>
<span id="cb321-2"><a href="#cb321-2"></a>  <span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb321-3"><a href="#cb321-3"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">x =</span> Date, <span class="at">y =</span> NewPat, <span class="at">color =</span> Country2),</span>
<span id="cb321-4"><a href="#cb321-4"></a>            <span class="at">size =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb321-5"><a href="#cb321-5"></a>  <span class="fu">scale_x_date</span>(<span class="at">date_labels =</span> <span class="st">"%Y年%m月%d日"</span>) <span class="sc">+</span></span>
<span id="cb321-6"><a href="#cb321-6"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"年月日"</span>, <span class="at">y =</span> <span class="st">"新規感染者数 (人)"</span>, <span class="at">color =</span> <span class="st">""</span>) <span class="sc">+</span></span>
<span id="cb321-7"><a href="#cb321-7"></a>  <span class="fu">theme_gray</span>(<span class="at">base_family =</span> <span class="st">"HiraKakuProN-W3"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="dplyr_intro_files/figure-html/unnamed-chunk-139-1.png" class="img-fluid figure-img" width="2100"></p>
</figure>
</div>
</div>
</div>
<p>　これで図がさらに読みやすくなりました。ちなみに、{forcats}パッケージは<code>last2()</code>以外にも<code>first2()</code>という関数も提供しております。これを使うと、7月1日でなく、6月27日の新規感染者数の降順で水準の順番が調整されます。他にも引数を2つ使用する自作関数も使えますが、<code>fct_reorder2()</code>の主な使いみちは<code>last2()</code>で十分でしょう。</p>
<p><strong><code>fct_collapse()</code>: 水準を統合する</strong></p>
<p>　水準数をより水準数に減らすためには、<code>fct_recode()</code>を使います。先ほど、<code>fct_shift()</code>で使った<code>df4</code>の例を考えてみましょう。<code>df4</code>の<code>Q1</code>の水準数は6つです。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb322"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb322-1"><a href="#cb322-1"></a><span class="fu">levels</span>(df4<span class="sc">$</span>Q1)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "そう思う"                     "どちらかと言えばそう思う"    
[3] "どちらとも言えない"           "どちらかと言えばそう思わない"
[5] "そう思わない"                 "答えたくない"                </code></pre>
</div>
</div>
<p>　これを4つに減らして見ましょう。具体的には「そう思う」と「どちらかと言えばそう思う」を「そう思う」に、「そう思わない」と「どちらかと言えばそう思わない」を「そう思わない」に統合します。これを<code>fct_recode()</code>で処理したのが以下のコードです。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb324"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb324-1"><a href="#cb324-1"></a><span class="co"># fct_recode()を使った例</span></span>
<span id="cb324-2"><a href="#cb324-2"></a>df4 <span class="ot">&lt;-</span> df4 <span class="sc">%&gt;%</span> </span>
<span id="cb324-3"><a href="#cb324-3"></a>    <span class="fu">mutate</span>(<span class="at">Q1_R2 =</span> <span class="fu">fct_recode</span>(Q1,</span>
<span id="cb324-4"><a href="#cb324-4"></a>                              そう思う          <span class="ot">=</span> <span class="st">"そう思う"</span>,</span>
<span id="cb324-5"><a href="#cb324-5"></a>                              そう思う          <span class="ot">=</span> <span class="st">"どちらかと言えばそう思う"</span>,</span>
<span id="cb324-6"><a href="#cb324-6"></a>                              どちらとも言えない  <span class="ot">=</span> <span class="st">"どちらとも言えない"</span>,</span>
<span id="cb324-7"><a href="#cb324-7"></a>                              そう思わない       <span class="ot">=</span> <span class="st">"どちらかと言えばそう思わない"</span>,</span>
<span id="cb324-8"><a href="#cb324-8"></a>                              そう思わない       <span class="ot">=</span> <span class="st">"そう思わない"</span>,</span>
<span id="cb324-9"><a href="#cb324-9"></a>                              答えたくない       <span class="ot">=</span> <span class="st">"答えたくない"</span>))</span>
<span id="cb324-10"><a href="#cb324-10"></a></span>
<span id="cb324-11"><a href="#cb324-11"></a>df4</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 10 × 4
      ID Q1                           Q1_R                         Q1_R2        
   &lt;int&gt; &lt;fct&gt;                        &lt;fct&gt;                        &lt;fct&gt;        
 1     1 そう思う                     そう思う                     そう思う     
 2     2 そう思わない                 そう思わない                 そう思わない 
 3     3 どちらとも言えない           どちらとも言えない           どちらとも言…
 4     4 どちらかと言えばそう思う     どちらかと言えばそう思う     そう思う     
 5     5 答えたくない                 答えたくない                 答えたくない 
 6     6 どちらかと言えばそう思う     どちらかと言えばそう思う     そう思う     
 7     7 どちらかと言えばそう思わない どちらかと言えばそう思わない そう思わない 
 8     8 答えたくない                 答えたくない                 答えたくない 
 9     9 そう思わない                 そう思わない                 そう思わない 
10    10 そう思う                     そう思う                     そう思う     </code></pre>
</div>
<div class="sourceCode cell-code" id="cb326"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb326-1"><a href="#cb326-1"></a><span class="fu">levels</span>(df4<span class="sc">$</span>Q1_R2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "そう思う"           "どちらとも言えない" "そう思わない"      
[4] "答えたくない"      </code></pre>
</div>
</div>
<p>　しかし、水準を統合するに特化した<code>fct_collapse()</code>を使えばより便利です。使い方は、<code>fct_recode()</code>に非常に似ているため省略しますが、<code>=</code>の右側を<code>c()</code>でまとめることが出来ます。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb328"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb328-1"><a href="#cb328-1"></a><span class="co"># fct_collapse()を使った例</span></span>
<span id="cb328-2"><a href="#cb328-2"></a>df4 <span class="ot">&lt;-</span> df4 <span class="sc">%&gt;%</span> </span>
<span id="cb328-3"><a href="#cb328-3"></a>    <span class="fu">mutate</span>(<span class="at">Q1_R3 =</span> <span class="fu">fct_collapse</span>(Q1,</span>
<span id="cb328-4"><a href="#cb328-4"></a>                                そう思う <span class="ot">=</span> <span class="fu">c</span>(<span class="st">"そう思う"</span>, <span class="st">"どちらかと言えばそう思う"</span>),</span>
<span id="cb328-5"><a href="#cb328-5"></a>                                どちらとも言えない <span class="ot">=</span> <span class="st">"どちらとも言えない"</span>,</span>
<span id="cb328-6"><a href="#cb328-6"></a>                                そう思わない <span class="ot">=</span> <span class="fu">c</span>( <span class="st">"どちらかと言えばそう思わない"</span>, <span class="st">"そう思わない"</span>),</span>
<span id="cb328-7"><a href="#cb328-7"></a>                                答えたくない <span class="ot">=</span> <span class="st">"答えたくない"</span>))</span>
<span id="cb328-8"><a href="#cb328-8"></a></span>
<span id="cb328-9"><a href="#cb328-9"></a>df4</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 10 × 5
      ID Q1                           Q1_R                         Q1_R2   Q1_R3
   &lt;int&gt; &lt;fct&gt;                        &lt;fct&gt;                        &lt;fct&gt;   &lt;fct&gt;
 1     1 そう思う                     そう思う                     そう思… そう…
 2     2 そう思わない                 そう思わない                 そう思… そう…
 3     3 どちらとも言えない           どちらとも言えない           どちら… どち…
 4     4 どちらかと言えばそう思う     どちらかと言えばそう思う     そう思… そう…
 5     5 答えたくない                 答えたくない                 答えた… 答え…
 6     6 どちらかと言えばそう思う     どちらかと言えばそう思う     そう思… そう…
 7     7 どちらかと言えばそう思わない どちらかと言えばそう思わない そう思… そう…
 8     8 答えたくない                 答えたくない                 答えた… 答え…
 9     9 そう思わない                 そう思わない                 そう思… そう…
10    10 そう思う                     そう思う                     そう思… そう…</code></pre>
</div>
<div class="sourceCode cell-code" id="cb330"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb330-1"><a href="#cb330-1"></a><span class="fu">levels</span>(df4<span class="sc">$</span>Q1_R3)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "そう思う"           "どちらとも言えない" "そう思わない"      
[4] "答えたくない"      </code></pre>
</div>
</div>
<p>　<code>fct_recode()</code>の結果と同じ結果が得られました。元の水準数や、減らされる水準数などによっては書く手間があまり変わらないので、好きな方を使っても良いでしょう。</p>
<p><strong><code>fct_drop()</code>: 使われていない水準を除去する</strong></p>
<p>　水準としては存在するものの、データとしては存在しないケースもあります。これをここでは「空水準 (empty levels)」と呼びます。たとえば、以下のコードは<code>Pref</code>をfactor化してから<code>Pref == "奈良県"</code>のケースを落としたものです。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb332"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb332-1"><a href="#cb332-1"></a>Score_df_f2 <span class="ot">&lt;-</span> df <span class="sc">%&gt;%</span></span>
<span id="cb332-2"><a href="#cb332-2"></a>  <span class="fu">mutate</span>(<span class="at">Pref =</span> <span class="fu">fct_inorder</span>(Pref)) <span class="sc">%&gt;%</span></span>
<span id="cb332-3"><a href="#cb332-3"></a>  <span class="fu">filter</span>(Pref <span class="sc">!=</span> <span class="st">"奈良県"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb332-4"><a href="#cb332-4"></a>  <span class="fu">group_by</span>(Pref) <span class="sc">%&gt;%</span></span>
<span id="cb332-5"><a href="#cb332-5"></a>  <span class="fu">summarise</span>(<span class="at">Score   =</span> <span class="fu">mean</span>(Score, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb332-6"><a href="#cb332-6"></a>            <span class="at">.groups =</span> <span class="st">"drop"</span>)</span>
<span id="cb332-7"><a href="#cb332-7"></a></span>
<span id="cb332-8"><a href="#cb332-8"></a>Score_df_f2</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 8 × 2
  Pref     Score
  &lt;fct&gt;    &lt;dbl&gt;
1 東京都    3.67
2 神奈川県  3.53
3 千葉県    3.72
4 埼玉県    3.64
5 大阪府    3.77
6 京都府    3.68
7 兵庫県    3.54
8 和歌山県  3.97</code></pre>
</div>
</div>
<p>　このように結果としては、奈良県のデータを除外したため空水準である奈良県は表示されませんが、<code>Pref</code>変数はどうでしょうか。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb334"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb334-1"><a href="#cb334-1"></a><span class="fu">levels</span>(Score_df_f2<span class="sc">$</span>Pref)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "東京都"   "神奈川県" "千葉県"   "埼玉県"   "大阪府"   "京都府"   "兵庫県"  
[8] "奈良県"   "和歌山県"</code></pre>
</div>
</div>
<p>　このように水準としては残っていることが分かります。使われていない水準が分析や可視化に影響を与えないケースもありますが、与えるケースもあります。これもこれまで勉強してきた<code>fct_*()</code>関数群で対応可能ですが、<code>fct_drop()</code>関数を使えば一発で終わります。実際にやってみましょう。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb336"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb336-1"><a href="#cb336-1"></a>Score_df_f2 <span class="ot">&lt;-</span> Score_df_f2 <span class="sc">%&gt;%</span></span>
<span id="cb336-2"><a href="#cb336-2"></a>  <span class="fu">mutate</span>(<span class="at">Pref =</span> <span class="fu">fct_drop</span>(Pref))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb337"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb337-1"><a href="#cb337-1"></a><span class="fu">levels</span>(Score_df_f2<span class="sc">$</span>Pref)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "東京都"   "神奈川県" "千葉県"   "埼玉県"   "大阪府"   "京都府"   "兵庫県"  
[8] "和歌山県"</code></pre>
</div>
</div>
<p>　水準から奈良県が消えました。同じ機能をする関数としてはR内蔵関数である<code>droplevels()</code>関数があり、使い方は<code>fct_drop()</code>と同じです。</p>
<p><strong><code>fct_expand()</code>: 水準を追加する</strong></p>
<p>　一方、空水準を追加することも可能です。<code>fct_expand()</code>関数には元の変数名に加え、追加する水準名を入れるだけです。たとえば、<code>df</code>の<code>Pref</code>の水準は関東と関西の9都府県名となっていますが、ここに<code>"滋賀県"</code>という水準を追加してみます。。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb339"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb339-1"><a href="#cb339-1"></a>df5 <span class="ot">&lt;-</span> df <span class="sc">%&gt;%</span></span>
<span id="cb339-2"><a href="#cb339-2"></a>  <span class="fu">mutate</span>(<span class="at">Pref =</span> <span class="fu">fct_expand</span>(Pref, <span class="st">"滋賀県"</span>))</span>
<span id="cb339-3"><a href="#cb339-3"></a></span>
<span id="cb339-4"><a href="#cb339-4"></a><span class="fu">levels</span>(df5<span class="sc">$</span>Pref)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> [1] "京都府"   "兵庫県"   "千葉県"   "和歌山県" "埼玉県"   "大阪府"  
 [7] "奈良県"   "東京都"   "神奈川県" "滋賀県"  </code></pre>
</div>
</div>
<p>　<code>"滋賀県"</code>という新しい水準が出来ましたね。ただし、新しく追加された水準は最後の順番になりますので、修正が必要な場合は<code>fct_relevel()</code>などを使って適宜修正してください。</p>
<p>　新しく水準が追加されることによって、何かの変化はあるでしょうか。まずは都府県ごとに<code>Score</code>の平均値とケース数を計算してみましょう。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb341"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb341-1"><a href="#cb341-1"></a>df5 <span class="sc">%&gt;%</span></span>
<span id="cb341-2"><a href="#cb341-2"></a>  <span class="fu">group_by</span>(Pref) <span class="sc">%&gt;%</span></span>
<span id="cb341-3"><a href="#cb341-3"></a>  <span class="fu">summarise</span>(<span class="at">Score   =</span> <span class="fu">mean</span>(Score, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb341-4"><a href="#cb341-4"></a>            <span class="at">N       =</span> <span class="fu">n</span>(),</span>
<span id="cb341-5"><a href="#cb341-5"></a>            <span class="at">.groups =</span> <span class="st">"drop"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 9 × 3
  Pref     Score     N
  &lt;fct&gt;    &lt;dbl&gt; &lt;int&gt;
1 京都府    3.68   414
2 兵庫県    3.54   591
3 千葉県    3.72  1000
4 和歌山県  3.97   140
5 埼玉県    3.64  1000
6 大阪府    3.77  1000
7 奈良県    3.85   147
8 東京都    3.67  1000
9 神奈川県  3.53  1000</code></pre>
</div>
</div>
<p>　見た目は全く変わらず、滋賀県の行が新しく出来たわけでもありません。{dplyr}の<code>group_by()</code>の場合、空水準はグループ化の対象になりません。一方、多くのR内蔵関数はケースとして存在しなくても計算の対象となります。たとえば、ベクトル内のある値が何個格納されているか確認する<code>table()</code>関数の例を見てみましょう。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb343"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb343-1"><a href="#cb343-1"></a><span class="fu">table</span>(df5<span class="sc">$</span>Pref)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
  京都府   兵庫県   千葉県 和歌山県   埼玉県   大阪府   奈良県   東京都 
     414      591     1000      140     1000     1000      147     1000 
神奈川県   滋賀県 
    1000        0 </code></pre>
</div>
</div>
<p>　<code>"滋賀県"</code>という列があり、合致するケースが0と表示されます。<code>group_by()</code>でも空の水準まで含めて出力する引数<code>.drop</code>があります。デフォルトは<code>TRUE</code>ですが、これを<code>FALSE</code>に指定してみます。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb345"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb345-1"><a href="#cb345-1"></a>df5 <span class="sc">%&gt;%</span></span>
<span id="cb345-2"><a href="#cb345-2"></a>  <span class="fu">group_by</span>(Pref, <span class="at">.drop =</span> <span class="cn">FALSE</span>) <span class="sc">%&gt;%</span></span>
<span id="cb345-3"><a href="#cb345-3"></a>  <span class="fu">summarise</span>(<span class="at">Score   =</span> <span class="fu">mean</span>(Score, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb345-4"><a href="#cb345-4"></a>            <span class="at">N       =</span> <span class="fu">n</span>(),</span>
<span id="cb345-5"><a href="#cb345-5"></a>            <span class="at">.groups =</span> <span class="st">"drop"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 10 × 3
   Pref      Score     N
   &lt;fct&gt;     &lt;dbl&gt; &lt;int&gt;
 1 京都府     3.68   414
 2 兵庫県     3.54   591
 3 千葉県     3.72  1000
 4 和歌山県   3.97   140
 5 埼玉県     3.64  1000
 6 大阪府     3.77  1000
 7 奈良県     3.85   147
 8 東京都     3.67  1000
 9 神奈川県   3.53  1000
10 滋賀県   NaN        0</code></pre>
</div>
</div>
<p>　空水準も出力され、<code>Score</code>の平均値は計算不可 (<code>NaN</code>)、ケース数は0という結果が得られました。</p>
<p><strong><code>fct_explicit_na()</code>: 欠損値に水準を与える</strong></p>
<p>　まずは、実習用データ<code>df6</code>を作ってみまます。<code>X1</code>はnumeric型変数ですが、これをfactor化します。最初から<code>tibble()</code>内でfactor化しておいても問題ありませんが、練習だと思ってください。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb347"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb347-1"><a href="#cb347-1"></a>df6 <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb347-2"><a href="#cb347-2"></a>  <span class="at">ID =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>,</span>
<span id="cb347-3"><a href="#cb347-3"></a>  <span class="at">X1 =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">3</span>, <span class="dv">2</span>, <span class="cn">NA</span>, <span class="dv">2</span>, <span class="dv">2</span>, <span class="dv">1</span>, <span class="cn">NA</span>, <span class="dv">3</span>, <span class="cn">NA</span>)</span>
<span id="cb347-4"><a href="#cb347-4"></a>)</span>
<span id="cb347-5"><a href="#cb347-5"></a></span>
<span id="cb347-6"><a href="#cb347-6"></a>df6 <span class="ot">&lt;-</span> df6 <span class="sc">%&gt;%</span></span>
<span id="cb347-7"><a href="#cb347-7"></a>  <span class="fu">mutate</span>(<span class="at">X1 =</span> <span class="fu">factor</span>(X1, </span>
<span id="cb347-8"><a href="#cb347-8"></a>                     <span class="at">levels =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>),</span>
<span id="cb347-9"><a href="#cb347-9"></a>                     <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"ラーメン"</span>, <span class="st">"うどん"</span>, <span class="st">"そば"</span>)))</span>
<span id="cb347-10"><a href="#cb347-10"></a></span>
<span id="cb347-11"><a href="#cb347-11"></a>df6</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 10 × 2
      ID X1      
   &lt;int&gt; &lt;fct&gt;   
 1     1 ラーメン
 2     2 そば    
 3     3 うどん  
 4     4 &lt;NA&gt;    
 5     5 うどん  
 6     6 うどん  
 7     7 ラーメン
 8     8 &lt;NA&gt;    
 9     9 そば    
10    10 &lt;NA&gt;    </code></pre>
</div>
</div>
<p>　それでは<code>X1</code>をグループ化変数とし、ケース数を計算してみましょう。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb349"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb349-1"><a href="#cb349-1"></a>df6 <span class="sc">%&gt;%</span></span>
<span id="cb349-2"><a href="#cb349-2"></a>  <span class="fu">group_by</span>(X1) <span class="sc">%&gt;%</span></span>
<span id="cb349-3"><a href="#cb349-3"></a>  <span class="fu">summarise</span>(<span class="at">N       =</span> <span class="fu">n</span>(),</span>
<span id="cb349-4"><a href="#cb349-4"></a>            <span class="at">.groups =</span> <span class="st">"drop"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 4 × 2
  X1           N
  &lt;fct&gt;    &lt;int&gt;
1 ラーメン     2
2 うどん       3
3 そば         2
4 &lt;NA&gt;         3</code></pre>
</div>
</div>
<p>　<code>NA</code>もグループ化の対象となります。以下はこの欠損値も一つの水準として指定する方法について紹介します。欠損値を欠損値のままにするケースが多いですが、欠損値が何らかの意味を持つ場合、分析の対象になります。たとえば、多項ロジスティック回帰の応答変数として「分からない/答えたくない」を含めたり、<a href="https://ci.nii.ac.jp/naid/40021269699">「分からない/答えたくない」を選択する要因を分析</a>したい場合は、欠損値に値を与える必要があります。なぜなら、一般的な分析において欠損値は分析対象から除外されるからです。</p>
<p>　まずは、これまで紹介した関数を使ったやり方から紹介します。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb351"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb351-1"><a href="#cb351-1"></a>df6 <span class="sc">%&gt;%</span></span>
<span id="cb351-2"><a href="#cb351-2"></a>         <span class="co"># まず、X1をcharacter型に変換し、X2という列に保存</span></span>
<span id="cb351-3"><a href="#cb351-3"></a>  <span class="fu">mutate</span>(<span class="at">X2 =</span> <span class="fu">as.character</span>(X1),</span>
<span id="cb351-4"><a href="#cb351-4"></a>         <span class="co"># X2がNAなら"欠損値"、それ以外なら元のX2の値に置換</span></span>
<span id="cb351-5"><a href="#cb351-5"></a>         <span class="at">X2 =</span> <span class="fu">ifelse</span>(<span class="fu">is.na</span>(X2), <span class="st">"欠損値"</span>, X2),</span>
<span id="cb351-6"><a href="#cb351-6"></a>         <span class="co"># X2を再度factor化する</span></span>
<span id="cb351-7"><a href="#cb351-7"></a>         <span class="at">X2 =</span> <span class="fu">factor</span>(X2, </span>
<span id="cb351-8"><a href="#cb351-8"></a>                     <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"ラーメン"</span>, <span class="st">"うどん"</span>, <span class="st">"そば"</span>, <span class="st">"欠損値"</span>)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 10 × 3
      ID X1       X2      
   &lt;int&gt; &lt;fct&gt;    &lt;fct&gt;   
 1     1 ラーメン ラーメン
 2     2 そば     そば    
 3     3 うどん   うどん  
 4     4 &lt;NA&gt;     欠損値  
 5     5 うどん   うどん  
 6     6 うどん   うどん  
 7     7 ラーメン ラーメン
 8     8 &lt;NA&gt;     欠損値  
 9     9 そば     そば    
10    10 &lt;NA&gt;     欠損値  </code></pre>
</div>
</div>
<p>　<code>X1</code>をcharacter型に戻す理由<a href="#fn6" class="footnote-ref" id="fnref6" role="doc-noteref"><sup>6</sup></a>は、水準にない値が入るとfactor化が解除されるからです。factor型をcharacter型に戻さずに<code>df6$X1</code>の<code>NA</code>を<code>"欠損値"</code>に置換すると、以下のようになります。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb353"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb353-1"><a href="#cb353-1"></a><span class="co"># df6のX1がNAなら"欠損"、それ以外なら元のX1の値を返す</span></span>
<span id="cb353-2"><a href="#cb353-2"></a><span class="fu">ifelse</span>(<span class="fu">is.na</span>(df6<span class="sc">$</span>X1), <span class="st">"欠損値"</span>, df6<span class="sc">$</span>X1)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> [1] "1"      "3"      "2"      "欠損値" "2"      "2"      "1"      "欠損値"
 [9] "3"      "欠損値"</code></pre>
</div>
</div>
<p>　<code>"ラーメン"</code>と<code>"うどん"</code>、<code>"そば"</code>がfactor化前の1, 2, 3に戻っただけでなく、<code>NA</code>が<code>"欠損値"</code>というcharacter型に置換されたため、全体がcharacter型に変換されました。このように欠損値に水準を与える作業は難しくはありませんが、面倒な作業です。そこで登場する関数が<code>fct_exlpicit_na()</code>関数です。使い方は、元の変数に加え、欠損値の水準名を指定する<code>na_level</code>です。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb355"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb355-1"><a href="#cb355-1"></a>df6 <span class="ot">&lt;-</span> df6 <span class="sc">%&gt;%</span></span>
<span id="cb355-2"><a href="#cb355-2"></a>  <span class="co"># na_levelのデフォルト値は"(Missing)"</span></span>
<span id="cb355-3"><a href="#cb355-3"></a>  <span class="fu">mutate</span>(<span class="at">X2 =</span> <span class="fu">fct_explicit_na</span>(X1, <span class="at">na_level =</span> <span class="st">"欠損値"</span>))</span>
<span id="cb355-4"><a href="#cb355-4"></a></span>
<span id="cb355-5"><a href="#cb355-5"></a>df6</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 10 × 3
      ID X1       X2      
   &lt;int&gt; &lt;fct&gt;    &lt;fct&gt;   
 1     1 ラーメン ラーメン
 2     2 そば     そば    
 3     3 うどん   うどん  
 4     4 &lt;NA&gt;     欠損値  
 5     5 うどん   うどん  
 6     6 うどん   うどん  
 7     7 ラーメン ラーメン
 8     8 &lt;NA&gt;     欠損値  
 9     9 そば     そば    
10    10 &lt;NA&gt;     欠損値  </code></pre>
</div>
</div>
<p>　欠損値が一つの水準になったことが分かります。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb357"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb357-1"><a href="#cb357-1"></a>df6 <span class="sc">%&gt;%</span></span>
<span id="cb357-2"><a href="#cb357-2"></a>  <span class="fu">group_by</span>(X2) <span class="sc">%&gt;%</span></span>
<span id="cb357-3"><a href="#cb357-3"></a>  <span class="fu">summarise</span>(<span class="at">N       =</span> <span class="fu">n</span>(),</span>
<span id="cb357-4"><a href="#cb357-4"></a>            <span class="at">.groups =</span> <span class="st">"drop"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 4 × 2
  X2           N
  &lt;fct&gt;    &lt;int&gt;
1 ラーメン     2
2 うどん       3
3 そば         2
4 欠損値       3</code></pre>
</div>
</div>
<p>　むろん、<code>group_by()</code>を使ってもちゃんと出力されます。</p>
</section>
</section>
<section id="行単位の操作" class="level2">
<h2 class="anchored" data-anchor-id="行単位の操作">行単位の操作</h2>
<p>　ここでは行単位の操作について考えたいと思います。<code>select()</code>の説明で使った<code>myDF1</code>を見てみましょう。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb359"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb359-1"><a href="#cb359-1"></a>myDF1</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 5 × 10
     ID    X1    Y1   X1D    X2    Y2   X2D    X3    Y3   X3D
  &lt;int&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;
1     1     2     3     4     5     3     8     3     1     9
2     2     4     5     2     5     3     9     0     5     1
3     3     6     1     1     6     2     5     3     9     3
4     4     2     1     6     0     3     0     0     1     3
5     5     7     0     9     2     1     1     2     3     8</code></pre>
</div>
</div>
<p>　ここで<code>X1</code>と<code>X2</code>と<code>X3</code>の平均値を計算し、<code>X_Mean</code>という名の変数にする場合、以下のような書き方が普通でしょう。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb361"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb361-1"><a href="#cb361-1"></a>myDF1 <span class="sc">%&gt;%</span></span>
<span id="cb361-2"><a href="#cb361-2"></a>  <span class="fu">mutate</span>(<span class="at">X_Mean =</span> <span class="fu">mean</span>(<span class="fu">c</span>(X1, X2, X3)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 5 × 11
     ID    X1    Y1   X1D    X2    Y2   X2D    X3    Y3   X3D X_Mean
  &lt;int&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt;
1     1     2     3     4     5     3     8     3     1     9   3.13
2     2     4     5     2     5     3     9     0     5     1   3.13
3     3     6     1     1     6     2     5     3     9     3   3.13
4     4     2     1     6     0     3     0     0     1     3   3.13
5     5     7     0     9     2     1     1     2     3     8   3.13</code></pre>
</div>
</div>
<p>　あらら、なんかおかしくありませんか。1行目の場合、<code>X1</code>と<code>X2</code>、<code>X3</code>それぞれ2、5、3であり、平均値は3.333であるはずなのに3.133になりました。これは2行目以降も同じです。なぜでしょうか。</p>
<p>　実は{dplyr}は行単位の計算が苦手です。実際、データフレーム (または、tibble)というのは既に説明したとおり、縦ベクトルを横に並べたものです。列をまたがる場合、データ型が異なる場合も多いため、そもそも使う場面も多くありません。したがって、以下のような書き方が必要でした。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb363"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb363-1"><a href="#cb363-1"></a>myDF1 <span class="sc">%&gt;%</span></span>
<span id="cb363-2"><a href="#cb363-2"></a>  <span class="fu">mutate</span>(<span class="at">X_Mean =</span> (X1 <span class="sc">+</span> X2 <span class="sc">+</span> X3) <span class="sc">/</span> <span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 5 × 11
     ID    X1    Y1   X1D    X2    Y2   X2D    X3    Y3   X3D X_Mean
  &lt;int&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt;
1     1     2     3     4     5     3     8     3     1     9  3.33 
2     2     4     5     2     5     3     9     0     5     1  3    
3     3     6     1     1     6     2     5     3     9     3  5    
4     4     2     1     6     0     3     0     0     1     3  0.667
5     5     7     0     9     2     1     1     2     3     8  3.67 </code></pre>
</div>
</div>
<p>　先ほどの<code>mean(c(X1, X2, X3))</code>は(<code>X1</code>列と<code>X2</code>列、<code>X3</code>列)の平均値です。<code>X1</code>は長さ1のベクトルではなく、その列全体を指すものです。つまり、<code>mean(c(X1, X2, X3))</code>は<code>mean(c(myD1F$X1, myDF1$X2, myDF1$X3))</code>と同じことになります。だから全て3.133という結果が得られました。ただし、後者はベクトル同士の加減乗除になるため問題ありません。実際<code>c(1, 2, 3) + c(3, 5, 0)</code>は同じ位置の要素同士の計算になります。</p>
<p>　ここで<code>mean()</code>関数を使う場合には全ての演算を、一行一行に分けて行う必要があります。ある一行のみに限定する場合、<code>mean(c(X1, X2, X3))</code>の<code>X1</code>などは長さ1のベクトルになるため、<code>(X1 + X2 + X3) / 3</code>と同じことになります。この「一行単位で処理を行う」ことを指定する関数が<code>rowwise()</code>関数です。これは行単位の作業を行う前に指定するだけです。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb365"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb365-1"><a href="#cb365-1"></a>myDF1 <span class="sc">%&gt;%</span></span>
<span id="cb365-2"><a href="#cb365-2"></a>  <span class="fu">rowwise</span>() <span class="sc">%&gt;%</span></span>
<span id="cb365-3"><a href="#cb365-3"></a>  <span class="fu">mutate</span>(<span class="at">X_Mean =</span> <span class="fu">mean</span>(<span class="fu">c</span>(X1, X2, X3)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 5 × 11
# Rowwise: 
     ID    X1    Y1   X1D    X2    Y2   X2D    X3    Y3   X3D X_Mean
  &lt;int&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt;
1     1     2     3     4     5     3     8     3     1     9  3.33 
2     2     4     5     2     5     3     9     0     5     1  3    
3     3     6     1     1     6     2     5     3     9     3  5    
4     4     2     1     6     0     3     0     0     1     3  0.667
5     5     7     0     9     2     1     1     2     3     8  3.67 </code></pre>
</div>
</div>
<p>　これで問題なく行単位の処理ができるようになりました。今回は変数が3つのみだったので、これで問題ありませんが、変数が多くなると<code>:</code>や<code>starts_with()</code>、<code>num_range()</code>などを使って変数を選択したくなります。この場合は計算する関数内に<code>c_across()</code>を入れます。ここでは<code>X1</code>列から<code>X3D</code>列までの平均値を求めてみましょう。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb367"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb367-1"><a href="#cb367-1"></a>myDF1 <span class="sc">%&gt;%</span></span>
<span id="cb367-2"><a href="#cb367-2"></a>  <span class="fu">rowwise</span>() <span class="sc">%&gt;%</span></span>
<span id="cb367-3"><a href="#cb367-3"></a>  <span class="fu">mutate</span>(<span class="at">X_Mean =</span> <span class="fu">mean</span>(X1<span class="sc">:</span>X3D))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 5 × 11
# Rowwise: 
     ID    X1    Y1   X1D    X2    Y2   X2D    X3    Y3   X3D X_Mean
  &lt;int&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt;
1     1     2     3     4     5     3     8     3     1     9    5.5
2     2     4     5     2     5     3     9     0     5     1    2.5
3     3     6     1     1     6     2     5     3     9     3    4.5
4     4     2     1     6     0     3     0     0     1     3    2.5
5     5     7     0     9     2     1     1     2     3     8    7.5</code></pre>
</div>
</div>
<p>　実は<code>rowwise()</code>関数、2020年6月に公開された{dplyr} 1.0.0で注目されるようになった関数ですが、昔の{dplyr}にも<code>rowwise()</code>関数はありました。ただし、{purrr}パッケージや{tidyr}パッケージの<code>nest()</code>関数などにより使い道がなくなりましたが、なぜか華麗に復活しました。データ分析に使うデータは基本単位は列であるため、実際に<code>rowwise()</code>が使われる場面は今の段階では多くないでしょう。また、簡単な作業なら<code>X1 + X2</code>のような演算でも対応できます。それでも、覚えておけば便利な関数であることには間違いありません。</p>
</section>
<section id="データの結合" class="level2">
<h2 class="anchored" data-anchor-id="データの結合">データの結合</h2>
<section id="行の結合" class="level3">
<h3 class="anchored" data-anchor-id="行の結合">行の結合</h3>
<p>　まずは、複数のデータフレームまたはtibbleを縦に結合する方法について解説します。イメージとしては <a href="#fig-merge-row">図&nbsp;9</a> のようなものです。</p>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div id="fig-merge-row" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="Figs/Handling1/Merge1.png" class="img-fluid figure-img" style="width:100.0%"></p>
<p></p><figcaption aria-hidden="true" class="figure-caption">図 9: 行の結合</figcaption><p></p>
</figure>
</div>
</div>
</div>
<p>　行を結合する際には{dplyr}パッケージの<code>bind_rows()</code>関数を使います。この関数の使い方は以下の通りです。</p>
<div class="sourceCode" id="cb369"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb369-1"><a href="#cb369-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 新しいデータ名ではなく、既にあるデータ名にすると上書きとなる</span></span>
<span id="cb369-2"><a href="#cb369-2" aria-hidden="true" tabindex="-1"></a>新しいデータ名 <span class="ot">&lt;-</span>  <span class="fu">bind_rows</span>(データ1, データ2, ...)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>　それでは早速実際に使ってみましょう。実習のために、4つのtibbleを作成します (tibbleでなくデータフレームでも問題ありません)。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb370"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb370-1"><a href="#cb370-1"></a><span class="co"># tibble()の代わりにdata.frame()も可</span></span>
<span id="cb370-2"><a href="#cb370-2"></a>rbind_df1 <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">X1 =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>,</span>
<span id="cb370-3"><a href="#cb370-3"></a>                    <span class="at">X2 =</span> <span class="fu">c</span>(<span class="st">"A"</span>, <span class="st">"B"</span>, <span class="st">"C"</span>),</span>
<span id="cb370-4"><a href="#cb370-4"></a>                    <span class="at">X3 =</span> <span class="fu">c</span>(T, T, F)) <span class="co"># TRUEとFALSEはTはFと省略可能</span></span>
<span id="cb370-5"><a href="#cb370-5"></a></span>
<span id="cb370-6"><a href="#cb370-6"></a>rbind_df2 <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">X1 =</span> <span class="dv">4</span><span class="sc">:</span><span class="dv">6</span>,</span>
<span id="cb370-7"><a href="#cb370-7"></a>                    <span class="at">X2 =</span> <span class="fu">c</span>(<span class="st">"D"</span>, <span class="st">"E"</span>, <span class="st">"F"</span>),</span>
<span id="cb370-8"><a href="#cb370-8"></a>                    <span class="at">X3 =</span> <span class="fu">c</span>(F, T, F))</span>
<span id="cb370-9"><a href="#cb370-9"></a></span>
<span id="cb370-10"><a href="#cb370-10"></a>rbind_df3 <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">X1 =</span> <span class="dv">7</span><span class="sc">:</span><span class="dv">9</span>,</span>
<span id="cb370-11"><a href="#cb370-11"></a>                    <span class="at">X3 =</span> <span class="fu">c</span>(T, T, T),</span>
<span id="cb370-12"><a href="#cb370-12"></a>                    <span class="at">X2 =</span> <span class="fu">c</span>(<span class="st">"G"</span>, <span class="st">"H"</span>, <span class="st">"I"</span>))</span>
<span id="cb370-13"><a href="#cb370-13"></a></span>
<span id="cb370-14"><a href="#cb370-14"></a>rbind_df4 <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">X1 =</span> <span class="dv">10</span><span class="sc">:</span><span class="dv">12</span>,</span>
<span id="cb370-15"><a href="#cb370-15"></a>                    <span class="at">X2 =</span> <span class="fu">c</span>(<span class="st">"J"</span>, <span class="st">"K"</span>, <span class="st">"L"</span>),</span>
<span id="cb370-16"><a href="#cb370-16"></a>                    <span class="at">X5 =</span> <span class="fu">c</span>(<span class="st">"Song"</span>, <span class="st">"Yanai"</span>, <span class="st">"Hadley"</span>))</span>
<span id="cb370-17"><a href="#cb370-17"></a></span>
<span id="cb370-18"><a href="#cb370-18"></a>rbind_df1 <span class="co"># rbind_df1を出力</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 3 × 3
     X1 X2    X3   
  &lt;int&gt; &lt;chr&gt; &lt;lgl&gt;
1     1 A     TRUE 
2     2 B     TRUE 
3     3 C     FALSE</code></pre>
</div>
<div class="sourceCode cell-code" id="cb372"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb372-1"><a href="#cb372-1"></a>rbind_df2 <span class="co"># rbind_df2を出力</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 3 × 3
     X1 X2    X3   
  &lt;int&gt; &lt;chr&gt; &lt;lgl&gt;
1     4 D     FALSE
2     5 E     TRUE 
3     6 F     FALSE</code></pre>
</div>
<div class="sourceCode cell-code" id="cb374"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb374-1"><a href="#cb374-1"></a>rbind_df3 <span class="co"># rbind_df3を出力</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 3 × 3
     X1 X3    X2   
  &lt;int&gt; &lt;lgl&gt; &lt;chr&gt;
1     7 TRUE  G    
2     8 TRUE  H    
3     9 TRUE  I    </code></pre>
</div>
<div class="sourceCode cell-code" id="cb376"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb376-1"><a href="#cb376-1"></a>rbind_df4 <span class="co"># rbind_df4を出力</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 3 × 3
     X1 X2    X5    
  &lt;int&gt; &lt;chr&gt; &lt;chr&gt; 
1    10 J     Song  
2    11 K     Yanai 
3    12 L     Hadley</code></pre>
</div>
</div>
<p>　まずは、<code>rbind_df1</code>と<code>rbind_df2</code>を結合してみます。この2つのデータは同じ変数が同じ順番で並んでいますね。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb378"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb378-1"><a href="#cb378-1"></a>Binded_df1 <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(rbind_df1, rbind_df2)</span>
<span id="cb378-2"><a href="#cb378-2"></a>Binded_df1</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 3
     X1 X2    X3   
  &lt;int&gt; &lt;chr&gt; &lt;lgl&gt;
1     1 A     TRUE 
2     2 B     TRUE 
3     3 C     FALSE
4     4 D     FALSE
5     5 E     TRUE 
6     6 F     FALSE</code></pre>
</div>
</div>
<p>　2つのデータが結合されたことが確認できます。それでは<code>rbind_df1</code>と<code>rbind_df2</code>、<code>rbind_df3</code>はどうでしょうか。確かに3つのデータは同じ変数を持ちますが、<code>rbind_df3</code>は変数の順番が<code>X1</code>、<code>X3</code>、<code>X2</code>になっています。このまま結合するとエラーが出るでしょうか。とりあえず、やってみます。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb380"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb380-1"><a href="#cb380-1"></a>Binded_df2 <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(rbind_df1, rbind_df2, rbind_df3)</span>
<span id="cb380-2"><a href="#cb380-2"></a>Binded_df2</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 9 × 3
     X1 X2    X3   
  &lt;int&gt; &lt;chr&gt; &lt;lgl&gt;
1     1 A     TRUE 
2     2 B     TRUE 
3     3 C     FALSE
4     4 D     FALSE
5     5 E     TRUE 
6     6 F     FALSE
7     7 G     TRUE 
8     8 H     TRUE 
9     9 I     TRUE </code></pre>
</div>
</div>
<p>　このように変数の順番が異なっても、先に指定したデータの変数順で問題なく結合できました。これまでの作業は{dplyr}パッケージの<code>bind_rows()</code>を使わずに、R内蔵関数の<code>rbind()</code>でも同じやり方でできます。<code>bind_rows()</code>の特徴は、変数名が一致しない場合、つまり今回の例だと<code>rbind_df4</code>が含まれる場合です。<code>rbind_df1</code>から<code>rbind_df3</code>までは順番が違っても<code>X1</code>、<code>X2</code>、<code>X3</code>変数で構成されていました。一方、<code>rbind_dr4</code>には<code>X3</code>がなく、新たに<code>X4</code>という変数があります。これを<code>rbind()</code>関数で結合するとエラーが出力されます。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb382"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb382-1"><a href="#cb382-1"></a><span class="co"># rbind()を使う場合</span></span>
<span id="cb382-2"><a href="#cb382-2"></a><span class="fu">rbind</span>(rbind_df1, rbind_df2, rbind_df3, rbind_df4)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-error">
<pre><code>Error in match.names(clabs, names(xi)): names do not match previous names</code></pre>
</div>
</div>
<p>　一方、<code>bind_rows()</code>はどうでしょうか。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb384"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb384-1"><a href="#cb384-1"></a>Binded_df3 <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(rbind_df1, rbind_df2, rbind_df3, rbind_df4)</span>
<span id="cb384-2"><a href="#cb384-2"></a>Binded_df3</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 12 × 4
      X1 X2    X3    X5    
   &lt;int&gt; &lt;chr&gt; &lt;lgl&gt; &lt;chr&gt; 
 1     1 A     TRUE  &lt;NA&gt;  
 2     2 B     TRUE  &lt;NA&gt;  
 3     3 C     FALSE &lt;NA&gt;  
 4     4 D     FALSE &lt;NA&gt;  
 5     5 E     TRUE  &lt;NA&gt;  
 6     6 F     FALSE &lt;NA&gt;  
 7     7 G     TRUE  &lt;NA&gt;  
 8     8 H     TRUE  &lt;NA&gt;  
 9     9 I     TRUE  &lt;NA&gt;  
10    10 J     NA    Song  
11    11 K     NA    Yanai 
12    12 L     NA    Hadley</code></pre>
</div>
</div>
<p>　<code>X1</code>から<code>X4</code>まで全ての列が生成され、元のデータにはなかった列に関しては<code>NA</code>で埋められています。</p>
<p>　ならば、<code>bind_rows()</code>の完全勝利かというと、そうとは限りません。自分で架空した複数のデータフレーム、またはtibbleを結合する際、「このデータは全て同じ変数を持っているはず」と事前に分かっているなら<code>rbind()</code>の方が効果的です。なぜなら、変数名が異なる場合、エラーが出力されるからです。<code>bind_rows()</code>を使うと、コーディングミスなどにより、列名の相違がある場合でも結合してくれてしまうので、分析の結果を歪ませる可能性があります。</p>
</section>
<section id="列の結合" class="level3">
<h3 class="anchored" data-anchor-id="列の結合">列の結合</h3>
<p>　実はデータ分析においてデータの結合といえば、列の結合が一般的です。これは <a href="#fig-merge-col">図&nbsp;10</a> のような操作を意味します。</p>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div id="fig-merge-col" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="Figs/Handling1/Merge2.png" class="img-fluid figure-img" style="width:100.0%"></p>
<p></p><figcaption aria-hidden="true" class="figure-caption">図 10: 列の結合</figcaption><p></p>
</figure>
</div>
</div>
</div>
<p>　まずは、本章で作成した<code>df2</code>をもう一回作ってみます。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb386"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb386-1"><a href="#cb386-1"></a>df2 <span class="ot">&lt;-</span> df <span class="sc">%&gt;%</span></span>
<span id="cb386-2"><a href="#cb386-2"></a>  <span class="fu">group_by</span>(Pref) <span class="sc">%&gt;%</span></span>
<span id="cb386-3"><a href="#cb386-3"></a>  <span class="fu">summarise</span>(<span class="at">Budget_Mean =</span> <span class="fu">mean</span>(Budget, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb386-4"><a href="#cb386-4"></a>            <span class="at">ScoreN_Sum  =</span> <span class="fu">sum</span>(ScoreN, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb386-5"><a href="#cb386-5"></a>            <span class="at">Score_Mean  =</span> <span class="fu">mean</span>(Score, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb386-6"><a href="#cb386-6"></a>            <span class="at">N           =</span> <span class="fu">n</span>(),</span>
<span id="cb386-7"><a href="#cb386-7"></a>            <span class="at">.groups     =</span> <span class="st">"drop"</span>)</span>
<span id="cb386-8"><a href="#cb386-8"></a></span>
<span id="cb386-9"><a href="#cb386-9"></a>df2</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 9 × 5
  Pref     Budget_Mean ScoreN_Sum Score_Mean     N
  &lt;chr&gt;          &lt;dbl&gt;      &lt;dbl&gt;      &lt;dbl&gt; &lt;int&gt;
1 京都府         1399.        216       3.68   414
2 兵庫県         1197.        230       3.54   591
3 千葉県         1124.        259       3.72  1000
4 和歌山県       1252          83       3.97   140
5 埼玉県         1147.        278       3.64  1000
6 大阪府         1203.        516       3.77  1000
7 奈良県         1169.         45       3.85   147
8 東京都         1283.       1165       3.67  1000
9 神奈川県       1239.        587       3.53  1000</code></pre>
</div>
</div>
<p>　ラーメン屋の店舗ですが、たしかにデータには埼玉、東京、大阪などは1000店舗しか入っておりません。実はもっと多いですが、ぐるなびAPIの仕様上、最大1000店舗しか情報取得が出来ないからです。ここに実際の店舗数が入っている新しいデータセット、<a href="Data/Ramen2.csv">Ramen2.csv</a>があります。これを読み込み、<code>df3</code>という名で格納しましょう。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb388"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb388-1"><a href="#cb388-1"></a><span class="co"># データのパスは適宜修正すること</span></span>
<span id="cb388-2"><a href="#cb388-2"></a>df3 <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">"Data/Ramen2.csv"</span>)</span>
<span id="cb388-3"><a href="#cb388-3"></a></span>
<span id="cb388-4"><a href="#cb388-4"></a>df3</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 47 × 15
   Pref      Pop   Area RamenN Turnout   LDP   CDP  DPFP Komei   JIP   JCP   SDP
   &lt;chr&gt;   &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;   &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;
 1 北海道 5.38e6 83424.   1454    53.8  32.3  20.8  6.65 11.7   7.78 11.6   1.31
 2 青森県 1.31e6  9646.    336    42.9  39.8  22.0  7.24 11.3   3.4   8.31  2.36
 3 岩手県 1.28e6 15275.    285    56.5  35.5  17.8 12.5   8.22  4.36 10.4   3.83
 4 宮城県 2.33e6  7282.    557    51.2  39.6  17.8  9.02 11.1   4.6   7.89  2.1 
 5 秋田県 1.02e6 11638.    301    56.3  44.5  13.5  8.64 10.6   4.48  8.09  3.77
 6 山形県 1.12e6  9323.    512    60.7  45.2  14.9  7.37  9.87  4.28  6.51  5.08
 7 福島県 1.91e6 13784.    550    52.4  38.2  13.6 12.1  12.8   5.31  7.99  3.01
 8 茨城県 2.92e6  6097.    663    45.0  39.3  15.2  7.15 15.1   6.73  7.73  1.46
 9 栃木県 1.97e6  6408.    595    44.1  40.3  18.9  9.94 12.8   4.9   5.04  1.03
10 群馬県 1.97e6  6362.    488    48.2  40.6  16.4  9.76 12.4   4.67  7.58  1.87
# … with 37 more rows, and 3 more variables: Reiwa &lt;dbl&gt;, NHK &lt;dbl&gt;, HRP &lt;dbl&gt;</code></pre>
</div>
</div>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">

<div id="msrydjmmtn" style="overflow-x:auto;overflow-y:auto;width:auto;height:auto;">
<style>html {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Helvetica Neue', 'Fira Sans', 'Droid Sans', Arial, sans-serif;
}

#msrydjmmtn .gt_table {
  display: table;
  border-collapse: collapse;
  margin-left: auto;
  margin-right: auto;
  color: #333333;
  font-size: 16px;
  font-weight: normal;
  font-style: normal;
  background-color: #FFFFFF;
  width: auto;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #A8A8A8;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #A8A8A8;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
}

#msrydjmmtn .gt_heading {
  background-color: #FFFFFF;
  text-align: center;
  border-bottom-color: #FFFFFF;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#msrydjmmtn .gt_title {
  color: #333333;
  font-size: 125%;
  font-weight: initial;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-color: #FFFFFF;
  border-bottom-width: 0;
}

#msrydjmmtn .gt_subtitle {
  color: #333333;
  font-size: 85%;
  font-weight: initial;
  padding-top: 0;
  padding-bottom: 6px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-color: #FFFFFF;
  border-top-width: 0;
}

#msrydjmmtn .gt_bottom_border {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#msrydjmmtn .gt_col_headings {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#msrydjmmtn .gt_col_heading {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 6px;
  padding-left: 5px;
  padding-right: 5px;
  overflow-x: hidden;
}

#msrydjmmtn .gt_column_spanner_outer {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  padding-top: 0;
  padding-bottom: 0;
  padding-left: 4px;
  padding-right: 4px;
}

#msrydjmmtn .gt_column_spanner_outer:first-child {
  padding-left: 0;
}

#msrydjmmtn .gt_column_spanner_outer:last-child {
  padding-right: 0;
}

#msrydjmmtn .gt_column_spanner {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 5px;
  overflow-x: hidden;
  display: inline-block;
  width: 100%;
}

#msrydjmmtn .gt_group_heading {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
}

#msrydjmmtn .gt_empty_group_heading {
  padding: 0.5px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: middle;
}

#msrydjmmtn .gt_from_md > :first-child {
  margin-top: 0;
}

#msrydjmmtn .gt_from_md > :last-child {
  margin-bottom: 0;
}

#msrydjmmtn .gt_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  margin: 10px;
  border-top-style: solid;
  border-top-width: 1px;
  border-top-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  overflow-x: hidden;
}

#msrydjmmtn .gt_stub {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 5px;
  padding-right: 5px;
}

#msrydjmmtn .gt_stub_row_group {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 5px;
  padding-right: 5px;
  vertical-align: top;
}

#msrydjmmtn .gt_row_group_first td {
  border-top-width: 2px;
}

#msrydjmmtn .gt_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#msrydjmmtn .gt_first_summary_row {
  border-top-style: solid;
  border-top-color: #D3D3D3;
}

#msrydjmmtn .gt_first_summary_row.thick {
  border-top-width: 2px;
}

#msrydjmmtn .gt_last_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#msrydjmmtn .gt_grand_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#msrydjmmtn .gt_first_grand_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-style: double;
  border-top-width: 6px;
  border-top-color: #D3D3D3;
}

#msrydjmmtn .gt_striped {
  background-color: rgba(128, 128, 128, 0.05);
}

#msrydjmmtn .gt_table_body {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#msrydjmmtn .gt_footnotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#msrydjmmtn .gt_footnote {
  margin: 0px;
  font-size: 90%;
  padding-left: 4px;
  padding-right: 4px;
  padding-left: 5px;
  padding-right: 5px;
}

#msrydjmmtn .gt_sourcenotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#msrydjmmtn .gt_sourcenote {
  font-size: 90%;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
}

#msrydjmmtn .gt_left {
  text-align: left;
}

#msrydjmmtn .gt_center {
  text-align: center;
}

#msrydjmmtn .gt_right {
  text-align: right;
  font-variant-numeric: tabular-nums;
}

#msrydjmmtn .gt_font_normal {
  font-weight: normal;
}

#msrydjmmtn .gt_font_bold {
  font-weight: bold;
}

#msrydjmmtn .gt_font_italic {
  font-style: italic;
}

#msrydjmmtn .gt_super {
  font-size: 65%;
}

#msrydjmmtn .gt_two_val_uncert {
  display: inline-block;
  line-height: 1em;
  text-align: right;
  font-size: 60%;
  vertical-align: -0.25em;
  margin-left: 0.1em;
}

#msrydjmmtn .gt_footnote_marks {
  font-style: italic;
  font-weight: normal;
  font-size: 75%;
  vertical-align: 0.4em;
}

#msrydjmmtn .gt_asterisk {
  font-size: 100%;
  vertical-align: 0;
}

#msrydjmmtn .gt_slash_mark {
  font-size: 0.7em;
  line-height: 0.7em;
  vertical-align: 0.15em;
}

#msrydjmmtn .gt_fraction_numerator {
  font-size: 0.6em;
  line-height: 0.6em;
  vertical-align: 0.45em;
}

#msrydjmmtn .gt_fraction_denominator {
  font-size: 0.6em;
  line-height: 0.6em;
  vertical-align: -0.05em;
}
</style>
<table class="gt_table">
  
  <thead class="gt_col_headings">
    <tr>
      <th class="gt_col_heading gt_columns_bottom_border gt_left" rowspan="1" colspan="1">変数名</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_left" rowspan="1" colspan="1">説明</th>
    </tr>
  </thead>
  <tbody class="gt_table_body">
    <tr><td class="gt_row gt_left">Pref</td>
<td class="gt_row gt_left">都道府県名</td></tr>
    <tr><td class="gt_row gt_left">Pop</td>
<td class="gt_row gt_left">日本人人口 (2015年国勢調査)</td></tr>
    <tr><td class="gt_row gt_left">Area</td>
<td class="gt_row gt_left">面積 (2015年国勢調査)</td></tr>
    <tr><td class="gt_row gt_left">RamenN</td>
<td class="gt_row gt_left">ぐるなびに登録されたラーメン屋の店舗数</td></tr>
    <tr><td class="gt_row gt_left">Turnout</td>
<td class="gt_row gt_left">2019年参院選: 投票率 (比例)</td></tr>
    <tr><td class="gt_row gt_left">LDP</td>
<td class="gt_row gt_left">2019年参院選: 自民党の得票率 (比例)</td></tr>
    <tr><td class="gt_row gt_left">CDP</td>
<td class="gt_row gt_left">2019年参院選: 立憲民主党の得票率 (比例)</td></tr>
    <tr><td class="gt_row gt_left">DPFP</td>
<td class="gt_row gt_left">2019年参院選: 国民民主党の得票率 (比例)</td></tr>
    <tr><td class="gt_row gt_left">Komei</td>
<td class="gt_row gt_left">2019年参院選: 公明党の得票率 (比例)</td></tr>
    <tr><td class="gt_row gt_left">JIP</td>
<td class="gt_row gt_left">2019年参院選: 日本維新の会の得票率 (比例)</td></tr>
    <tr><td class="gt_row gt_left">JCP</td>
<td class="gt_row gt_left">2019年参院選: 日本共産党の得票率 (比例)</td></tr>
    <tr><td class="gt_row gt_left">SDP</td>
<td class="gt_row gt_left">2019年参院選: 社会民主党の得票率 (比例)</td></tr>
    <tr><td class="gt_row gt_left">Reiwa</td>
<td class="gt_row gt_left">2019年参院選: れいわ新選組の得票率 (比例)</td></tr>
    <tr><td class="gt_row gt_left">NHK</td>
<td class="gt_row gt_left">2019年参院選: NHKから国民を守る党の得票率 (比例)</td></tr>
    <tr><td class="gt_row gt_left">HRP</td>
<td class="gt_row gt_left">2019年参院選: 幸福実現党の得票率 (比例)</td></tr>
  </tbody>
  
  
</table>
</div>
</div>
</div>
<p>　本データは都道府県ごとの人口、面積、ぐるなびに登録されたラーメン屋の店舗数、2019年参議院議員通常選挙の結果が格納されています。人口と面積は2015年国勢調査、ぐるなびの情報は2020年6月時点での情報です。</p>
<p>　<code>df2</code>にデータ上の店舗数ではなく、実際の店舗数を新しい列として追加したい場合はどうすれば良いでしょうか。簡単な方法としては<code>df3</code>から情報を取得し、それを自分で入れる方法です。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb390"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb390-1"><a href="#cb390-1"></a>df3 <span class="sc">%&gt;%</span></span>
<span id="cb390-2"><a href="#cb390-2"></a>  <span class="co"># df2のPrefベクトルの要素と一致するものに絞る</span></span>
<span id="cb390-3"><a href="#cb390-3"></a>  <span class="fu">filter</span>(Pref <span class="sc">%in%</span> df2<span class="sc">$</span>Pref) <span class="sc">%&gt;%</span></span>
<span id="cb390-4"><a href="#cb390-4"></a>  <span class="co"># 都道府県名とラーメン屋の店舗数のみ抽出</span></span>
<span id="cb390-5"><a href="#cb390-5"></a>  <span class="fu">select</span>(Pref, RamenN)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 9 × 2
  Pref     RamenN
  &lt;chr&gt;     &lt;dbl&gt;
1 埼玉県     1106
2 千葉県     1098
3 東京都     3220
4 神奈川県   1254
5 京都府      415
6 大阪府     1325
7 兵庫県      591
8 奈良県      147
9 和歌山県    140</code></pre>
</div>
</div>
<p>　そして、この情報を<code>df2$RamenN &lt;- c(415, 1106, 1254, ...)</code>のように追加すればいいですね。</p>
<p>　しかし、このような方法は非効率的です。そもそも<code>df3</code>から得られた結果の順番と<code>df2</code>の順番も一致しないので、一々対照しながらベクトルを作ることになります。ここで登場する関数が{dplyr}の<code>*_join()</code>関数群です。この関数群には4つの関数が含まれており、以下のような使い方になります。</p>
<div class="sourceCode" id="cb392"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb392-1"><a href="#cb392-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 新しいデータ名ではなく、データ1またはデータ2の名前に格納すると上書きとなる</span></span>
<span id="cb392-2"><a href="#cb392-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb392-3"><a href="#cb392-3" aria-hidden="true" tabindex="-1"></a><span class="co"># 1. データ1を基準に結合</span></span>
<span id="cb392-4"><a href="#cb392-4" aria-hidden="true" tabindex="-1"></a>新しいデータ名 <span class="ot">&lt;-</span>  <span class="fu">left_join</span>(データ1, データ2, <span class="at">by =</span> <span class="st">"共通変数名"</span>)</span>
<span id="cb392-5"><a href="#cb392-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb392-6"><a href="#cb392-6" aria-hidden="true" tabindex="-1"></a><span class="co"># 2. データ2を基準に結合</span></span>
<span id="cb392-7"><a href="#cb392-7" aria-hidden="true" tabindex="-1"></a>新しいデータ名 <span class="ot">&lt;-</span> <span class="fu">right_join</span>(データ1, データ2, <span class="at">by =</span> <span class="st">"共通変数名"</span>)</span>
<span id="cb392-8"><a href="#cb392-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb392-9"><a href="#cb392-9" aria-hidden="true" tabindex="-1"></a><span class="co"># 3. データ1とデータ2両方に共通するケースのみ結合</span></span>
<span id="cb392-10"><a href="#cb392-10" aria-hidden="true" tabindex="-1"></a>新しいデータ名 <span class="ot">&lt;-</span> <span class="fu">inner_join</span>(データ1, データ2, <span class="at">by =</span> <span class="st">"共通変数名"</span>)</span>
<span id="cb392-11"><a href="#cb392-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb392-12"><a href="#cb392-12" aria-hidden="true" tabindex="-1"></a><span class="co"># 4. データ1とデータ2、どれかに存在するケースを結合</span></span>
<span id="cb392-13"><a href="#cb392-13" aria-hidden="true" tabindex="-1"></a>新しいデータ名 <span class="ot">&lt;-</span>  <span class="fu">full_join</span>(データ1, データ2, <span class="at">by =</span> <span class="st">"共通変数名"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>　4つの関数の違いについて説明する前に、<code>by</code>引数について話したいと思います。これは主にキー (key)変数と呼ばれる変数で、それぞれのデータに同じ名前の変数がある必要があります。<code>df2</code>と<code>df3</code>だとそれが<code>Pref</code>変数です。どの<code>*_join()</code>関数でも、<code>Pref</code>の値が同じもの同士を結合することになります。</p>
<p>　データのキー変数名が異なる場合もあります。たとえば、データ1の都道府県名は<code>Pref</code>という列に、データ2の都道府県名は<code>Prefecture</code>という列になっている場合、<code>by = "Pref"</code>でなく、<code>by = c("データ1のキー変数名" = "データ2のキー変数名")</code>、つまり、<code>by = c("Pref" = "Prefecture")</code>と指定します。</p>
<p>　それでは、<code>df3</code>から都道府県名とラーメン屋の店舗数だけ抽出し、<code>df4</code>として格納しておきます。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb393"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb393-1"><a href="#cb393-1"></a>df4 <span class="ot">&lt;-</span> df3 <span class="sc">%&gt;%</span></span>
<span id="cb393-2"><a href="#cb393-2"></a>  <span class="fu">select</span>(Pref, RamenN)</span>
<span id="cb393-3"><a href="#cb393-3"></a></span>
<span id="cb393-4"><a href="#cb393-4"></a>df4</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 47 × 2
   Pref   RamenN
   &lt;chr&gt;   &lt;dbl&gt;
 1 北海道   1454
 2 青森県    336
 3 岩手県    285
 4 宮城県    557
 5 秋田県    301
 6 山形県    512
 7 福島県    550
 8 茨城県    663
 9 栃木県    595
10 群馬県    488
# … with 37 more rows</code></pre>
</div>
</div>
<p>　これから共通変数名の値をキー (key)と呼びます。今回の例だと<code>Pref</code>が<code>df2</code>と<code>df4</code>のキー変数であり、その値である<code>"東京都"</code>、<code>"北海道"</code>などがキーです。</p>
<p>　まずは、<code>inner_join()</code>の仕組みについて考えます。これは<code>df2</code>と<code>df4</code>に共通するキーを持つケースのみ結合する関数です。<code>df4</code>には<code>"北海道"</code>というキーがありますが、<code>df2</code>にはありません。したがって、キーが<code>"北海道"</code>のケースは結合から除外されます。これをイメージにしたものが@fig-inner-joinです<a href="#fn7" class="footnote-ref" id="fnref7" role="doc-noteref"><sup>7</sup></a>。それぞれ3 <span class="math inline">\(\times\)</span> 2 (3行2列)のデータですが、キーが一致するケースは2つしかないため、結合後のデータは3 <span class="math inline">\(\times\)</span> 2となります。</p>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div id="fig-inner-join" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="Figs/Handling1/Merge_Inner.png" class="img-fluid figure-img" style="width:100.0%"></p>
<p></p><figcaption aria-hidden="true" class="figure-caption">図 11: <code>inner_join()</code>の仕組み</figcaption><p></p>
</figure>
</div>
</div>
</div>
<p>　実際にやってみましょう。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb395"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb395-1"><a href="#cb395-1"></a><span class="fu">inner_join</span>(df2, df4, <span class="at">by =</span> <span class="st">"Pref"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 9 × 6
  Pref     Budget_Mean ScoreN_Sum Score_Mean     N RamenN
  &lt;chr&gt;          &lt;dbl&gt;      &lt;dbl&gt;      &lt;dbl&gt; &lt;int&gt;  &lt;dbl&gt;
1 京都府         1399.        216       3.68   414    415
2 兵庫県         1197.        230       3.54   591    591
3 千葉県         1124.        259       3.72  1000   1098
4 和歌山県       1252          83       3.97   140    140
5 埼玉県         1147.        278       3.64  1000   1106
6 大阪府         1203.        516       3.77  1000   1325
7 奈良県         1169.         45       3.85   147    147
8 東京都         1283.       1165       3.67  1000   3220
9 神奈川県       1239.        587       3.53  1000   1254</code></pre>
</div>
</div>
<p>　共通するキーは9つのみであり、結果として返されたデータの大きさも9 <span class="math inline">\(\times\)</span> 6です。<code>df2</code>に足された<code>df4</code>は2列のデータですが、キー変数である<code>Pref</code>は共通するため、1列のみ足されました。キー変数を両方残す場合は<code>keep = TRUE</code>引数を追加してください。</p>
<p>　一方、<code>full_join()</code>は、すべてのキーに対して結合を行います (<a href="#fig-full-join">図&nbsp;12</a>)。たとえば、<code>df2</code>には<code>"北海道"</code>というキーがありません。それでも新しく出来上がるデータには北海道の列が追加されます。ただし、道内店舗の平均予算、口コミ数などの情報はないため、欠損値が代入されます。</p>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div id="fig-full-join" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="Figs/Handling1/Merge_Full.png" class="img-fluid figure-img" style="width:100.0%"></p>
<p></p><figcaption aria-hidden="true" class="figure-caption">図 12: <code>full_join()</code>の仕組み</figcaption><p></p>
</figure>
</div>
</div>
</div>
<p>　それでは実際、結果を確認してみましょう。今回は結合後、<code>RamenN</code>が大きい順で出力します。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb397"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb397-1"><a href="#cb397-1"></a><span class="fu">full_join</span>(df2, df4, <span class="at">by =</span> <span class="st">"Pref"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb397-2"><a href="#cb397-2"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(RamenN)) <span class="co"># ぐるなびに登録された店舗の多い都道府県から出力</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 47 × 6
   Pref     Budget_Mean ScoreN_Sum Score_Mean     N RamenN
   &lt;chr&gt;          &lt;dbl&gt;      &lt;dbl&gt;      &lt;dbl&gt; &lt;int&gt;  &lt;dbl&gt;
 1 東京都         1283.       1165       3.67  1000   3220
 2 北海道           NA          NA      NA       NA   1454
 3 大阪府         1203.        516       3.77  1000   1325
 4 愛知県           NA          NA      NA       NA   1255
 5 神奈川県       1239.        587       3.53  1000   1254
 6 埼玉県         1147.        278       3.64  1000   1106
 7 千葉県         1124.        259       3.72  1000   1098
 8 福岡県           NA          NA      NA       NA    985
 9 新潟県           NA          NA      NA       NA    705
10 静岡県           NA          NA      NA       NA    679
# … with 37 more rows</code></pre>
</div>
</div>
<p>　<code>df2</code>にはなかった北海道や愛知県などの行ができました。そして、<code>df2</code>にはない情報はすべて欠損値 (<code>NA</code>)となりました。</p>
<p>　続いて、<code>left_join()</code>ですが、これは先に指定したデータに存在するキーのみで結合を行います (<a href="#fig-left-join">図&nbsp;13</a>)。今回は<code>df2</code>が先に指定されていますが、<code>df2</code>のキーは<code>df4</code>のキーの部分集合であるため、<code>inner_join()</code>と同じ結果が得られます。</p>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div id="fig-left-join" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="Figs/Handling1/Merge_Left.png" class="img-fluid figure-img" style="width:100.0%"></p>
<p></p><figcaption aria-hidden="true" class="figure-caption">図 13: <code>left_join()</code>の仕組み</figcaption><p></p>
</figure>
</div>
</div>
</div>
<p>　一方、<code>right_join()</code>は<code>left_join()</code>と逆の関数であり、後に指定したデータに存在するキーを基準に結合を行います (<a href="#fig-right-join">図&nbsp;14</a>)。後に指定された<code>df4</code>のキーは<code>df2</code>のキーを完全に含むので、<code>full_join()</code>と同じ結果が得られます。</p>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div id="fig-right-join" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="Figs/Handling1/Merge_Right.png" class="img-fluid figure-img" style="width:100.0%"></p>
<p></p><figcaption aria-hidden="true" class="figure-caption">図 14: <code>right_join()</code>の仕組み</figcaption><p></p>
</figure>
</div>
</div>
</div>
<p>　これからは<code>df2</code>と<code>df4</code>を結合することになりますが、この2つのtibbleの大きさが異なります。<code>df2</code>は9つの都府県のみであるに対し、<code>df4</code>は47都道府県全てのデータが入っているからです。</p>
<p>　ここまではキー変数が一つである場合についてのみ考えましたが、複数のキー変数が必要な場合もあります。たとえば、市区町村の人口・面積データと市区町村の投票率データを結合するとします。各自治体に与えられている「<a href="https://www.soumu.go.jp/denshijiti/code.html">全国地方公共団体コード</a>」が両データに含まれている場合は、このコードをキー変数として使えば問題ありませんが、市区町村名をキー変数として使わざる得ないケースもあるでしょう。しかし、キー変数が複数ある場合もあります。たとえば、府中市は東京都と広島県にありますし、太子町は大阪府と兵庫県にあります。この場合、市区町村名のみでケースをマッチングすると、重複されてマッチングされる恐れがあります。この場合はキー変数を増やすことで対処できます。たとえば、同じ都道府県なら同じ市区町村は存在しないでしょう<a href="#fn8" class="footnote-ref" id="fnref8" role="doc-noteref"><sup>8</sup></a>。キー変数を複数指定する方法は簡単です。たとえば、市区町村名変数が<code>Munip</code>、都道府県名変数が<code>Pref</code>なら<code>by = c("Munip", "Pref")</code>と指定するだけです。</p>
<p>　最後に、キー変数以外の変数名が重複する場合について考えましょう。これはパネルデータを結合する時によく直面する問題です。同じ回答者に2回の調査を行った場合、回答者のIDでデータを結合することになります。ただし、それぞれのデータにおいて回答者の性別に関する変数が<code>F1</code>という名前の場合、どうなるでしょうか。同じデータの同じ名前の変数が複数あると、非常に扱いにくくなります。実際の結果を見てみましょう。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb399"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb399-1"><a href="#cb399-1"></a>Wave1_df <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">ID =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>, <span class="dv">4</span>, <span class="dv">5</span>),</span>
<span id="cb399-2"><a href="#cb399-2"></a>                   <span class="at">F1 =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">1</span>),</span>
<span id="cb399-3"><a href="#cb399-3"></a>                   <span class="at">F2 =</span> <span class="fu">c</span>(<span class="dv">18</span>, <span class="dv">77</span>, <span class="dv">37</span>, <span class="dv">50</span>, <span class="dv">41</span>),</span>
<span id="cb399-4"><a href="#cb399-4"></a>                   <span class="at">Q1 =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">5</span>, <span class="dv">2</span>, <span class="dv">2</span>, <span class="dv">3</span>))</span>
<span id="cb399-5"><a href="#cb399-5"></a></span>
<span id="cb399-6"><a href="#cb399-6"></a>Wave2_df <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">ID =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">3</span>, <span class="dv">4</span>, <span class="dv">6</span>, <span class="dv">7</span>),</span>
<span id="cb399-7"><a href="#cb399-7"></a>                   <span class="at">F1 =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">1</span>),</span>
<span id="cb399-8"><a href="#cb399-8"></a>                   <span class="at">F2 =</span> <span class="fu">c</span>(<span class="dv">18</span>, <span class="dv">37</span>, <span class="dv">50</span>, <span class="dv">20</span>, <span class="dv">62</span>),</span>
<span id="cb399-9"><a href="#cb399-9"></a>                   <span class="at">Q1 =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">2</span>, <span class="dv">5</span>, <span class="dv">4</span>))</span>
<span id="cb399-10"><a href="#cb399-10"></a></span>
<span id="cb399-11"><a href="#cb399-11"></a><span class="fu">full_join</span>(Wave1_df, Wave2_df, <span class="at">by =</span> <span class="st">"ID"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 7 × 7
     ID  F1.x  F2.x  Q1.x  F1.y  F2.y  Q1.y
  &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;
1     1     1    18     1     1    18     1
2     2     1    77     5    NA    NA    NA
3     3     0    37     2     0    37     2
4     4     0    50     2     0    50     2
5     5     1    41     3    NA    NA    NA
6     6    NA    NA    NA     0    20     5
7     7    NA    NA    NA     1    62     4</code></pre>
</div>
</div>
<p>　それぞれの変数名の後に<code>.x</code>と<code>.y</code>が付きます。この接尾辞 (suffix)は<code>suffix</code>引数を指定することで、分析側からカスタマイズ可能です。たとえば、接尾辞を<code>_W1</code>、<code>_W2</code>にしたい場合は</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb401"><pre class="sourceCode numberSource r numberLines code-with-copy"><code class="sourceCode r"><span id="cb401-1"><a href="#cb401-1"></a><span class="fu">full_join</span>(Wave1_df, Wave2_df, <span class="at">by =</span> <span class="st">"ID"</span>, <span class="at">suffix =</span> <span class="fu">c</span>(<span class="st">"_W1"</span>, <span class="st">"_W2"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 7 × 7
     ID F1_W1 F2_W1 Q1_W1 F1_W2 F2_W2 Q1_W2
  &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;
1     1     1    18     1     1    18     1
2     2     1    77     5    NA    NA    NA
3     3     0    37     2     0    37     2
4     4     0    50     2     0    50     2
5     5     1    41     3    NA    NA    NA
6     6    NA    NA    NA     0    20     5
7     7    NA    NA    NA     1    62     4</code></pre>
</div>
</div>
<p>のように、データ1とデータ2それぞれの接尾辞を指定するだけです。</p>


</section>
</section>


<div id="quarto-appendix" class="default"><section class="footnotes footnotes-end-of-document" role="doc-endnotes"><h2 class="anchored quarto-appendix-heading">注</h2>

<ol>
<li id="fn1" role="doc-endnote"><p>実は<code>select(starts_with("X"), -ends_with("D"), ID)</code>のように順番を変えると<code>ID</code>は最後の列になりますが、とりあえず残ります。なぜなら、<code>select()</code>関数は左側から右側の方へコードを実行するからです。<a href="#fnref1" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn2" role="doc-endnote"><p>実は<code>select.df[, c(2, 8, 9)]</code>でも前後にパイプ演算子を使うことは可能ですが、コードが読みにくくなるため、推奨しません。<a href="#fnref2" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn3" role="doc-endnote"><p>サービスによってはこの機能が有料になっていたりもしますね。<a href="#fnref3" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn4" role="doc-endnote"><p>たとえば、データ内に「ラーメンショップ」という店舗は3店舗あり、この場合、長さ3のベクトルが返されます。<a href="#fnref4" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn5" role="doc-endnote"><p>データの出典は<a href="https://news.google.com/covid19/map">Google</a>です。<a href="#fnref5" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn6" role="doc-endnote"><p>character型でなく、numeric型でも出来ます。<a href="#fnref6" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn7" role="doc-endnote"><p>これらの図は<a href="https://r4ds.had.co.nz">Garrett Grolemund and Hadley Wickham. 2017. <em>R for Data Science: Import, Tidy, Transform, Visualize, and Model Data.</em> O’Reilly.</a>を参考にしました。<a href="#fnref7" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn8" role="doc-endnote"><p>行政区も含むなら多くの政令指定都市にある「南区」とか「北区」が重複しますが、ここでは考えないことにしましょう。<a href="#fnref8" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
</ol>
</section></div></main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    setTimeout(function() {
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      let href = ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const cites = ref.parentNode.getAttribute('data-cites').split(' ');
    tippyHover(ref, function() {
      var popup = window.document.createElement('div');
      cites.forEach(function(cite) {
        var citeDiv = window.document.createElement('div');
        citeDiv.classList.add('hanging-indent');
        citeDiv.classList.add('csl-entry');
        var biblioDiv = window.document.getElementById('ref-' + cite);
        if (biblioDiv) {
          citeDiv.innerHTML = biblioDiv.innerHTML;
        }
        popup.appendChild(citeDiv);
      });
      return popup.innerHTML;
    });
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var filterRegex = new RegExp(/https:\/\/www\.jaysong\.net\//);
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
    var links = window.document.querySelectorAll('a:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
          // target, if specified
          link.setAttribute("target", "_blank");
      }
    }
});
</script>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
      <div class="nav-footer-center">Copyright 2022, Jaehyun Song. Powered by <a href="https://quarto.org/">Quarto</a></div>
  </div>
</footer>



</body></html>